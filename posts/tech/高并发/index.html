<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ç½‘ç»œé«˜å¹¶å‘ | ç–¯å­çˆ±æ·¡å®š</title>
<meta name="keywords" content="é«˜å¹¶å‘, å¤šè·¯å¤ç”¨, è¿›ç¨‹é—´é€šä¿¡">
<meta name="description" content="é«˜å¹¶å‘çš„ä¸€äº›æ¦‚å¿µè®°å½•">
<meta name="author" content="becool">
<link rel="canonical" href="http://heketong.github.io/posts/tech/%E9%AB%98%E5%B9%B6%E5%8F%91/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://becool.vip:666/img/heketong_profile_photo.JPG">
<link rel="icon" type="image/png" sizes="16x16" href="http://becool.vip:666/img/heketong_profile_photo.JPG">
<link rel="icon" type="image/png" sizes="32x32" href="http://becool.vip:666/img/heketong_profile_photo.JPG">
<link rel="apple-touch-icon" href="http://becool.vip:666/img/heketong_profile_photo.JPG">
<link rel="mask-icon" href="http://becool.vip:666/img/heketong_profile_photo.JPG">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://heketong.github.io/posts/tech/%E9%AB%98%E5%B9%B6%E5%8F%91/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  

<meta property="og:title" content="ç½‘ç»œé«˜å¹¶å‘" />
<meta property="og:description" content="é«˜å¹¶å‘çš„ä¸€äº›æ¦‚å¿µè®°å½•" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://heketong.github.io/posts/tech/%E9%AB%98%E5%B9%B6%E5%8F%91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-13T22:45:46+08:00" />
<meta property="article:modified_time" content="2020-05-13T22:45:46+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ç½‘ç»œé«˜å¹¶å‘"/>
<meta name="twitter:description" content="é«˜å¹¶å‘çš„ä¸€äº›æ¦‚å¿µè®°å½•"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "http://heketong.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "http://heketong.github.io/posts/tech/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç½‘ç»œé«˜å¹¶å‘",
      "item": "http://heketong.github.io/posts/tech/%E9%AB%98%E5%B9%B6%E5%8F%91/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ç½‘ç»œé«˜å¹¶å‘",
  "name": "ç½‘ç»œé«˜å¹¶å‘",
  "description": "é«˜å¹¶å‘çš„ä¸€äº›æ¦‚å¿µè®°å½•",
  "keywords": [
    "é«˜å¹¶å‘", "å¤šè·¯å¤ç”¨", "è¿›ç¨‹é—´é€šä¿¡"
  ],
  "articleBody": "é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾ è¿æ¥ç›¸å…³ æœåŠ¡ç«¯èƒ½ä¿æŒï¼Œç®¡ç†ï¼Œå¤„ç†å¤šå°‘å®¢æˆ·ç«¯çš„è¿æ¥\næ´»è·ƒè¿æ¥æ•°ï¼šæ‰€æœ‰ESTABLISHEDçŠ¶æ€çš„TCPè¿æ¥ï¼ŒæŸä¸ªç¬æ—¶ï¼Œè¿™äº›è¿æ¥æ­£åœ¨ä¼ è¾“æ•°æ®ã€‚å¦‚æœæ‚¨é‡‡ç”¨çš„æ˜¯é•¿è¿æ¥çš„æƒ…å†µï¼Œä¸€ä¸ªè¿æ¥ä¼šåŒæ—¶ä¼ è¾“å¤šä¸ªè¯·æ±‚ã€‚ä¹Ÿå¯ä»¥é—´æ¥è€ƒå¯Ÿåç«¯æœåŠ¡å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ³¨æ„ä¸åŒäºå¹¶å‘é‡ã€‚ éæ´»è·ƒè¿æ¥æ•°ï¼šè¡¨ç¤ºé™¤ESTABLISHEDçŠ¶æ€çš„å…¶å®ƒæ‰€æœ‰çŠ¶æ€çš„TCPè¿æ¥æ•°ã€‚ å¹¶å‘è¿æ¥æ•°ï¼šæ‰€æœ‰å»ºç«‹çš„TCPè¿æ¥æ•°é‡ã€‚=æ´»è·ƒè¿æ¥æ•°+éæ´»è·ƒè¿æ¥æ•°ã€‚ æ–°å»ºè¿æ¥æ•°ï¼šåœ¨ç»Ÿè®¡å‘¨æœŸå†…ï¼Œä»å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ç«¯ï¼Œæ–°å»ºç«‹çš„è¿æ¥è¯·æ±‚çš„å¹³å‡æ•°ã€‚ä¸»è¦è€ƒå¯Ÿåº”å¯¹ çªå‘æµé‡æˆ–ä»æ­£å¸¸åˆ°é«˜å³°æµé‡çš„èƒ½åŠ›ã€‚å¦‚ï¼šç§’æ€ã€æŠ¢ç¥¨åœºæ™¯ã€‚ ä¸¢å¼ƒè¿æ¥æ•°ï¼šæ¯ç§’ä¸¢å¼ƒçš„è¿æ¥æ•°ã€‚å¦‚æœè¿æ¥æœåŠ¡å™¨åšäº†è¿æ¥ç†”æ–­å¤„ç†ï¼Œè¿™éƒ¨åˆ†æ•°æ®å³ç†”æ–­çš„è¿æ¥ åœ¨linuxä¸Šsocketè¿æ¥ä½“ç°ä¸Šå°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œé«˜å¹¶å‘ä¸­ç›¸å…³çš„å‚æ•°ä¸€å®šè¦è°ƒä¼˜ã€‚\næµé‡ç›¸å…³ â€‹ ä¸»è¦æ˜¯ç½‘ç»œå¸¦å®½çš„é…ç½®ã€‚\næµå…¥æµé‡ï¼šä»å¤–éƒ¨è®¿é—®æœåŠ¡å™¨æ‰€æ¶ˆè€—çš„æµé‡ã€‚ æµå‡ºæµé‡ï¼šæœåŠ¡å™¨å¯¹å¤–å“åº”çš„æµé‡ã€‚ æ•°æ®åŒ…æ•° æ•°æ®åŒ…æ˜¯TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥åï¼Œä¼ è¾“çš„å†…å®¹å°è£…\næµå…¥æ•°æ®åŒ…æ•°ï¼šæœåŠ¡å™¨æ¯ç§’æ¥åˆ°çš„è¯·æ±‚æ•°æ®åŒ…æ•°é‡ã€‚ æµå‡ºæ•°æ®åŒ…æ•°ï¼šæœåŠ¡å™¨æ¯ç§’å‘å‡ºçš„æ•°æ®åŒ…æ•°é‡ã€‚ å¦‚æœæ•°æ®åŒ…å¤ªå¤§å¯ä»¥è€ƒè™‘å‹ç¼©ï¼Œå› ä¸ºä¼ è¾“çš„æ•°æ®åŒ…å° æ•ˆç‡ä¸€èˆ¬ä¼šæå‡ï¼Œä½†è§£å‹ç¼©ä¹Ÿéœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œä¸èƒ½æ— é™åˆ¶å‹ç¼©\nåº”ç”¨ä¼ è¾“åè®® â€‹\tä¼ è¾“åè®®å‹ç¼©ç‡å¥½ï¼Œä¼ è¾“æ€§èƒ½å¥½ï¼Œå¯¹å¹¶å‘æ€§èƒ½æå‡é«˜ã€‚ä½†æ˜¯ä¹Ÿéœ€è¦çœ‹è°ƒç”¨åŒæ–¹çš„è¯­è¨€å¯ä»¥ä½¿ç”¨åè®®æ‰è¡Œã€‚å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æˆç†Ÿçš„ä¼ è¾“åè®®ã€‚æ¯”å¦‚redisçš„åºåˆ—åŒ–ä¼ è¾“åè®®ã€jsonä¼ è¾“åè®®ã€Protocol Buffersä¼ è¾“åè®®ã€httpåè®®ç­‰ã€‚ å°¤å…¶åœ¨ rpcè°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªä¼ è¾“åè®®é€‰æ‹©éœ€è¦ä»”ç»†ç”„åˆ«é€‰å‹ã€‚\né•¿è¿æ¥ã€çŸ­è¿æ¥ é•¿è¿æ¥æ˜¯æŒ‡åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šï¼Œå¯ä»¥é‡ç”¨å¤šæ¬¡å‘é€æ•°æ®åŒ…ï¼Œåœ¨TCPè¿æ¥ä¿æŒæœŸé—´ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åŒ…å‘é€ï¼Œéœ€è¦åŒæ–¹å‘æ£€æµ‹åŒ…ä»¥ç»´æŒæ­¤è¿æ¥ã€‚ åŠå¼€è¿æ¥çš„å¤„ç†ï¼šå½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹èµ·æ­£å¸¸çš„TCPè¿æ¥åï¼Œå¦‚æœå®¢æˆ·ä¸»æœºæ‰çº¿ï¼ˆç½‘çº¿æ–­å¼€ï¼‰ã€ç”µæºæ‰ç”µã€æˆ–ç³»ç»Ÿå´©æºƒï¼ŒæœåŠ¡å™¨å°†æ°¸è¿œä¸ä¼šçŸ¥é“ã€‚é•¿è¿æ¥ä¸­é—´ä»¶ï¼Œéœ€è¦å¤„ç†è¿™ä¸ªç»†èŠ‚ã€‚linuxé»˜è®¤é…ç½®2å°æ—¶ï¼Œå¯ä»¥é…ç½®ä¿®æ”¹ã€‚ä¸è¿‡ç°å®é¡¹ç›®ä¸€èˆ¬ä¸ç”¨ç³»ç»Ÿçš„è¿™ä¸ªæœºåˆ¶ï¼Œå¾ˆå¤šç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯å¿ƒè·³åŒ…ç»´æŒè¿æ¥ï¼ŒæœåŠ¡ç«¯å¯åŠ¨å®šæ—¶å™¨ï¼Œè¶…æ—¶å°±closeæ‰è¿æ¥ çŸ­è¿æ¥æ˜¯æŒ‡é€šä¿¡åŒæ–¹æœ‰æ•°æ®äº¤äº’æ—¶ï¼Œå°±å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œæ•°æ®å‘é€å®Œæˆåï¼Œåˆ™æ–­å¼€æ­¤TCPè¿æ¥ã€‚ä½†æ˜¯æ¯æ¬¡å»ºç«‹è¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ã€æ–­å¼€è¿æ¥éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚ å…³é—­è¿æ¥æœ€å¥½ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·ï¼ŒTIME_WAITè¿™ä¸ªçŠ¶æ€æœ€å¥½ä¸è¦åœ¨æœåŠ¡å™¨ç«¯ï¼Œå‡å°‘å ç”¨èµ„æºï¼Œå½“ç„¶å¦‚æœæ˜¯ä½¿ç”¨çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯é«˜é¢‘çš„å‡ºç°TIME_WAITä¹Ÿè¦æ³¨æ„ä¸´æ—¶ç«¯å£è€—å°½çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰å¾ˆå¤šä¼˜åŒ–(æ¯”å¦‚SO_REUSEADDRé€‰é¡¹ã€SO_LINGERé€‰é¡¹ï¼Œä¸´æ—¶ç«¯å£èŒƒå›´è°ƒä¼˜ç­‰) é€‰æ‹©å»ºè®®ï¼š\nåœ¨å®¢æˆ·ç«¯æ•°é‡å°‘åœºæ™¯ä¸€èˆ¬ä½¿ç”¨é•¿è¿æ¥ã€‚åç«¯ä¸­é—´ä»¶ã€å¾®æœåŠ¡ä¹‹é—´é€šä¿¡æœ€å¥½ä½¿ç”¨é•¿è¿æ¥ã€‚å¦‚ï¼šæ•°æ®åº“è¿æ¥ï¼Œdubooé»˜è®¤åè®®ç­‰ã€‚ è€Œå¤§å‹webã€appåº”ç”¨ï¼Œä½¿ç”¨httpçŸ­è¿æ¥ï¼ˆhttp1.1çš„keep aliveå˜ç›¸çš„æ”¯æŒé•¿è¿æ¥ï¼Œä½†è¿˜æ˜¯ä¸²è¡Œè¯·æ±‚/å“åº”äº¤äº’ï¼‰ã€‚http2.0æ”¯æŒçœŸæ­£çš„é•¿è¿æ¥ã€‚ é•¿è¿æ¥ä¼šå¯¹æœåŠ¡ç«¯è€—è´¹æ›´å¤šçš„èµ„æºï¼Œä¸Šç™¾ä¸‡ç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬å ä¸€ä¸ªè¿æ¥ï¼Œå¯¹æœåŠ¡ç«¯å‹åŠ›å¤šå¤§ï¼Œæˆæœ¬å¤šé«˜ã€‚IMã€pushåº”ç”¨ä¼šä½¿ç”¨é•¿è¿æ¥ï¼Œä½†æ˜¯ä¼šåšå¾ˆå¤šä¼˜åŒ–å·¥ä½œã€‚ ç”±äºhttpséœ€è¦åŠ è§£å¯†è¿ç®—ç­‰ï¼Œæœ€å¥½ä½¿ç”¨http2.0ï¼ˆå¼ºåˆ¶sslï¼‰ï¼Œä¼ è¾“æ€§èƒ½å¾ˆå¥½ã€‚ä½†æ˜¯æœåŠ¡ç«¯éœ€è¦ç»´æŒæ›´å¤šçš„è¿æ¥ã€‚ å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡ å¹¶å‘è¿æ¥æ•°ï¼š=æ´»è·ƒè¿æ¥æ•°+éæ´»è·ƒè¿æ¥æ•°ã€‚æ‰€æœ‰å»ºç«‹çš„TCPè¿æ¥æ•°é‡ã€‚ç½‘ç»œæœåŠ¡å™¨èƒ½å¹¶è¡Œç®¡ç†çš„è¿æ¥æ•°ã€‚ å¹¶å‘é‡ï¼šç¬æ—¶é€šè¿‡æ´»è·ƒè¿æ¥ä¼ è¾“æ•°æ®çš„é‡ï¼Œè¿™ä¸ªé‡ä¸€èˆ¬åœ¨å¤„ç†ç«¯å¥½è¯„ä¼°ã€‚è·Ÿæ´»è·ƒè¿æ¥æ•°æ²¡æœ‰ç»å¯¹çš„å…³ç³»ã€‚ç½‘ç»œæœåŠ¡å™¨èƒ½å¹¶è¡Œå¤„ç†çš„ä¸šåŠ¡è¯·æ±‚æ•°ã€‚ rtå“åº”æ—¶é—´ï¼šå„ç±»æ“ä½œå•æœºrtè‚¯å®šä¸ç›¸åŒã€‚æ¯”å¦‚ï¼šä»cacheä¸­è¯»æ•°æ®å’Œåˆ†å¸ƒå¼äº‹åŠ¡å†™æ•°æ®åº“ï¼Œèµ„æºçš„æ¶ˆè€—ä¸åŒï¼Œæ“ä½œæ—¶é—´æœ¬èº«å°±ä¸åŒã€‚ ååé‡ï¼šQPS/TPSï¼Œæ¯ç§’å¯ä»¥å¤„ç†çš„æŸ¥è¯¢æˆ–äº‹åŠ¡æ•°ï¼Œè¿™ä¸ªæ˜¯å…³é”®æŒ‡æ ‡ã€‚ IOå¤šè·¯å¤ç”¨ ç›¸å…³è§‚å¿µå›é¡¾ ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ linuxæ“ä½œç³»ç»Ÿé‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨æŠ€æœ¯ï¼Œå¯¹äº32ä½æ“ä½œç³»ç»Ÿï¼Œå†…å­˜å¯»å€ç©ºé—´å°±æ˜¯4G(2^32)ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒå«åšå†…æ ¸kernelï¼Œç‹¬ç«‹äºæ™®é€šçš„Applicationï¼Œå†…æ ¸æ˜¯å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶çš„æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸(å†…æ ¸è¦è¶³å¤Ÿç¨³å®š)ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†2éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†å«åšå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†å«åšç”¨æˆ·ç©ºé—´ã€‚\nlinuxæ“ä½œç³»ç»Ÿ32ä½ï¼Œå°†æœ€é«˜çš„1G(è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFF) æ˜¯ç»™å†…æ ¸ä½¿ç”¨çš„ï¼Œå«åšå†…æ ¸ç©ºé—´ï¼Œè€Œè¾ƒä½çš„3Gå­—èŠ‚(è™šæ‹Ÿåœ°å€ä»0x00000000åˆ°0xBFFFFFFF)ï¼Œç»™å„ä¸ªåº”ç”¨è¿›ç¨‹ä½¿ç”¨ï¼Œå«åšç”¨æˆ·ç©ºé—´ã€‚\næ¯ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œå› æ­¤linuxå†…æ ¸æœ‰ç³»ç»Ÿå†…çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œç©ºé—´åˆ†é…å›¾å¤§è‡´å¦‚ä¸‹:\nlinuxç³»ç»Ÿå†…éƒ¨ç»“æ„å¤§å€¼å›¾ç¤º:\nå½“ä¸€ä¸ªä»»åŠ¡(å¾€å¾€æ˜¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹)æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹Ÿå°±æ˜¯æ‰§è¡Œå†…æ ¸ä»£ç ï¼Œè¿›ç¨‹å°±è¿›å…¥å†…æ ¸æ€ï¼Œå½“ä»»åŠ¡æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç ï¼Œç§°ä¸ºå¤„äºç”¨æˆ·è¿è¡Œæ€(ç”¨æˆ·æ€)\nè¿›ç¨‹åˆ‡æ¢ ä¸ºäº†æ§åˆ¶å„ä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼Œå†…æ ¸å¿…é¡»æœ‰èƒ½åŠ›æŒ‚èµ·æŸä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹(æ­£åœ¨ä½¿ç”¨cpu)ï¼Œå¹¶å…·æœ‰æ¢å¤ä»¥å‰æŒ‚èµ·è¿›ç¨‹å¹¶æ‰§è¡Œçš„èƒ½åŠ›ã€‚è¿™ç§æŒ‚èµ·ä¸æ¢å¤æ‰§è¡Œå¾€å¾€è¢«ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢ï¼Œä»»ä½•è¿›ç¨‹éƒ½æ˜¯åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ”¯æŒä¸‹æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œè·Ÿå†…æ ¸å¯†åˆ‡ç›¸å…³ã€‚\nè¿›ç¨‹åˆ‡æ¢å¤§è‡´æ¶‰åŠå†…å®¹ï¼š\nä¿å­˜å¤„ç†æœºçš„ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨ æ›´æ–°è¿›ç¨‹PCB(Process Control Block)ä¿¡æ¯ å°†è¿›ç¨‹PCBæ”¾å…¥ç›¸åº”çš„é˜Ÿåˆ—ï¼Œå¦‚å°±ç»ªé˜Ÿåˆ—ï¼ŒæŸäº›æ—¶é—´çš„é˜»å¡ç­‰å¾…é˜Ÿåˆ—ç­‰ç­‰ é€‰æ‹©å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œæ›´æ–°å…¶PCBä¿¡æ¯ æ›´æ–°å†…å­˜ç®¡ç†çš„æ•°æ®ç»“æ„ æ¢å¤å¤„ç†æœºä¸Šä¸‹æ–‡ linuxä¸€ä¸ªæ³¨é‡Š\nå½“ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œæ—¶,CPUçš„æ‰€æœ‰å¯„å­˜å™¨ä¸­çš„å€¼ã€è¿›ç¨‹çš„çŠ¶æ€ä»¥åŠå †æ ˆä¸­çš„å†…å®¹è¢«ç§°ä¸ºè¯¥è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚å½“å†…æ ¸éœ€è¦åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒéœ€è¦ä¿å­˜å½“å‰è¿›ç¨‹çš„æ‰€æœ‰çŠ¶æ€ï¼Œå³ä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åœ¨å†æ¬¡æ‰§è¡Œè¯¥è¿›ç¨‹æ—¶ï¼Œèƒ½å¤Ÿå¿…å¾—åˆ°åˆ‡æ¢æ—¶çš„çŠ¶æ€æ‰§è¡Œä¸‹å»ã€‚åœ¨LINUXä¸­ï¼Œå½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡å‡ä¿å­˜åœ¨è¿›ç¨‹çš„ä»»åŠ¡æ•°æ®ç»“æ„ä¸­ã€‚åœ¨å‘ç”Ÿä¸­æ–­æ—¶,å†…æ ¸å°±åœ¨è¢«ä¸­æ–­è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåœ¨å†…æ ¸æ€ä¸‹æ‰§è¡Œä¸­æ–­æœåŠ¡ä¾‹ç¨‹ã€‚ä½†åŒæ—¶ä¼šä¿ç•™æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„èµ„æºï¼Œä»¥ä¾¿ä¸­ç»§æœåŠ¡ç»“æŸæ—¶èƒ½æ¢å¤è¢«ä¸­æ–­è¿›ç¨‹çš„æ‰§è¡Œ è¿›ç¨‹é˜»å¡ æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç”±äºç­‰å¾…æŸäº›äº‹ä»¶(ç­‰å¾…ç³»ç»Ÿèµ„æºï¼Œç­‰å¾…æŸç§æ“ä½œå®Œæˆï¼Œæ–°çš„æ•°æ®å°šæœªåˆ°è¾¾æˆ–è€…æ²¡æœ‰æ–°çš„å·¥ä½œç­‰)ï¼Œåˆ™ä¼šæœ‰æ“ä½œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé˜»å¡åŸè¯­(Block),ä½¿è‡ªå·±ç”±è¿è¡ŒçŠ¶æ€å˜ä¸ºé˜»å¡çŠ¶æ€ï¼Œè¿›åº¦é˜»å¡çŠ¶æ€ä¹‹åï¼Œè¿›ç¨‹ä¸å ç”¨cpuèµ„æºï¼Œç­‰å¾…çš„äº‹ä»¶å®Œæˆåå†ç”±å†…æ ¸å°†å…¶å”¤é†’ã€‚ æ–‡ä»¶æè¿°ç¬¦ File Descriptorä¸ºè®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œç”¨äºè¡¨è¿°æŒ‡å‘æ–‡ä»¶çš„å¼•ç”¨ åœ¨å½¢å¼ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤çš„ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ã€‚ å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå†…æ ¸å°†è¿”å›å…¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ ä¸€äº›ç±»Unixåº•å±‚ç¨‹åºå¾€å¾€ä¼šå›´ç»•æ–‡ä»¶æè¿°ç¬¦å±•å¼€å·¥ä½œ ç¼“å†²I/O linuxæœ‰I/Oç¼“å­˜æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†I/Oæ•°æ®ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„é¡µç¼“å­˜(page catch)ä¸­ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å¾€å¾€å…ˆè¢«æ“ä½œç³»ç»Ÿæ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºï¼Œç„¶åå†ç”±æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¨‹åºçš„åœ°å€ç©ºé—´ã€‚ ç¼“å­˜I/Oæœºåˆ¶å¯¼è‡´æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´è¿›è¡Œå¤šæ¬¡æ‹·è´ï¼Œè¿™å°±å¿…ç„¶å¯¼è‡´cpuå’Œå†…å­˜å¼€é”€ å¸¸è§I/Oæ¨¡å¼å¤ä¹  å°±æ‹¿readè·ç¦»ï¼Œæ•°æ®å…ˆè¢«æ‹·è´åˆ°å†…æ ¸ç¼“å­˜åŒºï¼Œç„¶åå†æ‹·è´åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ä¼šç»è¿‡2ä¸ªé˜¶æ®µ\nå†…æ ¸ç­‰å¾…æ•°æ®å‡†å¤‡(Waiting for the data to be ready) æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹(Copying the data from the kernel to the process) æ­£æ˜¯å› ä¸ºI/Oç¼“å­˜æœºåˆ¶å¸¦æ¥çš„2é˜¶æ®µï¼Œæ‰€ä»¥æœ‰äº†linuxç³»ç»Ÿå¸¸è§çš„5ç§I/Oæ¨¡å¼\né˜»å¡I/O ( blocking IO)\néé˜»å¡I/O (nonblocking IO)\nI/Oå¤šè·¯å¤ç”¨ (IO multiplexing)\nä¿¡å·é©±åŠ¨I/O (signal driven IO)\nå¼‚æ­¥I/O ( asynchronous IO)\nå…¶ä¸­ä¿¡å·é©±åŠ¨IOå®é™…å¼€å‘ä¸­ç”¨åˆ°çš„ä¸å¤ªå¤šï¼Œä¸‹é¢å¤ä¹ ä¸‹å‡ ä¸ªå¸¸ç”¨çš„IOæ¨¡å¼\nBlocking IO é˜»å¡IO é»˜è®¤linuxæ‰€æœ‰çš„socketéƒ½æ˜¯blockingçš„(æœ‰APIè®¾ç½®ä¸ºnonblocking),å…¸å‹è¯»æ“ä½œæµç¨‹å¦‚ä¸‹:\nprocess call recv/recvform â€”\u003eprocess blocking è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ è¿›ç¨‹é˜»å¡\nKernel wait for the data å†…æ ¸ç­‰å¾…ç¼“å†²åŒºæ•°æ®è¾¾åˆ°(ç½‘ç»œIOæ•°æ®åˆ°ç¼“å†²åŒºä¸€èˆ¬éœ€è¦ä¸€å®šæ—¶é—´) process still blocking Data is ready ,copy data to user æ•°æ®è¾¾åˆ°å å†…æ ¸å°†å…¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ process unblock to run è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œè¿™ä¸ªåœ°æ–¹ä¹Ÿéœ€è¦cpuè°ƒåº¦ï¼Œå…¶å®ä¹Ÿéœ€è¦æ—¶é—´ blocking IOçš„ç‰¹ç‚¹å°±æ˜¯IOæ‰§è¡Œçš„2ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹ä¸€è‡´å¤„äºé˜»å¡çŠ¶æ€ ä¸èƒ½æ‰§è¡Œå…¶å®ƒä»»åŠ¡\nä¸‹é¢å†æ‘˜ä¸€ä¸ªå›¾:\nNonBlocking IO éé˜»å¡IO å¯ä»¥è°ƒç”¨APIå°†socketè®¾ç½®ä¸ºnon-blocking å¤§è‡´æµç¨‹å¦‚ä¸‹ while ( recv(data)!=OK ){//ç³»ç»Ÿè°ƒç”¨recvä¸ä¼šé˜»å¡ï¼Œå¦‚æœdata is not ready,å†…æ ¸ç«‹é©¬è¿”å›å¤±è´¥ wait sometime;//è¿›ç¨‹åˆ¤æ–­å¤±è´¥ å¾€å¾€ä¼‘çœ ä¸€å®šæ—¶é—´ å†æ¬¡è°ƒç”¨recvç³»ç»Ÿè°ƒç”¨ } å› ä¸ºæ²¡æœ‰é˜»å¡ ç³»ç»Ÿè°ƒç”¨ä¼šç«‹é©¬è¿”å›ï¼Œä½†å¾€å¾€æ•°æ®ä¸ä¼šç«‹é©¬readyï¼Œæ‰€ä»¥éé˜»å¡IOå¾€å¾€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯¢é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½äº† IO multiplexing IOå¤šè·¯å¤ç”¨ è¿™é‡Œå¸¸å¸¸å°±æ˜¯æŒ‡çš„selectã€polã€epollï¼Œå¤šè·¯æ˜¯æŒ‡ç®¡ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤ç”¨æ˜¯æŒ‡åŒä¸€ä¸ªè¿›ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æ€»ç»“èµ·æ¥å°±æ˜¯åŒä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹)ç®¡ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜IOå¤„ç†æ•ˆç‡çš„æŠ€æœ¯\nselectæ–¹å¼å¤šè·¯å¤ç”¨å›¾è§£ selectè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹\nè¿›ç¨‹é¦–å…ˆè¦å°†éœ€è¦ç®¡ç†çš„æè¿°ç¬¦æ‰”è¿›selecté›†åˆ è¿›ç¨‹è°ƒç”¨select API(å¾€å¾€ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºä¸è®¾ç½®æ²¡æœ‰æ•°æ®åˆ°è¾¾å°±éœ€è¦å¾ªç¯select)ï¼Œæ­¤æ—¶è¿›ç¨‹è¿›å…¥blockingçŠ¶æ€ å†…æ ¸æ”¶åˆ°apiè°ƒç”¨å°±ä¼šå¾ªç¯ç›‘è§†æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ•°æ®æ˜¯å¦å‡†å¤‡å¥½äº† å¦‚æœæœ‰ä¸€ä¸ªå¥½äº†ï¼Œselectå°±ç«‹é©¬è¿”å› ç„¶åè¿›ç¨‹æ”¶åˆ°selectè¿”å› å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ selectæ¨¡å¼è·Ÿé˜»å¡IOæ¨¡å¼æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œè€Œä¸”æœ‰2æ¬¡ç³»ç»Ÿè°ƒç”¨(selectã€recv)ï¼Œæ™®é€šçš„é˜»å¡åªæœ‰ä¸€ä¸ªrecv,ä½†selectçš„ä¼˜åŠ¿åœ¨äºä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç®¡ç†å¾ˆå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶å¤„ç†å¤šä¸ªé“¾æ¥(socket conn)\nå¦‚æœéœ€è¦å¤„ç†çš„è¿æ¥æ•°ä¸é«˜çš„è¯ï¼Œå•ä»»åŠ¡select/poll/epollçš„æœåŠ¡å™¨ ä¸ä¸€å®šæ¯”å¤šä»»åŠ¡çš„blocking IOæ€§èƒ½é«˜ï¼Œå› ä¸ºè®©å†…æ ¸è½®è¯¢æ¯ä¸ªæè¿°ç¬¦ä¹Ÿæ˜¯éœ€è¦èŠ±è´¹æ—¶é—´çš„ï¼Œæœ‰å¯èƒ½å»¶è¿Ÿä¼šæ›´å¤§ï¼ŒIOå¤šè·¯å¤ç”¨çš„ä¼˜åŠ¿åœ¨äºèƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¿æ¥ï¼Œè€Œä¸æ˜¯å•ä¸ªè¿æ¥çš„å¤„ç†é€Ÿåº¦æ›´å¿«ã€‚\nIOå¤šè·¯å¤ç”¨ä¸‹ä¸€èˆ¬éƒ½å°†socketè®¾ç½®ä¸ºnon-blockingï¼Œè€Œä¸”è¦æ³¨æ„æ­¤æ—¶è¿›ç¨‹è¿˜æ˜¯blockingçš„ åªä¸è¿‡æ˜¯è¢«select/poll/epollè°ƒç”¨blocking,ä¹‹å‰æ˜¯è¢«recvfromè°ƒç”¨blockingï¼Œä½†è¿™ä¸ªblockingçš„ä»£ä»·è¾ƒå°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç®¡ç†æ›´å¤šçš„å¥—æ¥å­—ã€‚\nAsynchronous IO å¼‚æ­¥IO å¼‚æ­¥IOä¸ªäººæ¥è§¦çš„ä¹Ÿä¸å¤šï¼Œä¹Ÿæ˜¯å¤§è‡´äº†è§£æµç¨‹ï¼Œçœ‹ä¸ªå›¾ï¼š\nç”¨æˆ·å‘èµ·å¼‚æ­¥readæ“ä½œåï¼Œkernelç›´æ¥è¿”å›ï¼Œè¿›ç¨‹ä¹Ÿè¯¥å¹²å˜›å¹²å˜›ï¼Œæ²¡æœ‰blocking\nkernelç­‰æ•°æ®readyå copy to userï¼Œç„¶åç»™ç”¨æˆ·è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·(singnal)\nè¿›ç¨‹æ”¶åˆ°ä¿¡å·ï¼Œè°ƒç”¨æ³¨å†Œçš„å¤„ç†å‡½æ•°è¿›è¡Œæ•°æ®è¯»å–\nè²Œä¼¼å¼‚æ­¥IOéå¸¸NBï¼Œä½†å…¶å®linuxå¹¶æ²¡æœ‰å®ç°ä¸€ä¸ªå®Œç¾çš„AIOï¼Œè€Œä¸”å¼‚æ­¥IOå¿…é¡»é¢„å…ˆåˆ†é…ç¼“å­˜ï¼Œè¿™ä¸ªå¯èƒ½é€ æˆå†…å­˜æµªè´¹ï¼Œè¿™éƒ½å¯èƒ½æ˜¯AIOæ²¡æœ‰æµè¡Œçš„åŸå› \nBlockingä¸non-blocking é˜»å¡ä¸éé˜»å¡ é€šå¸¸æ˜¯è¯´è°ƒç”¨æ“ä½œåï¼Œå¦‚ä½•æ•°æ®å°šæœªåˆ°è¾¾ï¼Œæˆ–è€…ä¸å…·å¤‡æ¡ä»¶ï¼Œkernelæ˜¯å¦è¿”å›ï¼Œå¦‚æœç«‹é©¬è¿”å›(ä¸ç®¡æœ‰æ— æ•°æ®)ï¼Œå°±æ˜¯non-blocking,å¦‚æœkernelç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œæ²¡æœ‰ç«‹é©¬è¿”å›ï¼Œé‚£å°±æ˜¯é˜»å¡ Synchronous IOä¸asynchronous IO Posixå®šä¹‰å¦‚ä¸‹ï¼š\nA synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes An asynchronous I/O operation does not cause the requesting process to be blocked å¦‚æœæ‰§è¡ŒIOæ“ä½œ è¿›ç¨‹è¢«blockå°±æ˜¯åŒæ­¥ï¼Œå¦åˆ™å°±æ˜¯å¼‚æ­¥ ä¸Šé¢çš„4ç§IOæ¨¡å¼ï¼Œé™¤äº†æœ€åçš„AIOéƒ½æ˜¯åŒæ­¥IOï¼ŒIOå¤šè·¯å¤ç”¨è™½ç„¶å°†socketè®¾ç½®ä¸ºnon-blocking,ä½†å…¶å®è°ƒç”¨select/poll/epollè¿˜æ˜¯ä¼šblocking\nå‡ ç§IOæ¨¡å¼æ¯”è¾ƒå›¾ åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å•ä»»åŠ¡ listenFd=socket(...);//åˆ›å»ºsocket bind(listenFd,...);//ç»‘å®šç«¯å£ listen(listenFd,...);//å¼€å¯ç›‘å¬ while(1) { // accepté˜»å¡ client_fd = accept(listen_fd);//è¿™é‡Œä¼šé˜»å¡ å¯¼è‡´æ²¡æ³•åŠæ—¶å¤„ç†å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯çš„è¯·æ±‚ if (recv(client_fd)) {//è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ® è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ // logic send(client_fd,...);//å›åŒ… è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ } } // è¿™ç§æ¨¡å¼æ•™å­¦å¯ä»¥ï¼Œå®é™…é¡¹ç›®ä¸­æ²¡æ³•å¤„ç†é«˜å¹¶å‘çš„è¯·æ±‚ åŒæ­¥éé˜»å¡ æœåŠ¡ç«¯å•ä»»åŠ¡ listenFd=socket(...);//åˆ›å»ºsocket setNonblocking(listen_fd) bind(listenFd,...);//ç»‘å®šç«¯å£ listen(listenFd,...);//å¼€å¯ç›‘å¬ while(1) { // accepté˜»å¡ client_fd = accept(listen_fd);//è¿™é‡Œä¼šé˜»å¡ å¯¼è‡´æ²¡æ³•åŠæ—¶å¤„ç†å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯çš„è¯·æ±‚ setNonblocking(client_fd)ï¼›//è®¾ç½®ä¸ºéé˜»å¡ fds.add(client_fd);//åŠ å…¥è½®è¯¢é›†åˆ; for( fd in fds){//å¾ªç¯æ£€æŸ¥ if (recv(client_fd)) {//è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ® è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ // logic send(client_fd,...);//å›åŒ… è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ } } } //å¤„ç†å°é‡å¹¶å‘æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ¯”è¾ƒæµªè´¹cpuï¼Œå› ä¸ºæ¯ä¸€è½®å¾ªç¯éƒ½è¦é’ˆå¯¹æ¯ä¸€ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—æ‰§è¡Œæ£€æŸ¥ //åŒæ—¶å› ä¸ºæ˜¯å•ä»»åŠ¡ï¼Œé‡åˆ°é«˜å¹¶å‘è‚¯å®šä¹Ÿè¦æ­‡èœï¼Œå‡è®¾æœ‰1000ä¸ªclientï¼Œç¬¬ä¸€ä¸ªå‘é€äº†è¯·æ±‚ï¼Œä½†æ˜¯forå¾ªç¯æ£€æŸ¥çš„æ—¶å€™è·³è¿‡äº†ï¼Œç„¶åè¦ç­‰åˆ°å…¶å®ƒ999ä¸ªè¿æ¥éƒ½æ£€æŸ¥å¤„ç†å®Œäº†ï¼Œæ‰èƒ½è½®åˆ°è¿™ä¸ªclientï¼Œå¾ˆæœ‰å¯èƒ½å·²ç»è¶…æ—¶äº† åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡ listenFd=socket(...);//åˆ›å»ºsocket bind(listenFd,...);//ç»‘å®šç«¯å£ listen(listenFd,...);//å¼€å¯ç›‘å¬ while(1) { // accepté˜»å¡ client_fd = accept(listen_fd);//ä¸»è¿›ç¨‹ æˆ–è€…ä¸»çº¿ç¨‹åªè´Ÿè´£acceptæ–°çš„clientè¿æ¥ new ThreadProcess(client_fd){//è¿™é‡Œå¼€å¯å¤šä»»åŠ¡(å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹)ï¼Œä¸€ä¸ªclientä¸€ä¸ªå¤„ç†ä»»åŠ¡çº¿ç¨‹(è¿›ç¨‹) if (recv(fd)) {// // logic process send(client_fd,...);//å›åŒ… } } } //å¹¶å‘é‡ä¸æ˜¯å¾ˆå¤§çš„æ—¶å€™ï¼Œè¿™ç§æ¨¡å¼æ˜¯èƒ½å¤Ÿè‰¯å¥½åº”å¯¹çš„ï¼Œä½†å¦‚æœå¹¶å‘é‡å¾ˆå¤§ï¼Œæ¯”å¦‚ä¸Šä¸‡ï¼Œå¤§é‡çš„çº¿ç¨‹æˆ–è€…è¿›ç¨‹ä¹Ÿä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œè€Œä¸”è¿›ç¨‹åˆ‡æ¢æˆ–è€…çº¿ç¨‹åˆ‡æ¢éƒ½ä¼šæµªè´¹cpuï¼Œå°±ä¼šå¯¼è‡´çœŸæ­£å·¥ä½œçš„ä»»åŠ¡æ¯”ä¾‹å¾€å¾€å¾ˆä½ï¼Œæ‰€ä»¥è¿™ç§æ¨¡å¼é‡åˆ°çœŸæ­£é«˜å¹¶å‘ä¹Ÿä¼šæ­‡èœã€‚ //ç”¨goè¯­è¨€å®ç°ä¸€ä¸ªè¿™æ ·çš„æ¨¡å¼éå¸¸ç®€å• æ¥ä¸€ä¸ªclientå°±å¼€å¯ä¸€ä¸ªroutineå»å¤„ç†å³å¯ IOå¤šè·¯å¤ç”¨â€”select APIåŸå‹ //å°†ä¸€ä¸ªfdä»å…³å¿ƒçš„fdsetä¸­ç§»é™¤ å…¶å®å°±æ˜¯å°†å¯¹åº”çš„å‘ä½ç½®0 void\tFD_CLR(fd, fd_set *fdset); // æ£€æŸ¥fdæ˜¯å¦åœ¨å¯¹åº”çš„fdsetä¸­ ä¹Ÿå°±æ˜¯æ£€æŸ¥å¯¹åº”çš„å‘ä½æ˜¯å¦ä¸º1 int\tFD_ISSET(fd, fd_set *fdset); //å°†fdå¢åŠ åˆ°è¦å…³å¿ƒçš„fdseté›†åˆä¸­ ä¹Ÿå°±æ˜¯å°†å¯¹åº”fdsetå‘ä½ç½®1 æ¯”å¦‚å®¢æˆ·ç«¯socket fdä¸º9ï¼Œå°±æ˜¯å°†fdset[9]è®¾ç½®ä¸º1 void\tFD_SET(fd, fd_set *fdset); // æ¸…ç©ºè¦å…³å¿ƒçš„fdseté›†åˆ å°†fdsetæ•°ç»„å…¨éƒ¨ç½®0 void\tFD_ZERO(fd_set *fdset); //\tnfdsä¸ºæœ€å¤§æ£€æŸ¥æè¿°ç¬¦ selectå°†å¯¹fdsetæ•°ç»„0â€”\u003endfsä¸‹æ ‡åšæ£€æŸ¥ å¦‚æœä¸‹æ ‡å¯¹åº”çš„valueä¸º1 åˆ™éœ€è¦æ£€æŸ¥æè¿°ç¬¦æ˜¯å¦å…·å¤‡æ¡ä»¶äº† ä¸ç”¨1024ä¸ªéƒ½æ£€æŸ¥ï¼Œä¼ å…¥è¿™ä¸ªæœ€å¤§æ£€æŸ¥æè¿°ç¬¦æ˜¯ä¸ºäº†æé«˜selectè½®è¯¢çš„æ•ˆç‡ //readfdsä¸ºå…³å¿ƒè¯»äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ writefdsä¸ºå…³å¿ƒå†™äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ errorfdsä¸ºå…³å¿ƒå¼‚å¸¸äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ //timeoutä¸ºä¸€ä¸ªç»“æ„ä½“ å¦‚ä½•è®¾ç½®ä¸ºnullï¼Œåˆ™å¯¹åº”3ä¸ªfdsetè‹¥éƒ½æ²¡æœ‰å°±ç»ªçš„æè¿°ç¬¦ è¿›ç¨‹å°†ä¸€ç›´blocking //timeoutå¦‚æœè®¾ç½®ä¸º0 åˆ™selectæ£€æŸ¥ä¸€è½®å°†ç›´æ¥è¿”å› ä¸ä¼šç­‰å¾… //timeoutå¦‚æœè®¾ç½®ä¸ºå…·ä½“çš„ç§’+å¾®ç§’ åˆ™selectæœ€å¤šç­‰å¾…è®¾ç½®çš„æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰å°±è¿”å› //åŒæ—¶è¦è¯´æ˜çš„æ˜¯selectæ˜¯è½®è¯¢æ‰€æœ‰è®¾ç½®fdsetä¸­çš„æ‰€æœ‰valueä¸º1çš„æè¿°ç¬¦ï¼Œå¦‚ä½•ç¬¦åˆè¦æ±‚å°±å…¨éƒ¨éƒ½è¿”å› int\tselect(int nfds, fd_set *restrict readfds, fd_set *restrict writefds, fd_set *restrict errorfds, struct timeval *restrict timeout); å…³äº fd_setä¸€èˆ¬æ˜¯ä¸€ä¸ªintç±»å‹æ•°ç»„ ä¸€èˆ¬åˆå§‹åŒ–å¤§å°ä¸º1024 ç”¨æ¥ä¿å­˜å“ªäº›fdéœ€è¦æ£€æŸ¥ï¼Œè¿™ä¸ª1024æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œä½†æ¯”è¾ƒéº»çƒ¦è¿™ä¹Ÿæ˜¯selectä¸è¶³çš„åœ°æ–¹ï¼Œè€Œä¸”èƒ½ç›‘æ§çš„ä¸€èˆ¬æ²¡æœ‰1024ï¼Œå› ä¸ºè¿›ç¨‹æˆ–è€…çº¿ç¨‹ä¸€èˆ¬éƒ½æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯”å¦‚æ ‡å‡†è¾“å…¥è¾“å‡ºå‡ºé”™ï¼Œæˆ–è€…æ‰“å¼€çš„æœ‰æ—¥å¿—æ–‡ä»¶ç­‰ç­‰ã€‚ ä¸è¶³ èƒ½ç›‘æ§çš„æè¿°ç¬¦æ•°é‡æœ‰é™ ä¿®æ”¹èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦ æ¯æ¬¡selectéƒ½éœ€è¦å…¨éƒ¨è®¾ç½®ä¸€ééœ€è¦å…³å¿ƒçš„fdseté›†åˆï¼Œè¿™å°±æ¶‰åŠåˆ°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ‹·è´ æ•ˆç‡ä¸ä¼šå¾ˆé«˜ selectå†…éƒ¨å®ç°æ˜¯è½®è¯¢ï¼Œä¸ç®¡æè¿°ç¬¦å¯¹åº”æ˜¯å¦å°±ç»ªï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿä¸ä¼šå¤ªé«˜ ï¼Œå½“ç„¶å¦‚æœç›‘æ§çš„å¥—æ¥å­—éƒ½éå¸¸æ´»è·ƒï¼Œé‚£è¿™ä¸ªè½®è¯¢æ€§èƒ½é—®é¢˜ä¹Ÿå¯ä»¥å¿½ç•¥(ä½†æ­£æ˜¯å› ä¸ºéƒ½éå¸¸æ´»è·ƒï¼Œæ‰€ä»¥selectè¿”å›åå•ä»»åŠ¡å¤„ç†ä¹Ÿä¼šé‡åˆ°ç“¶é¢ˆï¼Œå› ä¸ºå¤§é‡æ´»è·ƒçš„è¿æ¥ç­‰å¾…å¤„ç†ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªå•ä»»åŠ¡è¿›ç¨‹/çº¿ç¨‹åœ¨å¤„ç†) å…¶å®ƒè¯´æ˜ selectç›‘æ§çš„socketfd è·Ÿsocketfdæœ¬èº«æ˜¯å¦æ˜¯blockingæ²¡æœ‰å…³ç³»ï¼Œæ‰€æœ‰å¥—æ¥å­—æ˜¯é˜»å¡æ—¶çœŸæ­£recvæˆ–è€…writeçš„æ—¶å€™ å¦‚æœæ•°æ®ä¸å…·å¤‡æ¡ä»¶åˆ™å†…æ ¸ç›´æ¥è¿”å›æˆ–è€…é˜»å¡ç­‰å¾…ï¼Œselelctåªæ˜¯æ£€æŸ¥æ•°æ®æ˜¯å¦å…·å¤‡è¯»æ¡ä»¶äº†ï¼Œæ²¡æœ‰å‘ç”ŸçœŸæ­£è¯»å†™ï¼Œè€Œä¸”æ˜¯å†…æ ¸ç›´æ¥åˆ¤æ–­è¯»å†™ç¼“å†²åŒºæ˜¯å¦ç¬¦åˆæ¡ä»¶çš„ ä½†ä¸èƒ½è¯´è°ƒç”¨selectçš„è¿›ç¨‹æ˜¯ä¸é˜»å¡çš„ï¼Œç†è®ºä¸Šè°ƒç”¨äº†selectä¹Ÿæ˜¯ä¸€ç›´é˜»å¡çš„ï¼Œåªæ˜¯é˜»å¡æ—¶é—´çš„é•¿çŸ­(timeoutè®¾ç½®ä¸º0 åªè½®è¯¢ä¸€æ¬¡å°±è¿”å›ï¼Œå¦‚æœä¸ºnullï¼Œæ— é™ç­‰å¾…ç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªå¥—æ¥å­—ç¬¦åˆæ¡ä»¶ï¼Œå¦‚æœè®¾ç½®ä¸ºå…·ä½“æ—¶é—´ï¼Œåˆ™æœ€å¤šç­‰å¾…è¿™ä¸ªè®¾ç½®æ—¶é—´)ï¼Œåªæ˜¯è¿›ç¨‹ä¸æ˜¯å› ä¸ºè°ƒç”¨recvæˆ–è€…writeé˜»å¡ï¼Œè€Œæ˜¯è°ƒç”¨selecté˜»å¡ï¼Œè€Œä¸”è¿”å›çš„å¯ä»¥æ˜¯å¤šä¸ªç¬¦åˆè¯»å†™çš„fdã€‚ ä»£ç  selectç¤ºä¾‹ä»£ç è½¬è½½åŠ æ³¨é‡Šï¼Œç®€å•ä¼˜åŒ–c ```c #include #include #include #include #include #include #include #include #include #include #include #include #define IPADDR \"127.0.0.1\" #define PORT 8787 #define MAXLINE 1024 #define LISTENQ 5 #define MAXCLIENTSIZE 10 //å½“å‰å¥—æ¥å­—è¿æ¥ä¿¡æ¯ç»“æ„ä½“ typedef struct server_context_st { int cli_cnt; /*å·²è¿æ¥è¿‡çš„å®¢æˆ·ç«¯ä¸ªæ•°*/ int clifds[MAXCLIENTSIZE]; /*å®¢æˆ·ç«¯å¥—æ¥å­—é›†åˆ*/ fd_set allfds; /*å¥æŸ„é›†åˆ*/ int maxfd; /*å¥æŸ„æœ€å¤§å€¼*/ } server_context_st; static server_context_st *s_srv_ctx = NULL; /*=========================================================================== createSocketAndListen æ ¹æ®ä¼ å…¥å­—ç¬¦ä¸²æ ¼å¼ipå’Œç«¯å£portï¼Œåˆ›å»ºsocketå¹¶ä¸”å¼€å¯ç›‘å¬ * ==========================================================================*/ static int createSocketAndListen(const char* ip,int port){ int fd; struct sockaddr_in servaddr; //int socket(int domain, int type, int protocol); fd = socket(AF_INET, SOCK_STREAM,0); if (fd == -1) { fprintf(stderr, \"create socket fail,erron:%d,reason:%s\\n\", errno, strerror(errno)); return -1; } /*ä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸€æ®µæ—¶é—´å(æ¯”å¦‚ä¸¤åˆ†é’Ÿ)æ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚*/ int reuse = 1; if (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, \u0026reuse, sizeof(reuse)) == -1) { return -1; } //å¥—æ¥å­—ç»“æ„ä½“åˆå§‹åŒ–ä¸º0 bzero(\u0026servaddr,sizeof(servaddr)); servaddr.sin_family = AF_INET; //ip ASCIIå­—ç¬¦ä¸²è½¬ä¸ºäºŒè¿›åˆ¶ inet_pton(AF_INET,ip,\u0026servaddr.sin_addr); //portè½¬ä¸ºç½‘ç»œå­—èŠ‚åº servaddr.sin_port = htons(port); //å¥—æ¥å­—ç»‘å®šipå’Œç«¯å£ if (bind(fd,(struct sockaddr*)\u0026servaddr,sizeof(servaddr)) == -1) { perror(\"bind error: \"); return -1; } //å¼€å¯ç›‘å¬ if ( listen(fd,LISTENQ) == -1){ perror(\"listen error: \"); return -1; } return fd; } /*=========================================================================== accept_client_proc ä¼ å…¥æœåŠ¡ç«¯ç›‘å¬å¥—æ¥å­—ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ * ==========================================================================*/ static int accept_client_proc(int srvfd) { struct sockaddr_in cliaddr; socklen_t cliaddrlen; cliaddrlen = sizeof(cliaddr); int clifd = -1; printf(\"accpet clint proc is called.\\n\"); ACCEPT: clifd = accept(srvfd,(struct sockaddr*)\u0026cliaddr,\u0026cliaddrlen); if (clifd == -1) { if (errno == EINTR) { goto ACCEPT; } else { fprintf(stderr, \"accept fail,error:%s\\n\", strerror(errno)); return -1; } } //æ‰“å°å®¢æˆ·ç«¯å¥—æ¥å­—ä¿¡æ¯ fprintf(stdout, \"accept a new client: %s:%d\\n\", inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port); //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­ int i = 0; for (i = 0; i \u003c MAXCLIENTSIZE; i++) { if (s_srv_ctx-\u003eclifds[i] \u003c 0) { s_srv_ctx-\u003eclifds[i] = clifd; s_srv_ctx-\u003ecli_cnt++; break; } } //å·²ç»è¾¾åˆ°æœ€å¤§è¿æ¥æ•° æ‰“å°é”™è¯¯æ—¥å¿—æŠ¥é”™è¿”å› if (i == MAXCLIENTSIZE) { fprintf(stderr,\"too many clients.\\n\"); return -1; } return 0; } /*=========================================================================== handle_client_msg ä¼ å…¥å®¢æˆ·ç«¯å¥—æ¥å­—å’Œç¼“å­˜ å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯ å®ç°å›å°„ * ==========================================================================*/ static int handle_client_msg(int fd, char *buf) { assert(buf); printf(\"recv buf is :%s\\n\", buf);//æ‰“å°å®¢æˆ·ç«¯æ¶ˆæ¯ if ( write(fd, buf, strlen(buf) +1) \u003c0){ perror(\"write to client error\"); return -1; }//å¹¶åŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯ return 0; } /*=========================================================================== recv_client_msg ä¼ å…¥fdsetæŒ‡é’ˆ å¤„ç†å¯è¯»çš„å®¢æˆ·ç«¯å¥—æ¥å­— * ==========================================================================*/ static void recv_client_msg(fd_set *readfds) { int i = 0, n = 0; int clifd; char buf[MAXLINE] = {0}; for (i = 0;i \u003c= s_srv_ctx-\u003ecli_cnt;i++) { clifd = s_srv_ctx-\u003eclifds[i]; if (clifd \u003c 0) { continue; } /*åˆ¤æ–­å®¢æˆ·ç«¯å¥—æ¥å­—æ˜¯å¦æœ‰æ•°æ®*/ if (FD_ISSET(clifd, readfds)) { //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ n = read(clifd, buf, MAXLINE); if (n \u003c= 0) { /*n==0è¡¨ç¤ºè¯»å–å®Œæˆï¼Œå®¢æˆ·éƒ½å…³é—­å¥—æ¥å­—*/ FD_CLR(clifd, \u0026s_srv_ctx-\u003eallfds); close(clifd); s_srv_ctx-\u003eclifds[i] = -1; continue; } //å›ä¼ ç»™å®¢æˆ·ç«¯ handle_client_msg(clifd, buf); } } } /*=========================================================================== handle_client_proc ä¸»å¤„ç†å‡½æ•° ä¼ å…¥ç›‘å¬å¥—æ¥å­— æ¥å—å®¢æˆ·ç«¯è¿æ¥ é€ä¸ªå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ * ==========================================================================*/ static void handle_client_proc(int srvfd) { int clifd = -1; int retval = 0; fd_set *readfds = \u0026s_srv_ctx-\u003eallfds; struct timeval tv; int i = 0; while (1) { /*æ¯æ¬¡è°ƒç”¨selectå‰éƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´ï¼Œå› ä¸ºäº‹ä»¶å‘ç”Ÿåï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´éƒ½è¢«å†…æ ¸ä¿®æ”¹å•¦ è¿™ä¸ªä¹Ÿæ˜¯ä½¿ç”¨selectçš„ç¼ºç‚¹*/ FD_ZERO(readfds); /*æ·»åŠ ç›‘å¬å¥—æ¥å­—*/ FD_SET(srvfd, readfds); s_srv_ctx-\u003emaxfd = srvfd; tv.tv_sec = 30;//è¶…æ—¶æ—¶é—´30ç§’ tv.tv_usec = 0; /*æ·»åŠ å®¢æˆ·ç«¯å¥—æ¥å­—*/ for (i = 0; i \u003c s_srv_ctx-\u003ecli_cnt; i++) { clifd = s_srv_ctx-\u003eclifds[i]; /*å»é™¤æ— æ•ˆçš„å®¢æˆ·ç«¯å¥æŸ„ æ¯”å¦‚å®¢æˆ·ç«¯å·²ç»close*/ if (clifd != -1) { FD_SET(clifd, readfds); } //è®¡ç®—æœ€å¤§fd s_srv_ctx-\u003emaxfd = (clifd \u003e s_srv_ctx-\u003emaxfd ? clifd : s_srv_ctx-\u003emaxfd); } /*å¼€å§‹è½®è¯¢æ¥æ”¶å¤„ç†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—*/ retval = select(s_srv_ctx-\u003emaxfd + 1, readfds, NULL, NULL, \u0026tv); if (retval == -1) { fprintf(stderr, \"select error:%s.\\n\", strerror(errno)); return; } if (retval == 0) { fprintf(stdout, \"select is timeout.\\n\"); continue; } if (FD_ISSET(srvfd, readfds)) { /*ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/ accept_client_proc(srvfd); } else { /*æ¥å—å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯*/ recv_client_msg(readfds); } } } /*=========================================================================== server_uninit ç¨‹åºé€€å‡ºå‰ç›¸å…³å·¥ä½œå¤„ç† * ==========================================================================*/ static void server_uninit() { if (s_srv_ctx) { free(s_srv_ctx); s_srv_ctx = NULL; } } /*=========================================================================== server_init æœåŠ¡å™¨åˆå§‹åŒ–ä¸»è¦æ˜¯åˆå§‹åŒ–å¥—æ¥å­—ç®¡ç†ç»“æ„ä½“ * ==========================================================================*/ static int server_init() { //ç”³è¯·å†…å­˜ s_srv_ctx = (server_context_st *)malloc(sizeof(server_context_st)); if (s_srv_ctx == NULL) { return -1; } //memsetåˆå§‹åŒ– memset(s_srv_ctx, 0, sizeof(server_context_st)); //åˆå§‹åŒ–å®¢æˆ·ç«¯å¥—æ¥å­—å…·æŸ„ä¸º-1 int i = 0;//æœ€å¤§å¤„ç†å®¢æˆ·ç«¯ä¸ºMAXCLIENTSIZE for (;i \u003c MAXCLIENTSIZE; i++) { s_srv_ctx-\u003eclifds[i] = -1; } return 0; } //mainå‡½æ•° int main(int argc,char *argv[]) { int srvfd; /*åˆå§‹åŒ–æœåŠ¡ç«¯context*/ if (server_init() \u003c 0) { return -1; } /*åˆ›å»ºæœåŠ¡,å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/ srvfd = createSocketAndListen(IPADDR, PORT); if (srvfd \u003c 0) { fprintf(stderr, \"socket create or bind fail.\\n\"); goto err; } /*å¼€å§‹æ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ è¿›å…¥ä¸»å‡½æ•°å¤„ç†*/ handle_client_proc(srvfd); //å‡†å¤‡é€€å‡º é€€å‡ºå‰å·¥ä½œå¤„ç† server_uninit(); return 0; err: server_uninit(); return -1; } ``` IOå¤šè·¯å¤ç”¨â€”poll APIåŸå‹ # include int poll ( struct pollfd * fds, unsigned int nfds, int timeout); struct pollfd { int fd; /* è¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ å¦‚æœä¸ºè´Ÿå€¼ å†…æ ¸ä¼šç›´æ¥å¿½ç•¥ å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸º-1 è®©å†…æ ¸ä¸å†ç›‘æ§*/ short events; /* æœŸå¾…ç­‰å¾…çš„äº‹ä»¶ */ short revents; /* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */ } ; pollè·Ÿselectæ•´ä½“æœºåˆ¶æ˜¯ä¸€æ ·çš„ ä¹Ÿæ˜¯ä¼ å…¥éœ€è¦ç›‘æ§çš„fdé›†åˆ ç„¶åè½®è¯¢ åªæ˜¯æ•°æ®ç»“æ„ä¸æ˜¯ç”¨intæ•°ç»„ï¼Œè€Œæ˜¯æ”¹ä¸ºpollfdç»“æ„ä½“æ•°ç»„ï¼Œæ‰€ä»¥æ²¡æœ‰äº†å¤§å°æ•°é‡é™åˆ¶ï¼Œå¯¹äºæ¯ä¸ªå…³å¿ƒçš„æè¿°ç¬¦å¯ä»¥æ›´çµæ´»çš„è®¾ç½®æœŸå¾…æ—¶é—´ ä»£ç ä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»\nç¬¬ä¸€ä¸ªå‚æ•°fdsä¸ºéœ€è¦ç›‘æ§çš„fdä¿¡æ¯ç»“æ„ä½“æ•°ç»„æŒ‡é’ˆ æ¯æ¬¡pollä¹‹å‰éƒ½å¯ä»¥åŠ¨æ€çš„æ·»åŠ æˆ–è€…ç§»é™¤(é€šå¸¸ç›´æ¥è®¾ç½®å¯¹åº”çš„fdä¸º-1)\nnfdsä¸ºç¬¬ä¸€ä¸ªå‚æ•°fdsçš„sizeä¹Ÿå°±æ˜¯éœ€è¦ç›‘æ§çš„fdçš„ä¸ªæ•°\ntimeoutä¸ºè¶…æ—¶æ—¶é—´\nIf timeout is greater than zero, it specifies a maximum interval (in milliseconds) to wait for any file descriptor to\nbecome ready. \u003e0 å•ä½æ¯«ç§’ å†…æ ¸æœ€å¤šç­‰å¾…timeoutæ¯«ç§’\nIf timeout is zero, then poll() will return without blocking. =0 å¦‚æœæ²¡æœ‰æè¿°ç¬¦å°±ä½ï¼Œç›´æ¥è¿”å›ä¸é˜»å¡ï¼Œå¦‚æœæœ‰å°±ä½çš„å°±ä¼šç«‹é©¬è¿”å›\nIf the value of timeout is -1, the poll blocks indefinitely å¦‚æœæ˜¯-1ï¼Œåˆ™ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è‡³å°‘ä¸€ä¸ªæè¿°ç¬¦æœŸå¾…çš„äº‹ä»¶å‘ç”Ÿ\npollfdå¯¹åº”çš„eventså’Œreventså–å€¼è§£é‡Š\nevents revents äº‹ä»¶ æè¿° å¯ä½œä¸ºè¾“å…¥ å¯ä½œä¸ºè¾“å‡º POLLIN æ•°æ®å¯è¯»ï¼ˆåŒ…æ‹¬æ™®é€šæ•°æ®\u0026ä¼˜å…ˆæ•°æ®ï¼‰ æ˜¯ æ˜¯ POLLOUT æ•°æ®å¯å†™ï¼ˆæ™®é€šæ•°æ®\u0026ä¼˜å…ˆæ•°æ®ï¼‰ æ˜¯ æ˜¯ POLLRDNORM æ™®é€šæ•°æ®å¯è¯» æ˜¯ æ˜¯ POLLRDBAND ä¼˜å…ˆçº§å¸¦æ•°æ®å¯è¯»ï¼ˆlinuxä¸æ”¯æŒï¼‰ æ˜¯ æ˜¯ POLLPRI é«˜ä¼˜å…ˆçº§æ•°æ®å¯è¯»ï¼Œæ¯”å¦‚TCPå¸¦å¤–æ•°æ® æ˜¯ æ˜¯ POLLWRNORM æ™®é€šæ•°æ®å¯å†™ æ˜¯ æ˜¯ POLLWRBAND ä¼˜å…ˆçº§å¸¦æ•°æ®å¯å†™ æ˜¯ æ˜¯ POLLRDHUP TCPè¿æ¥è¢«å¯¹ç«¯å…³é—­ï¼Œæˆ–è€…å…³é—­äº†å†™æ“ä½œï¼Œç”±GNUå¼•å…¥ æ˜¯ æ˜¯ POPPHUP æŒ‚èµ· å¦ æ˜¯ POLLERR é”™è¯¯ å¦ æ˜¯ POLLNVAL æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰æ‰“å¼€ å¦ æ˜¯ å¯èƒ½çš„è¿”å›ç \næ­£å¸¸è¿”å›fdsæ•°ç»„ä¸­reventsä¸ä¸º0çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•° å¦‚æœè¶…æ—¶ä¹‹å‰æ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿ åˆ™pollè¿”å›0 å¤±è´¥æ—¶ pollè¿”å›-1 errnoè®¾ç½®å¦‚ä¸‹ï¼š ä¸åŒosè¿”å›ç å¯èƒ½ä¸ä¸€è‡´ å¯ä»¥manä¸‹ EBADFã€€ä¸€ä¸ªæˆ–å¤šä¸ªç»“æ„ä½“ä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆ EFAULTã€€æŒ‡é’ˆæŒ‡å‘çš„åœ°å€è¶…å‡ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ EINTRã€€è¯·æ±‚çš„äº‹ä»¶ä¹‹å‰äº§ç”Ÿä¸€ä¸ªä¿¡å·ï¼Œè°ƒç”¨å¯ä»¥é‡æ–°å‘èµ· EINVALã€€å‚æ•°è¶…å‡ºPLIMIT_NOFILEå€¼ ENOMEMã€€å¯ç”¨å†…å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆè¯·æ±‚ ä¸è¶³åŠæ”¹è¿› ç›¸æ¯”select æ²¡æœ‰äº†æ•°é‡çš„é™åˆ¶ æ­¤ä¸ºæ”¹è¿› æ¯æ¬¡poll fdæ•°ç»„éƒ½è¦ç»è¿‡ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ æ€§èƒ½è¿˜æ˜¯ä¼šå—å½±å“ è¿˜æ˜¯è½®è¯¢æœºåˆ¶ ç›‘æ§çš„fdæ•°é‡å¦‚æœå¤ªå¤š ä¸è®ºæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ª å¼€é”€éšç€ç›‘æ§æ•°é‡å¢åŠ è€Œçº¿æ€§å¢å¤§ ä»£ç  pollç¤ºä¾‹ä»£ç _è½¬è½½æ•´ç†åŠ æ³¨é‡Šã€ç®€å•ä¼˜åŒ– C ```c #include #include #include #include #include #include #include #include #include #include #define IPADDRESS \"127.0.0.1\" #define PORT 8787 #define MAXLINE 1024 #define LISTENQ 5 #define OPEN_MAX 1000 #define INFTIM -1 //å‡½æ•°å£°æ˜ //åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®šç„¶åå¯åŠ¨ç›‘å¬ static int createSocketAndListen(const char* ip,int port); //IOå¤šè·¯å¤ç”¨poll static void do_poll(int listenfd); //å¤„ç†å¤šä¸ªè¿æ¥ static void handle_connection(struct pollfd *connfds,int num); int main(int argc,char *argv[]) { int listenfd,connfd,sockfd; struct sockaddr_in cliaddr; socklen_t cliaddrlen; listenfd = createSocketAndListen(IPADDRESS,PORT); do_poll(listenfd); return 0; } /*=========================================================================== createSocketAndListen æ ¹æ®ä¼ å…¥å­—ç¬¦ä¸²æ ¼å¼ipå’Œç«¯å£portï¼Œåˆ›å»ºsocketå¹¶ä¸”å¼€å¯ç›‘å¬ * ==========================================================================*/ static int createSocketAndListen(const char* ip,int port) { int listenfd; struct sockaddr_in servaddr; listenfd = socket(AF_INET,SOCK_STREAM,0); if (listenfd == -1) { perror(\"socket error:\"); exit(1); } bzero(\u0026servaddr,sizeof(servaddr)); servaddr.sin_family = AF_INET; inet_pton(AF_INET,ip,\u0026servaddr.sin_addr); servaddr.sin_port = htons(port); if (bind(listenfd,(struct sockaddr*)\u0026servaddr,sizeof(servaddr)) == -1) { perror(\"bind error: \"); exit(1); } //å¼€å¯ç›‘å¬ if ( listen(listenfd,LISTENQ) == -1){ perror(\"listen error: \"); exit(1); } return listenfd; } /*=========================================================================== do_poll ä¼ å…¥ç›‘å¬ç›‘å¬å¥—æ¥å­— æ‰§è¡Œä¸»æµç¨‹ * ==========================================================================*/ static void do_poll(int listenfd) { int connfd,sockfd; struct sockaddr_in cliaddr; socklen_t cliaddrlen; struct pollfd clientfds[OPEN_MAX];//å¸¸è§pollfdæ•°ç»„ int maxi;//éœ€è¦ç›‘æ§fdæ•°ç»„ä¸­æœ€å¤§ä¸ä¸º-1çš„ä¸‹æ ‡ä½ç½® å¯ä»¥è®¡ç®—å‡ºæ¥å½“å‰çœŸæ­£éœ€è¦ç›‘æ§çš„fdæ•°é‡ int i; int nready; //æ·»åŠ ç›‘å¬æè¿°ç¬¦ clientfds[0].fd = listenfd;//ç¬¬ä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸ºç›‘å¬å¥—æ¥å­— clientfds[0].events = POLLIN;//æœŸå¾…è¯»äº‹ä»¶ //åˆå§‹åŒ–å®¢æˆ·è¿æ¥æè¿°ç¬¦ for (i = 1;i \u003c OPEN_MAX;i++) clientfds[i].fd = -1; maxi = 0; //å¾ªç¯å¤„ç† for ( ; ; ) { //è·å–å¯ç”¨æè¿°ç¬¦çš„ä¸ªæ•° nready = poll(clientfds,maxi+1,INFTIM); if (nready == -1) { perror(\"poll error:\"); exit(1); } //æµ‹è¯•ç›‘å¬æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½ if (clientfds[0].revents \u0026 POLLIN) { cliaddrlen = sizeof(cliaddr); //æ¥å—æ–°çš„è¿æ¥ if ((connfd = accept(listenfd,(struct sockaddr*)\u0026cliaddr,\u0026cliaddrlen)) == -1) { if (errno == EINTR) continue; else { perror(\"accept error:\"); exit(1); } } fprintf(stdout,\"accept a new client: %s:%d\\n\", inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port); //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­ æ‰¾åˆ°fdæ•°ç»„å¯ä»¥æ’å…¥çš„ä½ç½® æ˜¯-1å°±å¯ä»¥æ’å…¥ è€Œä¸”æ˜¯ä¸‹æ ‡ä»å°åˆ°è¾¾å¼€å§‹æŸ¥æ‰¾ for (i = 1;i \u003c OPEN_MAX;i++) { if (clientfds[i].fd \u003c 0)//é¡ºåºæŸ¥æ‰¾å“ªä¸ªæ§½ä½å¯ä»¥ä½¿ç”¨ åˆšå¼€å§‹åªæœ‰ç¬¬ä¸€ä¸ªä¸ä¸º-1 { clientfds[i].fd = connfd;//åŠ è¿›pollfdæ•°ç»„ break; } } if (i == OPEN_MAX)//è¿™é‡Œåªæ˜¯ä¸ºäº†æµ‹è¯• è¶…è¿‡è¿™ä¸ªæ•°é‡çš„å®¢æˆ·ç«¯ ç¨‹åºæŠ¥é”™é€€å‡º { fprintf(stderr,\"too many clients.\\n\"); exit(1); } //å°†æ–°çš„æè¿°ç¬¦æ·»åŠ åˆ°è¯»æè¿°ç¬¦é›†åˆä¸­ clientfds[i].events = POLLIN; //è®°å½•å®¢æˆ·è¿æ¥å¥—æ¥å­—çš„ä¸ªæ•° maxi = (i \u003e maxi ? i : maxi); if (--nready \u003c= 0)//å¦‚æœé™¤äº†ç›‘å¬å¥—æ¥å­—æ²¡æœ‰å°±ç»ªçš„äº‹ä»¶ é‚£å°±continueç»§ç»­ä¸‹æ¬¡pollè½®è¯¢ continue; } //å¤„ç†å®¢æˆ·è¿æ¥ handle_connection(clientfds,maxi); } } /*=========================================================================== handle_connection ä¼ å…¥pollè¿”å›çš„fdæ•°ç»„ é€ä¸ªå¤„ç†å°±ç»ªçš„å®¢æˆ·ç«¯å¥—æ¥å­— * ==========================================================================*/ static void handle_connection(struct pollfd *connfds,int num) { int i,n; char buf[MAXLINE]; memset(buf,0,MAXLINE); for (i = 1;i \u003c= num;i++) { if (connfds[i].fd \u003c 0) continue; //æµ‹è¯•å®¢æˆ·æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½ if (connfds[i].revents \u0026 POLLIN) { //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ n = read(connfds[i].fd,buf,MAXLINE); if (n == 0) { close(connfds[i].fd); connfds[i].fd = -1;//å¦‚æœå®¢æˆ·ç«¯å…³é—­äº†å¥—æ¥å­— ä»ç›‘æ§å¥—æ¥å­—æ•°ç»„ä¸­ç§»é™¤ continue; } // printf(\"read msg is: \"); write(STDOUT_FILENO,buf,n); //å‘å®¢æˆ·ç«¯å‘é€buf write(connfds[i].fd,buf,n); } } } ``` IOå¤šè·¯å¤ç”¨â€”epoll APIåŸå‹ #include int epoll_create(int size); int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout); struct epoll_event { __uint32_t events; /* Epoll events */ epoll_data_t data; /* User data variable */ }; eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆï¼š EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ï¼› EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼› EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼› EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼› EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼› EPOLLETï¼š å°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ã€‚ EPOLLONESHOTï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ epoll_create\nåˆ›å»ºä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦ï¼Œsizeæ˜¯è¦å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬å¥—æ¥å­—çš„æ•°é‡ï¼Œåˆ›å»ºå¥½epollå¥æŸ„åï¼Œå°±ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxç³»ç»Ÿä»¥ä¸‹ç›®å½•/proc/pid/fdæ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼Œæ‰€ä»¥epollç»“æŸ å¥½ä¹ æƒ¯ä¹Ÿè¦closeæ‰ epoll_ctl\nctlå°±æ˜¯controlæ§åˆ¶çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªäº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œepfdä¸ºepoll_createå‡½æ•°è¿”å›çš„epollå¥æŸ„ ç¬¬äºŒä¸ªå‚æ•°opä¸ºæ“ä½œç±»å‹ æœ‰ä»¥ä¸‹ä¸‰ä¸ª EPOLL_CTL_ADDï¼šæ³¨å†Œæ–°çš„fdåˆ°epfdä¸­ EPOLL_CTL_MODï¼šä¿®æ”¹å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶ EPOLL_CTL_DELï¼šä»epfdä¸­åˆ é™¤ä¸€ä¸ªfd ç¬¬ä¸‰ä¸ªå‚æ•°fdä¸ºéœ€è¦ç›‘å¬çš„å¥—æ¥å­—å¥æŸ„ ç¬¬å››ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å†…æ ¸é’ˆå¯¹fdè¦ç›‘å¬ä»€ä¹ˆäº‹ä»¶ eventsæšä¸¾ä¸Šé¢æœ‰åˆ—å‡ºæ¥ epoll_wait\nç±»ä¼¼selectã€pollè°ƒç”¨åå­—ä¹Ÿæœ‰waitï¼Œå°±æ˜¯ç­‰å¾…äº‹ä»¶äº§ç”Ÿ ç¬¬ä¸€ä¸ªå‚æ•°epfdä¸ºepoll_createè¿”å›çš„epollå¥æŸ„ ç¬¬äºŒä¸ªå‚æ•°eventsç”¨æ¥ä»å†…æ ¸å¾—åˆ°äº‹ä»¶é›†åˆï¼Œå†…æ ¸ä¼šå°†å°±ç»ªçš„æè¿°ç¬¦åŠå‘ç”Ÿçš„äº‹ä»¶å†™åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­ ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‘ŠçŸ¥å†…æ ¸ è¿™ä¸ªåˆ—è¡¨æœ‰å¤šå¤§ï¼Œä¸èƒ½å¤§äºè°ƒç”¨epoll_create(int size)ä¼ å…¥çš„size ç¬¬å››ä¸ªå‚æ•°è¶…æ—¶æ—¶é—´ å•ä½æ¯«ç§’ ï¼š timeout\u003e0 å¦‚æœæ²¡æœ‰å¥—æ¥å­—å°±ç»ª å†…æ ¸æœ€å¤šç­‰åˆ°timeoutæ¯«ç§’ timeout=0 å¦‚æœæ²¡æœ‰å¥—æ¥å­—å°±ç»ª å†…æ ¸ç›´æ¥è¿”å› ä¸é˜»å¡ timeout=-1 ä¼šä¸€ç›´é˜»å¡ ç›´åˆ°æœ‰å¥—æ¥å­—å°±ç»ª epollä¸¤è€…å·¥ä½œæ¨¡å¼\nLT(level trigger) æ°´å¹³è§¦å‘æ¨¡å¼\nepoll_waitæ£€æµ‹åˆ°fdäº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸ç«‹å³å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitä¼šå†æ¬¡å‘ŠçŸ¥åº”ç”¨ç¨‹åº\nET(edge trigger) è¾¹ç¼˜è§¦å‘æ¨¡å¼\nå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶\nETæ¨¡å¼å¾ˆå¤§ç¨‹åº¦å‡å°‘äº†epolläº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œç›¸å¯¹äºLTæ•ˆç‡æ›´é«˜ï¼Œåœ¨ETæ¨¡å¼ä¸‹ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å­—ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªå¥—æ¥å­—é˜»å¡è¯»å†™å¯¼è‡´æ•´ä¸ªå¤„ç†å¤šå¥—æ¥å­—çš„ä»»åŠ¡ææ­»ã€‚ æ”¹è¿›ã€ä¸è¶³ ç›¸å¯¹äºselectæ²¡æœ‰æ•°é‡é™åˆ¶ ç›¸å¯¹äºselectã€poll å¯¹äºç›‘æ§çš„æè¿°ç¬¦é›†åˆ ä¸ç”¨æ¯æ¬¡éƒ½ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œåªæ˜¯åœ¨epoll_ctlæ·»åŠ çš„æ—¶å€™æ‹·è´ä¸€æ¬¡ epoll_waitä¸æ˜¯è½®è¯¢æœºåˆ¶ è€Œæ˜¯é‡‡ç”¨å›è°ƒå‡½æ•°çš„æœºåˆ¶ æ‰€ä»¥æ•ˆç‡æ›´é«˜ epollç›®å‰åªæœ‰linuxæœ‰ æ˜¯ä»linuxå†…æ ¸2.6å¼€å§‹æå‡ºçš„ ä¸è¿‡windowså’ŒMac(bsd)ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç° ä»£ç  epollç¤ºä¾‹ä»£ç  è½¬è½½åŠ æ³¨é‡Š ç®€å•ä¼˜åŒ– C ```c #include #include #include #include #include #include #include #include #include #include #define IPADDRESS \"127.0.0.1\" #define PORT 8787 #define MAXSIZE 1024 #define LISTENQ 5 #define FDSIZE 1000 #define EPOLLEVENTS 100 //å‡½æ•°å£°æ˜ //åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š static int socket_bind(const char* ip,int port); //IOå¤šè·¯å¤ç”¨epoll static void do_epoll(int listenfd); //äº‹ä»¶å¤„ç†å‡½æ•° static void handle_events(int epollfd,struct epoll_event *events,int num,int listenfd); //å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥ static void handle_accpet(int epollfd,int listenfd); //è¯»å¤„ç† static void handle_connection(int epollfd,int fd); //å†™å¤„ç† static void sendToClient(int epollfd,int fd,char *buf); //æ·»åŠ äº‹ä»¶ static void add_event(int epollfd,int fd,int state); //ä¿®æ”¹äº‹ä»¶ static void modify_event(int epollfd,int fd,int state); //åˆ é™¤äº‹ä»¶ static void delete_event(int epollfd,int fd,int state); int main(int argc,char *argv[]) { int listenfd; listenfd = socket_bind(IPADDRESS,PORT); listen(listenfd,LISTENQ); do_epoll(listenfd); return 0; } /*=========================================================================== socket_bind åˆ›å»ºç›‘å¬å¥—æ¥å­— * ==========================================================================*/ static int socket_bind(const char* ip,int port) { int listenfd; struct sockaddr_in servaddr; listenfd = socket(AF_INET,SOCK_STREAM,0); if (listenfd == -1) { perror(\"socket error:\"); exit(1); } /*ä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸€æ®µæ—¶é—´å(æ¯”å¦‚ä¸¤åˆ†é’Ÿ)æ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚*/ int reuse = 1; if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, \u0026reuse, sizeof(reuse)) == -1) { return -1; } bzero(\u0026servaddr,sizeof(servaddr)); servaddr.sin_family = AF_INET; inet_pton(AF_INET,ip,\u0026servaddr.sin_addr); servaddr.sin_port = htons(port); if (bind(listenfd,(struct sockaddr*)\u0026servaddr,sizeof(servaddr)) == -1) { perror(\"bind error: \"); exit(1); } return listenfd; } /*=========================================================================== epollå¤„ç†ä¸»å‡½æ•° éœ€è¦ä¼ å…¥ç›‘å¬å¥—æ¥å­— * ==========================================================================*/ static void do_epoll(int listenfd) { int epollfd; struct epoll_event events[EPOLLEVENTS]; int ret; //åˆ›å»ºä¸€ä¸ªæè¿°ç¬¦ epollfd = epoll_create(FDSIZE); //æ·»åŠ ç›‘å¬æè¿°ç¬¦äº‹ä»¶ add_event(epollfd,listenfd,EPOLLIN); for ( ; ; ) { //è·å–å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦äº‹ä»¶ ret = epoll_wait(epollfd,events,EPOLLEVENTS,-1); handle_events(epollfd,events,ret,listenfd); } close(epollfd); } /*=========================================================================== handle_events epoll_wait è¿”å›åé’ˆå¯¹å°±ç»ªå¥—æ¥å­— é€ä¸ªå¤„ç† * ==========================================================================*/ static void handle_events(int epollfd,struct epoll_event *events,int num,int listenfd) { int i; int fd; //å¯¹å†…æ ¸è¿”å›å°±ç»ªçš„eventsåˆ—è¡¨ éå†å¤„ç† for (i = 0;i \u003c num;i++) { fd = events[i].data.fd; //æ ¹æ®æè¿°ç¬¦çš„ç±»å‹å’Œäº‹ä»¶ç±»å‹è¿›è¡Œå¤„ç† if ((fd == listenfd) \u0026\u0026(events[i].events \u0026 EPOLLIN))//ç›‘å¬å¥—æ¥å­— éœ€è¦acceptåŒæ—¶å°†è¿æ¥å¥½çš„clientfdåŠ å…¥epollfd handle_accpet(epollfd,listenfd); else if (events[i].events \u0026 EPOLLIN)//è¯»äº‹ä»¶ handle_connection(epollfd,fd); else{ perror(\"éacceptå¯è¯»ã€éclinetå¯è¯»\"); } } } /*=========================================================================== handle_accpet ç›‘å¬å¥—æ¥å­— éœ€è¦acceptåŒæ—¶å°†è¿æ¥å¥½çš„clientfdåŠ å…¥epollfd * ==========================================================================*/ static void handle_accpet(int epollfd,int listenfd) { int clifd; struct sockaddr_in cliaddr; socklen_t cliaddrlen; clifd = accept(listenfd,(struct sockaddr*)\u0026cliaddr,\u0026cliaddrlen); if (clifd == -1) perror(\"accpet error:\"); else { printf(\"accept a new client: %s:%d\\n\",inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port); //æ·»åŠ ä¸€ä¸ªå®¢æˆ·æè¿°ç¬¦å’Œäº‹ä»¶ add_event(epollfd,clifd,EPOLLIN); } } /*=========================================================================== do_read å¤„ç†è¯»äº‹ä»¶å°±ç»ªçš„å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­— * ==========================================================================*/ static void handle_connection(int epollfd,int fd) { char buf[MAXSIZE]; memset(buf,0,MAXSIZE); int nread; nread = read(fd,buf,MAXSIZE); if (nread == -1) { perror(\"read error:\"); close(fd); delete_event(epollfd,fd,EPOLLIN); } else if (nread == 0) { fprintf(stderr,\"client close.\\n\"); close(fd); delete_event(epollfd,fd,EPOLLIN); } else { printf(\"read message is : %s\\n\",buf); //ç›´æ¥å›å¤ç»™å®¢æˆ·ç«¯ sendToClient(epollfd,fd,buf); } } static void sendToClient(int epollfd,int fd,char *buf) { int nwrite; nwrite = write(fd,buf,strlen(buf)); if (nwrite == -1) { perror(\"write error:\"); close(fd); delete_event(epollfd,fd,EPOLLIN); } } static void add_event(int epollfd,int fd,int state) { struct epoll_event ev; ev.events = state; ev.data.fd = fd; epoll_ctl(epollfd,EPOLL_CTL_ADD,fd,\u0026ev); } static void delete_event(int epollfd,int fd,int state) { struct epoll_event ev; ev.events = state; ev.data.fd = fd; epoll_ctl(epollfd,EPOLL_CTL_DEL,fd,\u0026ev); } static void modify_event(int epollfd,int fd,int state) { struct epoll_event ev; ev.events = state; ev.data.fd = fd; epoll_ctl(epollfd,EPOLL_CTL_MOD,fd,\u0026ev); } ``` # å¤šçº¿ç¨‹ ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹ æœ¬è´¨åŸå› cpuã€å†…å­˜IOã€ç£ç›˜IOå› ä¸ºä»‹è´¨ä¸åŒï¼Œå·¥ä½œæ•ˆç‡å¤©å£¤ä¹‹åˆ«ï¼Œcpué€Ÿåº¦è¿œè¿œå¤§äºå†…å­˜ï¼Œå†…å­˜é€Ÿåº¦åˆè¿œè¿œå¤§äºç£ç›˜ã€‚æ‰€ä»¥è¿™ä¹ˆä¸€æ¥æœ€å¼€å§‹çš„è®¡ç®—ä½¿ç”¨è€…å°±å‘ç°ï¼Œcpuå¤ªé—²äº†ï¼Œè€Œcpuè´µï¼Œå®åœ¨æ˜¯å¤ªæµªè´¹äº†ï¼Œæ‰€ä»¥åé¢å°±æƒ³å°½åŠæ³•åŠæ³•ï¼Œè®©cpuå¿™èµ·æ¥ ä¸‹é¢çš„æ˜¯ç®€å•çš„å‘å±•å†å²\nå•ä»»åŠ¡æ—¶ä»£\nè®¡ç®—æœºåªè´Ÿè´£è®¡ç®—ï¼Œä¸èƒ½ç›´æ¥å†™å…¥æŒ‡ä»¤å’Œè¾“å‡ºç»“æœï¼Œç¨‹åºå‘˜æŠŠç¨‹åºå†™åˆ°çº¸ä¸Šï¼Œç„¶åç©¿å­”ç§°å¡ç‰‡ï¼Œå†æŠŠå¡ç‰‡è¾“å…¥åˆ°è®¡ç®—æœºï¼Œè®¡ç®—æœºè®¡ç®—ç»“æœæ‰“å°å‡ºæ¥ï¼Œç¨‹åºå‘˜æœ€åæ‹¿åˆ°ç»“æœã€‚è¿™ä¸ªæ—¶ä»£çš„è®¡ç®—æœºcpuæ˜¯å¾ˆé—²çš„ï¼Œç¨‹åºå‘˜å¹²åŠå¤©ï¼Œè®¡ç®—æœºä¸€ä¼šå®Œäº‹ã€‚\næ‰¹å¤„ç†\nç¨‹åºç”±å¡ç‰‡æ”¹ä¸ºäº†ç£å¸¦ï¼Œè¿™æ—¶å€™ä¸€æ¬¡å¯ä»¥å½•å…¥æ›´å¤šçš„ç¨‹åºï¼Œä¸€æ¬¡æ‰¹å¤„ç†çš„æ–¹å¼æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä½†è®¡ç®—æœºåŒæ—¶è¿˜æ˜¯åªèƒ½å¹²ä¸€ä»¶äº‹æƒ…ï¼Œè¿›è¡ŒIOçš„æ—¶å€™ä¸èƒ½è®¡ç®—ï¼Œè¿›è¡Œè®¡ç®—çš„æ—¶å€™ä¸èƒ½IOï¼Œè€Œcpuå¹²æ´»åˆè´¼å¿«ï¼Œæ‰€ä»¥cpuæ•´ä½“è¿˜æ˜¯å¾ˆé—²ã€‚\næ”¯æŒå¤šé“ç¨‹åºè®¾è®¡ å¤šè¿›ç¨‹æ—¶ä»£\nå‡ºç°äº†å¤šè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´äº’ä¸å¹²æ¶‰ï¼Œå› ä¸ºcpuå¤ªå¿«è€Œä¸”åˆè´µï¼Œæ‰€ä»¥å¤§å®¶å°±è½®ç€ç”¨ï¼Œä¹Ÿå°±æ˜¯cpuæ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œä¸åŒçš„è¿›ç¨‹ä½¿ç”¨cpuç”±æ“ä½œç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼Œäº‰å–å…¬å¹³çš„åˆ†é…ç»™æ¯ä¸ªè¿›ç¨‹æ‰€éœ€è¦çš„cpuæ—¶é—´ç‰‡ï¼Œä¸€ä¸ªè¿›ç¨‹ç”¨ä¸€ä¼šcpuï¼Œæ“ä½œç³»ç»Ÿå°±ä¿å­˜ç°åœºï¼ŒåŒæ—¶æŠŠcpuè½¬ç»™å…¶å®ƒè¿›ç¨‹(ä¹Ÿå°±æ˜¯è¿›ç¨‹åˆ‡æ¢)ï¼Œè¿™ä¸ªæ—¶ä»£è¿›ç¨‹å¦‚æœå¤Ÿå¤šï¼Œcpuå…¶å®å·²ç»å¾ˆå¿™äº†ï¼Œå› ä¸ºä¸€å †è¿›ç¨‹è½®ç•ªä¸Šé˜µï¼Œæ— ä¼‘æ­¢çš„è½¦è½®æˆ˜ã€‚\nå¤šçº¿ç¨‹æ—¶ä»£\nå› ä¸ºè¿›ç¨‹åˆ‡æ¢æ¯”è¾ƒæ¶ˆè€—æ—¶é—´ï¼Œç°åœºä¿å­˜å’Œåˆ‡æ¢å·¥ä½œå› ä¸ºè¿›ç¨‹æ¯”è¾ƒé‡æ‰€ä»¥æ¯”è¾ƒæ¶ˆè€—æ—¶é—´å’Œèµ„æºï¼Œæ‰€ä»¥å°±æ¥äº†å¤šçº¿ç¨‹ï¼Œçº¿ç¨‹æ›´åŠ è½»é‡çº§ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹é—´å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥åˆ‡æ¢èµ·æ¥æ›´å¿«ï¼Œå½“ç„¶cpuä¹Ÿå°±ä¼šæ›´ç´¯ã€‚\nå› ä¸ºå¤šçº¿ç¨‹çš„å‡ºç°ï¼Œcpuå˜å¾—æ›´åŠ ç¹å¿™ã€‚\nå¤šcpu å¤šçº¿ç¨‹\nè¿›å…¥äº†å¤šçº¿ç¨‹æ—¶ä»£åï¼Œç»ˆäºå½»åº•å¯ä»¥æŠŠcpuææ­»äº†ï¼Œæ‰€ä»¥äººä»¬å¼€å§‹å«Œå¼ƒcpuæ²¡æœ‰é‚£ä¹ˆå¿«äº†ï¼Œæ‰€ä»¥å°±æƒ³ç€æå¤šä¸ªcpuï¼Œè®©å¤šä¸ªcpuåŒæ—¶å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™å…¶å®æ‰æ˜¯çœŸæ­£çš„ä»»åŠ¡å¹¶è¡Œäº†ï¼Œä¹‹å‰æ˜¯å¤šä¸ªä»»åŠ¡ä¸æ–­çš„æŠ¢ä¸€ä¸ªcpuï¼Œå› ä¸ºcpuå¤ªå¿«äº†ï¼Œæ‰€ä»¥åŸºæœ¬æ²¡ä»€ä¹ˆæ„Ÿè§‰ï¼Œè¿›å…¥å¤šæ ¸cpuåæ‰çœŸæ­£çš„è®©å¤šä¸ªä»»åŠ¡å¹¶è¡Œäº†ã€‚\nå¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜ è¿˜æ˜¯å› ä¸ºcpuå¤ªå¿«ï¼Œå†…å­˜ç£ç›˜å¤ªæ…¢æ‰€ä»¥æœ‰äº†cpuç¼“å­˜ï¼Œæ‰€ä»¥cpuæ‰§è¡Œæ•°æ®æ“ä½œè¿‡å±‚å¯¼è‡´å¦‚ä¸‹ï¼š\nä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…å­˜ ä»å†…å­˜åŠ è½½åˆ°cpuç¼“å­˜ æ‰§è¡Œç›¸å…³è®¡ç®—æ“ä½œ æ›´æ–°cpuç¼“å­˜ æ›´æ–°å†…å­˜ æ›´æ–°ç£ç›˜ å¤šæ ¸cpuï¼Œå°±æœ‰å¤šä¸ªcpuç¼“å­˜ï¼Œè€Œå®ƒä»¬å½¼æ­¤ä¸å¯è§ï¼Œæ¯ä¸ªcpuä¹Ÿæ˜¯æ“ä½œçš„è‡ªå·±ç‹¬ç«‹çš„cpuç¼“å­˜ï¼Œè¿™å°±å¿…ç„¶äº§ç”Ÿä¸å¯è§æ€§ï¼Œæ¯”å¦‚a=a+1\ncpu1ä¿®æ”¹äº†å¯¹åº”çš„cpuç¼“å­˜ï¼Œè€Œæ­¤æ—¶cpu2æ˜¯ä¸çŸ¥é“çš„ï¼Œå¿…é¡»ç­‰ç¼“å­˜åŒæ­¥ä»¥åæ‰çŸ¥é“ã€‚\næ‰€ä»¥çº¿ç¨‹è§å¦‚æœæ“ä½œå…±äº«èµ„æºè¦æ³¨æ„åŠ é”ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ„æƒ³ä¸åˆ°çš„ç»“æœ\nä¾‹å­ï¼š2ä¸ªçº¿ç¨‹ åŒæ—¶++ä¸€ä¸ªå˜é‡10Wæ¬¡\ncpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜ åŸå­æ€§å°±æ˜¯ä¸€ä¸ªæ“ä½œ(å¤šä¸ªç›¸å…³å­æ“ä½œ)åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸èƒ½è¢«æ‰“æ–­ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚\nä¾‹å­ int number=0;number=number+1;\nnumber=number+1çš„æŒ‡ä»¤å¯èƒ½å¦‚ä¸‹ï¼š\næŒ‡ä»¤1ï¼šCPUæŠŠnumberä»å†…å­˜æ‹·è´åˆ°CPUç¼“å­˜ã€‚\næŒ‡ä»¤2ï¼šæŠŠnumberè¿›è¡Œ+1çš„æ“ä½œã€‚\næŒ‡ä»¤3ï¼šæŠŠnumberå›å†™åˆ°å†…å­˜.\nå¦‚æœæœ‰2ä¸ªçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä¸Šé¢çš„ä¾‹å­ï¼Œcpuçš„æ‰§è¡Œæµç¨‹å¯èƒ½å¦‚ä¸‹ï¼š æ‰§è¡Œç»†èŠ‚ï¼š\nâ€‹\t1ã€CPUå…ˆæ‰§è¡Œçº¿ç¨‹Açš„æ‰§è¡Œï¼ŒæŠŠnumber=0æ‹·è´åˆ°CUPå¯„å­˜å™¨ã€‚\nâ€‹\t2ã€ç„¶åCPUåˆ‡æ¢åˆ°çº¿ç¨‹Bæ‰§è¡ŒæŒ‡ä»¤ã€‚\nâ€‹\t3ã€çº¿ç¨‹B æŠŠnumber=0æ‹·è´åˆ°CUPå¯„å­˜å™¨ã€‚\nâ€‹\t4ã€çº¿ç¨‹B æ‰§è¡Œnumber=number+1 æ“ä½œå¾—åˆ°number=1ã€‚\nâ€‹\t5ã€çº¿ç¨‹BæŠŠnumberæ‰§è¡Œç»“æœå›å†™åˆ°ç¼“å­˜é‡Œé¢ã€‚\nâ€‹\t6ã€ç„¶åCPUåˆ‡æ¢åˆ°çº¿ç¨‹Aæ‰§è¡ŒæŒ‡ä»¤ã€‚\nâ€‹\t7ã€çº¿ç¨‹Aæ‰§è¡Œnumber=number+1 æ“ä½œå¾—åˆ°numbe=1ã€‚\nâ€‹\t8ã€çº¿ç¨‹AæŠŠnumberæ‰§è¡Œç»“æœå›å†™åˆ°ç¼“å­˜é‡Œé¢ã€‚\nâ€‹\t9ã€æœ€åå†…å­˜é‡Œé¢numberçš„å€¼ä¸º1ã€‚\nç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜ ç¼–è¯‘å™¨çš„æœ‰äº›ä¼˜åŒ–ä¼šæ‰“ä¹±æ‰§è¡Œæœ¬æ¥äººä¸ºç†è§£çš„é¡ºåº\nä¾‹å­ï¼š å•ä¾‹æ¨¡å¼çš„double checkï¼Œå…¶å®ç”¨äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°å†…å­˜reorderé—®é¢˜å‘ç°ã€‚\npublic class Singleton { private Singleton() {} private static Singleton sInstance; public static Singleton getInstance() { if (sInstance == null) {\t//ç¬¬ä¸€æ¬¡éªŒè¯æ˜¯å¦ä¸ºnull synchronized (Singleton.class) { //åŠ é” if (sInstance == null) {\t//ç¬¬äºŒæ¬¡éªŒè¯æ˜¯å¦ä¸ºnull sInstance = new Singleton(); //åˆ›å»ºå¯¹è±¡ } } } return sInstance; } } Instance = new Singleton();è¿™è¡Œä»£ç æ—¶ä¼šåˆ†è§£æˆä¸‰ä¸ªæŒ‡ä»¤æ‰§è¡Œã€‚\n1ã€ä¸ºå¯¹è±¡åˆ†é…ä¸€ä¸ªå†…å­˜ç©ºé—´ã€‚\n2ã€åœ¨åˆ†é…çš„å†…å­˜ç©ºé—´å®ä¾‹åŒ–å¯¹è±¡ã€‚\n3ã€æŠŠInstance å¼•ç”¨åœ°å€æŒ‡å‘å†…å­˜ç©ºé—´\nè€Œä¸”2 3çš„é¡ºåºå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå…ˆæ‰§è¡Œ3ï¼Œç„¶åå¦å¤–ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°cpu å‘ç°å¯¹è±¡æŒ‡é’ˆä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç„¶åä½¿ç”¨ï¼Œè€Œè¿™ä¸ªæ—¶å€™å¯¹è±¡è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–å·¥ä½œï¼Œæ˜¯ä¼šå‡ºé—®é¢˜çš„ã€‚\nc++11 å¤šçº¿ç¨‹ åˆ›å»ºçº¿ç¨‹ c++11 åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å• å¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š 1. #include 2. å®šä¹‰çº¿ç¨‹ä»£ç æ‰§è¡Œè·¯å¾„(çº¿ç¨‹å°±æ˜¯å¯ä»¥å•ç‹¬æ‰§è¡Œä»£ç çš„é€šé“ï¼Œè¦å®šä¹‰çº¿ç¨‹å¯åŠ¨åè¦ä»å“ªä¸ªåœ°æ–¹å¼€å§‹ä»ä¸Šå¾€ä¸‹æ‰§è¡Œä»£ç ) 3. åœ¨mainä¸»çº¿ç¨‹ åˆ›å»ºä¸€ä¸ªthreadå¯¹è±¡(è¿™ä¸ªæ—¶å€™çº¿ç¨‹å°±è‡ªåŠ¨ç”Ÿæˆå¹¶ä¸”è¿è¡Œäº†) 4. ä¸»çº¿ç¨‹åšä¸€äº›çº¿ç¨‹ç®¡ç†å·¥ä½œ(æ¯”å¦‚è°ƒç”¨joinå‡½æ•°é˜»å¡ç­‰å¾…æŸä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨detachå‡½æ•° è·ŸæŸä¸ªçº¿ç¨‹è„±ç¦»å…³ç³»ï¼Œè®©initè¿›ç¨‹æ¥ç®¡ç„¶åå»åå°è¿è¡Œï¼‰ çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼ æ™®é€šçš„å‡½æ•°\n//æ™®é€šå‡½æ•°ä½œä¸ºçº¿ç¨‹æ‰§è¡Œå…¥å£ void ordinaryFunc(){ cout\u003c\u003c\"çº¿ç¨‹id:\"\u003c",
  "wordCount" : "46621",
  "inLanguage": "zh",
  "datePublished": "2020-05-13T22:45:46+08:00",
  "dateModified": "2020-05-13T22:45:46+08:00",
  "author":[{
    "@type": "Person",
    "name": "becool"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://heketong.github.io/posts/tech/%E9%AB%98%E5%B9%B6%E5%8F%91/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ç–¯å­çˆ±æ·¡å®š",
    "logo": {
      "@type": "ImageObject",
      "url": "http://becool.vip:666/img/heketong_profile_photo.JPG"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://heketong.github.io/" accesskey="h" title="ç–¯å­çˆ±æ·¡å®š (Alt + H)">
            <img src="http://becool.vip:666/img/heketong_profile_photo.JPG" alt="logo" aria-label="logo"
                 height="35">ç–¯å­çˆ±æ·¡å®š</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://heketong.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
            <li>
                <a href="http://heketong.github.io/categories/" title="ğŸ§© åˆ†ç±»">
                <span>ğŸ§© åˆ†ç±»</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="http://heketong.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="http://heketong.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="http://heketong.github.io/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                ç½‘ç»œé«˜å¹¶å‘
            </h1>
            <div class="post-description">
                é«˜å¹¶å‘çš„ä¸€äº›æ¦‚å¿µè®°å½•
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2020-05-13
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>46621å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>94åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>becool
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="http://heketong.github.io/tags/%E7%BD%91%E7%BB%9C%E9%AB%98%E5%B9%B6%E5%8F%91/" style="color: var(--secondary)!important;">ç½‘ç»œé«˜å¹¶å‘</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "http://heketong.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%ab%98%e5%b9%b6%e5%8f%91%e6%80%a7%e8%83%bd%e7%9b%b8%e5%85%b3%e6%8c%87%e6%a0%87%e6%88%96%e6%9c%af%e8%af%ad%e5%9b%9e%e9%a1%be" aria-label="é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾">é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾</a><ul>
                        
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e7%9b%b8%e5%85%b3" aria-label="è¿æ¥ç›¸å…³">è¿æ¥ç›¸å…³</a></li>
                <li>
                    <a href="#%e6%b5%81%e9%87%8f%e7%9b%b8%e5%85%b3" aria-label="æµé‡ç›¸å…³">æµé‡ç›¸å…³</a></li>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%8c%85%e6%95%b0" aria-label="æ•°æ®åŒ…æ•°">æ•°æ®åŒ…æ•°</a></li>
                <li>
                    <a href="#%e5%ba%94%e7%94%a8%e4%bc%a0%e8%be%93%e5%8d%8f%e8%ae%ae" aria-label="åº”ç”¨ä¼ è¾“åè®®">åº”ç”¨ä¼ è¾“åè®®</a></li>
                <li>
                    <a href="#%e9%95%bf%e8%bf%9e%e6%8e%a5%e7%9f%ad%e8%bf%9e%e6%8e%a5" aria-label="é•¿è¿æ¥ã€çŸ­è¿æ¥">é•¿è¿æ¥ã€çŸ­è¿æ¥</a></li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e8%bf%9e%e6%8e%a5%e5%92%8c%e5%b9%b6%e5%8f%91%e9%87%8f" aria-label="å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡">å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡</a></li></ul>
                </li>
                <li>
                    <a href="#io%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8" aria-label="IOå¤šè·¯å¤ç”¨">IOå¤šè·¯å¤ç”¨</a><ul>
                        
                <li>
                    <a href="#%e7%9b%b8%e5%85%b3%e8%a7%82%e5%bf%b5%e5%9b%9e%e9%a1%be" aria-label="ç›¸å…³è§‚å¿µå›é¡¾">ç›¸å…³è§‚å¿µå›é¡¾</a><ul>
                        
                <li>
                    <a href="#%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e4%b8%8e%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4" aria-label="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´">ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e5%88%87%e6%8d%a2" aria-label="è¿›ç¨‹åˆ‡æ¢">è¿›ç¨‹åˆ‡æ¢</a></li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e9%98%bb%e5%a1%9e" aria-label="è¿›ç¨‹é˜»å¡">è¿›ç¨‹é˜»å¡</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6" aria-label="æ–‡ä»¶æè¿°ç¬¦">æ–‡ä»¶æè¿°ç¬¦</a></li>
                <li>
                    <a href="#%e7%bc%93%e5%86%b2io" aria-label="ç¼“å†²I/O">ç¼“å†²I/O</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81io%e6%a8%a1%e5%bc%8f%e5%a4%8d%e4%b9%a0" aria-label="å¸¸è§I/Oæ¨¡å¼å¤ä¹ ">å¸¸è§I/Oæ¨¡å¼å¤ä¹ </a><ul>
                        
                <li>
                    <a href="#blocking-io-%e9%98%bb%e5%a1%9eio" aria-label="Blocking IO é˜»å¡IO">Blocking IO é˜»å¡IO</a></li>
                <li>
                    <a href="#nonblocking-io-%e9%9d%9e%e9%98%bb%e5%a1%9eio" aria-label="NonBlocking IO éé˜»å¡IO">NonBlocking IO éé˜»å¡IO</a></li>
                <li>
                    <a href="#io-multiplexing-io%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8" aria-label="IO multiplexing IOå¤šè·¯å¤ç”¨">IO multiplexing IOå¤šè·¯å¤ç”¨</a></li>
                <li>
                    <a href="#asynchronous-io-%e5%bc%82%e6%ad%a5io" aria-label="Asynchronous IO å¼‚æ­¥IO">Asynchronous IO å¼‚æ­¥IO</a></li>
                <li>
                    <a href="#blocking%e4%b8%8enon-blocking-%e9%98%bb%e5%a1%9e%e4%b8%8e%e9%9d%9e%e9%98%bb%e5%a1%9e" aria-label="Blockingä¸non-blocking é˜»å¡ä¸éé˜»å¡">Blockingä¸non-blocking é˜»å¡ä¸éé˜»å¡</a></li>
                <li>
                    <a href="#synchronous-io%e4%b8%8easynchronous-io" aria-label="Synchronous IOä¸asynchronous IO">Synchronous IOä¸asynchronous IO</a></li>
                <li>
                    <a href="#%e5%87%a0%e7%a7%8dio%e6%a8%a1%e5%bc%8f%e6%af%94%e8%be%83%e5%9b%be" aria-label="å‡ ç§IOæ¨¡å¼æ¯”è¾ƒå›¾">å‡ ç§IOæ¨¡å¼æ¯”è¾ƒå›¾</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e9%98%bb%e5%a1%9ebio-%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%8d%95%e4%bb%bb%e5%8a%a1" aria-label="åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å•ä»»åŠ¡">åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å•ä»»åŠ¡</a></li>
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e9%9d%9e%e9%98%bb%e5%a1%9e-%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%8d%95%e4%bb%bb%e5%8a%a1" aria-label="åŒæ­¥éé˜»å¡ æœåŠ¡ç«¯å•ä»»åŠ¡">åŒæ­¥éé˜»å¡ æœåŠ¡ç«¯å•ä»»åŠ¡</a></li>
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e9%98%bb%e5%a1%9ebio-%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%a4%9a%e5%b9%b6%e5%8f%91%e4%bb%bb%e5%8a%a1" aria-label="åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡">åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡</a></li>
                <li>
                    <a href="#io%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8---select" aria-label="IOå¤šè·¯å¤ç”¨&amp;mdash;select">IOå¤šè·¯å¤ç”¨&mdash;select</a><ul>
                        
                <li>
                    <a href="#api%e5%8e%9f%e5%9e%8b" aria-label="APIåŸå‹">APIåŸå‹</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%b6%b3" aria-label="ä¸è¶³">ä¸è¶³</a></li>
                <li>
                    <a href="#%e5%85%b6%e5%ae%83%e8%af%b4%e6%98%8e" aria-label="å…¶å®ƒè¯´æ˜">å…¶å®ƒè¯´æ˜</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81" aria-label="ä»£ç ">ä»£ç </a></li></ul>
                </li>
                <li>
                    <a href="#io%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8---poll" aria-label="IOå¤šè·¯å¤ç”¨&amp;mdash;poll">IOå¤šè·¯å¤ç”¨&mdash;poll</a><ul>
                        
                <li>
                    <a href="#api%e5%8e%9f%e5%9e%8b-1" aria-label="APIåŸå‹">APIåŸå‹</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%b6%b3%e5%8f%8a%e6%94%b9%e8%bf%9b" aria-label="ä¸è¶³åŠæ”¹è¿›">ä¸è¶³åŠæ”¹è¿›</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81-1" aria-label="ä»£ç ">ä»£ç </a></li></ul>
                </li>
                <li>
                    <a href="#io%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8---epoll" aria-label="IOå¤šè·¯å¤ç”¨&amp;mdash;epoll">IOå¤šè·¯å¤ç”¨&mdash;epoll</a><ul>
                        
                <li>
                    <a href="#api%e5%8e%9f%e5%9e%8b-2" aria-label="APIåŸå‹">APIåŸå‹</a></li>
                <li>
                    <a href="#%e6%94%b9%e8%bf%9b%e4%b8%8d%e8%b6%b3" aria-label="æ”¹è¿›ã€ä¸è¶³">æ”¹è¿›ã€ä¸è¶³</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81-2" aria-label="ä»£ç ">ä»£ç </a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%a4%9a%e8%bf%9b%e7%a8%8b%e5%a4%9a%e7%ba%bf%e7%a8%8b" aria-label="ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹">ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹</a></li>
                <li>
                    <a href="#%e5%a4%9acpu%e5%b9%b6%e5%8f%91%e5%8f%af%e8%83%bd%e4%ba%a7%e7%94%9f%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="å¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜">å¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜</a><ul>
                        
                <li>
                    <a href="#%e5%a4%9a%e4%b8%aacpu%e7%bc%93%e5%ad%98%e5%af%bc%e8%87%b4%e7%9a%84%e5%8f%af%e8%a7%81%e6%80%a7%e9%97%ae%e9%a2%98" aria-label="å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜">å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜</a></li>
                <li>
                    <a href="#cpu%e5%88%87%e6%8d%a2%e7%ba%bf%e7%a8%8b%e5%af%bc%e8%87%b4%e7%9a%84%e5%8e%9f%e5%ad%90%e6%80%a7%e9%97%ae%e9%a2%98" aria-label="cpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜">cpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜</a></li>
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e5%99%a8%e4%bc%98%e5%8c%96%e5%b8%a6%e6%9d%a5%e7%9a%84%e6%8c%87%e4%bb%a4%e9%87%8d%e6%8e%92%e5%ba%8f%e9%97%ae%e9%a2%98" aria-label="ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜">ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜</a></li></ul>
                </li>
                <li>
                    <a href="#c11-%e5%a4%9a%e7%ba%bf%e7%a8%8b" aria-label="c&#43;&#43;11 å¤šçº¿ç¨‹">c++11 å¤šçº¿ç¨‹</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b" aria-label="åˆ›å»ºçº¿ç¨‹">åˆ›å»ºçº¿ç¨‹</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e5%85%a5%e5%8f%a3%e7%9a%84%e5%b8%b8%e8%a7%81%e6%96%b9%e5%bc%8f" aria-label="çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼">çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%89%a7%e8%a1%8c%e5%85%a5%e5%8f%a3%e4%bc%a0%e9%80%92%e5%8f%82%e6%95%b0" aria-label="çº¿ç¨‹æ‰§è¡Œå…¥å£ä¼ é€’å‚æ•°">çº¿ç¨‹æ‰§è¡Œå…¥å£ä¼ é€’å‚æ•°</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e7%ae%a1%e7%90%86%e5%87%bd%e6%95%b0" aria-label="çº¿ç¨‹ç®¡ç†å‡½æ•°">çº¿ç¨‹ç®¡ç†å‡½æ•°</a></li>
                <li>
                    <a href="#%e9%94%81%e8%b5%84%e6%ba%90%e7%ab%9e%e4%ba%89" aria-label="é”(èµ„æºç«äº‰)">é”(èµ„æºç«äº‰)</a></li>
                <li>
                    <a href="#%e6%9d%a1%e4%bb%b6%e5%8f%98%e9%87%8f" aria-label="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</a></li>
                <li>
                    <a href="#stdasync%e4%b8%8estdfuture" aria-label="Std::asyncä¸std::future">Std::asyncä¸std::future</a></li>
                <li>
                    <a href="#stdpackaged_task" aria-label="std::packaged_task">std::packaged_task</a></li>
                <li>
                    <a href="#stdpromise-%e7%b1%bb%e6%a8%a1%e7%89%88-%e4%bf%9d%e5%ad%98%e7%ba%bf%e7%a8%8b%e8%ae%a1%e7%ae%97%e7%bb%93%e6%9e%9c" aria-label="Std::promise ç±»æ¨¡ç‰ˆ ä¿å­˜çº¿ç¨‹è®¡ç®—ç»“æœ">Std::promise ç±»æ¨¡ç‰ˆ ä¿å­˜çº¿ç¨‹è®¡ç®—ç»“æœ</a></li>
                <li>
                    <a href="#%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9cstdatomic" aria-label="åŸå­æ“ä½œstd::atomic">åŸå­æ“ä½œstd::atomic</a></li>
                <li>
                    <a href="#stdthread%e5%92%8cstdasync%e5%8c%ba%e5%88%ab" aria-label="Std::threadå’Œstd::asyncåŒºåˆ«">Std::threadå’Œstd::asyncåŒºåˆ«</a></li>
                <li>
                    <a href="#thread_local" aria-label="thread_local">thread_local</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%bb%8f%e5%85%b8io%e6%a8%a1%e5%9e%8b%e5%ae%9e%e7%8e%b0" aria-label="ç»å…¸IOæ¨¡å‹å®ç°">ç»å…¸IOæ¨¡å‹å®ç°</a><ul>
                        
                <li>
                    <a href="#ppctpc" aria-label="PPCã€TPC">PPCã€TPC</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af%e6%80%bb%e7%bb%93%e5%8f%8a%e7%bd%91%e6%90%9c%e5%9b%be%e8%a7%a3" aria-label="æ•´ä½“æ€è·¯æ€»ç»“åŠç½‘æœå›¾è§£">æ•´ä½“æ€è·¯æ€»ç»“åŠç½‘æœå›¾è§£</a><ul>
                        
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5%e6%9d%a5%e6%97%b6%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b" aria-label="è¿æ¥æ¥æ—¶åˆ›å»ºçº¿ç¨‹">è¿æ¥æ¥æ—¶åˆ›å»ºçº¿ç¨‹</a></li>
                <li>
                    <a href="#%e9%a2%84%e5%85%88%e5%88%9b%e5%bb%ba%e5%8f%b7%e5%a4%84%e7%90%86%e8%bf%9b%e7%a8%8b%e6%88%96%e8%80%85%e7%ba%bf%e7%a8%8b" aria-label="é¢„å…ˆåˆ›å»ºå·å¤„ç†è¿›ç¨‹æˆ–è€…çº¿ç¨‹">é¢„å…ˆåˆ›å»ºå·å¤„ç†è¿›ç¨‹æˆ–è€…çº¿ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#reactor%e6%80%9d%e6%83%b3" aria-label="Reactoræ€æƒ³">Reactoræ€æƒ³</a></li>
                <li>
                    <a href="#%e5%8d%95reactor%e5%8d%95%e7%ba%bf%e7%a8%8b%e5%a4%84%e7%90%86%e6%95%b4%e4%bd%93%e5%b0%b1%e4%b8%80%e4%b8%aa%e7%ba%bf%e7%a8%8b---redis" aria-label="å•Reactor&#43;å•çº¿ç¨‹å¤„ç†(æ•´ä½“å°±ä¸€ä¸ªçº¿ç¨‹)&amp;mdash;redis">å•Reactor+å•çº¿ç¨‹å¤„ç†(æ•´ä½“å°±ä¸€ä¸ªçº¿ç¨‹)&mdash;redis</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af" aria-label="æ•´ä½“æ€è·¯ï¼š">æ•´ä½“æ€è·¯ï¼š</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-1" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95reactor%e5%8d%95%e9%98%9f%e5%88%97%e4%b8%9a%e5%8a%a1%e8%bf%9b%e7%a8%8b%e7%ba%bf%e7%a8%8b%e6%b1%a0---thrift0100-nonblocking-server" aria-label="å•Reactor&#43;å•é˜Ÿåˆ—&#43;ä¸šåŠ¡è¿›ç¨‹/çº¿ç¨‹æ± &amp;mdash;thrift0.10.0 nonblocking server">å•Reactor+å•é˜Ÿåˆ—+ä¸šåŠ¡è¿›ç¨‹/çº¿ç¨‹æ± &mdash;thrift0.10.0 nonblocking server</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af-1" aria-label="æ•´ä½“æ€è·¯">æ•´ä½“æ€è·¯</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-2" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8d%95-reactorn%e9%98%9f%e5%88%97n%e7%ba%bf%e7%a8%8b---memcached" aria-label="å• Reactor&#43;Né˜Ÿåˆ—&#43;Nçº¿ç¨‹&amp;mdash;memcached">å• Reactor+Né˜Ÿåˆ—+Nçº¿ç¨‹&mdash;memcached</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af-2" aria-label="æ•´ä½“æ€è·¯">æ•´ä½“æ€è·¯</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-3" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%bb%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86%e5%a4%9a%e8%bf%9b%e7%a8%8bacceptepoll_wait%e5%a4%84%e7%90%86--nginx" aria-label="ä¸»è¿›ç¨‹ç®¡ç†&#43;å¤šè¿›ç¨‹(accept&#43;epoll_wait&#43;å¤„ç†)&amp;ndash;nginx">ä¸»è¿›ç¨‹ç®¡ç†+å¤šè¿›ç¨‹(accept+epoll_wait+å¤„ç†)&ndash;nginx</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af-3" aria-label="æ•´ä½“æ€è·¯">æ•´ä½“æ€è·¯</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-4" aria-label="æ€»ç»“">æ€»ç»“</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%bb%e4%bb%8e%e5%a4%9areactor%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%a4%84%e7%90%86" aria-label="ä¸»ä»å¤šreactorå¤šçº¿ç¨‹å¤„ç†">ä¸»ä»å¤šreactorå¤šçº¿ç¨‹å¤„ç†</a><ul>
                        
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af-4" aria-label="æ•´ä½“æ€è·¯ï¼š">æ•´ä½“æ€è·¯ï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-5" aria-label="æ€»ç»“ï¼š">æ€»ç»“ï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#unix%e7%bc%96%e7%a8%8bapi-%e8%bd%ac%e8%bd%bd" aria-label="unixç¼–ç¨‹API è½¬è½½">unixç¼–ç¨‹API è½¬è½½</a><ul>
                        
                <li>
                    <a href="#1%e5%ad%97%e8%8a%82%e5%ba%8f%e5%87%bd%e6%95%b0" aria-label="1.å­—èŠ‚åºå‡½æ•°">1.å­—èŠ‚åºå‡½æ•°</a></li>
                <li>
                    <a href="#2%e5%ad%97%e8%8a%82%e6%93%8d%e4%bd%9c%e5%87%bd%e6%95%b0" aria-label="2.å­—èŠ‚æ“ä½œå‡½æ•°">2.å­—èŠ‚æ“ä½œå‡½æ•°</a></li>
                <li>
                    <a href="#3%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2%e5%87%bd%e6%95%b0" aria-label="3.åœ°å€è½¬æ¢å‡½æ•°">3.åœ°å€è½¬æ¢å‡½æ•°</a></li>
                <li>
                    <a href="#4readnwriten%e5%92%8creadline" aria-label="4.readnã€writenå’Œreadline">4.readnã€writenå’Œreadline</a></li>
                <li>
                    <a href="#5%e6%b5%8b%e8%af%95%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%b1%bb%e5%9e%8b" aria-label="5.æµ‹è¯•æè¿°ç¬¦ç±»å‹">5.æµ‹è¯•æè¿°ç¬¦ç±»å‹</a></li>
                <li>
                    <a href="#6socket%e5%87%bd%e6%95%b0" aria-label="6.socketå‡½æ•°">6.socketå‡½æ•°</a></li>
                <li>
                    <a href="#7connect%e5%87%bd%e6%95%b0" aria-label="7.connectå‡½æ•°">7.connectå‡½æ•°</a></li>
                <li>
                    <a href="#8bind%e5%87%bd%e6%95%b0" aria-label="8.bindå‡½æ•°">8.bindå‡½æ•°</a></li>
                <li>
                    <a href="#9listen%e5%87%bd%e6%95%b0" aria-label="9.listenå‡½æ•°">9.listenå‡½æ•°</a></li>
                <li>
                    <a href="#10accept%e5%87%bd%e6%95%b0" aria-label="10.acceptå‡½æ•°">10.acceptå‡½æ•°</a></li>
                <li>
                    <a href="#11close%e5%87%bd%e6%95%b0" aria-label="11.closeå‡½æ•°">11.closeå‡½æ•°</a></li>
                <li>
                    <a href="#12getsockname%e5%92%8cgetpeername" aria-label="12.getsocknameå’Œgetpeername">12.getsocknameå’Œgetpeername</a></li>
                <li>
                    <a href="#13select%e5%87%bd%e6%95%b0" aria-label="13.selectå‡½æ•°">13.selectå‡½æ•°</a></li>
                <li>
                    <a href="#14shutdown%e5%87%bd%e6%95%b0" aria-label="14.shutdownå‡½æ•°">14.shutdownå‡½æ•°</a></li>
                <li>
                    <a href="#15pselect%e5%87%bd%e6%95%b0" aria-label="15.pselectå‡½æ•°">15.pselectå‡½æ•°</a></li>
                <li>
                    <a href="#16poll%e5%87%bd%e6%95%b0" aria-label="16.pollå‡½æ•°">16.pollå‡½æ•°</a></li>
                <li>
                    <a href="#17getsockopt%e5%92%8csetsockopt" aria-label="17.getsockoptå’Œsetsockopt">17.getsockoptå’Œsetsockopt</a></li>
                <li>
                    <a href="#18%e5%a5%97%e6%8e%a5%e5%8f%a3%e9%80%89%e9%a1%b9%e5%88%97%e8%a1%a8" aria-label="18.å¥—æ¥å£é€‰é¡¹åˆ—è¡¨">18.å¥—æ¥å£é€‰é¡¹åˆ—è¡¨</a><ul>
                        
                <li>
                    <a href="#so_broadcast" aria-label="SO_BROADCAST">SO_BROADCAST</a></li>
                <li>
                    <a href="#so_debug" aria-label="SO_DEBUG">SO_DEBUG</a></li>
                <li>
                    <a href="#so_dontroute" aria-label="SO_DONTROUTE">SO_DONTROUTE</a></li>
                <li>
                    <a href="#so_error" aria-label="SO_ERROR">SO_ERROR</a></li>
                <li>
                    <a href="#so_keepalive" aria-label="SO_KEEPALIVE">SO_KEEPALIVE</a></li>
                <li>
                    <a href="#so_linger" aria-label="SO_LINGER">SO_LINGER</a></li>
                <li>
                    <a href="#so_oobinline" aria-label="SO_OOBINLINE">SO_OOBINLINE</a></li>
                <li>
                    <a href="#so_rcvbuf%e5%92%8cso_sndbuf" aria-label="SO_RCVBUFå’ŒSO_SNDBUF">SO_RCVBUFå’ŒSO_SNDBUF</a></li>
                <li>
                    <a href="#so_rcvlowat%e5%92%8cso_sndlowat" aria-label="SO_RCVLOWATå’ŒSO_SNDLOWAT">SO_RCVLOWATå’ŒSO_SNDLOWAT</a></li>
                <li>
                    <a href="#so_rcvtimeo%e5%92%8cso_sndtimeo" aria-label="SO_RCVTIMEOå’ŒSO_SNDTIMEO">SO_RCVTIMEOå’ŒSO_SNDTIMEO</a></li>
                <li>
                    <a href="#so_reuseaddr%e5%92%8cso_reuseport" aria-label="SO_REUSEADDRå’ŒSO_REUSEPORT">SO_REUSEADDRå’ŒSO_REUSEPORT</a></li>
                <li>
                    <a href="#so_type" aria-label="SO_TYPE">SO_TYPE</a></li>
                <li>
                    <a href="#so_useloopback" aria-label="SO_USELOOPBACK">SO_USELOOPBACK</a></li>
                <li>
                    <a href="#ip_hdrincl" aria-label="IP_HDRINCL">IP_HDRINCL</a></li>
                <li>
                    <a href="#ip_options" aria-label="IP_OPTIONS">IP_OPTIONS</a></li>
                <li>
                    <a href="#ip_recvdstaddr" aria-label="IP_RECVDSTADDR">IP_RECVDSTADDR</a></li>
                <li>
                    <a href="#ip_recvif" aria-label="IP_RECVIF">IP_RECVIF</a></li>
                <li>
                    <a href="#ip_tos" aria-label="IP_TOS">IP_TOS</a></li>
                <li>
                    <a href="#ip_ttl" aria-label="IP_TTL">IP_TTL</a></li>
                <li>
                    <a href="#icmp6_filter" aria-label="ICMP6_FILTER">ICMP6_FILTER</a></li>
                <li>
                    <a href="#ipv6_addrform" aria-label="IPV6_ADDRFORM">IPV6_ADDRFORM</a></li>
                <li>
                    <a href="#ipv6_checksum" aria-label="IPV6_CHECKSUM">IPV6_CHECKSUM</a></li>
                <li>
                    <a href="#ipv6_dstopts" aria-label="IPV6_DSTOPTS">IPV6_DSTOPTS</a></li>
                <li>
                    <a href="#ipv6_hoplimit" aria-label="IPV6_HOPLIMIT">IPV6_HOPLIMIT</a></li>
                <li>
                    <a href="#ipv6_hopopts" aria-label="IPV6_HOPOPTS">IPV6_HOPOPTS</a></li>
                <li>
                    <a href="#ipv6_nexthop" aria-label="IPV6_NEXTHOP">IPV6_NEXTHOP</a></li>
                <li>
                    <a href="#ipv6_pktinfo" aria-label="IPV6_PKTINFO">IPV6_PKTINFO</a></li>
                <li>
                    <a href="#ipv6_pktoptions" aria-label="IPV6_PKTOPTIONS">IPV6_PKTOPTIONS</a></li>
                <li>
                    <a href="#ipv6_rthdr" aria-label="IPV6_RTHDR">IPV6_RTHDR</a></li>
                <li>
                    <a href="#ipv6_unicast_hops" aria-label="IPV6_UNICAST_HOPS">IPV6_UNICAST_HOPS</a></li>
                <li>
                    <a href="#tcp_keepalive" aria-label="TCP_KEEPALIVE">TCP_KEEPALIVE</a></li>
                <li>
                    <a href="#tcp_maxrt" aria-label="TCP_MAXRT">TCP_MAXRT</a></li>
                <li>
                    <a href="#tcp_maxseg" aria-label="TCP_MAXSEG">TCP_MAXSEG</a></li>
                <li>
                    <a href="#tcp_nodelay" aria-label="TCP_NODELAY">TCP_NODELAY</a></li>
                <li>
                    <a href="#tcp_stdurg" aria-label="TCP_STDURG">TCP_STDURG</a></li></ul>
                </li>
                <li>
                    <a href="#19%e5%a4%84%e7%90%86%e5%a5%97%e6%8e%a5%e5%8f%a3%e7%9a%84fcntl%e5%87%bd%e6%95%b0" aria-label="19.å¤„ç†å¥—æ¥å£çš„fcntlå‡½æ•°">19.å¤„ç†å¥—æ¥å£çš„fcntlå‡½æ•°</a></li>
                <li>
                    <a href="#20gethostbyname%e5%87%bd%e6%95%b0" aria-label="20.gethostbynameå‡½æ•°">20.gethostbynameå‡½æ•°</a><ul>
                        
                <li>
                    <a href="#dns%e5%b0%8f%e5%b8%b8%e8%af%86" aria-label="DNSå°å¸¸è¯†ï¼š">DNSå°å¸¸è¯†ï¼š</a></li></ul>
                </li>
                <li>
                    <a href="#21gethostbyname2%e5%87%bd%e6%95%b0" aria-label="21.gethostbyname2å‡½æ•°">21.gethostbyname2å‡½æ•°</a></li>
                <li>
                    <a href="#22gethostbyaddr%e5%87%bd%e6%95%b0" aria-label="22.gethostbyaddrå‡½æ•°">22.gethostbyaddrå‡½æ•°</a></li>
                <li>
                    <a href="#23uname%e5%87%bd%e6%95%b0" aria-label="23.unameå‡½æ•°">23.unameå‡½æ•°</a></li>
                <li>
                    <a href="#24gethostname%e5%87%bd%e6%95%b0" aria-label="24.gethostnameå‡½æ•°">24.gethostnameå‡½æ•°</a></li>
                <li>
                    <a href="#25getservbyname%e5%87%bd%e6%95%b0" aria-label="25.getservbynameå‡½æ•°">25.getservbynameå‡½æ•°</a></li>
                <li>
                    <a href="#26getservbyport%e5%87%bd%e6%95%b0" aria-label="26.getservbyportå‡½æ•°">26.getservbyportå‡½æ•°</a></li>
                <li>
                    <a href="#27recv%e5%92%8csend" aria-label="27.recvå’Œsend">27.recvå’Œsend</a></li>
                <li>
                    <a href="#28readv%e5%92%8cwritev" aria-label="28.readvå’Œwritev">28.readvå’Œwritev</a></li>
                <li>
                    <a href="#29readmsg%e5%92%8cwritemsg" aria-label="29.readmsgå’Œwritemsg">29.readmsgå’Œwritemsg</a></li>
                <li>
                    <a href="#30socketpair%e5%87%bd%e6%95%b0" aria-label="30.socketpairå‡½æ•°">30.socketpairå‡½æ•°</a></li>
                <li>
                    <a href="#31%e5%a5%97%e6%8e%a5%e5%8f%a3ioctl%e5%87%bd%e6%95%b0" aria-label="31.å¥—æ¥å£ioctlå‡½æ•°">31.å¥—æ¥å£ioctlå‡½æ•°</a><ul>
                        
                <li>
                    <a href="#1%e5%a5%97%e6%8e%a5%e5%8f%a3%e6%93%8d%e4%bd%9c" aria-label="(1)å¥—æ¥å£æ“ä½œ">(1)å¥—æ¥å£æ“ä½œ</a></li>
                <li>
                    <a href="#2%e6%96%87%e4%bb%b6%e6%93%8d%e4%bd%9c" aria-label="(2)æ–‡ä»¶æ“ä½œ">(2)æ–‡ä»¶æ“ä½œ</a></li>
                <li>
                    <a href="#3%e6%8e%a5%e5%8f%a3%e9%85%8d%e7%bd%ae" aria-label="(3)æ¥å£é…ç½®">(3)æ¥å£é…ç½®</a></li>
                <li>
                    <a href="#4%e6%8e%a5%e5%8f%a3%e6%93%8d%e4%bd%9c" aria-label="(4)æ¥å£æ“ä½œ">(4)æ¥å£æ“ä½œ</a></li>
                <li>
                    <a href="#5arp%e9%ab%98%e9%80%9f%e7%bc%93%e5%ad%98%e6%93%8d%e4%bd%9c" aria-label="(5)ARPé«˜é€Ÿç¼“å­˜æ“ä½œ">(5)ARPé«˜é€Ÿç¼“å­˜æ“ä½œ</a></li>
                <li>
                    <a href="#6%e8%b7%af%e7%94%b1%e8%a1%a8%e6%93%8d%e4%bd%9c" aria-label="(6)è·¯ç”±è¡¨æ“ä½œ">(6)è·¯ç”±è¡¨æ“ä½œ</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%9b%e7%a8%8b%e9%97%b4%e9%80%9a%e4%bf%a1ipc-inter-process-communication" aria-label="è¿›ç¨‹é—´é€šä¿¡IPC Inter-Process Communication">è¿›ç¨‹é—´é€šä¿¡IPC Inter-Process Communication</a><ul>
                        
                <li>
                    <a href="#%e4%bf%a1%e5%8f%b7signal" aria-label="ä¿¡å·Signal">ä¿¡å·Signal</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e4%bf%a1%e5%8f%b7" aria-label="ä»€ä¹ˆæ˜¯ä¿¡å·">ä»€ä¹ˆæ˜¯ä¿¡å·</a></li>
                <li>
                    <a href="#%e4%bf%a1%e5%8f%b7%e7%9a%84%e6%9d%a5%e6%ba%90" aria-label="ä¿¡å·çš„æ¥æº">ä¿¡å·çš„æ¥æº</a></li>
                <li>
                    <a href="#%e6%94%b6%e5%88%b0%e4%bf%a1%e5%8f%b7%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86" aria-label="æ”¶åˆ°ä¿¡å·å¦‚ä½•å¤„ç†">æ”¶åˆ°ä¿¡å·å¦‚ä½•å¤„ç†</a></li>
                <li>
                    <a href="#%e7%9b%b8%e5%85%b3%e7%b3%bb%e7%bb%9f%e5%87%bd%e6%95%b0%e8%af%b4%e6%98%8e" aria-label="ç›¸å…³ç³»ç»Ÿå‡½æ•°è¯´æ˜">ç›¸å…³ç³»ç»Ÿå‡½æ•°è¯´æ˜</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e6%b3%a8%e5%86%8c%e4%bf%a1%e5%8f%b7%e5%a4%84%e7%90%86" aria-label="å¦‚ä½•æ³¨å†Œä¿¡å·å¤„ç†">å¦‚ä½•æ³¨å†Œä¿¡å·å¤„ç†</a></li>
                <li>
                    <a href="#%e7%bc%ba%e7%82%b9" aria-label="ç¼ºç‚¹">ç¼ºç‚¹</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6-file" aria-label="æ–‡ä»¶ file">æ–‡ä»¶ file</a></li>
                <li>
                    <a href="#%e7%ae%a1%e9%81%93-pipenamed-pipe" aria-label="ç®¡é“ pipe/named pipe">ç®¡é“ pipe/named pipe</a></li>
                <li>
                    <a href="#%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98-shm" aria-label="å…±äº«å†…å­˜ shm">å…±äº«å†…å­˜ shm</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98" aria-label="ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜">ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%8f%8a%e4%bd%bf%e7%94%a8" aria-label="åˆ›å»ºåŠä½¿ç”¨">åˆ›å»ºåŠä½¿ç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%a1%e5%8f%b7%e9%87%8fsemaphore" aria-label="ä¿¡å·é‡semaphore">ä¿¡å·é‡semaphore</a><ul>
                        
                <li>
                    <a href="#%e6%a6%82%e5%bf%b5" aria-label="æ¦‚å¿µ">æ¦‚å¿µ</a></li>
                <li>
                    <a href="#%e8%ae%bf%e9%97%ae%e8%a7%84%e5%88%99" aria-label="è®¿é—®è§„åˆ™">è®¿é—®è§„åˆ™</a></li>
                <li>
                    <a href="#%e7%9b%b8%e5%85%b3api" aria-label="ç›¸å…³API">ç›¸å…³API</a></li>
                <li>
                    <a href="#%e7%89%b9%e7%82%b9" aria-label="ç‰¹ç‚¹">ç‰¹ç‚¹</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97-message" aria-label="æ¶ˆæ¯é˜Ÿåˆ— Message">æ¶ˆæ¯é˜Ÿåˆ— Message</a><ul>
                        
                <li>
                    <a href="#%e6%a6%82%e5%bf%b5-1" aria-label="æ¦‚å¿µ">æ¦‚å¿µ</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9e%84" aria-label="ç»“æ„">ç»“æ„</a></li>
                <li>
                    <a href="#%e7%9b%b8%e5%85%b3api-1" aria-label="ç›¸å…³API">ç›¸å…³API</a></li>
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></li></ul>
                </li>
                <li>
                    <a href="#socket%e9%80%9a%e4%bf%a1" aria-label="Socketé€šä¿¡">Socketé€šä¿¡</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾">é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾<a hidden class="anchor" aria-hidden="true" href="#é«˜å¹¶å‘æ€§èƒ½ç›¸å…³æŒ‡æ ‡æˆ–æœ¯è¯­å›é¡¾">#</a></h1>
<h2 id="è¿æ¥ç›¸å…³">è¿æ¥ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#è¿æ¥ç›¸å…³">#</a></h2>
<p>æœåŠ¡ç«¯èƒ½ä¿æŒï¼Œç®¡ç†ï¼Œå¤„ç†å¤šå°‘å®¢æˆ·ç«¯çš„è¿æ¥</p>
<ul>
<li>æ´»è·ƒè¿æ¥æ•°ï¼šæ‰€æœ‰ESTABLISHEDçŠ¶æ€çš„TCPè¿æ¥ï¼ŒæŸä¸ªç¬æ—¶ï¼Œè¿™äº›è¿æ¥æ­£åœ¨ä¼ è¾“æ•°æ®ã€‚å¦‚æœæ‚¨é‡‡ç”¨çš„æ˜¯é•¿è¿æ¥çš„æƒ…å†µï¼Œä¸€ä¸ªè¿æ¥ä¼šåŒæ—¶ä¼ è¾“å¤šä¸ªè¯·æ±‚ã€‚ä¹Ÿå¯ä»¥é—´æ¥è€ƒå¯Ÿåç«¯æœåŠ¡å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œæ³¨æ„ä¸åŒäºå¹¶å‘é‡ã€‚</li>
<li>éæ´»è·ƒè¿æ¥æ•°ï¼šè¡¨ç¤ºé™¤ESTABLISHEDçŠ¶æ€çš„å…¶å®ƒæ‰€æœ‰çŠ¶æ€çš„TCPè¿æ¥æ•°ã€‚</li>
<li>å¹¶å‘è¿æ¥æ•°ï¼šæ‰€æœ‰å»ºç«‹çš„TCPè¿æ¥æ•°é‡ã€‚=æ´»è·ƒè¿æ¥æ•°+éæ´»è·ƒè¿æ¥æ•°ã€‚</li>
<li>æ–°å»ºè¿æ¥æ•°ï¼šåœ¨ç»Ÿè®¡å‘¨æœŸå†…ï¼Œä»å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ç«¯ï¼Œæ–°å»ºç«‹çš„è¿æ¥è¯·æ±‚çš„å¹³å‡æ•°ã€‚ä¸»è¦è€ƒå¯Ÿåº”å¯¹ çªå‘æµé‡æˆ–ä»æ­£å¸¸åˆ°é«˜å³°æµé‡çš„èƒ½åŠ›ã€‚å¦‚ï¼šç§’æ€ã€æŠ¢ç¥¨åœºæ™¯ã€‚</li>
<li>ä¸¢å¼ƒè¿æ¥æ•°ï¼šæ¯ç§’ä¸¢å¼ƒçš„è¿æ¥æ•°ã€‚å¦‚æœè¿æ¥æœåŠ¡å™¨åšäº†è¿æ¥ç†”æ–­å¤„ç†ï¼Œè¿™éƒ¨åˆ†æ•°æ®å³ç†”æ–­çš„è¿æ¥</li>
</ul>
<p>åœ¨linuxä¸Šsocketè¿æ¥ä½“ç°ä¸Šå°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œé«˜å¹¶å‘ä¸­ç›¸å…³çš„å‚æ•°ä¸€å®šè¦è°ƒä¼˜ã€‚</p>
<h2 id="æµé‡ç›¸å…³">æµé‡ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#æµé‡ç›¸å…³">#</a></h2>
<p>â€‹    ä¸»è¦æ˜¯ç½‘ç»œå¸¦å®½çš„é…ç½®ã€‚</p>
<ul>
<li>æµå…¥æµé‡ï¼šä»å¤–éƒ¨è®¿é—®æœåŠ¡å™¨æ‰€æ¶ˆè€—çš„æµé‡ã€‚</li>
<li>æµå‡ºæµé‡ï¼šæœåŠ¡å™¨å¯¹å¤–å“åº”çš„æµé‡ã€‚</li>
</ul>
<h2 id="æ•°æ®åŒ…æ•°">æ•°æ®åŒ…æ•°<a hidden class="anchor" aria-hidden="true" href="#æ•°æ®åŒ…æ•°">#</a></h2>
<p>æ•°æ®åŒ…æ˜¯TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥åï¼Œä¼ è¾“çš„å†…å®¹å°è£…</p>
<ul>
<li>æµå…¥æ•°æ®åŒ…æ•°ï¼šæœåŠ¡å™¨æ¯ç§’æ¥åˆ°çš„è¯·æ±‚æ•°æ®åŒ…æ•°é‡ã€‚</li>
<li>æµå‡ºæ•°æ®åŒ…æ•°ï¼šæœåŠ¡å™¨æ¯ç§’å‘å‡ºçš„æ•°æ®åŒ…æ•°é‡ã€‚</li>
</ul>
<p>å¦‚æœæ•°æ®åŒ…å¤ªå¤§å¯ä»¥è€ƒè™‘å‹ç¼©ï¼Œå› ä¸ºä¼ è¾“çš„æ•°æ®åŒ…å° æ•ˆç‡ä¸€èˆ¬ä¼šæå‡ï¼Œä½†è§£å‹ç¼©ä¹Ÿéœ€è¦æ€§èƒ½æ¶ˆè€—ï¼Œä¸èƒ½æ— é™åˆ¶å‹ç¼©</p>
<h2 id="åº”ç”¨ä¼ è¾“åè®®">åº”ç”¨ä¼ è¾“åè®®<a hidden class="anchor" aria-hidden="true" href="#åº”ç”¨ä¼ è¾“åè®®">#</a></h2>
<p>â€‹	ä¼ è¾“åè®®å‹ç¼©ç‡å¥½ï¼Œä¼ è¾“æ€§èƒ½å¥½ï¼Œå¯¹å¹¶å‘æ€§èƒ½æå‡é«˜ã€‚ä½†æ˜¯ä¹Ÿéœ€è¦çœ‹è°ƒç”¨åŒæ–¹çš„è¯­è¨€å¯ä»¥ä½¿ç”¨åè®®æ‰è¡Œã€‚å¯ä»¥è‡ªå·±å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æˆç†Ÿçš„ä¼ è¾“åè®®ã€‚æ¯”å¦‚redisçš„åºåˆ—åŒ–ä¼ è¾“åè®®ã€jsonä¼ è¾“åè®®ã€Protocol Buffersä¼ è¾“åè®®ã€httpåè®®ç­‰ã€‚  å°¤å…¶åœ¨ rpcè°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªä¼ è¾“åè®®é€‰æ‹©éœ€è¦ä»”ç»†ç”„åˆ«é€‰å‹ã€‚</p>
<h2 id="é•¿è¿æ¥çŸ­è¿æ¥">é•¿è¿æ¥ã€çŸ­è¿æ¥<a hidden class="anchor" aria-hidden="true" href="#é•¿è¿æ¥çŸ­è¿æ¥">#</a></h2>
<ul>
<li>é•¿è¿æ¥æ˜¯æŒ‡åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šï¼Œå¯ä»¥é‡ç”¨å¤šæ¬¡å‘é€æ•°æ®åŒ…ï¼Œåœ¨TCPè¿æ¥ä¿æŒæœŸé—´ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åŒ…å‘é€ï¼Œéœ€è¦åŒæ–¹å‘æ£€æµ‹åŒ…ä»¥ç»´æŒæ­¤è¿æ¥ã€‚</li>
<li>åŠå¼€è¿æ¥çš„å¤„ç†ï¼šå½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹èµ·æ­£å¸¸çš„TCPè¿æ¥åï¼Œå¦‚æœå®¢æˆ·ä¸»æœºæ‰çº¿ï¼ˆç½‘çº¿æ–­å¼€ï¼‰ã€ç”µæºæ‰ç”µã€æˆ–ç³»ç»Ÿå´©æºƒï¼ŒæœåŠ¡å™¨å°†æ°¸è¿œä¸ä¼šçŸ¥é“ã€‚é•¿è¿æ¥ä¸­é—´ä»¶ï¼Œéœ€è¦å¤„ç†è¿™ä¸ªç»†èŠ‚ã€‚linuxé»˜è®¤é…ç½®2å°æ—¶ï¼Œå¯ä»¥é…ç½®ä¿®æ”¹ã€‚ä¸è¿‡ç°å®é¡¹ç›®ä¸€èˆ¬ä¸ç”¨ç³»ç»Ÿçš„è¿™ä¸ªæœºåˆ¶ï¼Œå¾ˆå¤šç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯å¿ƒè·³åŒ…ç»´æŒè¿æ¥ï¼ŒæœåŠ¡ç«¯å¯åŠ¨å®šæ—¶å™¨ï¼Œè¶…æ—¶å°±closeæ‰è¿æ¥</li>
<li>çŸ­è¿æ¥æ˜¯æŒ‡é€šä¿¡åŒæ–¹æœ‰æ•°æ®äº¤äº’æ—¶ï¼Œå°±å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œæ•°æ®å‘é€å®Œæˆåï¼Œåˆ™æ–­å¼€æ­¤TCPè¿æ¥ã€‚ä½†æ˜¯æ¯æ¬¡å»ºç«‹è¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ã€æ–­å¼€è¿æ¥éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚</li>
<li>å…³é—­è¿æ¥æœ€å¥½ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·ï¼ŒTIME_WAITè¿™ä¸ªçŠ¶æ€æœ€å¥½ä¸è¦åœ¨æœåŠ¡å™¨ç«¯ï¼Œå‡å°‘å ç”¨èµ„æºï¼Œå½“ç„¶å¦‚æœæ˜¯ä½¿ç”¨çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯é«˜é¢‘çš„å‡ºç°TIME_WAITä¹Ÿè¦æ³¨æ„ä¸´æ—¶ç«¯å£è€—å°½çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰å¾ˆå¤šä¼˜åŒ–(æ¯”å¦‚SO_REUSEADDRé€‰é¡¹ã€SO_LINGERé€‰é¡¹ï¼Œä¸´æ—¶ç«¯å£èŒƒå›´è°ƒä¼˜ç­‰)</li>
</ul>
<p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p>
<ul>
<li>åœ¨å®¢æˆ·ç«¯æ•°é‡å°‘åœºæ™¯ä¸€èˆ¬ä½¿ç”¨é•¿è¿æ¥ã€‚åç«¯ä¸­é—´ä»¶ã€å¾®æœåŠ¡ä¹‹é—´é€šä¿¡æœ€å¥½ä½¿ç”¨é•¿è¿æ¥ã€‚å¦‚ï¼šæ•°æ®åº“è¿æ¥ï¼Œdubooé»˜è®¤åè®®ç­‰ã€‚</li>
<li>è€Œå¤§å‹webã€appåº”ç”¨ï¼Œä½¿ç”¨httpçŸ­è¿æ¥ï¼ˆhttp1.1çš„keep aliveå˜ç›¸çš„æ”¯æŒé•¿è¿æ¥ï¼Œä½†è¿˜æ˜¯ä¸²è¡Œè¯·æ±‚/å“åº”äº¤äº’ï¼‰ã€‚http2.0æ”¯æŒçœŸæ­£çš„é•¿è¿æ¥ã€‚</li>
<li>é•¿è¿æ¥ä¼šå¯¹æœåŠ¡ç«¯è€—è´¹æ›´å¤šçš„èµ„æºï¼Œä¸Šç™¾ä¸‡ç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬å ä¸€ä¸ªè¿æ¥ï¼Œå¯¹æœåŠ¡ç«¯å‹åŠ›å¤šå¤§ï¼Œæˆæœ¬å¤šé«˜ã€‚IMã€pushåº”ç”¨ä¼šä½¿ç”¨é•¿è¿æ¥ï¼Œä½†æ˜¯ä¼šåšå¾ˆå¤šä¼˜åŒ–å·¥ä½œã€‚</li>
<li>ç”±äºhttpséœ€è¦åŠ è§£å¯†è¿ç®—ç­‰ï¼Œæœ€å¥½ä½¿ç”¨http2.0ï¼ˆå¼ºåˆ¶sslï¼‰ï¼Œä¼ è¾“æ€§èƒ½å¾ˆå¥½ã€‚ä½†æ˜¯æœåŠ¡ç«¯éœ€è¦ç»´æŒæ›´å¤šçš„è¿æ¥ã€‚</li>
</ul>
<h2 id="å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡">å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡<a hidden class="anchor" aria-hidden="true" href="#å¹¶å‘è¿æ¥å’Œå¹¶å‘é‡">#</a></h2>
<ul>
<li>å¹¶å‘è¿æ¥æ•°ï¼š=æ´»è·ƒè¿æ¥æ•°+éæ´»è·ƒè¿æ¥æ•°ã€‚æ‰€æœ‰å»ºç«‹çš„TCPè¿æ¥æ•°é‡ã€‚ç½‘ç»œæœåŠ¡å™¨èƒ½å¹¶è¡Œç®¡ç†çš„è¿æ¥æ•°ã€‚</li>
<li>å¹¶å‘é‡ï¼šç¬æ—¶é€šè¿‡æ´»è·ƒè¿æ¥ä¼ è¾“æ•°æ®çš„é‡ï¼Œè¿™ä¸ªé‡ä¸€èˆ¬åœ¨å¤„ç†ç«¯å¥½è¯„ä¼°ã€‚è·Ÿæ´»è·ƒè¿æ¥æ•°æ²¡æœ‰ç»å¯¹çš„å…³ç³»ã€‚ç½‘ç»œæœåŠ¡å™¨èƒ½å¹¶è¡Œå¤„ç†çš„ä¸šåŠ¡è¯·æ±‚æ•°ã€‚</li>
<li>rtå“åº”æ—¶é—´ï¼šå„ç±»æ“ä½œå•æœºrtè‚¯å®šä¸ç›¸åŒã€‚æ¯”å¦‚ï¼šä»cacheä¸­è¯»æ•°æ®å’Œåˆ†å¸ƒå¼äº‹åŠ¡å†™æ•°æ®åº“ï¼Œèµ„æºçš„æ¶ˆè€—ä¸åŒï¼Œæ“ä½œæ—¶é—´æœ¬èº«å°±ä¸åŒã€‚</li>
<li>ååé‡ï¼šQPS/TPSï¼Œæ¯ç§’å¯ä»¥å¤„ç†çš„æŸ¥è¯¢æˆ–äº‹åŠ¡æ•°ï¼Œè¿™ä¸ªæ˜¯å…³é”®æŒ‡æ ‡ã€‚</li>
</ul>
<h1 id="ioå¤šè·¯å¤ç”¨">IOå¤šè·¯å¤ç”¨<a hidden class="anchor" aria-hidden="true" href="#ioå¤šè·¯å¤ç”¨">#</a></h1>
<h2 id="ç›¸å…³è§‚å¿µå›é¡¾">ç›¸å…³è§‚å¿µå›é¡¾<a hidden class="anchor" aria-hidden="true" href="#ç›¸å…³è§‚å¿µå›é¡¾">#</a></h2>
<h3 id="ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´">ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´">#</a></h3>
<ul>
<li>
<p>linuxæ“ä½œç³»ç»Ÿé‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨æŠ€æœ¯ï¼Œå¯¹äº32ä½æ“ä½œç³»ç»Ÿï¼Œå†…å­˜å¯»å€ç©ºé—´å°±æ˜¯4G(2^32)ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒå«åšå†…æ ¸kernelï¼Œç‹¬ç«‹äºæ™®é€šçš„Applicationï¼Œå†…æ ¸æ˜¯å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶çš„æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸(å†…æ ¸è¦è¶³å¤Ÿç¨³å®š)ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†2éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†å«åšå†…æ ¸ç©ºé—´ï¼Œä¸€éƒ¨åˆ†å«åšç”¨æˆ·ç©ºé—´ã€‚</p>
</li>
<li>
<p>linuxæ“ä½œç³»ç»Ÿ32ä½ï¼Œå°†æœ€é«˜çš„1G(è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFF) æ˜¯ç»™å†…æ ¸ä½¿ç”¨çš„ï¼Œå«åšå†…æ ¸ç©ºé—´ï¼Œè€Œè¾ƒä½çš„3Gå­—èŠ‚(è™šæ‹Ÿåœ°å€ä»0x00000000åˆ°0xBFFFFFFF)ï¼Œç»™å„ä¸ªåº”ç”¨è¿›ç¨‹ä½¿ç”¨ï¼Œå«åšç”¨æˆ·ç©ºé—´ã€‚</p>
</li>
<li>
<p>æ¯ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œå› æ­¤linuxå†…æ ¸æœ‰ç³»ç»Ÿå†…çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œç©ºé—´åˆ†é…å›¾å¤§è‡´å¦‚ä¸‹:</p>
</li>
</ul>
<p><img loading="lazy" src="http://becool.vip:666/img/linux32%e4%bd%8d%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e5%88%86%e9%85%8d%e7%a4%ba%e6%84%8f%e5%9b%be.png" alt=""  />
</p>
<ul>
<li>
<p>linuxç³»ç»Ÿå†…éƒ¨ç»“æ„å¤§å€¼å›¾ç¤º:</p>
<p><img loading="lazy" src="http://becool.vip:666/img/linux%e7%b3%bb%e7%bb%9f%e5%86%85%e9%83%a8%e7%bb%93%e6%9e%84%e5%a4%a7%e8%87%b4%e7%a4%ba%e6%84%8f%e5%9b%be.png" alt=""  />
</p>
</li>
<li>
<p>å½“ä¸€ä¸ªä»»åŠ¡(å¾€å¾€æ˜¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹)æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹Ÿå°±æ˜¯æ‰§è¡Œå†…æ ¸ä»£ç ï¼Œè¿›ç¨‹å°±è¿›å…¥å†…æ ¸æ€ï¼Œå½“ä»»åŠ¡æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç ï¼Œç§°ä¸ºå¤„äºç”¨æˆ·è¿è¡Œæ€(ç”¨æˆ·æ€)</p>
</li>
</ul>
<h3 id="è¿›ç¨‹åˆ‡æ¢">è¿›ç¨‹åˆ‡æ¢<a hidden class="anchor" aria-hidden="true" href="#è¿›ç¨‹åˆ‡æ¢">#</a></h3>
<ul>
<li>
<p>ä¸ºäº†æ§åˆ¶å„ä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼Œå†…æ ¸å¿…é¡»æœ‰èƒ½åŠ›æŒ‚èµ·æŸä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹(æ­£åœ¨ä½¿ç”¨cpu)ï¼Œå¹¶å…·æœ‰æ¢å¤ä»¥å‰æŒ‚èµ·è¿›ç¨‹å¹¶æ‰§è¡Œçš„èƒ½åŠ›ã€‚è¿™ç§æŒ‚èµ·ä¸æ¢å¤æ‰§è¡Œå¾€å¾€è¢«ç§°ä¸ºè¿›ç¨‹åˆ‡æ¢ï¼Œä»»ä½•è¿›ç¨‹éƒ½æ˜¯åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ”¯æŒä¸‹æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œè·Ÿå†…æ ¸å¯†åˆ‡ç›¸å…³ã€‚</p>
</li>
<li>
<p>è¿›ç¨‹åˆ‡æ¢å¤§è‡´æ¶‰åŠå†…å®¹ï¼š</p>
<ul>
<li>ä¿å­˜å¤„ç†æœºçš„ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨</li>
<li>æ›´æ–°è¿›ç¨‹PCB(Process Control Block)ä¿¡æ¯</li>
<li>å°†è¿›ç¨‹PCBæ”¾å…¥ç›¸åº”çš„é˜Ÿåˆ—ï¼Œå¦‚å°±ç»ªé˜Ÿåˆ—ï¼ŒæŸäº›æ—¶é—´çš„é˜»å¡ç­‰å¾…é˜Ÿåˆ—ç­‰ç­‰</li>
<li>é€‰æ‹©å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œæ›´æ–°å…¶PCBä¿¡æ¯</li>
<li>æ›´æ–°å†…å­˜ç®¡ç†çš„æ•°æ®ç»“æ„</li>
<li>æ¢å¤å¤„ç†æœºä¸Šä¸‹æ–‡</li>
</ul>
</li>
<li>
<p>linuxä¸€ä¸ªæ³¨é‡Š</p>
<ul>
<li><strong>å½“ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œæ—¶,CPUçš„æ‰€æœ‰å¯„å­˜å™¨ä¸­çš„å€¼ã€è¿›ç¨‹çš„çŠ¶æ€ä»¥åŠå †æ ˆä¸­çš„å†…å®¹è¢«ç§°ä¸ºè¯¥è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚å½“å†…æ ¸éœ€è¦åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒéœ€è¦ä¿å­˜å½“å‰è¿›ç¨‹çš„æ‰€æœ‰çŠ¶æ€ï¼Œå³ä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åœ¨å†æ¬¡æ‰§è¡Œè¯¥è¿›ç¨‹æ—¶ï¼Œèƒ½å¤Ÿå¿…å¾—åˆ°åˆ‡æ¢æ—¶çš„çŠ¶æ€æ‰§è¡Œä¸‹å»ã€‚åœ¨LINUXä¸­ï¼Œå½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡å‡ä¿å­˜åœ¨è¿›ç¨‹çš„ä»»åŠ¡æ•°æ®ç»“æ„ä¸­ã€‚åœ¨å‘ç”Ÿä¸­æ–­æ—¶,å†…æ ¸å°±åœ¨è¢«ä¸­æ–­è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåœ¨å†…æ ¸æ€ä¸‹æ‰§è¡Œä¸­æ–­æœåŠ¡ä¾‹ç¨‹ã€‚ä½†åŒæ—¶ä¼šä¿ç•™æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„èµ„æºï¼Œä»¥ä¾¿ä¸­ç»§æœåŠ¡ç»“æŸæ—¶èƒ½æ¢å¤è¢«ä¸­æ–­è¿›ç¨‹çš„æ‰§è¡Œ</strong></li>
</ul>
</li>
</ul>
<h3 id="è¿›ç¨‹é˜»å¡">è¿›ç¨‹é˜»å¡<a hidden class="anchor" aria-hidden="true" href="#è¿›ç¨‹é˜»å¡">#</a></h3>
<ul>
<li>æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ï¼Œç”±äºç­‰å¾…æŸäº›äº‹ä»¶(ç­‰å¾…ç³»ç»Ÿèµ„æºï¼Œç­‰å¾…æŸç§æ“ä½œå®Œæˆï¼Œæ–°çš„æ•°æ®å°šæœªåˆ°è¾¾æˆ–è€…æ²¡æœ‰æ–°çš„å·¥ä½œç­‰)ï¼Œåˆ™ä¼šæœ‰æ“ä½œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé˜»å¡åŸè¯­(Block),ä½¿è‡ªå·±ç”±è¿è¡ŒçŠ¶æ€å˜ä¸ºé˜»å¡çŠ¶æ€ï¼Œè¿›åº¦é˜»å¡çŠ¶æ€ä¹‹åï¼Œè¿›ç¨‹ä¸å ç”¨cpuèµ„æºï¼Œç­‰å¾…çš„äº‹ä»¶å®Œæˆåå†ç”±å†…æ ¸å°†å…¶å”¤é†’ã€‚</li>
</ul>
<h3 id="æ–‡ä»¶æè¿°ç¬¦">æ–‡ä»¶æè¿°ç¬¦<a hidden class="anchor" aria-hidden="true" href="#æ–‡ä»¶æè¿°ç¬¦">#</a></h3>
<ul>
<li>File Descriptorä¸ºè®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œç”¨äºè¡¨è¿°æŒ‡å‘æ–‡ä»¶çš„å¼•ç”¨</li>
<li>åœ¨å½¢å¼ä¸Šæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªç´¢å¼•å€¼ï¼ŒæŒ‡å‘å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤çš„ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„è®°å½•è¡¨ã€‚</li>
<li>å½“è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå†…æ ¸å°†è¿”å›å…¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</li>
<li>ä¸€äº›ç±»Unixåº•å±‚ç¨‹åºå¾€å¾€ä¼šå›´ç»•æ–‡ä»¶æè¿°ç¬¦å±•å¼€å·¥ä½œ</li>
</ul>
<h3 id="ç¼“å†²io">ç¼“å†²I/O<a hidden class="anchor" aria-hidden="true" href="#ç¼“å†²io">#</a></h3>
<ul>
<li>linuxæœ‰I/Oç¼“å­˜æœºåˆ¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†I/Oæ•°æ®ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„é¡µç¼“å­˜(page catch)ä¸­ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å¾€å¾€å…ˆè¢«æ“ä½œç³»ç»Ÿæ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºï¼Œç„¶åå†ç”±æ“ä½œç³»ç»Ÿå†…æ ¸çš„ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¨‹åºçš„åœ°å€ç©ºé—´ã€‚</li>
<li>ç¼“å­˜I/Oæœºåˆ¶å¯¼è‡´æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´è¿›è¡Œå¤šæ¬¡æ‹·è´ï¼Œè¿™å°±å¿…ç„¶å¯¼è‡´cpuå’Œå†…å­˜å¼€é”€</li>
</ul>
<h2 id="å¸¸è§ioæ¨¡å¼å¤ä¹ ">å¸¸è§I/Oæ¨¡å¼å¤ä¹ <a hidden class="anchor" aria-hidden="true" href="#å¸¸è§ioæ¨¡å¼å¤ä¹ ">#</a></h2>
<ul>
<li>
<p>å°±æ‹¿readè·ç¦»ï¼Œæ•°æ®å…ˆè¢«æ‹·è´åˆ°å†…æ ¸ç¼“å­˜åŒºï¼Œç„¶åå†æ‹·è´åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ä¼šç»è¿‡2ä¸ªé˜¶æ®µ</p>
<ul>
<li>å†…æ ¸ç­‰å¾…æ•°æ®å‡†å¤‡(Waiting for the data to be ready)</li>
<li>æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿›ç¨‹(Copying the data from the kernel to the process)</li>
</ul>
</li>
<li>
<p>æ­£æ˜¯å› ä¸ºI/Oç¼“å­˜æœºåˆ¶å¸¦æ¥çš„2é˜¶æ®µï¼Œæ‰€ä»¥æœ‰äº†linuxç³»ç»Ÿå¸¸è§çš„5ç§I/Oæ¨¡å¼</p>
<ul>
<li>
<p>é˜»å¡I/O ( blocking IO)</p>
</li>
<li>
<p>éé˜»å¡I/O (nonblocking IO)</p>
</li>
<li>
<p>I/Oå¤šè·¯å¤ç”¨ (IO multiplexing)</p>
</li>
<li>
<p>ä¿¡å·é©±åŠ¨I/O (signal driven IO)</p>
</li>
<li>
<p>å¼‚æ­¥I/O ( asynchronous IO)</p>
<p>å…¶ä¸­ä¿¡å·é©±åŠ¨IOå®é™…å¼€å‘ä¸­ç”¨åˆ°çš„ä¸å¤ªå¤šï¼Œä¸‹é¢å¤ä¹ ä¸‹å‡ ä¸ªå¸¸ç”¨çš„IOæ¨¡å¼</p>
</li>
</ul>
</li>
</ul>
<h3 id="blocking-io-é˜»å¡io">Blocking IO é˜»å¡IO<a hidden class="anchor" aria-hidden="true" href="#blocking-io-é˜»å¡io">#</a></h3>
<ul>
<li>
<p>é»˜è®¤linuxæ‰€æœ‰çš„socketéƒ½æ˜¯blockingçš„(æœ‰APIè®¾ç½®ä¸ºnonblocking),å…¸å‹è¯»æ“ä½œæµç¨‹å¦‚ä¸‹:</p>
<p><img loading="lazy" src="http://becool.vip:666/img/BlockingIO_Read_model%e5%9b%be%e8%a7%a3.png" alt=""  />
</p>
</li>
<li>
<p>process call recv/recvform &mdash;&gt;process blocking è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ è¿›ç¨‹é˜»å¡</p>
<ul>
<li>Kernel wait for the data å†…æ ¸ç­‰å¾…ç¼“å†²åŒºæ•°æ®è¾¾åˆ°(ç½‘ç»œIOæ•°æ®åˆ°ç¼“å†²åŒºä¸€èˆ¬éœ€è¦ä¸€å®šæ—¶é—´)  process still blocking</li>
<li>Data is ready ,copy data to user æ•°æ®è¾¾åˆ°å å†…æ ¸å°†å…¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li>
<li>process unblock to run è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œè¿™ä¸ªåœ°æ–¹ä¹Ÿéœ€è¦cpuè°ƒåº¦ï¼Œå…¶å®ä¹Ÿéœ€è¦æ—¶é—´</li>
</ul>
<p>blocking IOçš„ç‰¹ç‚¹å°±æ˜¯IOæ‰§è¡Œçš„2ä¸ªé˜¶æ®µï¼Œè¿›ç¨‹ä¸€è‡´å¤„äºé˜»å¡çŠ¶æ€ ä¸èƒ½æ‰§è¡Œå…¶å®ƒä»»åŠ¡</p>
<p>ä¸‹é¢å†æ‘˜ä¸€ä¸ªå›¾:</p>
<p><img loading="lazy" src="http://becool.vip:666/img/block-read.png" alt=""  />
</p>
</li>
</ul>
<h3 id="nonblocking-io-éé˜»å¡io">NonBlocking IO éé˜»å¡IO<a hidden class="anchor" aria-hidden="true" href="#nonblocking-io-éé˜»å¡io">#</a></h3>
<ul>
<li>å¯ä»¥è°ƒç”¨APIå°†socketè®¾ç½®ä¸ºnon-blocking å¤§è‡´æµç¨‹å¦‚ä¸‹</li>
</ul>
<p><img loading="lazy" src="http://becool.vip:666/img/nonblockingIO_ReadData%e6%b5%81%e7%a8%8b%e5%9b%be%e8%a7%a3.png" alt=""  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>while ( recv(data)!=OK ){//ç³»ç»Ÿè°ƒç”¨recvä¸ä¼šé˜»å¡ï¼Œå¦‚æœdata is not ready,å†…æ ¸ç«‹é©¬è¿”å›å¤±è´¥
</span></span><span style="display:flex;"><span>	wait sometime;//è¿›ç¨‹åˆ¤æ–­å¤±è´¥ å¾€å¾€ä¼‘çœ ä¸€å®šæ—¶é—´ å†æ¬¡è°ƒç”¨recvç³»ç»Ÿè°ƒç”¨
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>å› ä¸ºæ²¡æœ‰é˜»å¡ ç³»ç»Ÿè°ƒç”¨ä¼šç«‹é©¬è¿”å›ï¼Œä½†å¾€å¾€æ•°æ®ä¸ä¼šç«‹é©¬readyï¼Œæ‰€ä»¥éé˜»å¡IOå¾€å¾€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯¢é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½äº†</li>
</ul>
<h3 id="io-multiplexing-ioå¤šè·¯å¤ç”¨">IO multiplexing IOå¤šè·¯å¤ç”¨<a hidden class="anchor" aria-hidden="true" href="#io-multiplexing-ioå¤šè·¯å¤ç”¨">#</a></h3>
<ul>
<li>
<p>è¿™é‡Œå¸¸å¸¸å°±æ˜¯æŒ‡çš„selectã€polã€epollï¼Œå¤šè·¯æ˜¯æŒ‡ç®¡ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤ç”¨æ˜¯æŒ‡åŒä¸€ä¸ªè¿›ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æ€»ç»“èµ·æ¥å°±æ˜¯åŒä¸€ä¸ªè¿›ç¨‹(çº¿ç¨‹)ç®¡ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜IOå¤„ç†æ•ˆç‡çš„æŠ€æœ¯</p>
</li>
<li>
<p>selectæ–¹å¼å¤šè·¯å¤ç”¨å›¾è§£
<img loading="lazy" src="http://becool.vip:666/img/select%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8%e5%9b%be%e8%a7%a3.png" alt=""  />
</p>
<p>selectè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹</p>
<ul>
<li>è¿›ç¨‹é¦–å…ˆè¦å°†éœ€è¦ç®¡ç†çš„æè¿°ç¬¦æ‰”è¿›selecté›†åˆ</li>
<li>è¿›ç¨‹è°ƒç”¨select API(å¾€å¾€ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºä¸è®¾ç½®æ²¡æœ‰æ•°æ®åˆ°è¾¾å°±éœ€è¦å¾ªç¯select)ï¼Œæ­¤æ—¶è¿›ç¨‹è¿›å…¥blockingçŠ¶æ€</li>
<li>å†…æ ¸æ”¶åˆ°apiè°ƒç”¨å°±ä¼šå¾ªç¯ç›‘è§†æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ•°æ®æ˜¯å¦å‡†å¤‡å¥½äº† å¦‚æœæœ‰ä¸€ä¸ªå¥½äº†ï¼Œselectå°±ç«‹é©¬è¿”å›</li>
<li>ç„¶åè¿›ç¨‹æ”¶åˆ°selectè¿”å› å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹</li>
</ul>
</li>
<li>
<p>selectæ¨¡å¼è·Ÿé˜»å¡IOæ¨¡å¼æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œè€Œä¸”æœ‰2æ¬¡ç³»ç»Ÿè°ƒç”¨(selectã€recv)ï¼Œæ™®é€šçš„é˜»å¡åªæœ‰ä¸€ä¸ªrecv,ä½†selectçš„ä¼˜åŠ¿åœ¨äºä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç®¡ç†å¾ˆå¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶å¤„ç†å¤šä¸ªé“¾æ¥(socket conn)</p>
</li>
<li>
<p>å¦‚æœéœ€è¦å¤„ç†çš„è¿æ¥æ•°ä¸é«˜çš„è¯ï¼Œå•ä»»åŠ¡select/poll/epollçš„æœåŠ¡å™¨ ä¸ä¸€å®šæ¯”å¤šä»»åŠ¡çš„blocking IOæ€§èƒ½é«˜ï¼Œå› ä¸ºè®©å†…æ ¸è½®è¯¢æ¯ä¸ªæè¿°ç¬¦ä¹Ÿæ˜¯éœ€è¦èŠ±è´¹æ—¶é—´çš„ï¼Œæœ‰å¯èƒ½å»¶è¿Ÿä¼šæ›´å¤§ï¼ŒIOå¤šè·¯å¤ç”¨çš„ä¼˜åŠ¿åœ¨äºèƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¿æ¥ï¼Œè€Œä¸æ˜¯å•ä¸ªè¿æ¥çš„å¤„ç†é€Ÿåº¦æ›´å¿«ã€‚</p>
</li>
<li>
<p>IOå¤šè·¯å¤ç”¨ä¸‹ä¸€èˆ¬éƒ½å°†socketè®¾ç½®ä¸ºnon-blockingï¼Œè€Œä¸”è¦æ³¨æ„æ­¤æ—¶è¿›ç¨‹è¿˜æ˜¯blockingçš„ åªä¸è¿‡æ˜¯è¢«select/poll/epollè°ƒç”¨blocking,ä¹‹å‰æ˜¯è¢«recvfromè°ƒç”¨blockingï¼Œä½†è¿™ä¸ªblockingçš„ä»£ä»·è¾ƒå°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç®¡ç†æ›´å¤šçš„å¥—æ¥å­—ã€‚</p>
</li>
</ul>
<h3 id="asynchronous-io-å¼‚æ­¥io">Asynchronous IO å¼‚æ­¥IO<a hidden class="anchor" aria-hidden="true" href="#asynchronous-io-å¼‚æ­¥io">#</a></h3>
<ul>
<li>
<p>å¼‚æ­¥IOä¸ªäººæ¥è§¦çš„ä¹Ÿä¸å¤šï¼Œä¹Ÿæ˜¯å¤§è‡´äº†è§£æµç¨‹ï¼Œçœ‹ä¸ªå›¾ï¼š</p>
<p><img loading="lazy" src="http://becool.vip:666/img/AsynchronousIO_%e5%bc%82%e6%ad%a5IO%e6%b5%81%e7%a8%8b%e5%9b%be%e8%a7%a3.png" alt=""  />
</p>
</li>
<li>
<p>ç”¨æˆ·å‘èµ·å¼‚æ­¥readæ“ä½œåï¼Œkernelç›´æ¥è¿”å›ï¼Œè¿›ç¨‹ä¹Ÿè¯¥å¹²å˜›å¹²å˜›ï¼Œæ²¡æœ‰blocking</p>
</li>
<li>
<p>kernelç­‰æ•°æ®readyå copy to userï¼Œç„¶åç»™ç”¨æˆ·è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·(singnal)</p>
</li>
<li>
<p>è¿›ç¨‹æ”¶åˆ°ä¿¡å·ï¼Œè°ƒç”¨æ³¨å†Œçš„å¤„ç†å‡½æ•°è¿›è¡Œæ•°æ®è¯»å–</p>
</li>
<li>
<p>è²Œä¼¼å¼‚æ­¥IOéå¸¸NBï¼Œä½†å…¶å®linuxå¹¶æ²¡æœ‰å®ç°ä¸€ä¸ªå®Œç¾çš„AIOï¼Œè€Œä¸”å¼‚æ­¥IOå¿…é¡»é¢„å…ˆåˆ†é…ç¼“å­˜ï¼Œè¿™ä¸ªå¯èƒ½é€ æˆå†…å­˜æµªè´¹ï¼Œè¿™éƒ½å¯èƒ½æ˜¯AIOæ²¡æœ‰æµè¡Œçš„åŸå› </p>
</li>
</ul>
<h3 id="blockingä¸non-blocking-é˜»å¡ä¸éé˜»å¡">Blockingä¸non-blocking é˜»å¡ä¸éé˜»å¡<a hidden class="anchor" aria-hidden="true" href="#blockingä¸non-blocking-é˜»å¡ä¸éé˜»å¡">#</a></h3>
<ul>
<li>é€šå¸¸æ˜¯è¯´è°ƒç”¨æ“ä½œåï¼Œå¦‚ä½•æ•°æ®å°šæœªåˆ°è¾¾ï¼Œæˆ–è€…ä¸å…·å¤‡æ¡ä»¶ï¼Œkernelæ˜¯å¦è¿”å›ï¼Œå¦‚æœç«‹é©¬è¿”å›(ä¸ç®¡æœ‰æ— æ•°æ®)ï¼Œå°±æ˜¯non-blocking,å¦‚æœkernelç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œæ²¡æœ‰ç«‹é©¬è¿”å›ï¼Œé‚£å°±æ˜¯é˜»å¡</li>
</ul>
<h3 id="synchronous-ioä¸asynchronous-io">Synchronous IOä¸asynchronous IO<a hidden class="anchor" aria-hidden="true" href="#synchronous-ioä¸asynchronous-io">#</a></h3>
<p>Posixå®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>A synchronous I/O operation causes the requesting process to be blocked until that I/O operation completes</li>
<li>An asynchronous I/O operation does not cause the requesting process to be blocked</li>
</ul>
<p>å¦‚æœæ‰§è¡ŒIOæ“ä½œ è¿›ç¨‹è¢«blockå°±æ˜¯åŒæ­¥ï¼Œå¦åˆ™å°±æ˜¯å¼‚æ­¥ ä¸Šé¢çš„4ç§IOæ¨¡å¼ï¼Œé™¤äº†æœ€åçš„AIOéƒ½æ˜¯åŒæ­¥IOï¼ŒIOå¤šè·¯å¤ç”¨è™½ç„¶å°†socketè®¾ç½®ä¸ºnon-blocking,ä½†å…¶å®è°ƒç”¨select/poll/epollè¿˜æ˜¯ä¼šblocking</p>
<h3 id="å‡ ç§ioæ¨¡å¼æ¯”è¾ƒå›¾">å‡ ç§IOæ¨¡å¼æ¯”è¾ƒå›¾<a hidden class="anchor" aria-hidden="true" href="#å‡ ç§ioæ¨¡å¼æ¯”è¾ƒå›¾">#</a></h3>
<p><img loading="lazy" src="http://becool.vip:666/img/IO_Model%e6%af%94%e8%be%83%e5%9b%be.png" alt=""  />
</p>
<h2 id="åŒæ­¥é˜»å¡bio-æœåŠ¡ç«¯å•ä»»åŠ¡">åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å•ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#åŒæ­¥é˜»å¡bio-æœåŠ¡ç«¯å•ä»»åŠ¡">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>listenFd=socket(...);//åˆ›å»ºsocket
</span></span><span style="display:flex;"><span>bind(listenFd,...);//ç»‘å®šç«¯å£
</span></span><span style="display:flex;"><span>listen(listenFd,...);//å¼€å¯ç›‘å¬
</span></span><span style="display:flex;"><span>while(1) {
</span></span><span style="display:flex;"><span>  // accepté˜»å¡
</span></span><span style="display:flex;"><span>  client_fd = accept(listen_fd);//è¿™é‡Œä¼šé˜»å¡ å¯¼è‡´æ²¡æ³•åŠæ—¶å¤„ç†å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯çš„è¯·æ±‚
</span></span><span style="display:flex;"><span>  if (recv(client_fd)) {//è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®  è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚
</span></span><span style="display:flex;"><span>      // logic
</span></span><span style="display:flex;"><span>      send(client_fd,...);//å›åŒ… è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>// è¿™ç§æ¨¡å¼æ•™å­¦å¯ä»¥ï¼Œå®é™…é¡¹ç›®ä¸­æ²¡æ³•å¤„ç†é«˜å¹¶å‘çš„è¯·æ±‚
</span></span></code></pre></div><h2 id="åŒæ­¥éé˜»å¡-æœåŠ¡ç«¯å•ä»»åŠ¡">åŒæ­¥éé˜»å¡ æœåŠ¡ç«¯å•ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#åŒæ­¥éé˜»å¡-æœåŠ¡ç«¯å•ä»»åŠ¡">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>listenFd=socket(...);//åˆ›å»ºsocket
</span></span><span style="display:flex;"><span>setNonblocking(listen_fd)
</span></span><span style="display:flex;"><span>bind(listenFd,...);//ç»‘å®šç«¯å£
</span></span><span style="display:flex;"><span>listen(listenFd,...);//å¼€å¯ç›‘å¬
</span></span><span style="display:flex;"><span>while(1) {
</span></span><span style="display:flex;"><span>  // accepté˜»å¡
</span></span><span style="display:flex;"><span>  client_fd = accept(listen_fd);//è¿™é‡Œä¼šé˜»å¡ å¯¼è‡´æ²¡æ³•åŠæ—¶å¤„ç†å·²ç»è¿æ¥çš„å®¢æˆ·ç«¯çš„è¯·æ±‚
</span></span><span style="display:flex;"><span>  setNonblocking(client_fd)ï¼›//è®¾ç½®ä¸ºéé˜»å¡
</span></span><span style="display:flex;"><span>  fds.add(client_fd);//åŠ å…¥è½®è¯¢é›†åˆ;
</span></span><span style="display:flex;"><span>  for( fd in fds){//å¾ªç¯æ£€æŸ¥
</span></span><span style="display:flex;"><span>  		if (recv(client_fd)) {//è¯»å–å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®  è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚
</span></span><span style="display:flex;"><span>     	 // logic
</span></span><span style="display:flex;"><span>       send(client_fd,...);//å›åŒ… è¿™é‡Œä¹Ÿä¼šé˜»å¡ï¼Œä¼šå¯¼è‡´æ²¡æ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>//å¤„ç†å°é‡å¹¶å‘æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ¯”è¾ƒæµªè´¹cpuï¼Œå› ä¸ºæ¯ä¸€è½®å¾ªç¯éƒ½è¦é’ˆå¯¹æ¯ä¸€ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—æ‰§è¡Œæ£€æŸ¥
</span></span><span style="display:flex;"><span>//åŒæ—¶å› ä¸ºæ˜¯å•ä»»åŠ¡ï¼Œé‡åˆ°é«˜å¹¶å‘è‚¯å®šä¹Ÿè¦æ­‡èœï¼Œå‡è®¾æœ‰1000ä¸ªclientï¼Œç¬¬ä¸€ä¸ªå‘é€äº†è¯·æ±‚ï¼Œä½†æ˜¯forå¾ªç¯æ£€æŸ¥çš„æ—¶å€™è·³è¿‡äº†ï¼Œç„¶åè¦ç­‰åˆ°å…¶å®ƒ999ä¸ªè¿æ¥éƒ½æ£€æŸ¥å¤„ç†å®Œäº†ï¼Œæ‰èƒ½è½®åˆ°è¿™ä¸ªclientï¼Œå¾ˆæœ‰å¯èƒ½å·²ç»è¶…æ—¶äº†
</span></span></code></pre></div><h2 id="åŒæ­¥é˜»å¡bio-æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡">åŒæ­¥é˜»å¡BIO æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡<a hidden class="anchor" aria-hidden="true" href="#åŒæ­¥é˜»å¡bio-æœåŠ¡ç«¯å¤šå¹¶å‘ä»»åŠ¡">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>listenFd=socket(...);//åˆ›å»ºsocket
</span></span><span style="display:flex;"><span>bind(listenFd,...);//ç»‘å®šç«¯å£
</span></span><span style="display:flex;"><span>listen(listenFd,...);//å¼€å¯ç›‘å¬
</span></span><span style="display:flex;"><span>while(1) {
</span></span><span style="display:flex;"><span>  // accepté˜»å¡
</span></span><span style="display:flex;"><span>  client_fd = accept(listen_fd);//ä¸»è¿›ç¨‹ æˆ–è€…ä¸»çº¿ç¨‹åªè´Ÿè´£acceptæ–°çš„clientè¿æ¥
</span></span><span style="display:flex;"><span>  new ThreadProcess(client_fd){//è¿™é‡Œå¼€å¯å¤šä»»åŠ¡(å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹)ï¼Œä¸€ä¸ªclientä¸€ä¸ªå¤„ç†ä»»åŠ¡çº¿ç¨‹(è¿›ç¨‹)
</span></span><span style="display:flex;"><span>  		if (recv(fd)) {//
</span></span><span style="display:flex;"><span>      		// logic process
</span></span><span style="display:flex;"><span>      		send(client_fd,...);//å›åŒ… 
</span></span><span style="display:flex;"><span>    	}
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>//å¹¶å‘é‡ä¸æ˜¯å¾ˆå¤§çš„æ—¶å€™ï¼Œè¿™ç§æ¨¡å¼æ˜¯èƒ½å¤Ÿè‰¯å¥½åº”å¯¹çš„ï¼Œä½†å¦‚æœå¹¶å‘é‡å¾ˆå¤§ï¼Œæ¯”å¦‚ä¸Šä¸‡ï¼Œå¤§é‡çš„çº¿ç¨‹æˆ–è€…è¿›ç¨‹ä¹Ÿä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œè€Œä¸”è¿›ç¨‹åˆ‡æ¢æˆ–è€…çº¿ç¨‹åˆ‡æ¢éƒ½ä¼šæµªè´¹cpuï¼Œå°±ä¼šå¯¼è‡´çœŸæ­£å·¥ä½œçš„ä»»åŠ¡æ¯”ä¾‹å¾€å¾€å¾ˆä½ï¼Œæ‰€ä»¥è¿™ç§æ¨¡å¼é‡åˆ°çœŸæ­£é«˜å¹¶å‘ä¹Ÿä¼šæ­‡èœã€‚
</span></span><span style="display:flex;"><span>//ç”¨goè¯­è¨€å®ç°ä¸€ä¸ªè¿™æ ·çš„æ¨¡å¼éå¸¸ç®€å• æ¥ä¸€ä¸ªclientå°±å¼€å¯ä¸€ä¸ªroutineå»å¤„ç†å³å¯
</span></span></code></pre></div><h2 id="ioå¤šè·¯å¤ç”¨---select">IOå¤šè·¯å¤ç”¨&mdash;select<a hidden class="anchor" aria-hidden="true" href="#ioå¤šè·¯å¤ç”¨---select">#</a></h2>
<h3 id="apiåŸå‹">APIåŸå‹<a hidden class="anchor" aria-hidden="true" href="#apiåŸå‹">#</a></h3>
<ul>
<li>//å°†ä¸€ä¸ªfdä»å…³å¿ƒçš„fdsetä¸­ç§»é™¤ å…¶å®å°±æ˜¯å°†å¯¹åº”çš„å‘ä½ç½®0
void	FD_CLR(fd, fd_set *fdset);</li>
<li>// æ£€æŸ¥fdæ˜¯å¦åœ¨å¯¹åº”çš„fdsetä¸­ ä¹Ÿå°±æ˜¯æ£€æŸ¥å¯¹åº”çš„å‘ä½æ˜¯å¦ä¸º1
int		FD_ISSET(fd, fd_set *fdset);</li>
<li>//å°†fdå¢åŠ åˆ°è¦å…³å¿ƒçš„fdseté›†åˆä¸­ ä¹Ÿå°±æ˜¯å°†å¯¹åº”fdsetå‘ä½ç½®1 æ¯”å¦‚å®¢æˆ·ç«¯socket fdä¸º9ï¼Œå°±æ˜¯å°†fdset[9]è®¾ç½®ä¸º1
void	FD_SET(fd, fd_set *fdset);</li>
<li>// æ¸…ç©ºè¦å…³å¿ƒçš„fdseté›†åˆ å°†fdsetæ•°ç»„å…¨éƒ¨ç½®0
void	FD_ZERO(fd_set *fdset);</li>
<li>//	nfdsä¸ºæœ€å¤§æ£€æŸ¥æè¿°ç¬¦ selectå°†å¯¹fdsetæ•°ç»„0&mdash;&gt;ndfsä¸‹æ ‡åšæ£€æŸ¥ å¦‚æœä¸‹æ ‡å¯¹åº”çš„valueä¸º1 åˆ™éœ€è¦æ£€æŸ¥æè¿°ç¬¦æ˜¯å¦å…·å¤‡æ¡ä»¶äº† ä¸ç”¨1024ä¸ªéƒ½æ£€æŸ¥ï¼Œä¼ å…¥è¿™ä¸ªæœ€å¤§æ£€æŸ¥æè¿°ç¬¦æ˜¯ä¸ºäº†æé«˜selectè½®è¯¢çš„æ•ˆç‡
//readfdsä¸ºå…³å¿ƒè¯»äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ writefdsä¸ºå…³å¿ƒå†™äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ errorfdsä¸ºå…³å¿ƒå¼‚å¸¸äº‹ä»¶çš„æè¿°ç¬¦é›†åˆ
//timeoutä¸ºä¸€ä¸ªç»“æ„ä½“ å¦‚ä½•è®¾ç½®ä¸ºnullï¼Œåˆ™å¯¹åº”3ä¸ªfdsetè‹¥éƒ½æ²¡æœ‰å°±ç»ªçš„æè¿°ç¬¦ è¿›ç¨‹å°†ä¸€ç›´blocking
//timeoutå¦‚æœè®¾ç½®ä¸º0 åˆ™selectæ£€æŸ¥ä¸€è½®å°†ç›´æ¥è¿”å› ä¸ä¼šç­‰å¾…
//timeoutå¦‚æœè®¾ç½®ä¸ºå…·ä½“çš„ç§’+å¾®ç§’ åˆ™selectæœ€å¤šç­‰å¾…è®¾ç½®çš„æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰å°±è¿”å›
//åŒæ—¶è¦è¯´æ˜çš„æ˜¯selectæ˜¯è½®è¯¢æ‰€æœ‰è®¾ç½®fdsetä¸­çš„æ‰€æœ‰valueä¸º1çš„æè¿°ç¬¦ï¼Œå¦‚ä½•ç¬¦åˆè¦æ±‚å°±å…¨éƒ¨éƒ½è¿”å›
int		select(int nfds, fd_set *restrict readfds, fd_set *restrict writefds, fd_set *restrict errorfds,
struct timeval *restrict timeout);</li>
<li>å…³äº fd_setä¸€èˆ¬æ˜¯ä¸€ä¸ªintç±»å‹æ•°ç»„ ä¸€èˆ¬åˆå§‹åŒ–å¤§å°ä¸º1024 ç”¨æ¥ä¿å­˜å“ªäº›fdéœ€è¦æ£€æŸ¥ï¼Œè¿™ä¸ª1024æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œä½†æ¯”è¾ƒéº»çƒ¦è¿™ä¹Ÿæ˜¯selectä¸è¶³çš„åœ°æ–¹ï¼Œè€Œä¸”èƒ½ç›‘æ§çš„ä¸€èˆ¬æ²¡æœ‰1024ï¼Œå› ä¸ºè¿›ç¨‹æˆ–è€…çº¿ç¨‹ä¸€èˆ¬éƒ½æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯”å¦‚æ ‡å‡†è¾“å…¥è¾“å‡ºå‡ºé”™ï¼Œæˆ–è€…æ‰“å¼€çš„æœ‰æ—¥å¿—æ–‡ä»¶ç­‰ç­‰ã€‚</li>
</ul>
<h3 id="ä¸è¶³">ä¸è¶³<a hidden class="anchor" aria-hidden="true" href="#ä¸è¶³">#</a></h3>
<ul>
<li>èƒ½ç›‘æ§çš„æè¿°ç¬¦æ•°é‡æœ‰é™ ä¿®æ”¹èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦</li>
<li>æ¯æ¬¡selectéƒ½éœ€è¦å…¨éƒ¨è®¾ç½®ä¸€ééœ€è¦å…³å¿ƒçš„fdseté›†åˆï¼Œè¿™å°±æ¶‰åŠåˆ°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ‹·è´ æ•ˆç‡ä¸ä¼šå¾ˆé«˜</li>
<li>selectå†…éƒ¨å®ç°æ˜¯è½®è¯¢ï¼Œä¸ç®¡æè¿°ç¬¦å¯¹åº”æ˜¯å¦å°±ç»ªï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿä¸ä¼šå¤ªé«˜ ï¼Œå½“ç„¶å¦‚æœç›‘æ§çš„å¥—æ¥å­—éƒ½éå¸¸æ´»è·ƒï¼Œé‚£è¿™ä¸ªè½®è¯¢æ€§èƒ½é—®é¢˜ä¹Ÿå¯ä»¥å¿½ç•¥(ä½†æ­£æ˜¯å› ä¸ºéƒ½éå¸¸æ´»è·ƒï¼Œæ‰€ä»¥selectè¿”å›åå•ä»»åŠ¡å¤„ç†ä¹Ÿä¼šé‡åˆ°ç“¶é¢ˆï¼Œå› ä¸ºå¤§é‡æ´»è·ƒçš„è¿æ¥ç­‰å¾…å¤„ç†ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªå•ä»»åŠ¡è¿›ç¨‹/çº¿ç¨‹åœ¨å¤„ç†)</li>
</ul>
<h3 id="å…¶å®ƒè¯´æ˜">å…¶å®ƒè¯´æ˜<a hidden class="anchor" aria-hidden="true" href="#å…¶å®ƒè¯´æ˜">#</a></h3>
<ul>
<li>selectç›‘æ§çš„socketfd è·Ÿsocketfdæœ¬èº«æ˜¯å¦æ˜¯blockingæ²¡æœ‰å…³ç³»ï¼Œæ‰€æœ‰å¥—æ¥å­—æ˜¯é˜»å¡æ—¶çœŸæ­£recvæˆ–è€…writeçš„æ—¶å€™ å¦‚æœæ•°æ®ä¸å…·å¤‡æ¡ä»¶åˆ™å†…æ ¸ç›´æ¥è¿”å›æˆ–è€…é˜»å¡ç­‰å¾…ï¼Œselelctåªæ˜¯æ£€æŸ¥æ•°æ®æ˜¯å¦å…·å¤‡è¯»æ¡ä»¶äº†ï¼Œæ²¡æœ‰å‘ç”ŸçœŸæ­£è¯»å†™ï¼Œè€Œä¸”æ˜¯å†…æ ¸ç›´æ¥åˆ¤æ–­è¯»å†™ç¼“å†²åŒºæ˜¯å¦ç¬¦åˆæ¡ä»¶çš„</li>
<li>ä½†ä¸èƒ½è¯´è°ƒç”¨selectçš„è¿›ç¨‹æ˜¯ä¸é˜»å¡çš„ï¼Œç†è®ºä¸Šè°ƒç”¨äº†selectä¹Ÿæ˜¯ä¸€ç›´é˜»å¡çš„ï¼Œåªæ˜¯é˜»å¡æ—¶é—´çš„é•¿çŸ­(timeoutè®¾ç½®ä¸º0 åªè½®è¯¢ä¸€æ¬¡å°±è¿”å›ï¼Œå¦‚æœä¸ºnullï¼Œæ— é™ç­‰å¾…ç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªå¥—æ¥å­—ç¬¦åˆæ¡ä»¶ï¼Œå¦‚æœè®¾ç½®ä¸ºå…·ä½“æ—¶é—´ï¼Œåˆ™æœ€å¤šç­‰å¾…è¿™ä¸ªè®¾ç½®æ—¶é—´)ï¼Œåªæ˜¯è¿›ç¨‹ä¸æ˜¯å› ä¸ºè°ƒç”¨recvæˆ–è€…writeé˜»å¡ï¼Œè€Œæ˜¯è°ƒç”¨selecté˜»å¡ï¼Œè€Œä¸”è¿”å›çš„å¯ä»¥æ˜¯å¤šä¸ªç¬¦åˆè¯»å†™çš„fdã€‚</li>
</ul>
<h3 id="ä»£ç ">ä»£ç <a hidden class="anchor" aria-hidden="true" href="#ä»£ç ">#</a></h3>
<details>
  <summary>selectç¤ºä¾‹ä»£ç è½¬è½½åŠ æ³¨é‡Šï¼Œç®€å•ä¼˜åŒ–c</summary>
  ```c
  #include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <netinet/in.h>
#include <sys/socket.h>
#include <sys/select.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <assert.h>
#define IPADDR      "127.0.0.1"
#define PORT        8787
#define MAXLINE     1024
#define LISTENQ     5
#define MAXCLIENTSIZE        10
//å½“å‰å¥—æ¥å­—è¿æ¥ä¿¡æ¯ç»“æ„ä½“
typedef struct server_context_st
{
    int cli_cnt;        /*å·²è¿æ¥è¿‡çš„å®¢æˆ·ç«¯ä¸ªæ•°*/
    int clifds[MAXCLIENTSIZE];   /*å®¢æˆ·ç«¯å¥—æ¥å­—é›†åˆ*/
    fd_set allfds;      /*å¥æŸ„é›†åˆ*/
    int maxfd;          /*å¥æŸ„æœ€å¤§å€¼*/
} server_context_st;
static server_context_st *s_srv_ctx = NULL;
/*===========================================================================
createSocketAndListen æ ¹æ®ä¼ å…¥å­—ç¬¦ä¸²æ ¼å¼ipå’Œç«¯å£portï¼Œåˆ›å»ºsocketå¹¶ä¸”å¼€å¯ç›‘å¬ 
 * ==========================================================================*/
static int createSocketAndListen(const char* ip,int port){
    int  fd;
    struct sockaddr_in servaddr;
    //int socket(int domain, int type, int protocol);
    fd = socket(AF_INET, SOCK_STREAM,0);
    if (fd == -1) {
        fprintf(stderr, "create socket fail,erron:%d,reason:%s\n",
                errno, strerror(errno));
        return -1;
    }
    /*ä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸€æ®µæ—¶é—´å(æ¯”å¦‚ä¸¤åˆ†é’Ÿ)æ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚*/
    int reuse = 1;
    if (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse)) == -1) {
        return -1;
    }
    //å¥—æ¥å­—ç»“æ„ä½“åˆå§‹åŒ–ä¸º0
    bzero(&servaddr,sizeof(servaddr));
    servaddr.sin_family = AF_INET;
    //ip ASCIIå­—ç¬¦ä¸²è½¬ä¸ºäºŒè¿›åˆ¶
    inet_pton(AF_INET,ip,&servaddr.sin_addr);
    //portè½¬ä¸ºç½‘ç»œå­—èŠ‚åº
    servaddr.sin_port = htons(port);
    //å¥—æ¥å­—ç»‘å®šipå’Œç«¯å£
    if (bind(fd,(struct sockaddr*)&servaddr,sizeof(servaddr)) == -1) {
        perror("bind error: ");
        return -1;
    }
    //å¼€å¯ç›‘å¬
    if ( listen(fd,LISTENQ) == -1){
        perror("listen error: ");
        return -1;
    }
    return fd;
}
/*===========================================================================
accept_client_proc ä¼ å…¥æœåŠ¡ç«¯ç›‘å¬å¥—æ¥å­—ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ 
 * ==========================================================================*/
static int accept_client_proc(int srvfd)
{
    struct sockaddr_in cliaddr;
    socklen_t cliaddrlen;
    cliaddrlen = sizeof(cliaddr);
    int clifd = -1;
    printf("accpet clint proc is called.\n");
ACCEPT:
    clifd = accept(srvfd,(struct sockaddr*)&cliaddr,&cliaddrlen);
    if (clifd == -1) {
        if (errno == EINTR) {
            goto ACCEPT;
        } else {
            fprintf(stderr, "accept fail,error:%s\n", strerror(errno));
            return -1;
        }
    }
    //æ‰“å°å®¢æˆ·ç«¯å¥—æ¥å­—ä¿¡æ¯
    fprintf(stdout, "accept a new client: %s:%d\n",
            inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port);
    //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­
    int i = 0;
    for (i = 0; i < MAXCLIENTSIZE; i++) {
        if (s_srv_ctx->clifds[i] < 0) {
            s_srv_ctx->clifds[i] = clifd;
            s_srv_ctx->cli_cnt++;
            break;
        }
    }
    //å·²ç»è¾¾åˆ°æœ€å¤§è¿æ¥æ•° æ‰“å°é”™è¯¯æ—¥å¿—æŠ¥é”™è¿”å›
    if (i == MAXCLIENTSIZE) {
        fprintf(stderr,"too many clients.\n");
        return -1;
    }
    return 0;
}
/*===========================================================================
handle_client_msg ä¼ å…¥å®¢æˆ·ç«¯å¥—æ¥å­—å’Œç¼“å­˜ å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯ å®ç°å›å°„ 
 * ==========================================================================*/
static int handle_client_msg(int fd, char *buf)
{
    assert(buf);
    printf("recv buf is :%s\n", buf);//æ‰“å°å®¢æˆ·ç«¯æ¶ˆæ¯
    if ( write(fd, buf, strlen(buf) +1) <0){
        perror("write to client error");
        return -1;
    }//å¹¶åŸæ ·è¿”å›ç»™å®¢æˆ·ç«¯
    return 0;
}
/*===========================================================================
recv_client_msg ä¼ å…¥fdsetæŒ‡é’ˆ å¤„ç†å¯è¯»çš„å®¢æˆ·ç«¯å¥—æ¥å­—
 * ==========================================================================*/
static void recv_client_msg(fd_set *readfds)
{
    int i = 0, n = 0;
    int clifd;
    char buf[MAXLINE] = {0};
    for (i = 0;i <= s_srv_ctx->cli_cnt;i++) {
        clifd = s_srv_ctx->clifds[i];
        if (clifd < 0) {
            continue;
        }
        /*åˆ¤æ–­å®¢æˆ·ç«¯å¥—æ¥å­—æ˜¯å¦æœ‰æ•°æ®*/
        if (FD_ISSET(clifd, readfds)) {
            //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯
            n = read(clifd, buf, MAXLINE);
            if (n <= 0) {
                /*n==0è¡¨ç¤ºè¯»å–å®Œæˆï¼Œå®¢æˆ·éƒ½å…³é—­å¥—æ¥å­—*/
                FD_CLR(clifd, &s_srv_ctx->allfds);
                close(clifd);
                s_srv_ctx->clifds[i] = -1;
                continue;
            }
            //å›ä¼ ç»™å®¢æˆ·ç«¯
            handle_client_msg(clifd, buf);
        }
    }
}
/*===========================================================================
handle_client_proc ä¸»å¤„ç†å‡½æ•° ä¼ å…¥ç›‘å¬å¥—æ¥å­— æ¥å—å®¢æˆ·ç«¯è¿æ¥ é€ä¸ªå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
 * ==========================================================================*/
static void handle_client_proc(int srvfd)
{
    int  clifd = -1;
    int  retval = 0;
    fd_set *readfds = &s_srv_ctx->allfds;
    struct timeval tv;
    int i = 0;
    while (1) {
        /*æ¯æ¬¡è°ƒç”¨selectå‰éƒ½è¦é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´ï¼Œå› ä¸ºäº‹ä»¶å‘ç”Ÿåï¼Œæ–‡ä»¶æè¿°ç¬¦å’Œæ—¶é—´éƒ½è¢«å†…æ ¸ä¿®æ”¹å•¦ è¿™ä¸ªä¹Ÿæ˜¯ä½¿ç”¨selectçš„ç¼ºç‚¹*/
        FD_ZERO(readfds);
        /*æ·»åŠ ç›‘å¬å¥—æ¥å­—*/
        FD_SET(srvfd, readfds);
        s_srv_ctx->maxfd = srvfd;
        tv.tv_sec = 30;//è¶…æ—¶æ—¶é—´30ç§’
        tv.tv_usec = 0;
        /*æ·»åŠ å®¢æˆ·ç«¯å¥—æ¥å­—*/
        for (i = 0; i < s_srv_ctx->cli_cnt; i++) {
            clifd = s_srv_ctx->clifds[i];
            /*å»é™¤æ— æ•ˆçš„å®¢æˆ·ç«¯å¥æŸ„ æ¯”å¦‚å®¢æˆ·ç«¯å·²ç»close*/
            if (clifd != -1) {
                FD_SET(clifd, readfds);
            }
            //è®¡ç®—æœ€å¤§fd
            s_srv_ctx->maxfd = (clifd > s_srv_ctx->maxfd ? clifd : s_srv_ctx->maxfd);
        }
        /*å¼€å§‹è½®è¯¢æ¥æ”¶å¤„ç†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—*/
        retval = select(s_srv_ctx->maxfd + 1, readfds, NULL, NULL, &tv);
        if (retval == -1) {
            fprintf(stderr, "select error:%s.\n", strerror(errno));
            return;
        }
        if (retval == 0) {
            fprintf(stdout, "select is timeout.\n");
            continue;
        }
        if (FD_ISSET(srvfd, readfds)) {
            /*ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/
            accept_client_proc(srvfd);
        } else {
            /*æ¥å—å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯*/
            recv_client_msg(readfds);
        }
    }
}
/*===========================================================================
server_uninit ç¨‹åºé€€å‡ºå‰ç›¸å…³å·¥ä½œå¤„ç†
 * ==========================================================================*/
static void server_uninit()
{
    if (s_srv_ctx) {
        free(s_srv_ctx);
        s_srv_ctx = NULL;
    }
}
/*===========================================================================
server_init æœåŠ¡å™¨åˆå§‹åŒ–ä¸»è¦æ˜¯åˆå§‹åŒ–å¥—æ¥å­—ç®¡ç†ç»“æ„ä½“
 * ==========================================================================*/
static int server_init()
{
    //ç”³è¯·å†…å­˜
    s_srv_ctx = (server_context_st *)malloc(sizeof(server_context_st));
    if (s_srv_ctx == NULL) {
        return -1;
    }
    //memsetåˆå§‹åŒ–
    memset(s_srv_ctx, 0, sizeof(server_context_st));
    //åˆå§‹åŒ–å®¢æˆ·ç«¯å¥—æ¥å­—å…·æŸ„ä¸º-1
    int i = 0;//æœ€å¤§å¤„ç†å®¢æˆ·ç«¯ä¸ºMAXCLIENTSIZE
    for (;i < MAXCLIENTSIZE; i++) {
        s_srv_ctx->clifds[i] = -1;
    }
    return 0;
}
//mainå‡½æ•°
int main(int argc,char *argv[])
{
    int  srvfd;
    /*åˆå§‹åŒ–æœåŠ¡ç«¯context*/
    if (server_init() < 0) {
        return -1;
    }
    /*åˆ›å»ºæœåŠ¡,å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚*/
    srvfd = createSocketAndListen(IPADDR, PORT);
    if (srvfd < 0) {
        fprintf(stderr, "socket create or bind fail.\n");
        goto err;
    }
    /*å¼€å§‹æ¥æ”¶å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ è¿›å…¥ä¸»å‡½æ•°å¤„ç†*/
    handle_client_proc(srvfd);
    //å‡†å¤‡é€€å‡º é€€å‡ºå‰å·¥ä½œå¤„ç†
    server_uninit();
    return 0;
err:
    server_uninit();
    return -1;
}
  ```
</details>
<h2 id="ioå¤šè·¯å¤ç”¨---poll">IOå¤šè·¯å¤ç”¨&mdash;poll<a hidden class="anchor" aria-hidden="true" href="#ioå¤šè·¯å¤ç”¨---poll">#</a></h2>
<h3 id="apiåŸå‹-1">APIåŸå‹<a hidden class="anchor" aria-hidden="true" href="#apiåŸå‹-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># include &lt;poll.h&gt;
</span></span><span style="display:flex;"><span>int poll ( struct pollfd * fds, unsigned int nfds, int timeout);
</span></span><span style="display:flex;"><span>struct pollfd {
</span></span><span style="display:flex;"><span>int fd;         /* è¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ å¦‚æœä¸ºè´Ÿå€¼ å†…æ ¸ä¼šç›´æ¥å¿½ç•¥ å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸º-1 è®©å†…æ ¸ä¸å†ç›‘æ§*/
</span></span><span style="display:flex;"><span>short events;         /* æœŸå¾…ç­‰å¾…çš„äº‹ä»¶ */
</span></span><span style="display:flex;"><span>short revents;       /* å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ */
</span></span><span style="display:flex;"><span>} ; 
</span></span></code></pre></div><ul>
<li>
<p>pollè·Ÿselectæ•´ä½“æœºåˆ¶æ˜¯ä¸€æ ·çš„ ä¹Ÿæ˜¯ä¼ å…¥éœ€è¦ç›‘æ§çš„fdé›†åˆ ç„¶åè½®è¯¢ åªæ˜¯æ•°æ®ç»“æ„ä¸æ˜¯ç”¨intæ•°ç»„ï¼Œè€Œæ˜¯æ”¹ä¸ºpollfdç»“æ„ä½“æ•°ç»„ï¼Œæ‰€ä»¥æ²¡æœ‰äº†å¤§å°æ•°é‡é™åˆ¶ï¼Œå¯¹äºæ¯ä¸ªå…³å¿ƒçš„æè¿°ç¬¦å¯ä»¥æ›´çµæ´»çš„è®¾ç½®æœŸå¾…æ—¶é—´ ä»£ç ä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»</p>
</li>
<li>
<p>ç¬¬ä¸€ä¸ªå‚æ•°fdsä¸ºéœ€è¦ç›‘æ§çš„fdä¿¡æ¯ç»“æ„ä½“æ•°ç»„æŒ‡é’ˆ æ¯æ¬¡pollä¹‹å‰éƒ½å¯ä»¥åŠ¨æ€çš„æ·»åŠ æˆ–è€…ç§»é™¤(é€šå¸¸ç›´æ¥è®¾ç½®å¯¹åº”çš„fdä¸º-1)</p>
</li>
<li>
<p>nfdsä¸ºç¬¬ä¸€ä¸ªå‚æ•°fdsçš„sizeä¹Ÿå°±æ˜¯éœ€è¦ç›‘æ§çš„fdçš„ä¸ªæ•°</p>
</li>
<li>
<p>timeoutä¸ºè¶…æ—¶æ—¶é—´</p>
<ul>
<li>
<p>If timeout is greater than zero, it specifies a maximum interval (in milliseconds) to wait for any file descriptor to</p>
<p>become ready.  &gt;0 å•ä½æ¯«ç§’ å†…æ ¸æœ€å¤šç­‰å¾…timeoutæ¯«ç§’</p>
</li>
<li>
<p>If timeout is zero, then <strong>poll</strong>() will return without blocking.  =0 å¦‚æœæ²¡æœ‰æè¿°ç¬¦å°±ä½ï¼Œç›´æ¥è¿”å›ä¸é˜»å¡ï¼Œå¦‚æœæœ‰å°±ä½çš„å°±ä¼šç«‹é©¬è¿”å›</p>
</li>
<li>
<p>If the value of timeout is -1, the poll blocks indefinitely å¦‚æœæ˜¯-1ï¼Œåˆ™ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è‡³å°‘ä¸€ä¸ªæè¿°ç¬¦æœŸå¾…çš„äº‹ä»¶å‘ç”Ÿ</p>
</li>
</ul>
</li>
<li>
<p>pollfdå¯¹åº”çš„eventså’Œreventså–å€¼è§£é‡Š</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th><strong>events</strong></th>
<th><strong>revents</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>äº‹ä»¶</strong></td>
<td><strong>æè¿°</strong></td>
<td><strong>å¯ä½œä¸ºè¾“å…¥</strong></td>
<td><strong>å¯ä½œä¸ºè¾“å‡º</strong></td>
</tr>
<tr>
<td>POLLIN</td>
<td>æ•°æ®å¯è¯»ï¼ˆåŒ…æ‹¬æ™®é€šæ•°æ®&amp;ä¼˜å…ˆæ•°æ®ï¼‰</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLOUT</td>
<td>æ•°æ®å¯å†™ï¼ˆæ™®é€šæ•°æ®&amp;ä¼˜å…ˆæ•°æ®ï¼‰</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLRDNORM</td>
<td>æ™®é€šæ•°æ®å¯è¯»</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLRDBAND</td>
<td>ä¼˜å…ˆçº§å¸¦æ•°æ®å¯è¯»ï¼ˆlinuxä¸æ”¯æŒï¼‰</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLPRI</td>
<td>é«˜ä¼˜å…ˆçº§æ•°æ®å¯è¯»ï¼Œæ¯”å¦‚TCPå¸¦å¤–æ•°æ®</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLWRNORM</td>
<td>æ™®é€šæ•°æ®å¯å†™</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLWRBAND</td>
<td>ä¼˜å…ˆçº§å¸¦æ•°æ®å¯å†™</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLRDHUP</td>
<td>TCPè¿æ¥è¢«å¯¹ç«¯å…³é—­ï¼Œæˆ–è€…å…³é—­äº†å†™æ“ä½œï¼Œç”±GNUå¼•å…¥</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POPPHUP</td>
<td>æŒ‚èµ·</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLERR</td>
<td>é”™è¯¯</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>POLLNVAL</td>
<td>æ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰æ‰“å¼€</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>å¯èƒ½çš„è¿”å›ç </p>
<ul>
<li>æ­£å¸¸è¿”å›fdsæ•°ç»„ä¸­reventsä¸ä¸º0çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°</li>
<li>å¦‚æœè¶…æ—¶ä¹‹å‰æ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿ åˆ™pollè¿”å›0</li>
<li>å¤±è´¥æ—¶ pollè¿”å›-1 errnoè®¾ç½®å¦‚ä¸‹ï¼š ä¸åŒosè¿”å›ç å¯èƒ½ä¸ä¸€è‡´ å¯ä»¥manä¸‹
<ul>
<li>EBADFã€€ã€€    ä¸€ä¸ªæˆ–å¤šä¸ªç»“æ„ä½“ä¸­æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆ</li>
<li>EFAULTã€€ã€€ æŒ‡é’ˆæŒ‡å‘çš„åœ°å€è¶…å‡ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</li>
<li>EINTRã€€ã€€ã€€ã€€  è¯·æ±‚çš„äº‹ä»¶ä¹‹å‰äº§ç”Ÿä¸€ä¸ªä¿¡å·ï¼Œè°ƒç”¨å¯ä»¥é‡æ–°å‘èµ·</li>
<li>EINVALã€€ã€€å‚æ•°è¶…å‡ºPLIMIT_NOFILEå€¼</li>
<li>ENOMEMã€€ã€€   å¯ç”¨å†…å­˜ä¸è¶³ï¼Œæ— æ³•å®Œæˆè¯·æ±‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ä¸è¶³åŠæ”¹è¿›">ä¸è¶³åŠæ”¹è¿›<a hidden class="anchor" aria-hidden="true" href="#ä¸è¶³åŠæ”¹è¿›">#</a></h3>
<ul>
<li>ç›¸æ¯”select æ²¡æœ‰äº†æ•°é‡çš„é™åˆ¶ æ­¤ä¸ºæ”¹è¿›</li>
<li>æ¯æ¬¡poll fdæ•°ç»„éƒ½è¦ç»è¿‡ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ æ€§èƒ½è¿˜æ˜¯ä¼šå—å½±å“</li>
<li>è¿˜æ˜¯è½®è¯¢æœºåˆ¶ ç›‘æ§çš„fdæ•°é‡å¦‚æœå¤ªå¤š ä¸è®ºæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ª å¼€é”€éšç€ç›‘æ§æ•°é‡å¢åŠ è€Œçº¿æ€§å¢å¤§</li>
</ul>
<h3 id="ä»£ç -1">ä»£ç <a hidden class="anchor" aria-hidden="true" href="#ä»£ç -1">#</a></h3>
<details>
  <summary>pollç¤ºä¾‹ä»£ç _è½¬è½½æ•´ç†åŠ æ³¨é‡Šã€ç®€å•ä¼˜åŒ– C</summary>
  ```c
  #include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <netinet/in.h>
#include <sys/socket.h>
#include <poll.h>
#include <unistd.h>
#include <sys/types.h>
#include <arpa/inet.h>
#define IPADDRESS   "127.0.0.1"
#define PORT        8787
#define MAXLINE     1024
#define LISTENQ     5
#define OPEN_MAX    1000
#define INFTIM      -1
//å‡½æ•°å£°æ˜
//åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®šç„¶åå¯åŠ¨ç›‘å¬
static int createSocketAndListen(const char* ip,int port);
//IOå¤šè·¯å¤ç”¨poll
static void do_poll(int listenfd);
//å¤„ç†å¤šä¸ªè¿æ¥
static void handle_connection(struct pollfd *connfds,int num);
int main(int argc,char *argv[])
{
    int  listenfd,connfd,sockfd;
    struct sockaddr_in cliaddr;
    socklen_t cliaddrlen;
    listenfd = createSocketAndListen(IPADDRESS,PORT);
    do_poll(listenfd);
    return 0;
}
/*===========================================================================
createSocketAndListen æ ¹æ®ä¼ å…¥å­—ç¬¦ä¸²æ ¼å¼ipå’Œç«¯å£portï¼Œåˆ›å»ºsocketå¹¶ä¸”å¼€å¯ç›‘å¬ 
 * ==========================================================================*/
static int createSocketAndListen(const char* ip,int port)
{
    int  listenfd;
    struct sockaddr_in servaddr;
    listenfd = socket(AF_INET,SOCK_STREAM,0);
    if (listenfd == -1)
    {
        perror("socket error:");
        exit(1);
    }
    bzero(&servaddr,sizeof(servaddr));
    servaddr.sin_family = AF_INET;
    inet_pton(AF_INET,ip,&servaddr.sin_addr);
    servaddr.sin_port = htons(port);
    if (bind(listenfd,(struct sockaddr*)&servaddr,sizeof(servaddr)) == -1)
    {
        perror("bind error: ");
        exit(1);
    }
    //å¼€å¯ç›‘å¬
    if ( listen(listenfd,LISTENQ) == -1){
        perror("listen error: ");
        exit(1);
    }
    return listenfd;
}
/*===========================================================================
do_poll ä¼ å…¥ç›‘å¬ç›‘å¬å¥—æ¥å­— æ‰§è¡Œä¸»æµç¨‹ 
 * ==========================================================================*/
static void do_poll(int listenfd)
{
    int  connfd,sockfd;
    struct sockaddr_in cliaddr;
    socklen_t cliaddrlen;
    struct pollfd clientfds[OPEN_MAX];//å¸¸è§pollfdæ•°ç»„
    int maxi;//éœ€è¦ç›‘æ§fdæ•°ç»„ä¸­æœ€å¤§ä¸ä¸º-1çš„ä¸‹æ ‡ä½ç½® å¯ä»¥è®¡ç®—å‡ºæ¥å½“å‰çœŸæ­£éœ€è¦ç›‘æ§çš„fdæ•°é‡
    int i;
    int nready;
    //æ·»åŠ ç›‘å¬æè¿°ç¬¦
    clientfds[0].fd = listenfd;//ç¬¬ä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸ºç›‘å¬å¥—æ¥å­—
    clientfds[0].events = POLLIN;//æœŸå¾…è¯»äº‹ä»¶
    //åˆå§‹åŒ–å®¢æˆ·è¿æ¥æè¿°ç¬¦
    for (i = 1;i < OPEN_MAX;i++)
        clientfds[i].fd = -1;
    maxi = 0;
    //å¾ªç¯å¤„ç†
    for ( ; ; )
    {
        //è·å–å¯ç”¨æè¿°ç¬¦çš„ä¸ªæ•°
        nready = poll(clientfds,maxi+1,INFTIM);
        if (nready == -1)
        {
            perror("poll error:");
            exit(1);
        }
        //æµ‹è¯•ç›‘å¬æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½
        if (clientfds[0].revents & POLLIN)
        {
            cliaddrlen = sizeof(cliaddr);
            //æ¥å—æ–°çš„è¿æ¥
            if ((connfd = accept(listenfd,(struct sockaddr*)&cliaddr,&cliaddrlen)) == -1)
            {
                if (errno == EINTR)
                    continue;
                else
                {
                   perror("accept error:");
                   exit(1);
                }
            }
            fprintf(stdout,"accept a new client: %s:%d\n", inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port);
            //å°†æ–°çš„è¿æ¥æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­ æ‰¾åˆ°fdæ•°ç»„å¯ä»¥æ’å…¥çš„ä½ç½® æ˜¯-1å°±å¯ä»¥æ’å…¥ è€Œä¸”æ˜¯ä¸‹æ ‡ä»å°åˆ°è¾¾å¼€å§‹æŸ¥æ‰¾
            for (i = 1;i < OPEN_MAX;i++)
            {
                if (clientfds[i].fd < 0)//é¡ºåºæŸ¥æ‰¾å“ªä¸ªæ§½ä½å¯ä»¥ä½¿ç”¨ åˆšå¼€å§‹åªæœ‰ç¬¬ä¸€ä¸ªä¸ä¸º-1
                {
                    clientfds[i].fd = connfd;//åŠ è¿›pollfdæ•°ç»„
                    break;
                }
            }
            if (i == OPEN_MAX)//è¿™é‡Œåªæ˜¯ä¸ºäº†æµ‹è¯• è¶…è¿‡è¿™ä¸ªæ•°é‡çš„å®¢æˆ·ç«¯ ç¨‹åºæŠ¥é”™é€€å‡º
            {
                fprintf(stderr,"too many clients.\n");
                exit(1);
            }
            //å°†æ–°çš„æè¿°ç¬¦æ·»åŠ åˆ°è¯»æè¿°ç¬¦é›†åˆä¸­
            clientfds[i].events = POLLIN;
            //è®°å½•å®¢æˆ·è¿æ¥å¥—æ¥å­—çš„ä¸ªæ•°
            maxi = (i > maxi ? i : maxi);
            if (--nready <= 0)//å¦‚æœé™¤äº†ç›‘å¬å¥—æ¥å­—æ²¡æœ‰å°±ç»ªçš„äº‹ä»¶ é‚£å°±continueç»§ç»­ä¸‹æ¬¡pollè½®è¯¢
                continue;
        }
        //å¤„ç†å®¢æˆ·è¿æ¥
        handle_connection(clientfds,maxi);
    }
}
/*===========================================================================
handle_connection ä¼ å…¥pollè¿”å›çš„fdæ•°ç»„ é€ä¸ªå¤„ç†å°±ç»ªçš„å®¢æˆ·ç«¯å¥—æ¥å­—
 * ==========================================================================*/
static void handle_connection(struct pollfd *connfds,int num)
{
    int i,n;
    char buf[MAXLINE];
    memset(buf,0,MAXLINE);
    for (i = 1;i <= num;i++)
    {
        if (connfds[i].fd < 0)
            continue;
        //æµ‹è¯•å®¢æˆ·æè¿°ç¬¦æ˜¯å¦å‡†å¤‡å¥½
        if (connfds[i].revents & POLLIN)
        {
            //æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯
            n = read(connfds[i].fd,buf,MAXLINE);
            if (n == 0)
            {
                close(connfds[i].fd);
                connfds[i].fd = -1;//å¦‚æœå®¢æˆ·ç«¯å…³é—­äº†å¥—æ¥å­— ä»ç›‘æ§å¥—æ¥å­—æ•°ç»„ä¸­ç§»é™¤
                continue;
            }
           // printf("read msg is: ");
            write(STDOUT_FILENO,buf,n);
            //å‘å®¢æˆ·ç«¯å‘é€buf
            write(connfds[i].fd,buf,n);
        }
    }
}
  ```
</details>
<h2 id="ioå¤šè·¯å¤ç”¨---epoll">IOå¤šè·¯å¤ç”¨&mdash;epoll<a hidden class="anchor" aria-hidden="true" href="#ioå¤šè·¯å¤ç”¨---epoll">#</a></h2>
<h3 id="apiåŸå‹-2">APIåŸå‹<a hidden class="anchor" aria-hidden="true" href="#apiåŸå‹-2">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/epoll.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> epoll_create(<span style="color:#a6e22e">int</span> size);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> epoll_ctl(<span style="color:#a6e22e">int</span> epfd, <span style="color:#a6e22e">int</span> op, <span style="color:#a6e22e">int</span> fd, struct epoll_event <span style="color:#f92672">*</span>event);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> epoll_wait(<span style="color:#a6e22e">int</span> epfd, struct epoll_event <span style="color:#f92672">*</span> events, <span style="color:#a6e22e">int</span> maxevents, <span style="color:#a6e22e">int</span> timeout);
</span></span><span style="display:flex;"><span>struct epoll_event {
</span></span><span style="display:flex;"><span>  __uint32_t events;  <span style="color:#f92672">/*</span> Epoll events <span style="color:#f92672">*/</span>
</span></span><span style="display:flex;"><span>  epoll_data_t data;  <span style="color:#f92672">/*</span> User data variable <span style="color:#f92672">*/</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>eventså¯ä»¥æ˜¯ä»¥ä¸‹å‡ ä¸ªå®çš„é›†åˆ<span style="color:#960050;background-color:#1e0010">ï¼š</span>
</span></span><span style="display:flex;"><span>EPOLLIN <span style="color:#960050;background-color:#1e0010">ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯</span>SOCKETæ­£å¸¸å…³é—­<span style="color:#960050;background-color:#1e0010">ï¼‰ï¼›</span>
</span></span><span style="display:flex;"><span>EPOLLOUT<span style="color:#960050;background-color:#1e0010">ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›</span>
</span></span><span style="display:flex;"><span>EPOLLPRI<span style="color:#960050;background-color:#1e0010">ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›</span>
</span></span><span style="display:flex;"><span>EPOLLERR<span style="color:#960050;background-color:#1e0010">ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›</span>
</span></span><span style="display:flex;"><span>EPOLLHUP<span style="color:#960050;background-color:#1e0010">ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›</span>
</span></span><span style="display:flex;"><span>EPOLLET<span style="color:#960050;background-color:#1e0010">ï¼š</span> <span style="color:#960050;background-color:#1e0010">å°†</span>EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)<span style="color:#960050;background-color:#1e0010">æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘</span>(Level Triggered)<span style="color:#960050;background-color:#1e0010">æ¥è¯´çš„ã€‚</span>
</span></span><span style="display:flex;"><span>EPOLLONESHOT<span style="color:#960050;background-color:#1e0010">ï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ª</span>socketçš„è¯<span style="color:#960050;background-color:#1e0010">ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ª</span>socketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œ
</span></span></code></pre></div><ul>
<li>
<p>epoll_create</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦ï¼Œsizeæ˜¯è¦å‘Šè¯‰å†…æ ¸è¿™ä¸ªç›‘å¬å¥—æ¥å­—çš„æ•°é‡ï¼Œåˆ›å»ºå¥½epollå¥æŸ„åï¼Œå°±ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxç³»ç»Ÿä»¥ä¸‹ç›®å½•/proc/pid/fdæ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼Œæ‰€ä»¥epollç»“æŸ å¥½ä¹ æƒ¯ä¹Ÿè¦closeæ‰</li>
</ul>
</li>
<li>
<p>epoll_ctl</p>
<ul>
<li>ctlå°±æ˜¯controlæ§åˆ¶çš„ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªäº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œepfdä¸ºepoll_createå‡½æ•°è¿”å›çš„epollå¥æŸ„</li>
<li>ç¬¬äºŒä¸ªå‚æ•°opä¸ºæ“ä½œç±»å‹ æœ‰ä»¥ä¸‹ä¸‰ä¸ª
<ul>
<li>EPOLL_CTL_ADDï¼šæ³¨å†Œæ–°çš„fdåˆ°epfdä¸­</li>
<li>EPOLL_CTL_MODï¼šä¿®æ”¹å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶</li>
<li>EPOLL_CTL_DELï¼šä»epfdä¸­åˆ é™¤ä¸€ä¸ªfd</li>
</ul>
</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•°fdä¸ºéœ€è¦ç›‘å¬çš„å¥—æ¥å­—å¥æŸ„</li>
<li>ç¬¬å››ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å†…æ ¸é’ˆå¯¹fdè¦ç›‘å¬ä»€ä¹ˆäº‹ä»¶ eventsæšä¸¾ä¸Šé¢æœ‰åˆ—å‡ºæ¥</li>
</ul>
</li>
<li>
<p>epoll_wait</p>
<ul>
<li>ç±»ä¼¼selectã€pollè°ƒç”¨åå­—ä¹Ÿæœ‰waitï¼Œå°±æ˜¯ç­‰å¾…äº‹ä»¶äº§ç”Ÿ</li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°epfdä¸ºepoll_createè¿”å›çš„epollå¥æŸ„</li>
<li>ç¬¬äºŒä¸ªå‚æ•°eventsç”¨æ¥ä»å†…æ ¸å¾—åˆ°äº‹ä»¶é›†åˆï¼Œå†…æ ¸ä¼šå°†å°±ç»ªçš„æè¿°ç¬¦åŠå‘ç”Ÿçš„äº‹ä»¶å†™åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‘ŠçŸ¥å†…æ ¸ è¿™ä¸ªåˆ—è¡¨æœ‰å¤šå¤§ï¼Œä¸èƒ½å¤§äºè°ƒç”¨epoll_create(int size)ä¼ å…¥çš„size</li>
<li>ç¬¬å››ä¸ªå‚æ•°è¶…æ—¶æ—¶é—´ å•ä½æ¯«ç§’ ï¼š
<ul>
<li>timeout&gt;0 å¦‚æœæ²¡æœ‰å¥—æ¥å­—å°±ç»ª å†…æ ¸æœ€å¤šç­‰åˆ°timeoutæ¯«ç§’</li>
<li>timeout=0 å¦‚æœæ²¡æœ‰å¥—æ¥å­—å°±ç»ª å†…æ ¸ç›´æ¥è¿”å› ä¸é˜»å¡</li>
<li>timeout=-1 ä¼šä¸€ç›´é˜»å¡ ç›´åˆ°æœ‰å¥—æ¥å­—å°±ç»ª</li>
</ul>
</li>
</ul>
</li>
<li>
<p>epollä¸¤è€…å·¥ä½œæ¨¡å¼</p>
<ul>
<li>
<p>LT(level trigger) æ°´å¹³è§¦å‘æ¨¡å¼</p>
<p>epoll_waitæ£€æµ‹åˆ°fdäº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸ç«‹å³å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitä¼šå†æ¬¡å‘ŠçŸ¥åº”ç”¨ç¨‹åº</p>
</li>
<li>
<p>ET(edge trigger) è¾¹ç¼˜è§¦å‘æ¨¡å¼</p>
<p><strong>å½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶</strong></p>
<ul>
<li>ETæ¨¡å¼å¾ˆå¤§ç¨‹åº¦å‡å°‘äº†epolläº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œç›¸å¯¹äºLTæ•ˆç‡æ›´é«˜ï¼Œåœ¨ETæ¨¡å¼ä¸‹ï¼Œå¿…é¡»ä½¿ç”¨éé˜»å¡å¥—æ¥å­—ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªå¥—æ¥å­—é˜»å¡è¯»å†™å¯¼è‡´æ•´ä¸ªå¤„ç†å¤šå¥—æ¥å­—çš„ä»»åŠ¡ææ­»ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="æ”¹è¿›ä¸è¶³">æ”¹è¿›ã€ä¸è¶³<a hidden class="anchor" aria-hidden="true" href="#æ”¹è¿›ä¸è¶³">#</a></h3>
<ul>
<li>ç›¸å¯¹äºselectæ²¡æœ‰æ•°é‡é™åˆ¶</li>
<li>ç›¸å¯¹äºselectã€poll å¯¹äºç›‘æ§çš„æè¿°ç¬¦é›†åˆ ä¸ç”¨æ¯æ¬¡éƒ½ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œåªæ˜¯åœ¨epoll_ctlæ·»åŠ çš„æ—¶å€™æ‹·è´ä¸€æ¬¡</li>
<li>epoll_waitä¸æ˜¯è½®è¯¢æœºåˆ¶ è€Œæ˜¯é‡‡ç”¨å›è°ƒå‡½æ•°çš„æœºåˆ¶ æ‰€ä»¥æ•ˆç‡æ›´é«˜</li>
<li>epollç›®å‰åªæœ‰linuxæœ‰ æ˜¯ä»linuxå†…æ ¸2.6å¼€å§‹æå‡ºçš„ ä¸è¿‡windowså’ŒMac(bsd)ä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°</li>
</ul>
<h3 id="ä»£ç -2">ä»£ç <a hidden class="anchor" aria-hidden="true" href="#ä»£ç -2">#</a></h3>
<details>
  <summary>epollç¤ºä¾‹ä»£ç  è½¬è½½åŠ æ³¨é‡Š ç®€å•ä¼˜åŒ– C</summary>
  ```c
  #include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <netinet/in.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <sys/epoll.h>
#include <unistd.h>
#include <sys/types.h>
#define IPADDRESS   "127.0.0.1"
#define PORT        8787
#define MAXSIZE     1024
#define LISTENQ     5
#define FDSIZE      1000
#define EPOLLEVENTS 100
//å‡½æ•°å£°æ˜
//åˆ›å»ºå¥—æ¥å­—å¹¶è¿›è¡Œç»‘å®š
static int socket_bind(const char* ip,int port);
//IOå¤šè·¯å¤ç”¨epoll
static void do_epoll(int listenfd);
//äº‹ä»¶å¤„ç†å‡½æ•°
static void
handle_events(int epollfd,struct epoll_event *events,int num,int listenfd);
//å¤„ç†æ¥æ”¶åˆ°çš„è¿æ¥
static void handle_accpet(int epollfd,int listenfd);
//è¯»å¤„ç†
static void handle_connection(int epollfd,int fd);
//å†™å¤„ç†
static void sendToClient(int epollfd,int fd,char *buf);
//æ·»åŠ äº‹ä»¶
static void add_event(int epollfd,int fd,int state);
//ä¿®æ”¹äº‹ä»¶
static void modify_event(int epollfd,int fd,int state);
//åˆ é™¤äº‹ä»¶
static void delete_event(int epollfd,int fd,int state);
int main(int argc,char *argv[])
{
    int  listenfd;
    listenfd = socket_bind(IPADDRESS,PORT);
    listen(listenfd,LISTENQ);
    do_epoll(listenfd);
    return 0;
}
/*===========================================================================
socket_bind åˆ›å»ºç›‘å¬å¥—æ¥å­— 
 * ==========================================================================*/
static int socket_bind(const char* ip,int port)
{
    int  listenfd;
    struct sockaddr_in servaddr;
    listenfd = socket(AF_INET,SOCK_STREAM,0);
    if (listenfd == -1)
    {
        perror("socket error:");
        exit(1);
    }
    /*ä¸€ä¸ªç«¯å£é‡Šæ”¾åä¼šç­‰å¾…ä¸€æ®µæ—¶é—´å(æ¯”å¦‚ä¸¤åˆ†é’Ÿ)æ‰èƒ½å†è¢«ä½¿ç”¨ï¼ŒSO_REUSEADDRæ˜¯è®©ç«¯å£é‡Šæ”¾åç«‹å³å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨ã€‚*/
    int reuse = 1;
    if (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &reuse, sizeof(reuse)) == -1) {
        return -1;
    }
    bzero(&servaddr,sizeof(servaddr));
    servaddr.sin_family = AF_INET;
    inet_pton(AF_INET,ip,&servaddr.sin_addr);
    servaddr.sin_port = htons(port);
    if (bind(listenfd,(struct sockaddr*)&servaddr,sizeof(servaddr)) == -1)
    {
        perror("bind error: ");
        exit(1);
    }
    return listenfd;
}
/*===========================================================================
epollå¤„ç†ä¸»å‡½æ•° éœ€è¦ä¼ å…¥ç›‘å¬å¥—æ¥å­— 
 * ==========================================================================*/
static void do_epoll(int listenfd)
{
    int epollfd;
    struct epoll_event events[EPOLLEVENTS];
    int ret;
    //åˆ›å»ºä¸€ä¸ªæè¿°ç¬¦
    epollfd = epoll_create(FDSIZE);
    //æ·»åŠ ç›‘å¬æè¿°ç¬¦äº‹ä»¶
    add_event(epollfd,listenfd,EPOLLIN);
    for ( ; ; )
    {
        //è·å–å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦äº‹ä»¶
        ret = epoll_wait(epollfd,events,EPOLLEVENTS,-1);
        handle_events(epollfd,events,ret,listenfd);
    }
    close(epollfd);
}
/*===========================================================================
handle_events epoll_wait è¿”å›åé’ˆå¯¹å°±ç»ªå¥—æ¥å­— é€ä¸ªå¤„ç† 
 * ==========================================================================*/
static void handle_events(int epollfd,struct epoll_event *events,int num,int listenfd)
{
    int i;
    int fd;
    //å¯¹å†…æ ¸è¿”å›å°±ç»ªçš„eventsåˆ—è¡¨ éå†å¤„ç†
    for (i = 0;i < num;i++)
    {
        fd = events[i].data.fd;
        //æ ¹æ®æè¿°ç¬¦çš„ç±»å‹å’Œäº‹ä»¶ç±»å‹è¿›è¡Œå¤„ç†
        if ((fd == listenfd) &&(events[i].events & EPOLLIN))//ç›‘å¬å¥—æ¥å­— éœ€è¦acceptåŒæ—¶å°†è¿æ¥å¥½çš„clientfdåŠ å…¥epollfd
            handle_accpet(epollfd,listenfd);
        else if (events[i].events & EPOLLIN)//è¯»äº‹ä»¶
            handle_connection(epollfd,fd);
        else{
            perror("éacceptå¯è¯»ã€éclinetå¯è¯»");
        } 
    }
}
/*===========================================================================
handle_accpet ç›‘å¬å¥—æ¥å­— éœ€è¦acceptåŒæ—¶å°†è¿æ¥å¥½çš„clientfdåŠ å…¥epollfd 
 * ==========================================================================*/
static void handle_accpet(int epollfd,int listenfd)
{
    int clifd;
    struct sockaddr_in cliaddr;
    socklen_t  cliaddrlen;
    clifd = accept(listenfd,(struct sockaddr*)&cliaddr,&cliaddrlen);
    if (clifd == -1)
        perror("accpet error:");
    else
    {
        printf("accept a new client: %s:%d\n",inet_ntoa(cliaddr.sin_addr),cliaddr.sin_port);
        //æ·»åŠ ä¸€ä¸ªå®¢æˆ·æè¿°ç¬¦å’Œäº‹ä»¶
        add_event(epollfd,clifd,EPOLLIN);
    }
}
/*===========================================================================
do_read å¤„ç†è¯»äº‹ä»¶å°±ç»ªçš„å®¢æˆ·ç«¯è¿æ¥å¥—æ¥å­—
 * ==========================================================================*/
static void handle_connection(int epollfd,int fd)
{
    char buf[MAXSIZE];
    memset(buf,0,MAXSIZE);
    int nread;
    nread = read(fd,buf,MAXSIZE);
    if (nread == -1)
    {
        perror("read error:");
        close(fd);
        delete_event(epollfd,fd,EPOLLIN);
    }
    else if (nread == 0)
    {
        fprintf(stderr,"client close.\n");
        close(fd);
        delete_event(epollfd,fd,EPOLLIN);
    }
    else
    {
        printf("read message is : %s\n",buf);
        //ç›´æ¥å›å¤ç»™å®¢æˆ·ç«¯
        sendToClient(epollfd,fd,buf);
    }
}
static void sendToClient(int epollfd,int fd,char *buf)
{
    int nwrite;
    nwrite = write(fd,buf,strlen(buf));
    if (nwrite == -1)
    {
        perror("write error:");
        close(fd);
        delete_event(epollfd,fd,EPOLLIN);
    }
}
static void add_event(int epollfd,int fd,int state)
{
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd,EPOLL_CTL_ADD,fd,&ev);
}
static void delete_event(int epollfd,int fd,int state)
{
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd,EPOLL_CTL_DEL,fd,&ev);
}
static void modify_event(int epollfd,int fd,int state)
{
    struct epoll_event ev;
    ev.events = state;
    ev.data.fd = fd;
    epoll_ctl(epollfd,EPOLL_CTL_MOD,fd,&ev);
}
  ```
</details>
# å¤šçº¿ç¨‹
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹">ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹å¤šçº¿ç¨‹">#</a></h2>
<ul>
<li>
<p>æœ¬è´¨åŸå› cpuã€å†…å­˜IOã€ç£ç›˜IOå› ä¸ºä»‹è´¨ä¸åŒï¼Œå·¥ä½œæ•ˆç‡å¤©å£¤ä¹‹åˆ«ï¼Œcpué€Ÿåº¦è¿œè¿œå¤§äºå†…å­˜ï¼Œå†…å­˜é€Ÿåº¦åˆè¿œè¿œå¤§äºç£ç›˜ã€‚æ‰€ä»¥è¿™ä¹ˆä¸€æ¥æœ€å¼€å§‹çš„è®¡ç®—ä½¿ç”¨è€…å°±å‘ç°ï¼Œcpuå¤ªé—²äº†ï¼Œè€Œcpuè´µï¼Œå®åœ¨æ˜¯å¤ªæµªè´¹äº†ï¼Œæ‰€ä»¥åé¢å°±æƒ³å°½åŠæ³•åŠæ³•ï¼Œè®©cpuå¿™èµ·æ¥ ä¸‹é¢çš„æ˜¯ç®€å•çš„å‘å±•å†å²</p>
<ul>
<li>
<p>å•ä»»åŠ¡æ—¶ä»£</p>
<p>è®¡ç®—æœºåªè´Ÿè´£è®¡ç®—ï¼Œä¸èƒ½ç›´æ¥å†™å…¥æŒ‡ä»¤å’Œè¾“å‡ºç»“æœï¼Œç¨‹åºå‘˜æŠŠç¨‹åºå†™åˆ°çº¸ä¸Šï¼Œç„¶åç©¿å­”ç§°å¡ç‰‡ï¼Œå†æŠŠå¡ç‰‡è¾“å…¥åˆ°è®¡ç®—æœºï¼Œè®¡ç®—æœºè®¡ç®—ç»“æœæ‰“å°å‡ºæ¥ï¼Œç¨‹åºå‘˜æœ€åæ‹¿åˆ°ç»“æœã€‚è¿™ä¸ªæ—¶ä»£çš„è®¡ç®—æœºcpuæ˜¯å¾ˆé—²çš„ï¼Œç¨‹åºå‘˜å¹²åŠå¤©ï¼Œè®¡ç®—æœºä¸€ä¼šå®Œäº‹ã€‚</p>
</li>
<li>
<p>æ‰¹å¤„ç†</p>
<p>ç¨‹åºç”±å¡ç‰‡æ”¹ä¸ºäº†ç£å¸¦ï¼Œè¿™æ—¶å€™ä¸€æ¬¡å¯ä»¥å½•å…¥æ›´å¤šçš„ç¨‹åºï¼Œä¸€æ¬¡æ‰¹å¤„ç†çš„æ–¹å¼æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä½†è®¡ç®—æœºåŒæ—¶è¿˜æ˜¯åªèƒ½å¹²ä¸€ä»¶äº‹æƒ…ï¼Œè¿›è¡ŒIOçš„æ—¶å€™ä¸èƒ½è®¡ç®—ï¼Œè¿›è¡Œè®¡ç®—çš„æ—¶å€™ä¸èƒ½IOï¼Œè€Œcpuå¹²æ´»åˆè´¼å¿«ï¼Œæ‰€ä»¥cpuæ•´ä½“è¿˜æ˜¯å¾ˆé—²ã€‚</p>
</li>
<li>
<p>æ”¯æŒå¤šé“ç¨‹åºè®¾è®¡ å¤šè¿›ç¨‹æ—¶ä»£</p>
<p>å‡ºç°äº†å¤šè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´äº’ä¸å¹²æ¶‰ï¼Œå› ä¸ºcpuå¤ªå¿«è€Œä¸”åˆè´µï¼Œæ‰€ä»¥å¤§å®¶å°±è½®ç€ç”¨ï¼Œä¹Ÿå°±æ˜¯cpuæ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œä¸åŒçš„è¿›ç¨‹ä½¿ç”¨cpuç”±æ“ä½œç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼Œäº‰å–å…¬å¹³çš„åˆ†é…ç»™æ¯ä¸ªè¿›ç¨‹æ‰€éœ€è¦çš„cpuæ—¶é—´ç‰‡ï¼Œä¸€ä¸ªè¿›ç¨‹ç”¨ä¸€ä¼šcpuï¼Œæ“ä½œç³»ç»Ÿå°±ä¿å­˜ç°åœºï¼ŒåŒæ—¶æŠŠcpuè½¬ç»™å…¶å®ƒè¿›ç¨‹(ä¹Ÿå°±æ˜¯è¿›ç¨‹åˆ‡æ¢)ï¼Œè¿™ä¸ªæ—¶ä»£è¿›ç¨‹å¦‚æœå¤Ÿå¤šï¼Œcpuå…¶å®å·²ç»å¾ˆå¿™äº†ï¼Œå› ä¸ºä¸€å †è¿›ç¨‹è½®ç•ªä¸Šé˜µï¼Œæ— ä¼‘æ­¢çš„è½¦è½®æˆ˜ã€‚</p>
</li>
<li>
<p>å¤šçº¿ç¨‹æ—¶ä»£</p>
<p>å› ä¸ºè¿›ç¨‹åˆ‡æ¢æ¯”è¾ƒæ¶ˆè€—æ—¶é—´ï¼Œç°åœºä¿å­˜å’Œåˆ‡æ¢å·¥ä½œå› ä¸ºè¿›ç¨‹æ¯”è¾ƒé‡æ‰€ä»¥æ¯”è¾ƒæ¶ˆè€—æ—¶é—´å’Œèµ„æºï¼Œæ‰€ä»¥å°±æ¥äº†å¤šçº¿ç¨‹ï¼Œçº¿ç¨‹æ›´åŠ è½»é‡çº§ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹é—´å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥åˆ‡æ¢èµ·æ¥æ›´å¿«ï¼Œå½“ç„¶cpuä¹Ÿå°±ä¼šæ›´ç´¯ã€‚</p>
<p>å› ä¸ºå¤šçº¿ç¨‹çš„å‡ºç°ï¼Œcpuå˜å¾—æ›´åŠ ç¹å¿™ã€‚</p>
</li>
<li>
<p>å¤šcpu å¤šçº¿ç¨‹</p>
<p>è¿›å…¥äº†å¤šçº¿ç¨‹æ—¶ä»£åï¼Œç»ˆäºå½»åº•å¯ä»¥æŠŠcpuææ­»äº†ï¼Œæ‰€ä»¥äººä»¬å¼€å§‹å«Œå¼ƒcpuæ²¡æœ‰é‚£ä¹ˆå¿«äº†ï¼Œæ‰€ä»¥å°±æƒ³ç€æå¤šä¸ªcpuï¼Œè®©å¤šä¸ªcpuåŒæ—¶å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™å…¶å®æ‰æ˜¯çœŸæ­£çš„ä»»åŠ¡å¹¶è¡Œäº†ï¼Œä¹‹å‰æ˜¯å¤šä¸ªä»»åŠ¡ä¸æ–­çš„æŠ¢ä¸€ä¸ªcpuï¼Œå› ä¸ºcpuå¤ªå¿«äº†ï¼Œæ‰€ä»¥åŸºæœ¬æ²¡ä»€ä¹ˆæ„Ÿè§‰ï¼Œè¿›å…¥å¤šæ ¸cpuåæ‰çœŸæ­£çš„è®©å¤šä¸ªä»»åŠ¡å¹¶è¡Œäº†ã€‚</p>
</li>
</ul>
</li>
</ul>
<h2 id="å¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜">å¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¤šcpuå¹¶å‘å¯èƒ½äº§ç”Ÿçš„é—®é¢˜">#</a></h2>
<h3 id="å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜">å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å¤šä¸ªcpuç¼“å­˜å¯¼è‡´çš„å¯è§æ€§é—®é¢˜">#</a></h3>
<ul>
<li>
<p>è¿˜æ˜¯å› ä¸ºcpuå¤ªå¿«ï¼Œå†…å­˜ç£ç›˜å¤ªæ…¢æ‰€ä»¥æœ‰äº†cpuç¼“å­˜ï¼Œæ‰€ä»¥cpuæ‰§è¡Œæ•°æ®æ“ä½œè¿‡å±‚å¯¼è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…å­˜</li>
<li>ä»å†…å­˜åŠ è½½åˆ°cpuç¼“å­˜</li>
<li>æ‰§è¡Œç›¸å…³è®¡ç®—æ“ä½œ æ›´æ–°cpuç¼“å­˜</li>
<li>æ›´æ–°å†…å­˜</li>
<li>æ›´æ–°ç£ç›˜</li>
</ul>
</li>
<li>
<p>å¤šæ ¸cpuï¼Œå°±æœ‰å¤šä¸ªcpuç¼“å­˜ï¼Œè€Œå®ƒä»¬å½¼æ­¤ä¸å¯è§ï¼Œæ¯ä¸ªcpuä¹Ÿæ˜¯æ“ä½œçš„è‡ªå·±ç‹¬ç«‹çš„cpuç¼“å­˜ï¼Œè¿™å°±å¿…ç„¶äº§ç”Ÿä¸å¯è§æ€§ï¼Œæ¯”å¦‚a=a+1</p>
<p>cpu1ä¿®æ”¹äº†å¯¹åº”çš„cpuç¼“å­˜ï¼Œè€Œæ­¤æ—¶cpu2æ˜¯ä¸çŸ¥é“çš„ï¼Œå¿…é¡»ç­‰ç¼“å­˜åŒæ­¥ä»¥åæ‰çŸ¥é“ã€‚</p>
<p><img loading="lazy" src="http://becool.vip:666/img/cpu%e5%a4%9a%e7%bc%93%e5%ad%98%e5%8f%af%e8%a7%81%e6%80%a7%e9%97%ae%e9%a2%98.jpg" alt=""  />
</p>
</li>
<li>
<p>æ‰€ä»¥çº¿ç¨‹è§å¦‚æœæ“ä½œå…±äº«èµ„æºè¦æ³¨æ„åŠ é”ï¼Œå¦åˆ™å¯èƒ½å‡ºç°æ„æƒ³ä¸åˆ°çš„ç»“æœ</p>
</li>
<li>
<p>ä¾‹å­ï¼š2ä¸ªçº¿ç¨‹ åŒæ—¶++ä¸€ä¸ªå˜é‡10Wæ¬¡</p>
</li>
</ul>
<h3 id="cpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜">cpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#cpuåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„åŸå­æ€§é—®é¢˜">#</a></h3>
<ul>
<li>
<p>åŸå­æ€§å°±æ˜¯ä¸€ä¸ªæ“ä½œ(å¤šä¸ªç›¸å…³å­æ“ä½œ)åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸èƒ½è¢«æ‰“æ–­ï¼Œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</p>
</li>
<li>
<p>ä¾‹å­ int number=0;number=number+1;</p>
<p><strong>number=number+1çš„æŒ‡ä»¤å¯èƒ½å¦‚ä¸‹ï¼š</strong></p>
<p>æŒ‡ä»¤1ï¼šCPUæŠŠnumberä»å†…å­˜æ‹·è´åˆ°CPUç¼“å­˜ã€‚</p>
<p>æŒ‡ä»¤2ï¼šæŠŠnumberè¿›è¡Œ+1çš„æ“ä½œã€‚</p>
<p>æŒ‡ä»¤3ï¼šæŠŠnumberå›å†™åˆ°å†…å­˜.</p>
<ul>
<li>å¦‚æœæœ‰2ä¸ªçº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä¸Šé¢çš„ä¾‹å­ï¼Œcpuçš„æ‰§è¡Œæµç¨‹å¯èƒ½å¦‚ä¸‹ï¼š</li>
</ul>
<p><img loading="lazy" src="http://becool.vip:666/img/cpu%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2%e7%a0%b4%e5%9d%8f%e5%8e%9f%e5%ad%90%e6%80%a7.jpg" alt=""  />
</p>
<p><strong>æ‰§è¡Œç»†èŠ‚ï¼š</strong></p>
</li>
</ul>
<p>â€‹	1ã€CPUå…ˆæ‰§è¡Œçº¿ç¨‹Açš„æ‰§è¡Œï¼ŒæŠŠnumber=0æ‹·è´åˆ°CUPå¯„å­˜å™¨ã€‚</p>
<p>â€‹	2ã€ç„¶åCPUåˆ‡æ¢åˆ°çº¿ç¨‹Bæ‰§è¡ŒæŒ‡ä»¤ã€‚</p>
<p>â€‹	3ã€çº¿ç¨‹B æŠŠnumber=0æ‹·è´åˆ°CUPå¯„å­˜å™¨ã€‚</p>
<p>â€‹	4ã€çº¿ç¨‹B æ‰§è¡Œnumber=number+1 æ“ä½œå¾—åˆ°number=1ã€‚</p>
<p>â€‹	5ã€çº¿ç¨‹BæŠŠnumberæ‰§è¡Œç»“æœå›å†™åˆ°ç¼“å­˜é‡Œé¢ã€‚</p>
<p>â€‹	6ã€ç„¶åCPUåˆ‡æ¢åˆ°çº¿ç¨‹Aæ‰§è¡ŒæŒ‡ä»¤ã€‚</p>
<p>â€‹	7ã€çº¿ç¨‹Aæ‰§è¡Œnumber=number+1 æ“ä½œå¾—åˆ°numbe=1ã€‚</p>
<p>â€‹	8ã€çº¿ç¨‹AæŠŠnumberæ‰§è¡Œç»“æœå›å†™åˆ°ç¼“å­˜é‡Œé¢ã€‚</p>
<p>â€‹	9ã€æœ€åå†…å­˜é‡Œé¢numberçš„å€¼ä¸º1ã€‚</p>
<h3 id="ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜">ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#ç¼–è¯‘å™¨ä¼˜åŒ–å¸¦æ¥çš„æŒ‡ä»¤é‡æ’åºé—®é¢˜">#</a></h3>
<ul>
<li>
<p>ç¼–è¯‘å™¨çš„æœ‰äº›ä¼˜åŒ–ä¼šæ‰“ä¹±æ‰§è¡Œæœ¬æ¥äººä¸ºç†è§£çš„é¡ºåº</p>
</li>
<li>
<p>ä¾‹å­ï¼š å•ä¾‹æ¨¡å¼çš„double checkï¼Œå…¶å®ç”¨äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°å†…å­˜reorderé—®é¢˜å‘ç°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>public class Singleton {
</span></span><span style="display:flex;"><span> private Singleton() {}
</span></span><span style="display:flex;"><span> private static Singleton sInstance;
</span></span><span style="display:flex;"><span> public static Singleton getInstance() {
</span></span><span style="display:flex;"><span> if (sInstance == null) {	//ç¬¬ä¸€æ¬¡éªŒè¯æ˜¯å¦ä¸ºnull
</span></span><span style="display:flex;"><span> 				synchronized (Singleton.class) {   //åŠ é”
</span></span><span style="display:flex;"><span> 						if (sInstance == null) {	  //ç¬¬äºŒæ¬¡éªŒè¯æ˜¯å¦ä¸ºnull
</span></span><span style="display:flex;"><span> 									sInstance = new Singleton();  //åˆ›å»ºå¯¹è±¡
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> return sInstance;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em>Instance</em> = <strong>new</strong> Singleton();è¿™è¡Œä»£ç æ—¶ä¼šåˆ†è§£æˆä¸‰ä¸ªæŒ‡ä»¤æ‰§è¡Œã€‚</p>
<p>1ã€ä¸ºå¯¹è±¡åˆ†é…ä¸€ä¸ªå†…å­˜ç©ºé—´ã€‚</p>
<p>2ã€åœ¨åˆ†é…çš„å†…å­˜ç©ºé—´å®ä¾‹åŒ–å¯¹è±¡ã€‚</p>
<p>3ã€æŠŠInstance å¼•ç”¨åœ°å€æŒ‡å‘å†…å­˜ç©ºé—´</p>
<p>è€Œä¸”2 3çš„é¡ºåºå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå…ˆæ‰§è¡Œ3ï¼Œç„¶åå¦å¤–ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ°cpu å‘ç°å¯¹è±¡æŒ‡é’ˆä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç„¶åä½¿ç”¨ï¼Œè€Œè¿™ä¸ªæ—¶å€™å¯¹è±¡è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–å·¥ä½œï¼Œæ˜¯ä¼šå‡ºé—®é¢˜çš„ã€‚</p>
</li>
</ul>
<h2 id="c11-å¤šçº¿ç¨‹">c++11 å¤šçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#c11-å¤šçº¿ç¨‹">#</a></h2>
<h3 id="åˆ›å»ºçº¿ç¨‹">åˆ›å»ºçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºçº¿ç¨‹">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>c++11 åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å• å¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š
</span></span><span style="display:flex;"><span>1. #include&lt;thread&gt;
</span></span><span style="display:flex;"><span>2. å®šä¹‰çº¿ç¨‹ä»£ç æ‰§è¡Œè·¯å¾„(çº¿ç¨‹å°±æ˜¯å¯ä»¥å•ç‹¬æ‰§è¡Œä»£ç çš„é€šé“ï¼Œè¦å®šä¹‰çº¿ç¨‹å¯åŠ¨åè¦ä»å“ªä¸ªåœ°æ–¹å¼€å§‹ä»ä¸Šå¾€ä¸‹æ‰§è¡Œä»£ç )
</span></span><span style="display:flex;"><span>3. åœ¨mainä¸»çº¿ç¨‹ åˆ›å»ºä¸€ä¸ªthreadå¯¹è±¡(è¿™ä¸ªæ—¶å€™çº¿ç¨‹å°±è‡ªåŠ¨ç”Ÿæˆå¹¶ä¸”è¿è¡Œäº†)
</span></span><span style="display:flex;"><span>4. ä¸»çº¿ç¨‹åšä¸€äº›çº¿ç¨‹ç®¡ç†å·¥ä½œ(æ¯”å¦‚è°ƒç”¨joinå‡½æ•°é˜»å¡ç­‰å¾…æŸä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨detachå‡½æ•° è·ŸæŸä¸ªçº¿ç¨‹è„±ç¦»å…³ç³»ï¼Œè®©initè¿›ç¨‹æ¥ç®¡ç„¶åå»åå°è¿è¡Œï¼‰
</span></span></code></pre></div><h4 id="çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼">çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹ä»£ç æ‰§è¡Œå…¥å£çš„å¸¸è§æ–¹å¼">#</a></h4>
<ul>
<li>
<p>æ™®é€šçš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//æ™®é€šå‡½æ•°ä½œä¸ºçº¿ç¨‹æ‰§è¡Œå…¥å£
</span></span><span style="display:flex;"><span>void ordinaryFunc(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    sleep(1);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    thread t1(ordinaryFunc);
</span></span><span style="display:flex;"><span>    t1.join();//mainå‡½æ•°é˜»å¡ ç­‰å¾…å­çº¿ç¨‹é€€å‡º
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to return&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>-----è¾“å‡º
</span></span><span style="display:flex;"><span>ä¸»çº¿ç¨‹id:0x11a916dc0 is running
</span></span><span style="display:flex;"><span>çº¿ç¨‹id:0x700001438000 is running
</span></span><span style="display:flex;"><span>çº¿ç¨‹id:0x700001438000 is ready to exit 
</span></span><span style="display:flex;"><span>ä¸»çº¿ç¨‹id:0x11a916dc0 is ready to exit
</span></span></code></pre></div></li>
<li>
<p>å‡½æ•°å¯¹è±¡(é‡è½½äº†()è¿ç®—ç¬¦çš„å¯¹è±¡)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//å‡½æ•°å¯¹è±¡ä½œä¸ºçº¿ç¨‹æ‰§è¡Œå…¥å£
</span></span><span style="display:flex;"><span>class FuncObj{
</span></span><span style="display:flex;"><span>public:
</span></span><span style="display:flex;"><span>    void operator()(){
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>        sleep(1);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    thread t1( ( FuncObj() ));
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>ç±»æˆå‘˜å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//ç±»æˆå‘˜å‡½æ•°ä½œä¸ºçº¿ç¨‹æ‰§è¡Œå…¥å£
</span></span><span style="display:flex;"><span>class ObjTest{
</span></span><span style="display:flex;"><span>public:
</span></span><span style="display:flex;"><span>    void  run(){
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>        sleep(1);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    ObjTest runtest;
</span></span><span style="display:flex;"><span>    thread t1(&amp;ObjTest::run,&amp;runtest);//ç±»æˆå‘˜å‡½æ•°ä½œä¸ºçº¿ç¨‹æ‰§è¡Œå…¥å£è¦å¤šä¼ å…¥ä¸€ä¸ªå¯¹è±¡çš„thisæŒ‡é’ˆ
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>lambdaè¡¨è¾¾å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    auto lambdaThread=[]{
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>        sleep(1);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>        cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    thread t1(lambdaThread);
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h4 id="çº¿ç¨‹æ‰§è¡Œå…¥å£ä¼ é€’å‚æ•°">çº¿ç¨‹æ‰§è¡Œå…¥å£ä¼ é€’å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹æ‰§è¡Œå…¥å£ä¼ é€’å‚æ•°">#</a></h4>
<ul>
<li>åˆ›å»ºçº¿ç¨‹ä¼šå¤åˆ¶æ–°çš„å †æ ˆ å‚æ•°ç»Ÿä¸€éƒ½ä¼šå¤åˆ¶ï¼Œå¦‚æœè¦ä¼ é€’å¼•ç”¨ å¯ä»¥ä½¿ç”¨std::ref()ï¼Œå¦åˆ™å³ä½¿å‡½æ•°å‚æ•°å†™çš„æ˜¯å¼•ç”¨ï¼Œæœ€åä¹Ÿä¸æ˜¯çœŸçš„å¼•ç”¨ã€‚</li>
<li>çº¿ç¨‹ä¹‹é—´å¦‚æœä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œè¦æ³¨æ„ä½œç”¨åŸŸé—®é¢˜ï¼Œç‰¹åˆ«æ˜¯detachåï¼Œå¾ˆå¯èƒ½ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒ‚äº†ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿˜åœ¨ä½¿ç”¨æŸä¸ªæŒ‚äº†çš„çº¿ç¨‹ä¸­çš„å˜é‡ï¼Œå°±ä¼šå·®ç”Ÿå¥‡æ€ªçš„åæœã€‚</li>
</ul>
<h3 id="çº¿ç¨‹ç®¡ç†å‡½æ•°">çº¿ç¨‹ç®¡ç†å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#çº¿ç¨‹ç®¡ç†å‡½æ•°">#</a></h3>
<ul>
<li>
<p>join</p>
<p>ä¸»çº¿ç¨‹ æ‰§è¡Œäº†t1.join()åï¼Œä¸»çº¿ç¨‹å°±ä¼šé˜»å¡çš„ç­‰å¾…å­çº¿ç¨‹ç»“æŸ</p>
</li>
<li>
<p>detach</p>
<p>ä¸»çº¿ç¨‹æ‰§è¡Œäº†t1.detach()åï¼Œt1çº¿ç¨‹å°±è·‘åˆ°åå°æ‰§è¡Œäº† è·Ÿå½“å‰ä¸»çº¿ç¨‹å°±æ²¡æœ‰å…³ç³»äº†ï¼Œä½†å¦‚æœä¸»çº¿ç¨‹é€€å‡ºï¼Œé‚£ä¹ˆè¿›ç¨‹ä¹Ÿä¼šé€€å‡ºï¼Œæ‰€æœ‰çš„çº¿ç¨‹ä¹Ÿéƒ½ä¼šé€€å‡ºï¼Œå¹¶ä¸æ˜¯è¯´detachåçº¿ç¨‹å°±çœŸçš„å¸¸é©»äº†ï¼Œåªæ˜¯è·Ÿä¸»çº¿ç¨‹è„±ç¦»æ§åˆ¶å…³ç³»äº†ã€‚</p>
</li>
</ul>
<h3 id="é”èµ„æºç«äº‰">é”(èµ„æºç«äº‰)<a hidden class="anchor" aria-hidden="true" href="#é”èµ„æºç«äº‰">#</a></h3>
<ul>
<li>
<p>äº’æ–¥é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>#include&lt;mutex&gt;
</span></span><span style="display:flex;"><span>std::mutex s1;
</span></span><span style="display:flex;"><span>s1.lock(); //åŠ é”
</span></span><span style="display:flex;"><span>doSomething();//å¤„ç†
</span></span><span style="display:flex;"><span>s1.unlock();//è§£é”  æœ€ç®€å•çš„å¯ä»¥é€šè¿‡äº’æ–¥é‡æ¥è§£å†³é—®é¢˜ã€‚åªæœ‰é”æˆåŠŸçš„çº¿ç¨‹ æ‰èƒ½å¯¹å…±äº«èµ„æºåšå¤„ç† å¦åˆ™å°±è¦ç­‰å¾…
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//å¦‚æœä¸æƒ³æ˜¾ç¤ºçš„unlockçš„ æˆ–è€…æ‹…å¿ƒå¿˜è®°å†™unlockä¹Ÿå¯ä»¥ç”¨std::lock_guardä»£ä¸ºç®¡ç†
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	std::mutex s1;
</span></span><span style="display:flex;"><span>	std::lock_guard&lt;std::mutex&gt; lg(s1); //åŠ é” ä¼šåœ¨æ„é€ å‡½æ•°å†…éƒ¨ è°ƒç”¨s1çš„lockå‡½æ•° 
</span></span><span style="display:flex;"><span>	//doSomething();//å¤„ç†
</span></span><span style="display:flex;"><span>}//é€€å‡ºè¿™ä¸ªå¤§æ‹¬å· lgå¯¹è±¡ä¼šææ„ï¼Œææ„çš„æ—¶å€™ä¼šè°ƒç”¨s1çš„unlockå‡½æ•°
</span></span></code></pre></div></li>
<li>
<p>æ­»é”é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">//æ­»é”æµ‹è¯•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeadLock</span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span>  func1(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10000</span>;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>            m1.lock();<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            m2.lock();
</span></span><span style="display:flex;"><span>            cout<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;this is func1&#34;</span><span style="color:#f92672">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>            m2.unlock();
</span></span><span style="display:flex;"><span>            m1.unlock();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span>  <span style="color:#a6e22e">func2</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10000</span>;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>            m2.lock();
</span></span><span style="display:flex;"><span>            m1.lock();
</span></span><span style="display:flex;"><span>            cout<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34;this is func2&#34;</span><span style="color:#f92672">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>            m1.unlock();
</span></span><span style="display:flex;"><span>            m2.unlock();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>mutex m1,m2;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>    cout<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34; ä¸»çº¿ç¨‹id:&#34;</span><span style="color:#f92672">&lt;&lt;</span>std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>get_id()<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34; is running&#34;</span><span style="color:#f92672">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>    DeadLock deadLockTest;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">thread</span> t1(<span style="color:#f92672">&amp;</span>DeadLock<span style="color:#f92672">::</span>func1,<span style="color:#f92672">&amp;</span>deadLockTest);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">thread</span> t2(<span style="color:#f92672">&amp;</span>DeadLock<span style="color:#f92672">::</span>func2,<span style="color:#f92672">&amp;</span>deadLockTest);
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    t2.join();
</span></span><span style="display:flex;"><span>    cout<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34; ä¸»çº¿ç¨‹id:&#34;</span><span style="color:#f92672">&lt;&lt;</span>std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>get_id()<span style="color:#f92672">&lt;&lt;</span><span style="color:#e6db74">&#34; is ready to exit&#34;</span><span style="color:#f92672">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//----------å¤§è‡´æ­»é”è¿‡ç¨‹----------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//t1çº¿ç¨‹ æ‰§è¡Œfunc1å‡½æ•° å…ˆé”äº†m1 å‡†å¤‡å»é”m2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//ç„¶åcpuåˆ‡æ¢åˆ°t2çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//t2çº¿ç¨‹ å…ˆé”äº†m2 å‡†å¤‡å»é”m1 å‘ç°m1è¢«é”äº† ç­‰å¾…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//cpuåˆ‡æ¢åˆ°t1çº¿ç¨‹ å»é”m2 å‘ç°m2è¢«é”äº†ï¼Œç­‰å¾… 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//2ä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ä¸‹å»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//ä¸åŒçº¿ç¨‹ä¹‹é—´åŠ é”è§£é”é¡ºåºåº”è¯¥ä¸€è‡´ é¿å…æ­»é”
</span></span></span></code></pre></div></li>
<li>
<p>std::lock() ä¸€æ¬¡é”å¤šä¸ªäº’æ–¥é‡ è¦ä¹ˆå…¨éƒ¨æˆåŠŸ è¦ä¹ˆå…¨éƒ¨å¤±è´¥ æœ‰åŸå­æ€§</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::mutex m1,m2;
</span></span><span style="display:flex;"><span>std::lock(m1,m2);//è¿™é‡Œm1 m2è¦ä¹ˆåŒæ—¶é”æˆåŠŸ è¦ä¹ˆéƒ½ä¸åŠ é”
</span></span><span style="display:flex;"><span>doSomething();//
</span></span><span style="display:flex;"><span>m1.lock();
</span></span><span style="display:flex;"><span>m2.lock();
</span></span></code></pre></div></li>
<li>
<p>std::lock_guard<a href="std::mutex">std::mutex</a> l1(m1,std::adopt_lock)</p>
<p>åŠ ä¸Šadopt_lockæ ‡è®°ï¼Œå¿…é¡»m1åœ¨ä¹‹å‰å·²ç»è¢«é”äº† å°±ä¸å†é”äº†ï¼Œä½†ææ„l1çš„æ—¶å€™è¿˜æ˜¯ä¼šå°è¯•unlock m1</p>
</li>
<li>
<p>std::unique_lock&lt;&gt;æ¨¡ç‰ˆç±»</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::unique_lock&lt;std::mutex&gt; ul1(m2,std::try_to_lock);//å°è¯•å»æ‹¿é”  ä¸ä¼šé˜»å¡
</span></span><span style="display:flex;"><span>    if( ul1.owns_lock){
</span></span><span style="display:flex;"><span>        //åŠ é”å¤„ç†
</span></span><span style="display:flex;"><span>    }else{
</span></span><span style="display:flex;"><span>        //åšå…¶å®ƒäº‹æƒ…
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::unique_lock&lt;std::mutex&gt; ul1(m2,std::defer_lock);//æ²¡æœ‰åŠ é”
</span></span><span style="display:flex;"><span>    ul1.lock();
</span></span><span style="display:flex;"><span>    //å…±äº«èµ„æºå¤„ç†
</span></span><span style="display:flex;"><span>    ul1.unlock();//æš‚æ—¶è§£é”
</span></span><span style="display:flex;"><span>    //å¤„ç†éå…±äº«èµ„æº
</span></span><span style="display:flex;"><span>    ul1.lock();
</span></span><span style="display:flex;"><span>    //å¤„ç†å…±äº«èµ„æº
</span></span><span style="display:flex;"><span>    //ul1ææ„çš„æ—¶å€™ è¿˜æ˜¯ä¼šunlock unique_lockç›¸å¯¹æ›´åŠ çµæ´» ä½†æ€§èƒ½ä¸Šä¹Ÿä¼šæœ‰æ‰€æŸå¤±
</span></span></code></pre></div></li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::unique_lock&lt;std::mutex&gt; ul1(m2,std::defer_lock);//æ²¡æœ‰åŠ é” åªæ˜¯è·Ÿm2è¿™ä¸ªäº’æ–¥é‡å…³è”
</span></span><span style="display:flex;"><span>    if (ul1.try_lock()==true){//ä¸ä¼šé˜»å¡
</span></span><span style="display:flex;"><span>        //å¤„ç†å…±äº«èµ„æºæˆ–è€…å…±äº«ä»£ç æ®µ
</span></span><span style="display:flex;"><span>    }else{
</span></span><span style="display:flex;"><span>        //æ²¡æœ‰åŠ é”æˆåŠŸ åšäº›åˆ«çš„äº‹æƒ… 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  std::unique_lock&lt;std::mutex&gt; ul2(std::move(ul1));  //è½¬ç§»æ‰€æœ‰æƒ ç›¸å½“äºun1.release  ul2æ ¹m2äº’æ–¥é‡ç»‘å®š
</span></span><span style="display:flex;"><span> //ul1.release()//ä¼šæ”¾å¼ƒè·Ÿå…³è”çš„äº’æ–¥é‡ä¹‹é—´çš„å…³ç³» é‚£ä¹ˆå°±éœ€è¦è‡ªå·±unlockäº†
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>åŠ é”çš„ç²’åº¦è¦æ§åˆ¶å¾—å½“ï¼Œå› ä¸ºåŠ é”ä¼šå½±å“æ•ˆç‡ï¼Œé”çš„ä¸œè¥¿å¿…é¡»æ˜¯æ¶‰åŠèµ„æºç«äº‰çš„ä¸œè¥¿ï¼Œä¸è¦åœ¨lock()å’Œunlock()ä¹‹é—´åŠ å¤ªå¤šä¸æ¶‰åŠå…±äº«çš„ä»£ç ï¼Œä¼šå½±å“æ•ˆç‡</p>
</li>
<li>
<p>std::recursive_mutex é€’å½’çš„ç‹¬å äº’æ–¥é‡ å¯ä»¥lockå¤šæ¬¡ æ•ˆç‡ä½</p>
</li>
<li>
<p>std::timed_mutex  æŠ¢é” åªä¸è¿‡æœ‰è¶…æ—¶æ—¶é—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::timed_mutex timedMutex;
</span></span><span style="display:flex;"><span>    std::chrono::milliseconds timeout(100);
</span></span><span style="display:flex;"><span>    if( timedMutex.try_lock_for(timeout)){//ç­‰å¾…100æ¯«ç§’ å¦‚æœæŠ¢åˆ°äº†é”å°±æ‰§è¡Œ
</span></span><span style="display:flex;"><span>        //å…±äº«èµ„æºå¤„ç†
</span></span><span style="display:flex;"><span>        timedMutex.unlock();
</span></span><span style="display:flex;"><span>    }else{
</span></span><span style="display:flex;"><span>        std::this_thread::sleep_for(timeout);//æŠ¢ä¸åˆ°å°±è¶…æ—¶ ç„¶ååšäº›åˆ«çš„äº‹æƒ…
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> timedMutex.try_lock_until(futureTime);/åˆ°æœªæ¥çš„æ—¶é—´å¦‚æœè¿˜æ²¡æŠ¢åˆ°é” åˆ™è¶…æ—¶ å¦åˆ™ç»§ç»­å¤„ç†
</span></span></code></pre></div></li>
</ul>
<h3 id="æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡<a hidden class="anchor" aria-hidden="true" href="#æ¡ä»¶å˜é‡">#</a></h3>
<p>â€‹     æ˜¯c++11çš„ä¸€ä¸ªæ–°çš„ç±»ï¼Œå¦‚æœçº¿ç¨‹ä¹‹é—´éœ€è¦æŒ‰ç…§é¢„å®šçš„å…ˆåé¡ºåºæ¥æ‰§è¡Œï¼Œå°±å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡è¿™ä¸ªç±»äº†ã€‚</p>
<p>å‡è®¾ä¸€ä¸ªçº¿ç¨‹ç”Ÿäº§æ•°æ®ï¼Œä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œ<strong>æ¶ˆè´¹çº¿ç¨‹ä¸€ç›´åŠ é”è§£é” éå¸¸æ¶ˆè€—cpuèµ„æº</strong>ï¼Œæ‰€ä»¥å¸Œæœ›åŠ é”åå‘ç°æ²¡æœ‰æ•°æ®å°±ç­‰ç€ï¼Œç„¶åå¸Œæœ›ç”Ÿäº§çº¿ç¨‹ç”Ÿäº§äº†æ•°æ®å°±å”¤é†’æ¶ˆè´¹çº¿ç¨‹èµ·æ¥å¹²æ´»ã€‚æ¯”è¾ƒå¸¸è§çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>æ¶ˆè´¹çº¿ç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>std::mutex myMutex; 
</span></span><span style="display:flex;"><span>std::condition_variable cv;
</span></span><span style="display:flex;"><span>vector<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">int</span><span style="color:#f92672">&gt;</span> myVec;
</span></span><span style="display:flex;"><span><span style="color:#f92672">///--------------</span><span style="color:#960050;background-color:#1e0010">ä»¥ä¸‹ä¸ºæ¶ˆè´¹çº¿ç¨‹ä»£ç é€»è¾‘</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(true){
</span></span><span style="display:flex;"><span>    std::unique_lock<span style="color:#f92672">&lt;</span>std::mutex<span style="color:#f92672">&gt;</span> uniquelock1(myMutex);
</span></span><span style="display:flex;"><span>    cv<span style="color:#f92672">.</span>wait(uniquelock1,[](){ <span style="color:#66d9ef">return</span> myVec<span style="color:#f92672">.</span>size()<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>;} ); 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">åŠ é”åå¦‚æœæ²¡æœ‰æ•°æ®</span> waitå°±é‡Šæ”¾é” <span style="color:#960050;background-color:#1e0010">åŒæ—¶æ¶ˆè´¹çº¿ç¨‹åˆ™é˜»å¡åœ¨è¿™é‡Œç­‰å¾…</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">å¦‚æœç”Ÿäº§çº¿ç¨‹</span> <span style="color:#960050;background-color:#1e0010">å”¤é†’äº†å®ƒï¼Œ</span>waitè¿™é‡Œè¿˜è¦åŠ é” <span style="color:#960050;background-color:#1e0010">åŒæ—¶åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æœ‰æ•°æ®ï¼Œæœ‰æ•°æ®å¹¶ä¸”åŠ é”æˆåŠŸäº†</span> <span style="color:#960050;background-color:#1e0010">å°±ä¼šæ‰§è¡Œä¸‹é¢çš„æ¶ˆè´¹é€»è¾‘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//------------</span><span style="color:#960050;background-color:#1e0010">æ¶ˆè´¹æ•°æ®</span><span style="color:#f92672">---------------</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>ç”Ÿäº§çº¿ç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>std::mutex myMutex; 
</span></span><span style="display:flex;"><span>std::condition_variable cv;
</span></span><span style="display:flex;"><span>vector<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">int</span><span style="color:#f92672">&gt;</span> myVec;
</span></span><span style="display:flex;"><span><span style="color:#f92672">///--------------</span><span style="color:#960050;background-color:#1e0010">ä»¥ä¸‹ä¸ºç”Ÿäº§çº¿ç¨‹ä»£ç é€»è¾‘</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(true){
</span></span><span style="display:flex;"><span>    std::unique_lock<span style="color:#f92672">&lt;</span>std::mutex<span style="color:#f92672">&gt;</span> uniquelock1(myMutex);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//--------</span><span style="color:#960050;background-color:#1e0010">ç”Ÿäº§æ•°æ®</span><span style="color:#f92672">--------------</span>
</span></span><span style="display:flex;"><span>    myVec<span style="color:#f92672">.</span>push_back(<span style="color:#e6db74">&#34;xxx&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//-------</span><span style="color:#960050;background-color:#1e0010">ç”Ÿäº§å®Œæ¯•</span> <span style="color:#960050;background-color:#1e0010">å…ˆè§£é”</span>
</span></span><span style="display:flex;"><span>    uniquelock1<span style="color:#f92672">.</span>unlock();
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">//-----</span><span style="color:#960050;background-color:#1e0010">ç„¶åå”¤é†’æ¶ˆè´¹çº¿ç¨‹å¹²æ´»</span>
</span></span><span style="display:flex;"><span>    cv<span style="color:#f92672">.</span>notify_all();<span style="color:#f92672">//</span>cv<span style="color:#f92672">.</span>notify_one();<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">å”¤é†’å› ä¸º</span>cvæ¡ä»¶ä¸æ»¡è¶³ç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹æˆ–è€…æŸä¸€ä¸ªçº¿ç¨‹
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="stdasyncä¸stdfuture">Std::asyncä¸std::future<a hidden class="anchor" aria-hidden="true" href="#stdasyncä¸stdfuture">#</a></h3>
<ul>
<li>
<p>std::asyncåˆ›å»ºä¸€ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä¼ é€’çš„ä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡åªè¦æ˜¯callable objectå‡å¯ï¼Œç„¶åè¿”å›ä¸€ä¸ªstd::futureã€‚futureå‚¨å­˜ä¸€ä¸ªå¤šçº¿ç¨‹å…±äº«çš„çŠ¶æ€,å½“è°ƒç”¨future.getæ—¶ä¼šé˜»å¡ç›´åˆ°ç»‘å®šçš„taskæ‰§è¡Œå®Œæ¯•</p>
</li>
<li>
<p>åˆ›å»ºasyncçš„æ—¶å€™æŒ‡å®šä¸€ä¸ªlaunch policy</p>
<ul>
<li>std::launch::asyncå½“è¿”å›çš„futureå¤±æ•ˆå‰ä¼šå¼ºåˆ¶æ‰§è¡Œtaskï¼Œå³ä¸è°ƒç”¨future.getä¹Ÿä¼šä¿è¯taskçš„æ‰§è¡Œ åˆ›å»ºæ–°çº¿ç¨‹</li>
<li>std::launch::deferredä»…å½“è°ƒç”¨future.getæ—¶æ‰ä¼šæ‰§è¡Œtask ä¸åˆ›å»ºæ–°çº¿ç¨‹ åªæ˜¯å»¶è¿Ÿæ‰§è¡Œ</li>
<li>ä¸æŒ‡å®šç­–ç•¥ï¼Œç³»ç»Ÿéšæœºã€‚</li>
<li>Wait_forå¯ä»¥æŒ‡å®šæ—¶é—´ ç„¶åè·å–çŠ¶æ€(ready æˆåŠŸæ‰§è¡Œå®Œæ¯•ã€timeoutè¶…æ—¶ã€deferredå»¶æœŸçš„å°šæœªæ‰§è¡Œçš„)</li>
<li>åªèƒ½getä¸€æ¬¡ å¦‚æœæƒ³getå¤šæ¬¡ å¯ä»¥<strong>std::shared_future</strong> resultShare(result.share());//</li>
</ul>
</li>
<li>
<p>è¿™ç§æ–¹å¼å¯ä»¥å¾ˆæ–¹ä¾¿çš„è·å–çº¿ç¨‹çš„è®¡ç®—ç»“æœã€‚</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>bool printThead(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    sleep(5);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    return true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    std::future&lt;bool&gt; result=std::async(printThead);
</span></span><span style="display:flex;"><span>    //std::future&lt;bool&gt; result=std::async(std::launch::deferred,printThead);//å¦‚æœæ¢æˆè¿™è¡Œ ä¸»çº¿ç¨‹ä¸ç­‰å­çº¿ç¨‹ ç›´æ¥é€€å‡ºï¼Œå­çº¿ç¨‹æ ¹æœ¬æ²¡æœ‰è¢«æ‰§è¡Œ å¿…é¡»è°ƒç”¨futureçš„waitæˆ–è€…getæ‰ä¼šè¢«æ‰§è¡Œ
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;//æ‰§è¡Œåˆ°è¿™é‡Œä¸»çº¿ç¨‹ä¸ä¼šé€€å‡º printTheadçº¿ç¨‹ä¼šè¢«å¼ºåˆ¶æ‰§è¡Œå®Œæˆ é»˜è®¤ç­–ç•¥æ˜¯std::launch::async
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>-----è¾“å‡º-----
</span></span><span style="display:flex;"><span>ä¸»çº¿ç¨‹id:0x113812dc0 is running
</span></span><span style="display:flex;"><span> ä¸»çº¿ç¨‹id:0x113812dc0 is ready to exit
</span></span><span style="display:flex;"><span>çº¿ç¨‹id:0x700006f48000 is running
</span></span><span style="display:flex;"><span>...sleeping
</span></span><span style="display:flex;"><span>çº¿ç¨‹id:0x700006f48000 is ready to exit 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>////mainå‡½æ•°å¯ä»¥æ”¹ä¸ºå¦‚ä¸‹çš„ï¼š
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    std::future&lt;bool&gt; result=std::async(std::launch::deferred,printThead);
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;è°ƒç”¨futureçš„getæ–¹æ³• å¼€å§‹å¯åŠ¨printThreadçº¿ç¨‹æ‰§è¡Œ åŒæ—¶ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;printThreadçº¿ç¨‹æ‰§è¡Œç»“æœä¸º:&#34;&lt;&lt;result.get()&lt;&lt;endl;//è°ƒç”¨getæ–¹æ³• æˆ–è€…waitæ–¹æ³• ä¸»çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾… å¯ä»¥æ§åˆ¶ä¸»çº¿ç¨‹æ‰§è¡Œæ—¶æœº
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="stdpackaged_task">std::packaged_task<a hidden class="anchor" aria-hidden="true" href="#stdpackaged_task">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>bool printThead(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    sleep(5);//ä¼‘çœ ä¸€ç§’é’Ÿ
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    return true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    std::packaged_task&lt;bool()&gt; myThreadPackage(printThead);//æ‰“åŒ…ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå…¥å£å‡½æ•°
</span></span><span style="display:flex;"><span>    thread t1(std::ref(myThreadPackage));//ç”¨æ‰“åŒ…å¥½çš„å…¥å£å‡½æ•° å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    // t1.detach();//detachä¹Ÿæ²¡æœ‰ è°ƒç”¨äº†getå°±ä¼šé˜»å¡ç­‰å¾…çš„
</span></span><span style="display:flex;"><span>    std::future&lt;bool&gt; result=myThreadPackage.get_future();//å¾—åˆ°è¿”å›ç»“æœ
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;printThreadçº¿ç¨‹æ‰§è¡Œç»“æœä¸º:&#34;&lt;&lt;result.get()&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥åŒ…è£…ä»»ä½•å¯æ‰§è¡Œå¯¹è±¡ ä¸‹é¢æ˜¯lambdaè¡¨è¾¾å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>std::packaged_task&lt;bool()&gt; myThreadPackage( [](){
</span></span><span style="display:flex;"><span>	.......
</span></span><span style="display:flex;"><span>	return true;
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><p>std::packaged_taskä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ ç›¸å½“äºå‡½æ•°è°ƒç”¨ è€Œä¸æ˜¯å¯åŠ¨çº¿ç¨‹</p>
<h3 id="stdpromise-ç±»æ¨¡ç‰ˆ-ä¿å­˜çº¿ç¨‹è®¡ç®—ç»“æœ">Std::promise ç±»æ¨¡ç‰ˆ ä¿å­˜çº¿ç¨‹è®¡ç®—ç»“æœ<a hidden class="anchor" aria-hidden="true" href="#stdpromise-ç±»æ¨¡ç‰ˆ-ä¿å­˜çº¿ç¨‹è®¡ç®—ç»“æœ">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>void promiseTest(std::promise&lt;int&gt; &amp;result,int num){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹promiseTest id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    num+=5;
</span></span><span style="display:flex;"><span>    sleep(3);
</span></span><span style="display:flex;"><span>    result.set_value(num);
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹promiseTest id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit &#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is running&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    std::promise&lt;int&gt; myResult;
</span></span><span style="display:flex;"><span>    thread t1(promiseTest,std::ref(myResult),999);
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    std::future&lt;int&gt; result=myResult.get_future();
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34;çº¿ç¨‹è¿ç®—ç»“æœä¸º:&#34;&lt;&lt;result.get()&lt;&lt;endl;
</span></span><span style="display:flex;"><span>    cout&lt;&lt;&#34; ä¸»çº¿ç¨‹id:&#34;&lt;&lt;std::this_thread::get_id()&lt;&lt;&#34; is ready to exit&#34;&lt;&lt;endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>-----è¾“å‡ºç»“æœ-------
</span></span><span style="display:flex;"><span>ä¸»çº¿ç¨‹id:0x107f2bdc0 is running
</span></span><span style="display:flex;"><span>çº¿ç¨‹promiseTest id:0x70000a5e8000 is running
</span></span><span style="display:flex;"><span>çº¿ç¨‹promiseTest id:0x70000a5e8000 is ready to exit 
</span></span><span style="display:flex;"><span>çº¿ç¨‹è¿ç®—ç»“æœä¸º:1004
</span></span><span style="display:flex;"><span>ä¸»çº¿ç¨‹id:0x107f2bdc0 is ready to exit
</span></span></code></pre></div><h3 id="åŸå­æ“ä½œstdatomic">åŸå­æ“ä½œstd::atomic<a hidden class="anchor" aria-hidden="true" href="#åŸå­æ“ä½œstdatomic">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>int count=0;
</span></span><span style="display:flex;"><span>void myTest(){
</span></span><span style="display:flex;"><span>	for (int i=0;i&lt;100000;++i){
</span></span><span style="display:flex;"><span>		count++;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>int main(){
</span></span><span style="display:flex;"><span>	thread t1(myTest);
</span></span><span style="display:flex;"><span>	thread t2(myTest);
</span></span><span style="display:flex;"><span>	t1.join();
</span></span><span style="display:flex;"><span>	t2.join();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>//count++æ‰§è¡Œçš„æ—¶å€™æ˜¯æœ‰å¤šæ¡æ‰§è¡Œçš„ï¼Œåˆå› ä¸ºcpuç¼“å­˜çš„ä¸å¯è§æ€§ï¼Œå¤šæ ¸cpuå¯èƒ½å‡ºç°æœ€åä¸æ˜¯200000çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯count++å˜æˆäº†ä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰€è°“åŸå­æ“ä½œå°±æ˜¯è¿™ä¸ªæ“ä½œè¦ä¹ˆå› æ­¤å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿåˆ«æ‰§è¡Œã€‚
</span></span><span style="display:flex;"><span>//c++11å¢åŠ äº†auomicæ¨¡ç‰ˆ æ”¯æŒå˜é‡çš„åŸå­æ“ä½œ,è§£å†³ä¸Šè¿°é—®é¢˜å¯ä»¥åŠ äº’æ–¥é”ï¼Œä½†æ•ˆç‡ä¸é«˜ï¼Œå¯ä»¥ä½¿ç”¨åŸå­æ“ä½œç±»æ¨¡ç‰ˆã€‚
</span></span><span style="display:flex;"><span>std::atomic&lt;int&gt; count=0;å°±ä¸ä¼šå‡ºç°é—®é¢˜äº†
</span></span><span style="display:flex;"><span>ä½†ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½æ”¯æŒåŸå­æ“ä½œï¼Œæ¯”å¦‚count++æ²¡é—®é¢˜ ä½†æ˜¯ count=count+1å°±ä¸æ”¯æŒäº†ï¼Œä½¿ç”¨æ—¶å€™è¦æŸ¥çœ‹apiè¯´æ˜
</span></span><span style="display:flex;"><span>åŸå­æ“ä½œçš„èµ‹å€¼éœ€è¦ä½¿ç”¨APIç‰¹å®šçš„æ–¹æ³• 
</span></span></code></pre></div><h3 id="stdthreadå’ŒstdasyncåŒºåˆ«">Std::threadå’Œstd::asyncåŒºåˆ«<a hidden class="anchor" aria-hidden="true" href="#stdthreadå’ŒstdasyncåŒºåˆ«">#</a></h3>
<ul>
<li>threadåˆ›å»ºçº¿ç¨‹ å¦‚æœèµ„æºç´§å¼ ï¼Œå¯èƒ½åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½ç³»ç»Ÿå´©æºƒ</li>
<li>Std::async å¯èƒ½è¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œæ›´æ–¹ä¾¿çš„</li>
</ul>
<h3 id="thread_local">thread_local<a hidden class="anchor" aria-hidden="true" href="#thread_local">#</a></h3>
<p>â€‹	thread_localå®šä¹‰çš„å˜é‡ä¼šåœ¨æ¯ä¸ªçº¿ç¨‹ä¿å­˜ä¸€ä»½å‰¯æœ¬ï¼Œè€Œä¸”äº’ä¸å¹²æ‰°ï¼Œåœ¨çº¿ç¨‹é€€å‡ºçš„æ—¶å€™è‡ªåŠ¨æ‘§æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;chrono&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">thread_local</span> <span style="color:#66d9ef">int</span> g_k <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func1</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (true){
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>g_k;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func2</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (true){
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;func2 thread ID is : &#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>get_id() <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;func2 g_k = &#34;</span> <span style="color:#f92672">&lt;&lt;</span> g_k <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>sleep_for(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>milliseconds(<span style="color:#ae81ff">1000</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t1(func1);
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> t2(func2);
</span></span><span style="display:flex;"><span>    t1.join();
</span></span><span style="display:flex;"><span>    t2.join();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">----</span><span style="color:#960050;background-color:#1e0010">åœ¨</span>func1()<span style="color:#960050;background-color:#1e0010">å¯¹</span>g_kå¾ªç¯åŠ 1æ“ä½œ<span style="color:#960050;background-color:#1e0010">ï¼Œåœ¨</span>func2()<span style="color:#960050;background-color:#1e0010">æ¯ä¸ª</span><span style="color:#ae81ff">1000</span><span style="color:#960050;background-color:#1e0010">æ¯«ç§’è¾“å‡ºä¸€æ¬¡</span>g_kçš„å€¼<span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span>func2 <span style="color:#66d9ef">thread</span> ID is : <span style="color:#ae81ff">15312</span>
</span></span><span style="display:flex;"><span>func2 g_k <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>func2 <span style="color:#66d9ef">thread</span> ID is : <span style="color:#ae81ff">15312</span>
</span></span><span style="display:flex;"><span>func2 g_k <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>func2 <span style="color:#66d9ef">thread</span> ID is : <span style="color:#ae81ff">15312</span>
</span></span><span style="display:flex;"><span>.....<span style="color:#960050;background-color:#1e0010">å¯ä»¥çœ‹å‡º</span>func2()<span style="color:#960050;background-color:#1e0010">ä¸­çš„</span>g_kå§‹ç»ˆä¿æŒä¸å˜
</span></span></code></pre></div><h1 id="ç»å…¸ioæ¨¡å‹å®ç°">ç»å…¸IOæ¨¡å‹å®ç°<a hidden class="anchor" aria-hidden="true" href="#ç»å…¸ioæ¨¡å‹å®ç°">#</a></h1>
<h2 id="ppctpc">PPCã€TPC<a hidden class="anchor" aria-hidden="true" href="#ppctpc">#</a></h2>
<ul>
<li>Process Per Connectionã€Process Per Connection</li>
</ul>
<h3 id="æ•´ä½“æ€è·¯æ€»ç»“åŠç½‘æœå›¾è§£">æ•´ä½“æ€è·¯æ€»ç»“åŠç½‘æœå›¾è§£<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯æ€»ç»“åŠç½‘æœå›¾è§£">#</a></h3>
<h4 id="è¿æ¥æ¥æ—¶åˆ›å»ºçº¿ç¨‹">è¿æ¥æ¥æ—¶åˆ›å»ºçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è¿æ¥æ¥æ—¶åˆ›å»ºçº¿ç¨‹">#</a></h4>
<ol>
<li>
<p>ä¸»è¿›ç¨‹/ä¸»çº¿ç¨‹è´Ÿè´£åˆ›å»ºç›‘å¬socketã€å¯åŠ¨ç›‘å¬</p>
</li>
<li>
<p>å¯¹æ¯ä¸€ä¸ªæ–°çš„client åˆ›å»ºå¯¹åº”çš„å¤„ç†è¿›ç¨‹/çº¿ç¨‹(å®Œæˆread&mdash;&gt;business process&mdash;&gt;send)</p>
<p><img loading="lazy" src="http://becool.vip:666/img/ppc_tpc_notPreModel.jpeg" alt=""  />
</p>
</li>
</ol>
<ul>
<li>å¤šè¿›ç¨‹éœ€è¦closeæ‰connfdï¼Œå¤šçº¿ç¨‹ä¸éœ€è¦</li>
</ul>
<h4 id="é¢„å…ˆåˆ›å»ºå·å¤„ç†è¿›ç¨‹æˆ–è€…çº¿ç¨‹">é¢„å…ˆåˆ›å»ºå·å¤„ç†è¿›ç¨‹æˆ–è€…çº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#é¢„å…ˆåˆ›å»ºå·å¤„ç†è¿›ç¨‹æˆ–è€…çº¿ç¨‹">#</a></h4>
<ol>
<li>
<p>æå‰åˆ›å»ºå¥½å¤šä¸ªå¤„ç†è¿›ç¨‹/çº¿ç¨‹</p>
</li>
<li>
<p>è¿æ¥è¿›æ¥åˆ†é…åˆ°é¢„å…ˆåˆ›å»ºå¥½çš„å¤„ç†è¿›ç¨‹/çº¿ç¨‹</p>
<p><img loading="lazy" src="http://becool.vip:666/img/ppc_tpc_prework.jpeg" alt=""  />
</p>
</li>
</ol>
<ul>
<li>æ³¨æ„acceptæƒŠç¾¤(TCP_IPæ–‡ç« æœ‰è®²è§£)ï¼Œè§£å†³æ–¹æ¡ˆ(è‡ªå·±åŠ accept_mutexé”ã€æ–°ä¸€ç‚¹çš„å†…æ ¸ç›´æ¥è®¾ç½®SO_REUSEPORTé€‰é¡¹ä¹Ÿæ˜¯å¯ä»¥çš„å†…æ ¸ä¼šéšæœºåˆ†é…ã€&hellip;.)</li>
</ul>
<h3 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h3>
<ul>
<li>ä¼˜ç‚¹ï¼šå¼€å‘ç®€å•</li>
<li>ç¼ºç‚¹:   èƒ½ç»™ç®¡ç†çš„è¿æ¥æ•°å¤ªå°‘äº†ï¼Œå› ä¸º1ä¸ªè¿›ç¨‹/çº¿ç¨‹ ç®¡ç†ä¸€ä¸ªclientå¥—æ¥å­—ï¼Œè€Œå•æœºç¡¬ä»¶æ¡ä»¶é™åˆ¶(cpuã€å†…å­˜)ï¼Œæ‰€ä»¥åŒæ—¶ç®¡ç†çš„ä»»åŠ¡è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æœ‰é™äº†(è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¤ªé‡ï¼Œçº¿ç¨‹ä¸Šåƒçº§åˆ«å¾€å¾€è°ƒåº¦ä¹Ÿæ˜¯éå¸¸æ¶ˆè€—æ—¶é—´äº†)ï¼Œæ‰€ä»¥æƒ³è¦é«˜å¹¶å‘ï¼Œppcå’Œtpcå¾€å¾€ç›´æ¥å¯ä»¥passäº†ã€‚</li>
</ul>
<h2 id="reactoræ€æƒ³">Reactoræ€æƒ³<a hidden class="anchor" aria-hidden="true" href="#reactoræ€æƒ³">#</a></h2>
<ul>
<li>æ¯ä¸ªè¿›ç¨‹/çº¿ç¨‹é€šè¿‡IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ç°ä¸€ä¸ªè¿›ç¨‹ç®¡ç†å¤šä¸ªè¿æ¥(å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ æ¯”å¦‚epollfd),åº”ç”¨åªé˜»å¡åœ¨epollfdä¸Šã€‚å½“è¿æ¥æœ‰æ•°æ®å¯ä»¥å¤„ç†çš„æ—¶å€™ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨è®©å†…æ ¸é€šçŸ¥åº”ç”¨ï¼Œç„¶åè¿›ç¨‹/çº¿ç¨‹å°±ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</li>
<li>reactorå¤„ç†æ€æƒ³å¤§å¤šä¹Ÿä¼šæœ‰ä¸€ä¸ªåˆ†å‘çš„æ€æƒ³å­˜åœ¨(Dispatch),æˆ–åˆ™å«åšæ‹†åˆ†ï¼Œä¹Ÿå°±å°†listenã€acceptã€(send read)ã€business processåˆ†å¼€ï¼Œè¿æ¥æœ‰æ•°æ®å¯ä»¥å¤„ç†ï¼Œå°±åˆ†å‘ç»™å¯¹åº”çš„handlerå¤„ç†ï¼Œå½“ç„¶handlerå¯ä»¥å†æ‹†å‡ºworkerçº¿ç¨‹æ± ç­‰ç­‰ã€‚</li>
<li>å¾€è®¾è®¡æ¨¡å¼çš„Observeæ¨¡å¼ä¸Šç†è§£ï¼Œè§‰å¾—ä¹Ÿå¯ä»¥ï¼Œå½“æ¶ˆæ¯æ¥äº†ï¼Œå°±é€šçŸ¥å¯¹åº”çš„è¿›ç¨‹/çº¿ç¨‹æ¥å¤„ç†(å½“ç„¶å¤„ç†å¯ä»¥å†æ¬¡æ‹†åˆ†)</li>
<li>è®¨è®ºä¸€äº›å…·ä½“reactoræ¨¡å¼å®ç°çš„æ—¶å€™ é‡Œé¢çš„reactorä¸€èˆ¬æ˜¯æŒ‡è´Ÿè´£ç›‘å¬å’Œåˆ†å‘ä»»åŠ¡çš„è§’è‰²</li>
</ul>
<h2 id="å•reactorå•çº¿ç¨‹å¤„ç†æ•´ä½“å°±ä¸€ä¸ªçº¿ç¨‹---redis">å•Reactor+å•çº¿ç¨‹å¤„ç†(æ•´ä½“å°±ä¸€ä¸ªçº¿ç¨‹)&mdash;redis<a hidden class="anchor" aria-hidden="true" href="#å•reactorå•çº¿ç¨‹å¤„ç†æ•´ä½“å°±ä¸€ä¸ªçº¿ç¨‹---redis">#</a></h2>
<ul>
<li>rediså°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä»£è¡¨ ä¸‹é¢æ˜¯redisè¿™ä¸ªioæ¨¡å‹çš„ç®€å•ç†è§£</li>
</ul>
<h3 id="æ•´ä½“æ€è·¯">æ•´ä½“æ€è·¯ï¼š<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯">#</a></h3>
<ol>
<li>çº¿ç¨‹åˆ›å»ºsocketå¯åŠ¨ç›‘å¬ æ³¨å†Œepoll</li>
<li>epoll_waitç­‰å¾…å®¢æˆ·ç«¯è¿æ¥æˆ–è€…è¯·æ±‚æ•°æ®ï¼Œæ‹¿åˆ°æ‰€æœ‰å¯ä»¥å¤„ç†çš„fdï¼Œç„¶åé¡ºåºéå†å¤„ç†å³å¯
<ul>
<li>å¦‚æœæ˜¯acceptäº‹ä»¶ å°±ä¹Ÿæ³¨å†Œåˆ°epoll</li>
<li>å¦‚æœæ˜¯connfdçš„è¯·æ±‚ å°±è¯»å–è¯·æ±‚&mdash;&gt;å¤„ç†&mdash;&gt;å›åŒ…</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="http://becool.vip:666/img/redis_IO%e7%ae%80%e5%8d%95%e7%90%86%e8%a7%a3.jpeg" alt=""  />
</p>
<h3 id="æ€»ç»“-1">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-1">#</a></h3>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¨¡å‹ç®€å•ï¼Œå› ä¸ºå°±ä¸€ä¸ªçº¿ç¨‹ ä¸ç”¨è€ƒè™‘å¹¶å‘ æ˜“å¼€å‘ï¼Œå‰é¢IOå¤ç”¨é‡Œé¢ä¹Ÿæœ‰epollçš„ä¾‹å­å°±æ˜¯è¿™ä¸ªå¥—è·¯</li>
<li>é€‚åˆçŸ­è€—æ—¶ä¸šåŠ¡(ä¸»ä¸šåŠ¡å¤„ç†é€»è¾‘ä¸èƒ½å¤ªè€—æ—¶ï¼Œå¦åˆ™å¿…ç„¶å½±å“æ–°è¿æ¥çš„å»ºè®®æˆ–è€…å…¶ä»–å®¢æˆ·ç«¯çš„å¤„ç†ç­‰å¾…)</li>
</ul>
</li>
<li>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ€§èƒ½ä¼šæœ‰ç“¶é¢ˆçš„ åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸cpuä¼˜åŠ¿</li>
<li>å› ä¸ºæ˜¯é¡ºåºå¤„ç†è¯·æ±‚ï¼Œé‡åˆ°é•¿è€—æ—¶çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¼šå»¶è¿Ÿæ‰€æœ‰ä¸šåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯redisç¦ç”¨è€—æ—¶å‘½ä»¤çš„åŸå› </li>
</ul>
</li>
<li>
<p>rediså› ä¸ºå¤„ç†å…¨åœ¨å†…å­˜ï¼Œå•ä¸ªè¯·æ±‚å¤„ç†éå¸¸å¿«ï¼Œæ‰€ä»¥é€‚åˆè¿™ä¹ˆå¤„ç†ï¼Œredisæ®è¯´å¯ä»¥æœ‰10Wçš„QPSååé‡</p>
</li>
</ul>
<h2 id="å•reactorå•é˜Ÿåˆ—ä¸šåŠ¡è¿›ç¨‹çº¿ç¨‹æ± ---thrift0100-nonblocking-server">å•Reactor+å•é˜Ÿåˆ—+ä¸šåŠ¡è¿›ç¨‹/çº¿ç¨‹æ± &mdash;thrift0.10.0 nonblocking server<a hidden class="anchor" aria-hidden="true" href="#å•reactorå•é˜Ÿåˆ—ä¸šåŠ¡è¿›ç¨‹çº¿ç¨‹æ± ---thrift0100-nonblocking-server">#</a></h2>
<h3 id="æ•´ä½“æ€è·¯-1">æ•´ä½“æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯-1">#</a></h3>
<ol>
<li>
<p>ä¸»çº¿ç¨‹å¯åŠ¨å¥—æ¥å­—ç›‘å¬ æ³¨å†Œepoll ï¼Œæœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥å°±ä¹Ÿæ³¨å†Œåˆ°epoll</p>
</li>
<li>
<p>ä¸»çº¿ç¨‹epoll_wait ç›‘æ§è¯·æ±‚æ•°æ®åˆ°è¾¾</p>
</li>
<li>
<p>ä¸»çº¿ç¨‹ä»connfdå®¢æˆ·ç«¯å¥—æ¥å­—readè¯·æ±‚æ•°æ® å…¥è¯·æ±‚é˜Ÿåˆ—</p>
</li>
<li>
<p>å­çº¿ç¨‹ä»é˜Ÿåˆ—å–å‡ºè¯·æ±‚ï¼Œè¿›è¡Œbusiness processï¼Œå¤„ç†å®Œæˆåº”ç­”æŠ¥æ–‡è¿˜æ˜¯äº¤ç”±ä¸»çº¿ç¨‹sendç»™client(clientfdåœ¨ä¸»çº¿ç¨‹hold)</p>
<p><img loading="lazy" src="http://becool.vip:666/img/%e5%8d%95reactor_%e5%8d%95%e9%98%9f%e5%88%97_worker%e7%ba%bf%e7%a8%8b%e6%b1%a0.jpeg" alt=""  />
</p>
</li>
</ol>
<ul>
<li>å®¢æˆ·ç«¯å¥—æ¥å­—å¯ä»¥æƒ³è±¡æˆä¸€ä¸ªé˜Ÿåˆ— reactorå°†è¿™ä¸ªé˜Ÿåˆ—é€šè¿‡IOå¤šè·¯å¤ç”¨è½¬æ¢æˆäº†çœŸæ­£çš„ä¸šåŠ¡è¯·æ±‚æ•°æ®é˜Ÿåˆ—ã€‚</li>
<li>ä¸šåŠ¡çº¿ç¨‹æ± çº¿ç¨‹æ± ï¼Œä»é˜Ÿåˆ—ä¸­æ‹¿åˆ°æ•°æ®è¿›è¡ŒçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œå°†ç»“æœè¿”å›Handlerã€‚Handleræ”¶åˆ°å“åº”ç»“æœåï¼Œsendç»“æœç»™å®¢æˆ·ç«¯</li>
<li>thrift0.10.0ç‰ˆæœ¬ä¸­ nonblocking server ä½¿ç”¨è¿™ç§æ¨¡å‹</li>
</ul>
<h3 id="æ€»ç»“-2">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-2">#</a></h3>
<ul>
<li>ä¼˜ç‚¹ï¼š
<ul>
<li>å¤šçº¿ç¨‹åŠ å¿«äº†çœŸæ­£ä¸šåŠ¡æ•°æ®å¤„ç†çš„é€Ÿåº¦ï¼Œè¿™ä¸ªæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå› ä¸ºä¸šåŠ¡å¤„ç†å¤§éƒ½æ˜¯æ¯”è¾ƒè€—æ—¶çš„(è·Ÿæ•°æ®åº“æ‰“äº¤é“ï¼Œè¿œç¨‹RPCç­‰ç­‰)</li>
</ul>
</li>
<li>å¯èƒ½å‡ºç°çš„ç¼ºç‚¹ï¼š
<ul>
<li>æ€§èƒ½ç“¶é¢ˆå¾ˆå¤§å¯èƒ½å‡ºç°åœ¨è¯·æ±‚é˜Ÿåˆ—ï¼Œå› ä¸ºä¸»çº¿ç¨‹å†™å’Œworkerçº¿ç¨‹è¯»æ˜¯çº¿ç¨‹å¹¶å‘çš„ï¼Œæ‰€ä»¥éœ€è¦é”(å¤šè¿›ç¨‹ä¸€æ ·)ï¼Œè¦é‡‡ç”¨é«˜æ€§èƒ½çš„è¯»å†™é”</li>
</ul>
</li>
</ul>
<h2 id="å•-reactorné˜Ÿåˆ—nçº¿ç¨‹---memcached">å• Reactor+Né˜Ÿåˆ—+Nçº¿ç¨‹&mdash;memcached<a hidden class="anchor" aria-hidden="true" href="#å•-reactorné˜Ÿåˆ—nçº¿ç¨‹---memcached">#</a></h2>
<h3 id="æ•´ä½“æ€è·¯-2">æ•´ä½“æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯-2">#</a></h3>
<ol>
<li>ä¸»çº¿ç¨‹åˆ›å»ºsocketç›‘å¬ï¼ŒåŒæ—¶acceptï¼Œå°†acceptçš„connfdé‡‡ç”¨Robinè½®è¯¢çš„æ–¹å¼ï¼Œæ‰”ç»™workerçº¿ç¨‹çš„é˜Ÿåˆ—</li>
<li>æ¯ä¸ªworkerçº¿ç¨‹ é‡‡ç”¨IOå¤šè·¯å¤ç”¨æŠ€æœ¯ä»è‡ªå·±çš„é˜Ÿåˆ—ä¸­å–å‡ºconnfdï¼Œç„¶åread&mdash;&gt;business process&ndash;&gt;send</li>
<li>æ¯ä¸ªworkerçº¿ç¨‹çš„é˜Ÿåˆ—å­˜æ”¾çš„æ˜¯connfdï¼Œæˆ‘ç†è§£è¿™ç§å…¶å®ä¹Ÿç®—æ˜¯ä¸»ä»Reactoræ¨¡å¼(master Reactoråªacceptï¼Œç„¶åæ‰”ç»™å¤šä¸ªsubReactor)</li>
</ol>
<p><img loading="lazy" src="http://becool.vip:666/img/memcached_IO%e6%a8%a1%e5%9e%8b.png" alt=""  />
</p>
<p><img loading="lazy" src="http://becool.vip:666/img/memcached_IO%e6%a8%a1%e5%9e%8b1.jpeg" alt=""  />
</p>
<h3 id="æ€»ç»“-3">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-3">#</a></h3>
<ul>
<li>ä¼˜ç‚¹ï¼šè§£å†³å•é˜Ÿåˆ—çš„æ€§èƒ½ç“¶é¢ˆï¼Œè€Œä¸”è¿™é‡Œçš„å¤šé˜Ÿåˆ—é‡Œé¢æ”¾çš„connfdï¼Œä¸å­˜åœ¨ä¸Šé¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªé˜Ÿåˆ—çš„é”ç«äº‰æ€§èƒ½æ¶ˆè€—</li>
<li>ç¼ºç‚¹ï¼šè´Ÿè½½å‡è¡¡å¯èƒ½å¯¼è‡´æœ‰äº›é˜Ÿåˆ—å¾ˆå¿™ï¼Œæœ‰äº›é˜Ÿåˆ—å¾ˆé—²ã€‚æ¯”å¦‚é˜Ÿåˆ—1é‡Œé¢æ”¾çš„å®¢æˆ·ç«¯ï¼Œå‘é€è¯·æ±‚æ¯”è¾ƒé¢‘ç¹ï¼Œé˜Ÿåˆ—2é‡Œé¢æ”¾çš„å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ¯”è¾ƒç©ºé—²ã€‚</li>
</ul>
<h2 id="ä¸»è¿›ç¨‹ç®¡ç†å¤šè¿›ç¨‹acceptepoll_waitå¤„ç†--nginx">ä¸»è¿›ç¨‹ç®¡ç†+å¤šè¿›ç¨‹(accept+epoll_wait+å¤„ç†)&ndash;nginx<a hidden class="anchor" aria-hidden="true" href="#ä¸»è¿›ç¨‹ç®¡ç†å¤šè¿›ç¨‹acceptepoll_waitå¤„ç†--nginx">#</a></h2>
<h3 id="æ•´ä½“æ€è·¯-3">æ•´ä½“æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯-3">#</a></h3>
<ol>
<li>ä¸»è¿›ç¨‹å…ˆåˆ›å»ºsocket å¯åŠ¨ç›‘å¬ï¼Œç„¶åforkå‡ºä¸€å †workerè¿›ç¨‹ï¼ˆ ä¸»è¿›ç¨‹ä¸accept åªæ˜¯ç®¡ç†å¤šä¸ªworkerè¿›ç¨‹ æ¯”å¦‚åŠ¨æ€å¢åŠ workerä¹‹ç±»çš„ï¼‰</li>
<li>æ¯ä¸ªworkerè¿›ç¨‹ åŒæ—¶acceptå®¢æˆ·ç«¯è¿æ¥(accept_mutexé”è§£å†³æƒŠç¾¤é—®é¢˜)ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªworkerè‡ªå·±æŠ¢å®¢æˆ·ï¼ŒåŒæ—¶å¤„ç†è‡ªå·±æŠ¢åˆ°çš„å¤šä¸ªå®¢æˆ·(epoll_wait)</li>
<li>workerè¿›ç¨‹æ ¹æ®è‡ªèº«è´Ÿè½½æƒ…å†µï¼Œé€‰æ‹©æ€§åœ°ä¸å»acceptæ–°fdï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡</li>
</ol>
<p><img loading="lazy" src="http://becool.vip:666/img/nginx_IO%e6%a8%a1%e5%9e%8b.jpeg" alt=""  />
</p>
<h3 id="æ€»ç»“-4">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-4">#</a></h3>
<ul>
<li>ä¼˜ç‚¹ï¼š
<ul>
<li>æŸä¸ªworkerè¿›ç¨‹æŒ‚æ‰ä¸ä¼šå½±å“æ•´ä¸ªæœåŠ¡</li>
<li>æ˜¯ç”±<strong>workerä¸»åŠ¨å®ç°è´Ÿè½½å‡è¡¡çš„</strong>ï¼Œè¿™ç§è´Ÿè½½å‡è¡¡æ–¹å¼æ¯”ç”±masteræ¥å¤„ç†æ›´ç®€å•</li>
</ul>
</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>å¤šè¿›ç¨‹æ¨¡å‹ç¼–ç¨‹ç›¸å¯¹å¤æ‚ï¼Œå¼€å‘æœ‰ä¸€å®šéš¾åº¦</li>
<li>è¿›ç¨‹çš„å¼€é”€æ˜¯æ¯”çº¿ç¨‹æ›´å¤šçš„</li>
</ul>
</li>
</ul>
<h2 id="ä¸»ä»å¤šreactorå¤šçº¿ç¨‹å¤„ç†">ä¸»ä»å¤šreactorå¤šçº¿ç¨‹å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#ä¸»ä»å¤šreactorå¤šçº¿ç¨‹å¤„ç†">#</a></h2>
<h3 id="æ•´ä½“æ€è·¯-4">æ•´ä½“æ€è·¯ï¼š<a hidden class="anchor" aria-hidden="true" href="#æ•´ä½“æ€è·¯-4">#</a></h3>
<ol>
<li>ä¸»çº¿ç¨‹åˆ›å»ºsocket å¯åŠ¨ç›‘å¬ï¼Œå¯åŠ¨acceptçº¿ç¨‹æ± (å¯ä»¥æ˜¯1ä¸ªæˆ–è€…å¤šä¸ª) è¿™ä¸ªçº¿ç¨‹æ± åªè´Ÿè´£acceptå®¢æˆ·ç«¯è¿æ¥
<ul>
<li>æ¯ä¸ªacceptçº¿ç¨‹ æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¹‹å å°†connfdä¼ ç»™subReactorçº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹</li>
</ul>
</li>
<li>subReactorçº¿ç¨‹æ± å¤„ç†æ€è·¯:
<ul>
<li>æ¯ä¸ªsubReactorçº¿ç¨‹éƒ½ä¼šå¤„ç†ç”¨epollçš„æ–¹å¼ç›‘æ§å¤šä¸ªconnfd è´Ÿè´£å¤„ç†read å’Œwriteäº‹ä»¶ ä¸šåŠ¡å¤„ç†è½¬å‘ç»™workerçº¿ç¨‹æ± </li>
</ul>
</li>
<li>workerçº¿ç¨‹æ± å¤„ç†ï¼š
<ul>
<li>æ¥å—è¯·æ±‚å¤„ç†äº‹ä»¶ è¿›è¡Œä¸šåŠ¡å¤„ç†(è®¡ç®—ã€æ•°æ®åº“å¤„ç†ä¹‹ç±»çš„) å¤„ç†å®Œæˆäº¤ç»™subReactorçº¿ç¨‹å›æŠ¥ç»™client</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="http://becool.vip:666/img/%e4%b8%bb%e4%bb%8e%e5%a4%9areactor%e5%a4%9a%e7%ba%bf%e7%a8%8bIO%e6%a8%a1%e5%9e%8b.png" alt=""  />
</p>
<h2 id="æ€»ç»“-5">æ€»ç»“ï¼š<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“-5">#</a></h2>
<p>è¿™ç§æ¨¡å¼ç†è®ºä¸Šæ˜¯æ€§èƒ½æœ€å®Œç¾çš„æ¨¡å‹ï¼Œç›¸å¯¹å°±æ˜¯å¼€å‘éš¾åº¦ç›¸å¯¹è¾ƒå¤§ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›ç°æˆçš„æ¡†æ¶é™ä½å¼€å‘éš¾åº¦(Java.Nettyã€c++æ”¹é€ libeventç­‰ç­‰)</p>
<h1 id="unixç¼–ç¨‹api-è½¬è½½">unixç¼–ç¨‹API è½¬è½½<a hidden class="anchor" aria-hidden="true" href="#unixç¼–ç¨‹api-è½¬è½½">#</a></h1>
<h2 id="1å­—èŠ‚åºå‡½æ•°">1.å­—èŠ‚åºå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#1å­—èŠ‚åºå‡½æ•°">#</a></h2>
<p>#include &lt;netinet.h&gt;
uint16_t htons(uint16_t host16bitvalue);
uint32_t htonl(uint32_t host32bitvalue);
è¿”å›ï¼šç½‘ç»œå­—èŠ‚åºå€¼</p>
<p>uint16_t ntohs(uint16_t net16bitvalue);
uint32_t ntohl(uint32_t net32bitvalue);
è¿”å›ï¼šä¸»æœºå­—èŠ‚åºå€¼</p>
<p>ä¸€ä¸ªæµ‹è¯•æœ¬æœºå­—èŠ‚åºçš„ç¨‹åºï¼Œå¯å‚è§è§unpv12eï¼šintro/byteorder.cã€‚</p>
<hr>
<h2 id="2å­—èŠ‚æ“ä½œå‡½æ•°">2.å­—èŠ‚æ“ä½œå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#2å­—èŠ‚æ“ä½œå‡½æ•°">#</a></h2>
<p>#include &lt;strings.h&gt;
void bzero(void *dest, size_t nbytes);
void bcopy(const void *src, void *dest, size_t nbytes);
int bcmp(const void *ptr1, const void *ptr2, size_t nbytes);
è¿”å›ï¼š0â€”ç›¸ç­‰ï¼Œé0â€”ä¸ç›¸ç­‰</p>
<p>#include &lt;string.h&gt;
void *memset(void *dest, int c, size_t len);
void *memcpy(void *dest, void *src, size_t nbytes);
int memcmp(const void *ptr1, const void *ptr2, size_t nbytes);
è¿”å›ï¼š0â€”ç›¸åŒï¼Œ&gt;0æˆ–&lt;0â€”ä¸ç›¸åŒï¼›è¿›è¡Œæ¯”è¾ƒæ“ä½œæ—¶ï¼Œå‡å®šä¸¤ä¸ªä¸ç›¸ç­‰çš„å­—èŠ‚å‡ä¸ºæ— ç¬¦å·å­—ç¬¦ï¼ˆunsigned charï¼‰ã€‚</p>
<hr>
<h2 id="3åœ°å€è½¬æ¢å‡½æ•°">3.åœ°å€è½¬æ¢å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#3åœ°å€è½¬æ¢å‡½æ•°">#</a></h2>
<p>#include &lt;arpa/inet.h&gt;
int inet_aton(const char *strptr, struct in_addr *addrptr);
è¿”å›ï¼š1â€”ä¸²æœ‰æ•ˆï¼Œ0â€”ä¸²æœ‰é”™ã€‚</p>
<p>in_addr_t inet_addr(const char *strptr);
è¿”å›ï¼šè‹¥æˆåŠŸï¼Œè¿”å›32ä¸ºäºŒè¿›åˆ¶çš„ç½‘ç»œå­—èŠ‚åºåœ°å€ï¼›è‹¥æœ‰é”™ï¼Œåˆ™è¿”å›INADDR_NONEã€‚</p>
<p>char *inet_ntoa(struct in_addr inaddr);
è¿”å›ï¼šæŒ‡å‘ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²çš„æŒ‡é’ˆã€‚</p>
<p>int inet_pton(int family, const char *strptr, void *addrptr);
è¿”å›ï¼š1â€”æˆåŠŸï¼›0â€”è¾“å…¥ä¸æ˜¯æœ‰æ•ˆçš„è¡¨è¾¾æ ¼å¼ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>const char *inet_ntop(int family, const void *addrptr, char *strptr, size_t len);
è¿”å›ï¼šæŒ‡å‘ç»“æœçš„æŒ‡é’ˆâ€”æˆåŠŸï¼ŒNULLâ€”å¤±è´¥ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>inet_atonå‡½æ•°çš„æŒ‡é’ˆè‹¥ä¸ºç©ºï¼Œåˆ™å‡½æ•°ä»ç„¶æ‰§è¡Œè¾“å…¥ä¸²çš„æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œä½†ä¸å­˜å‚¨ä»»ä½•ç»“æœã€‚</li>
<li>inet_addrçš„ç¼ºé™·ï¼šå‡ºé”™è¿”å›å€¼INADDR_NONEç­‰äº255.255.255.255ï¼ˆIPv4çš„æœ‰é™å¹¿æ’­åœ°å€ï¼‰ï¼Œæ‰€ä»¥è¯¥å‡½æ•°ä¸èƒ½å¤„ç†æ­¤åœ°å€ã€‚
å°½é‡ä½¿ç”¨inet_atonï¼Œä¸ä½¿ç”¨inet_addrã€‚</li>
<li>inet_ntoaå‡½æ•°çš„æ‰§è¡Œç»“æœæ”¾åœ¨é™æ€å†…å­˜ä¸­ï¼Œæ˜¯ä¸å¯é‡å…¥çš„ã€‚</li>
<li>å‚æ•°familyå¯ä»¥æ˜¯AF_INETï¼Œä¹Ÿå¯ä»¥æ˜¯AF_INET6ï¼Œè‹¥å‚æ•°familyä¸è¢«æ”¯æŒï¼Œåˆ™å‡ºé”™ï¼Œerrnoç½®ä¸ºEAFNOSUPPORTã€‚</li>
<li>æŒ‡é’ˆaddrptræ˜¯ç»“æ„æŒ‡é’ˆã€‚</li>
<li>lenæŒ‡å®šç›®æ ‡çš„å¤§å°ï¼Œé¿å…ç¼“å†²åŒºæº¢å‡ºã€‚å¦‚æœlenå¤ªå°ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œerrnoç½®ä¸ºENOSPCã€‚ä¸ºæœ‰åŠ©äºè§„å®šè¯¥å¤§å°ï¼Œæœ‰å¦‚ä¸‹å®šä¹‰ï¼š
#include &lt;netinet.h&gt;
#define INET_ADDRSTRLEN 16 /*fro IPv4 dotted-decimal */
#define INET6_ADDRSTRLEN 46 /*for IPv6 hex string */</li>
<li>inet_ntopå‡½æ•°çš„å‚æ•°strpträ¸èƒ½ä¸ºç©ºæŒ‡é’ˆï¼ŒæˆåŠŸæ—¶ï¼Œæ­¤æŒ‡é’ˆå³æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚</li>
</ul>
<p>å®ç°IPv4ç‰ˆæœ¬çš„inet_ptonå’Œinet_ntopçš„ç¨‹åºï¼Œå‚è§ï¼šunpv12eï¼šlibfree/inet_pton_ipv4.cå’Œlibfree/inet_ntop_ipv4.cã€‚</p>
<hr>
<h2 id="4readnwritenå’Œreadline">4.readnã€writenå’Œreadline<a hidden class="anchor" aria-hidden="true" href="#4readnwritenå’Œreadline">#</a></h2>
<p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š
ssize_t readn(int filedes, void *buff, size_t nbytes);
ssize-t writen(int filedes, void *buff, size_t nbytes);
ssize_t readline(int filedes, void *buff, size_t maxlen);
è¿”å›ï¼šè¯»å†™å­—èŠ‚æ•°ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>å®ç°ç¨‹åºè§ï¼šunpv12eï¼šlib/readn.cã€lib/writen.cã€lib/readline1.cå’Œlib/readline.cã€‚</p>
<hr>
<h2 id="5æµ‹è¯•æè¿°ç¬¦ç±»å‹">5.æµ‹è¯•æè¿°ç¬¦ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#5æµ‹è¯•æè¿°ç¬¦ç±»å‹">#</a></h2>
<p>#include &lt;sys/stat.h&gt;
int isfdtype( int fd, int fdtype);
è¿”å›ï¼š1â€”æ˜¯æŒ‡å®šç±»å‹ï¼Œ0â€”ä¸æ˜¯æŒ‡å®šç±»å‹ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>è¦æµ‹è¯•æ˜¯å¦ä¸ºå¥—æ¥å£æè¿°å­ï¼Œfdtypeåº”è®¾ä¸ºS_IFSOCKã€‚</p>
<p>è¯¥å‡½æ•°çš„ä¸€ä¸ªå®ç°ç¨‹åºï¼Œå‚è§unpv12eï¼šlib/isfdtype.c</p>
<hr>
<h2 id="6socketå‡½æ•°">6.socketå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#6socketå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int socket(int family, int type, int protocol);
è¿”å›ï¼šéè´Ÿæè¿°å­—â€”æˆåŠŸï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>familyæŒ‡å®šåè®®æ—ï¼Œæœ‰å¦‚ä¸‹å–å€¼ï¼š</p>
<ul>
<li>AF_INET   IPv4åè®®</li>
<li>AF_INET6  IPv6åè®®</li>
<li>AF_LOCAL  UnixåŸŸåè®®</li>
<li>AF_ROUTE  è·¯ç”±å¥—æ¥å£</li>
<li>AF_KEY   å¯†é’¥å¥—æ¥å£</li>
</ul>
<p>typeæŒ‡å®šå¥—æ¥å£ç±»å‹ï¼š</p>
<ul>
<li>SOCK_STREAM  å­—èŠ‚æµå¥—æ¥å£</li>
<li>SOCK_DGRAM   æ•°æ®æŠ¥å¥—æ¥å£</li>
<li>SOCK_RAW    åŸå§‹å¥—æ¥å£</li>
</ul>
<p>protocolä¸€èˆ¬è®¾ä¸º0ï¼Œé™¤éç”¨åœ¨åŸå§‹å¥—æ¥å£ä¸Šã€‚</p>
<p>å¹¶éæ‰€æœ‰familyå’Œtypeçš„ç»„åˆéƒ½æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p>AF_LOCALç­‰äºæ—©æœŸçš„AF_UNIXã€‚</p>
<hr>
<h2 id="7connectå‡½æ•°">7.connectå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#7connectå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int connect(int sockfd, const struct sockaddr *servaddr, socklen_t addrlen);
è¿”å›ï¼š0â€”æˆåŠŸï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>sockfdæ˜¯socketå‡½æ•°è¿”å›çš„å¥—æ¥å£æè¿°å­—ï¼Œservaddrå’Œaddrlenæ˜¯æŒ‡å‘æœåŠ¡å™¨çš„å¥—æ¥å£åœ°å€ç»“æ„æŒ‡é’ˆå’Œç»“æ„å¤§å°ã€‚</p>
<p>åœ¨è°ƒç”¨connectä¹‹å‰ä¸å¿…éå¾—è°ƒç”¨bindå‡½æ•°ã€‚</p>
<p>å¦‚æœæ˜¯TCPï¼Œåˆ™connectæ¿€å‘TCPçš„ä¸‰è·¯æ¡æ‰‹è¿‡ç¨‹ï¼Œåœ¨é˜»å¡æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨è¿æ¥å»ºç«‹æˆåŠŸæˆ–å‡ºé”™æ—¶è¯¥å‡½æ•°æ‰è¿”å›ï¼Œ
å‡ºé”™æƒ…å†µï¼š</p>
<ul>
<li>æ²¡æœ‰æ”¶åˆ°SYNåˆ†èŠ‚çš„å“åº”ï¼Œåœ¨è§„å®šæ—¶é—´å†…ç»è¿‡é‡å‘ä»æ— æ•ˆï¼Œåˆ™è¿”å›ETIMEDOUTï¼›</li>
<li>å¦‚æœå¯¹SYNåˆ†èŠ‚çš„å“åº”æ˜¯RSTï¼Œè¡¨ç¤ºæœåŠ¡å™¨åœ¨æŒ‡å®šç«¯å£ä¸Šæ²¡æœ‰ç›¸åº”çš„æœåŠ¡ï¼Œè¿”å›ECONNREFUSEDï¼›</li>
<li>å¦‚æœå‘å‡º SYNåœ¨ä¸­é—´è·¯ç”±å™¨ä¸Šå¼•å‘ä¸€ä¸ªç›®çš„åœ°ä¸å¯è¾¾ICMPé”™è¯¯ï¼Œåœ¨è§„å®šæ—¶é—´å†…ç»è¿‡é‡å‘ä»æ— æ•ˆï¼Œåˆ™è¿”å›EHOSTUNREACHæˆ–ENETUNREACHé”™è¯¯ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šå¦‚æœconnectå¤±è´¥ï¼Œåˆ™å¥—æ¥å£å°†ä¸èƒ½å†ä½¿ç”¨ï¼Œå¿…é¡»å…³é—­ï¼Œä¸èƒ½å¯¹æ­¤å¥—æ¥å£å†è°ƒç”¨å‡½æ•°connectã€‚</p>
<hr>
<h2 id="8bindå‡½æ•°">8.bindå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#8bindå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int bind(int sockfd, const struct sockaddr *maddr, socklen_t addrlen);
è¿”å›ï¼š0â€”æˆåŠŸï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>è¿›ç¨‹å¯ä»¥æŠŠä¸€ä¸ªç‰¹å®šçš„IPåœ°å€æ†ç»‘åˆ°ä»–çš„å¥—æ¥å£ä¸Šï¼Œä½†æ­¤IPåœ°å€å¿…é¡»æ˜¯ä¸»æœºçš„ä¸€ä¸ªæ¥å£ã€‚</p>
<p>å¯¹äºIPv4ï¼Œé€šé…åœ°å€æ˜¯INADDR_ANYï¼Œå…¶å€¼ä¸€èˆ¬ä¸º0ï¼›ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
struct sockaddr_in servaddr;
servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</p>
<p>å¯¹äºIPv6ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
struct sockaddr_in6 serv;
serv.sin6_addr = in6addr_any; ï¼ˆç³»ç»Ÿåˆ†é…å˜é‡in6addr_anyå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºå¸¸å€¼IN6ADDR_ANY_INITã€‚ï¼‰</p>
<p>å¦‚æœè®©å†…æ ¸é€‰æ‹©ä¸´æ—¶ç«¯å£ï¼Œæ³¨æ„çš„æ˜¯bindå¹¶ä¸è¿”å›æ‰€é€‰çš„æ–­å£å€¼ï¼Œè¦å¾—åˆ°ä¸€ä¸ªç«¯å£ï¼Œå¿…é¡»ä½¿ç”¨getsocknameå‡½æ•°ã€‚</p>
<p>bindå¤±è´¥çš„å¸¸è§é”™è¯¯æ˜¯EADDRINUSEï¼ˆåœ°å€å·²ä½¿ç”¨ï¼‰ã€‚</p>
<hr>
<h2 id="9listenå‡½æ•°">9.listenå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#9listenå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int listen(int sockfd, int backlog);
è¿”å›ï¼š0â€”æˆåŠŸï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>listenæŠŠæœªè¿æ¥çš„å¥—æ¥å£è½¬åŒ–ä¸ºè¢«åŠ¨å¥—æ¥å£ï¼ŒæŒ‡ç¤ºå†…æ ¸åº”æ¥å—æŒ‡å‘æ­¤å¥—æ¥å£çš„è¿æ¥è¯·æ±‚ã€‚ç¬¬äºŒä¸ªå‚æ•°è§„å®šäº†å†…æ ¸ä¸ºæ­¤å¥—æ¥å£æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•°ã€‚</p>
<p>å‚æ•°backlogæ›¾ç»è§„å®šä¸ºç›‘å¬å¥—æ¥å£ä¸Šçš„æœªå®Œæˆè¿æ¥é˜Ÿåˆ—å’Œå·²å®Œæˆè¿æ¥é˜Ÿåˆ—æ€»å’Œçš„æœ€å¤§å€¼ï¼Œä½†å„ä¸ªç³»ç»Ÿçš„å®šä¹‰æ–¹æ³•éƒ½ä¸å°½ç›¸åŒï¼›å†å²ä¸Šå¸¸æŠŠbacklogç½®ä¸º5ï¼Œä½†å¯¹äºç¹å¿™çš„æœåŠ¡å™¨æ˜¯ä¸å¤Ÿçš„ï¼›backlogçš„è®¾ç½®æ²¡æœ‰ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œä¾æƒ…å†µè€Œå®šï¼Œä½†ä¸è¦è®¾ä¸º0ã€‚</p>
<hr>
<h2 id="10acceptå‡½æ•°">10.acceptå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#10acceptå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int accept(int sockfd, struct sockaddr *cliaddr, socklen_t *addrlen);
è¿”å›ï¼šéè´Ÿæè¿°å­—â€”OKï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>acceptä»å·²å®Œæˆè¿æ¥é˜Ÿåˆ—å¤´è¿”å›ä¸‹ä¸€ä¸ªè¿æ¥ï¼Œè‹¥å·²å®Œæˆè¿æ¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿›ç¨‹ç¡çœ ï¼ˆå¥—æ¥å£ä¸ºé˜»å¡æ–¹å¼æ—¶ï¼‰ã€‚</p>
<p>å‚æ•°cliaddrå’Œaddrlenè¿”å›è¿æ¥å¯¹æ–¹çš„åè®®åœ°å€ï¼Œå…¶ä¸­addrlenæ˜¯å€¼-ç»“æœå‚æ•°ï¼Œè°ƒç”¨å‰addrlenæ‰€æŒ‡çš„æ•´æ•°å€¼è¦ç½®ä¸ºcliaddræ‰€æŒ‡çš„å¥—æ¥å£ç»“æ„çš„é•¿åº¦ï¼Œè¿”å›æ—¶ç”±å†…æ ¸ä¿®æ”¹ã€‚</p>
<p>acceptæˆåŠŸæ‰§è¡Œåï¼Œè¿”å›ä¸€ä¸ªè¿æ¥å¥—æ¥å£æè¿°å­—ã€‚</p>
<p>å¦‚æœå¯¹å®¢æˆ·çš„åè®®åœ°å€æ²¡æœ‰å…´è¶£ï¼Œå¯ä»¥æŠŠcliaddrå’Œaddrlenç½®ä¸ºç©ºæŒ‡é’ˆã€‚</p>
<hr>
<h2 id="11closeå‡½æ•°">11.closeå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#11closeå‡½æ•°">#</a></h2>
<p>#include &lt;unistd.h&gt;
int close(int sockfd);
è¿”å›ï¼š0â€”OKï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>TCPå¥—æ¥å£çš„closeç¼ºçœåŠŸèƒ½æ˜¯å°†å¥—æ¥å£åšä¸Šâ€œå·²å…³é—­â€æ ‡è®°ï¼Œå¹¶ç«‹å³è¿”å›åˆ°è¿›ç¨‹ã€‚è¿™ä¸ªå¥—æ¥å£æè¿°å­—ä¸èƒ½å†ä¸ºè¿›ç¨‹ä½¿ç”¨ï¼Œä½†TCPå°†è¯•ç€å‘é€å·²æ’é˜Ÿå¾…å‘çš„ä»»ä½•æ•°æ®ï¼Œç„¶åæŒ‰æ­£å¸¸çš„TCPè¿æ¥ç»ˆæ­¢åºåˆ—è¿›è¡Œæ“ä½œã€‚</p>
<p>closeæŠŠæè¿°å­—çš„è®¿é—®è®¡æ•°å‡1ï¼Œå½“è®¿é—®è®¡æ•°ä»å¤§äº0æ—¶ï¼Œcloseå¹¶ä¸ä¼šå¼•å‘TCPçš„å››åˆ†ç»„è¿æ¥ç»ˆæ­¢åºåˆ—ã€‚è‹¥ç¡®å®è¦å‘ä¸€ä¸ªFINï¼Œå¯ä»¥ç”¨å‡½æ•°shutdownã€‚</p>
<hr>
<h2 id="12getsocknameå’Œgetpeername">12.getsocknameå’Œgetpeername<a hidden class="anchor" aria-hidden="true" href="#12getsocknameå’Œgetpeername">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int getsockname(int sockfd, struct sockaddr *localaddr, socklen_t *addrlen);
int getpeername(int sockfd, struct sockaddr *peeraddr, socklen_t *addrlen);
è¿”å›ï¼š0â€”OKï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>getsocknameå‡½æ•°è¿”å›ä¸å¥—æ¥å£å…³è”çš„æœ¬åœ°åè®®åœ°å€ã€‚</p>
<p>getpeernameå‡½æ•°è¿”å›ä¸å¥—æ¥å£å…³è”çš„è¿œç¨‹åè®®åœ°å€ã€‚</p>
<p>addrlenæ˜¯å€¼-ç»“æœå‚æ•°ã€‚</p>
<p>ä½¿ç”¨åœºåˆï¼š</p>
<ul>
<li>åœ¨ä¸è°ƒç”¨bindçš„TCPå®¢æˆ·ï¼Œå½“connectæˆåŠŸè¿”å›åï¼Œgetsocknameè¿”å›åˆ†é…ç»™æ­¤è¿æ¥çš„æœ¬åœ°IPåœ°å€å’Œæœ¬åœ°ç«¯å£å·ï¼›</li>
<li>åœ¨ä»¥ç«¯å£å·ä¸º0è°ƒç”¨bindåï¼Œä½¿ç”¨getsocknameè¿”å›å†…æ ¸åˆ†é…çš„æœ¬åœ°ç«¯å£å·ï¼›</li>
<li>getsocknameå¯ç”¨æ¥è·å–æŸå¥—æ¥å£çš„åœ°å€æ—ï¼›</li>
<li>åœ¨æ†ç»‘äº†é€šé…IPåœ°å€çš„TCPæœåŠ¡å™¨ä¸Šï¼Œå½“è¿æ¥å»ºç«‹åï¼Œå¯ä»¥ä½¿ç”¨getsocknameè·å¾—åˆ†é…ç»™æ­¤è¿æ¥çš„æœ¬åœ°IPåœ°å€ï¼›</li>
<li>å½“ä¸€ä¸ªæœåŠ¡å™¨è°ƒç”¨execå¯åŠ¨åï¼Œä»–è·å¾—å®¢æˆ·èº«ä»½çš„å”¯ä¸€é€”å¾„æ˜¯è°ƒç”¨getpeernameå‡½æ•°ã€‚</li>
</ul>
<hr>
<h2 id="13selectå‡½æ•°">13.selectå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#13selectå‡½æ•°">#</a></h2>
<p>#include &lt;sys/select.h&gt;
#include &lt;sys/time.h&gt;
int select(int maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout);
è¿”å›ï¼šå‡†å¤‡å¥½æè¿°å­—çš„æ­£æ•°ç›®ï¼Œ0â€”è¶…æ—¶ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>ç»“æ„timevalçš„å®šä¹‰ï¼š
struct timeval {
long tv_sec; /* seconds <em>/
long tv_usec; /</em> microseconds */
};</p>
<p>timeoutå–å€¼çš„ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>æ°¸è¿œç­‰ä¸‹å»ï¼šä»…åœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶æ‰è¿”å›ï¼Œè®¾ç½®timeoutä¸ºç©ºæŒ‡é’ˆï¼›</li>
<li>ç­‰å¾…å›ºå®šæ—¶é—´ï¼šåœ¨æœ‰ä¸€ä¸ªæè¿°å­—å‡†å¤‡å¥½I/Oæ—¶è¿”å›ï¼Œä½†ä¸è¶…è¿‡ç”±timeoutå‚æ•°æ‰€æŒ‡å®šçš„ç§’æ•°å’Œå¾®ç§’æ•°ï¼›</li>
<li>æ ¹æœ¬ä¸ç­‰å¾…ï¼šæ£€æŸ¥æè¿°å­—åç«‹å³è¿”å›ï¼Œå°†timeoutä¸­çš„ç§’æ•°å’Œå¾®ç§’æ•°éƒ½è®¾ç½®ä¸º0ã€‚</li>
</ul>
<p>åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œè‹¥è¿›ç¨‹æ•è·äº†ä¿¡å·å¹¶ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›ï¼Œç­‰å¾…ä¸€èˆ¬è¢«ä¸­æ–­ï¼Œä¸ºäº†å¯ç§»æ¤æ€§ï¼Œå¿…é¡»å‡†å¤‡å¥½selectè¿”å›EINTRé”™è¯¯ã€‚</p>
<p>timeoutçš„å€¼åœ¨è¿”å›æ—¶å¹¶ä¸ä¼šè¢«selectä¿®æ”¹ï¼ˆconstæ ‡å¿—ï¼‰ã€‚</p>
<p>readsetã€writesetã€exceptsetæŒ‡å®šæˆ‘ä»¬è¦è®©å†…æ ¸æµ‹è¯•è¯»ã€å†™å’Œå¼‚å¸¸æ¡ä»¶æ‰€éœ€çš„æè¿°å­—ã€‚</p>
<p>å½“å‰æ”¯æŒçš„å¼‚å¸¸æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li>å¥—æ¥å£å¸¦å¤–æ•°æ®çš„åˆ°è¾¾ï¼›</li>
<li>æ§åˆ¶çŠ¶æ€ä¿¡æ¯çš„å­˜åœ¨ï¼Œå¯ä»ä¸€ä¸ªå·²ç½®ä¸ºåˆ†ç»„æ–¹å¼çš„ä¼ªç»ˆç«¯ä¸»ç«¯è¯»åˆ°ã€‚</li>
</ol>
<p>æè¿°å­—é›†çš„ä½¿ç”¨ï¼š
æ•°æ®ç±»å‹ï¼šfd_setï¼›
void FD_ZERO(fd_set *fdset);
void FD_SET(int fd, fd_set *fdset);
void FD_CLR(int fd, fd_set *fdset);
void FD_ISSET(int fd, fd_set *fdset);</p>
<p>å‚æ•°maxfdp1æŒ‡å®šè¢«æµ‹è¯•çš„æè¿°å­—ä¸ªæ•°ï¼Œå®ƒçš„å€¼æ˜¯è¦è¢«æµ‹è¯•çš„æœ€å¤§æè¿°å­—åŠ 1ã€‚æè¿°å­—0ï¼Œ1ï¼Œ2ï¼Œâ€¦ï¼Œmaxfdp1-1éƒ½è¢«æµ‹è¯•ã€‚</p>
<p>readsetã€writesetã€exceptsetæ˜¯å€¼-ç»“æœå‚æ•°ï¼Œselectä¿®æ”¹ä¸‰è€…æ‰€æŒ‡çš„æè¿°å­—é›†ã€‚æ‰€ä»¥ï¼Œæ¯æ¬¡è°ƒç”¨selectæ—¶ï¼Œæˆ‘ä»¬éƒ½è¦å°†æ‰€æœ‰æè¿°å­—é›†ä¸­å…³å¿ƒçš„ä½ç½®ä¸º1ã€‚</p>
<p>å¥—æ¥å£å‡†å¤‡å¥½è¯»çš„æ¡ä»¶ï¼š</p>
<ul>
<li>å¥—æ¥å£æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®å­—èŠ‚æ•°å¤§äºç­‰äºå¥—æ¥å£æ¥æ”¶ç¼“å†²åŒºä½æ½®é™åº¦çš„å½“å‰å€¼ã€‚å¯¹è¿™æ ·çš„å¥—æ¥å£çš„è¯»æ“ä½œå°†ä¸é˜»å¡å¹¶è¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ï¼ˆå³å‡†å¤‡å¥½è¯»å…¥çš„æ•°æ®é‡ï¼‰ã€‚å¯ä»¥ç”¨å¥—æ¥å£é€‰é¡¹SO_RCVLOWATæ¥è®¾ç½®ä½æ½®é™åº¦ï¼Œå¯¹äºTCPå’ŒUDPï¼Œç¼ºçœå€¼ä¸º1ï¼›</li>
<li>è¿æ¥çš„è¯»è¿™ä¸€åŠå…³é—­ï¼ˆæ¥æ”¶äº†FINçš„TCPè¿æ¥ï¼‰ã€‚å¯¹è¿™æ ·çš„å¥—æ¥å£è¯»æ“ä½œå°†ä¸é˜»å¡å¹¶ä¸”è¿”å›0ï¼ˆå³æ–‡ä»¶ç»“æŸç¬¦ï¼‰ï¼›</li>
<li>å¥—æ¥å£æ˜¯ä¸€ä¸ªç›‘å¬å¥—æ¥å£ä¸”å·²å®Œæˆçš„è¿æ¥æ•°ä¸ºé0ï¼›</li>
<li>æœ‰ä¸€ä¸ªå¥—æ¥å£é”™è¯¯å¾…å¤„ç†ã€‚å¯¹è¿™æ ·çš„å¥—æ¥å£è¯»æ“ä½œå°†ä¸é˜»å¡ä¸”è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œerrnoè®¾ç½®æˆæ˜ç¡®çš„é”™è¯¯æ¡ä»¶ã€‚è¿™äº›å¾…å¤„ç†é”™è¯¯ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå¥—æ¥å£é€‰é¡¹SO_ERRORè°ƒç”¨getsockoptæ¥å–å¾—å¹¶æ¸…é™¤ã€‚</li>
</ul>
<p>å¥—æ¥å£å‡†å¤‡å¥½å†™çš„æ¡ä»¶ï¼š</p>
<ul>
<li>å¥—æ¥å£å‘é€ç¼“å†²åŒºä¸­çš„å¯ç”¨å­—èŠ‚æ•°å¤§äºç­‰äºå¥—æ¥å£å‘é€ç¼“å†²åŒºä½æ½®é™åº¦çš„å½“å‰å€¼ï¼Œä¸”æˆ–è€…ï¼ˆ1ï¼‰å¥—æ¥å£å·²è¿æ¥ï¼Œæˆ–è€…ï¼ˆ2ï¼‰å¥—æ¥å£ä¸è¦æ±‚è¿æ¥ï¼ˆå¦‚UDPå¥—æ¥å£ï¼‰ã€‚å¯ä»¥ç”¨å¥—æ¥å£é€‰é¡¹SO_SNDLOWATæ¥è®¾ç½®æ­¤ä½æ½®é™åº¦ï¼Œå¯¹äºTCPå’ŒUDPï¼Œç¼ºçœå€¼ä¸º2048ï¼›</li>
<li>è¿æ¥çš„å†™è¿™ä¸€åŠå…³é—­ã€‚å¯¹è¿™æ ·çš„å¥—æ¥å£å†™å°†äº§ç”Ÿä¿¡å·SIGPIPEï¼›</li>
<li>æœ‰ä¸€ä¸ªå¥—æ¥å£é”™è¯¯å¾…å¤„ç†ã€‚å¯¹è¿™æ ·çš„å¥—æ¥å£å†™æ“ä½œå°†ä¸é˜»å¡ä¸”è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œerrnoè®¾ç½®æˆæ˜ç¡®çš„é”™è¯¯æ¡ä»¶ã€‚è¿™äº›å¾…å¤„ç†é”™è¯¯ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå¥—æ¥å£é€‰é¡¹SO_ERRORè°ƒç”¨getsockoptæ¥å–å¾—å¹¶æ¸…é™¤ã€‚</li>
</ul>
<p>å¦‚æœä¸€ä¸ªå¥—æ¥å£å­˜åœ¨å¸¦å¤–æ•°æ®æˆ–è€…ä»å¤„äºå¸¦å¤–æ ‡è®°ï¼Œé‚£å®ƒæœ‰å¼‚å¸¸æ¡ä»¶å¾…å¤„ç†ã€‚</p>
<p>ä¸€ä¸ªå¥—æ¥å£å‡ºé”™æ—¶ï¼Œå®ƒè¢«selectæ ‡è®°ä¸ºæ—¢å¯è¯»åˆå¯å†™ã€‚</p>
<hr>
<h2 id="14shutdownå‡½æ•°">14.shutdownå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#14shutdownå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int shutdown(int sockfd, int howto);
è¿”å›ï¼š0â€”æˆåŠŸï¼Œ-1â€”å¤±è´¥ã€‚</p>
<p>å‡½æ•°çš„è¡Œä¸ºä¾èµ–äºå‚æ•°howtoçš„å€¼ï¼š</p>
<ul>
<li>SHUT_RDï¼šå…³é—­è¿æ¥çš„è¯»è¿™ä¸€åŠï¼Œä¸å†æ¥æ”¶å¥—æ¥å£ä¸­çš„æ•°æ®ä¸”ç•™åœ¨å¥—æ¥å£ç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½ä½œåºŸã€‚è¿›ç¨‹ä¸èƒ½å†å¯¹å¥—æ¥å£ä»»ä½•è¯»å‡½æ•°ã€‚è°ƒç”¨æ­¤å‡½æ•°åï¼Œç”±TCPå¥—æ¥å£æ¥æ”¶çš„ä»»ä½•æ•°æ®éƒ½è¢«ç¡®è®¤ï¼Œä½†æ•°æ®æœ¬èº«è¢«æ‰”æ‰ã€‚</li>
<li>SHUT_WRï¼šå…³é—­è¿æ¥çš„å†™è¿™ä¸€åŠï¼Œåœ¨TCPåœºåˆä¸‹ï¼Œè¿™ç§°ä¸ºåŠå…³é—­ã€‚å½“å‰ç•™åœ¨å¥—æ¥å£å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½è¢«å‘é€ï¼Œåè·Ÿæ­£å¸¸çš„TCPè¿æ¥ç»ˆæ­¢åºåˆ—ã€‚æ­¤åŠå…³é—­ä¸ç®¡å¥—æ¥å£æè¿°å­—çš„è®¿é—®è®¡æ•°æ˜¯å¦å¤§äº0ã€‚è¿›ç¨‹ä¸èƒ½å†æ‰§è¡Œå¯¹å¥—æ¥å£çš„ä»»ä½•å†™å‡½æ•°ã€‚</li>
</ul>
<p>SHUT_RDWRï¼šè¿æ¥çš„è¯»è¿™ä¸€åŠå’Œå†™è¿™ä¸€åŠéƒ½å…³é—­ã€‚è¿™ç­‰æ•ˆäºè°ƒç”¨shutdownä¸¤æ¬¡ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ç”¨SHUT_RDï¼Œç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ç”¨SHUT_WRã€‚</p>
<hr>
<h2 id="15pselectå‡½æ•°">15.pselectå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#15pselectå‡½æ•°">#</a></h2>
<p>#include &lt;sys/select.h&gt;
#include &lt;signal.h&gt;
#include &lt;time.h&gt;
int pselect(int maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timespec *timeout, const sigset_t *sigmask);
è¿”å›ï¼šå‡†å¤‡å¥½æè¿°å­—çš„ä¸ªæ•°ï¼Œ0â€”è¶…æ—¶ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>pselectæ˜¯Posix.1gå‘æ˜çš„ã€‚ç›¸å¯¹selectçš„å˜åŒ–ï¼š</p>
<ol>
<li>pselectä½¿ç”¨ç»“æ„timespecï¼š
struct timespec {
time_t tv_sec; /* seconds <em>/
long tv_nsec; /</em> nanoseconds */
};
æ–°ç»“æ„ä¸­çš„tv_nsecè§„å®šçº³ç§’æ•°ã€‚</li>
<li>pselectå¢åŠ äº†ç¬¬å…­ä¸ªå‚æ•°ï¼šæŒ‡å‘ä¿¡å·æ©ç çš„æŒ‡é’ˆã€‚å…è®¸ç¨‹åºç¦æ­¢é€’äº¤æŸäº›ä¿¡å·ã€‚</li>
</ol>
<hr>
<h2 id="16pollå‡½æ•°">16.pollå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#16pollå‡½æ•°">#</a></h2>
<p>#include &lt;poll.h&gt;
int poll(struct pollfd *fdarray, unsigned long nfds, int timeout);
è¿”å›ï¼šå‡†å¤‡å¥½æè¿°å­—çš„ä¸ªæ•°ï¼Œ0â€”è¶…æ—¶ï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘ä¸€ä¸ªç»“æ„æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªpollfdç»“æ„ï¼š
struct pollfd {
int fd; /* descriptor to check <em>/
short events; /</em> events of interest on fd <em>/
short revents; /</em> events that occurred on fd */
};</p>
<p>è¦æµ‹è¯•çš„æ¡ä»¶ç”±æˆå‘˜eventsè§„å®šï¼Œå‡½æ•°åœ¨ç›¸åº”çš„reventsæˆå‘˜ä¸­è¿”å›æè¿°å­—çš„çŠ¶æ€ï¼ˆä¸€ä¸ªæè¿°å­—æœ‰ä¸¤ä¸ªå˜é‡ï¼šä¸€ä¸ªä¸ºè°ƒç”¨å€¼ï¼Œä¸€ä¸ªä¸ºç»“æœï¼‰ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°timeoutæŒ‡å®šå‡½æ•°è¿”å›å‰ç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚å¯èƒ½å€¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>INFTIMï¼Œæ°¸è¿œç­‰å¾…ï¼›</li>
<li>0ï¼Œç«‹å³è¿”å›ï¼Œä¸é˜»å¡ï¼›</li>
<li>&gt;0ï¼Œç­‰å¾…æŒ‡å®šæ•°ç›®çš„æ¯«ç§’æ•°ã€‚</li>
</ul>
<p>æ ‡å¿—çš„èŒƒå›´ï¼š</p>
<table>
<thead>
<tr>
<th>å¸¸é‡</th>
<th>èƒ½ä½œä¸ºeventsçš„è¾“å…¥å—ï¼Ÿ</th>
<th>èƒ½ä½œä¸ºreventsçš„ç»“æœå—ï¼Ÿ</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>POLLIN</td>
<td>yes</td>
<td>yes</td>
<td>æ™®é€šæˆ–ä¼˜å…ˆçº§å¸¦æ•°æ®å¯è¯»</td>
</tr>
<tr>
<td>POLLRDNORM</td>
<td>yes</td>
<td>yes</td>
<td>æ™®é€šæ•°æ®å¯è¯»</td>
</tr>
<tr>
<td>POLLRDBAND</td>
<td>yes</td>
<td>yes</td>
<td>ä¼˜å…ˆçº§å¸¦æ•°æ®å¯è¯»</td>
</tr>
<tr>
<td>POLLPRI</td>
<td>yes</td>
<td>yes</td>
<td>é«˜ä¼˜å…ˆçº§æ•°æ®å¯è¯»</td>
</tr>
<tr>
<td>POLLOUT</td>
<td>yes</td>
<td>yes</td>
<td>æ™®é€šæˆ–ä¼˜å…ˆçº§å¸¦æ•°æ®å¯å†™</td>
</tr>
<tr>
<td>POLLWRNORM</td>
<td>yes</td>
<td>yes</td>
<td>æ™®é€šæ•°æ®å¯å†™</td>
</tr>
<tr>
<td>POLLWRBAND</td>
<td>yes</td>
<td>yes</td>
<td>ä¼˜å…ˆçº§å¸¦æ•°æ®å¯å†™</td>
</tr>
<tr>
<td>POLLERR</td>
<td></td>
<td>yes</td>
<td>å‘ç”Ÿé”™è¯¯</td>
</tr>
<tr>
<td>POLLHUP</td>
<td></td>
<td>yes</td>
<td>å‘ç”ŸæŒ‚èµ·</td>
</tr>
<tr>
<td>POLLNVAL</td>
<td></td>
<td>yes</td>
<td>æè¿°å­—ä¸æ˜¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶</td>
</tr>
</tbody>
</table>
<p>å›¾å¯åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šå¤„ç†è¾“å…¥çš„å››ä¸ªå¸¸å€¼ï¼›å¤„ç†è¾“å‡ºçš„ä¸‰ä¸ªå¸¸å€¼ï¼›å¤„ç†é”™è¯¯çš„ä¸‰ä¸ªå¸¸å€¼ã€‚</p>
<p>pollè¯†åˆ«ä¸‰ä¸ªç±»åˆ«çš„æ•°æ®ï¼šæ™®é€šï¼ˆnormalï¼‰ã€ä¼˜å…ˆçº§å¸¦ï¼ˆpriority bandï¼‰ã€é«˜ä¼˜å…ˆçº§ï¼ˆhigh priorityï¼‰ã€‚æœ¯è¯­æ¥è‡ªæµçš„æ¦‚å¿µã€‚</p>
<p>è¿”å›æ¡ä»¶ï¼š</p>
<ul>
<li>æ‰€æœ‰æ­£è§„TCPæ•°æ®å’ŒUDPæ•°æ®éƒ½è¢«è®¤ä¸ºæ˜¯æ™®é€šæ•°æ®ï¼›</li>
<li>TCPçš„å¸¦å¤–æ•°æ®è¢«è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§å¸¦æ•°æ®ï¼›</li>
<li>å½“TCPè¿æ¥çš„è¯»è¿™ä¸€åŠå…³é—­æ—¶ï¼ˆå¦‚æ¥æ”¶äº†ä¸€ä¸ªFINï¼‰ï¼Œè¿™ä¹Ÿè®¤ä¸ºæ˜¯æ™®é€šæ•°æ®ï¼Œä¸”åç»­çš„è¯»æ“ä½œå°†è¿”å›0ï¼›</li>
<li>TCPè¿æ¥å­˜åœ¨é”™è¯¯æ—¢å¯ä»¥è®¤ä¸ºæ˜¯æ™®é€šæ•°æ®ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯é”™è¯¯ï¼ˆPOLLERRï¼‰ã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œåç»­çš„è¯»æ“ä½œå°†è¿”å›-1ï¼Œå¹¶å°†errnoç½®ä¸ºé€‚å½“çš„å€¼ï¼Œè¿™å°±å¤„ç†äº†è¯¸å¦‚æ¥æ”¶åˆ°RSTæˆ–è¶…æ—¶ç­‰æ¡ä»¶ï¼›</li>
<li>åœ¨ç›‘å¬å¥—æ¥å£ä¸Šæ–°è¿æ¥çš„å¯ç”¨æ€§æ—¢å¯è®¤ä¸ºæ˜¯æ™®é€šæ•°æ®ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¼˜å…ˆçº§å¸¦æ•°æ®ï¼Œå¤§å¤šæ•°å®ç°éƒ½å°†å…¶ä½œä¸ºæ™®é€šæ•°æ®è€ƒè™‘ã€‚</li>
<li>å¦‚æœä¸å…³å¿ƒæŸä¸ªç‰¹å®šçš„æè¿°å­—ï¼Œå¯å°†å…¶pollfdç»“æ„çš„fdæˆå‘˜ç½®ä¸ºä¸€ä¸ªè´Ÿå€¼ï¼Œè¿™æ ·å°±å¯ä»¥å¿½ç•¥æˆå‘˜eventsï¼Œä¸”è¿”å›æ—¶å°†æˆå‘˜reventsçš„å€¼ç½®ä¸º0ã€‚</li>
</ul>
<p>pollæ²¡æœ‰selectå­˜åœ¨çš„æœ€å¤§æè¿°å­—æ•°ç›®é—®é¢˜ã€‚ä½†å¯ç§»æ¤æ€§selectè¦å¥½äºpollã€‚</p>
<hr>
<h2 id="17getsockoptå’Œsetsockopt">17.getsockoptå’Œsetsockopt<a hidden class="anchor" aria-hidden="true" href="#17getsockoptå’Œsetsockopt">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int getsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen);
int setsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen);
è¿”å›ï¼š0â€”OKï¼Œ-1â€”å‡ºé”™ã€‚</p>
<p>sockfdå¿…é¡»æ˜¯ä¸€ä¸ªæ‰“å¼€çš„å¥—æ¥å£æè¿°å­—ï¼›levelï¼ˆçº§åˆ«ï¼‰æŒ‡å®šç³»ç»Ÿä¸­è§£é‡Šé€‰é¡¹çš„ä»£ç ï¼šæ™®é€šå¥—æ¥å£ä»£ç æˆ–ç‰¹å®šäºåè®®çš„ä»£ç ï¼‰ï¼›optvalæ˜¯ä¸€ä¸ªæŒ‡å‘å˜é‡çš„æŒ‡é’ˆï¼›æ­¤å˜é‡çš„å¤§å°ç”±æœ€åä¸€ä¸ªå‚æ•°å†³å®šã€‚</p>
<p>å¯¹äºæŸäº›å¥—æ¥å£é€‰é¡¹ï¼Œä»€ä¹ˆæ—¶å€™è¿›è¡Œè®¾ç½®æˆ–è·å–æ˜¯æœ‰å·®åˆ«çš„ã€‚ä¸‹é¢çš„å¥—æ¥å£é€‰é¡¹æ˜¯ç”±TCPå·²è¿æ¥å¥—æ¥å£ä»ç›‘å¬å¥—æ¥å£ç»§æ‰¿æ¥çš„ï¼š</p>
<ul>
<li>SO_DEBUGï¼›</li>
<li>SO_DONTROUTEï¼›</li>
<li>SO_KEEPALIVEï¼›</li>
<li>SO_LINGERï¼›</li>
<li>SO_OOBINLINEï¼›</li>
<li>SO_RCVBUFï¼›</li>
<li>SO_SNDBUFã€‚</li>
</ul>
<p>å¦‚æœæƒ³åœ¨ä¸‰è·¯æ¡æ‰‹å®Œæˆæ—¶ç¡®ä¿è¿™äº›å¥—æ¥å£é€‰é¡¹ä¸­çš„æŸä¸€ä¸ªæ˜¯ç»™å·²è¿æ¥å¥—æ¥å£è®¾ç½®çš„ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆç»™ç›‘å¬å¥—æ¥å£è®¾ç½®æ­¤é€‰é¡¹ã€‚</p>
<hr>
<h2 id="18å¥—æ¥å£é€‰é¡¹åˆ—è¡¨">18.å¥—æ¥å£é€‰é¡¹åˆ—è¡¨<a hidden class="anchor" aria-hidden="true" href="#18å¥—æ¥å£é€‰é¡¹åˆ—è¡¨">#</a></h2>
<table>
<thead>
<tr>
<th>level</th>
<th>Optname</th>
<th>get</th>
<th>set</th>
<th>è¯´æ˜</th>
<th>æ ‡å¿—</th>
<th>æ•°æ®ç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SOL_SOCKET</td>
<td>SO_BROADCAST</td>
<td>y</td>
<td>y</td>
<td>å…è®¸å‘é€å¹¿æ’­æ•°æ®æŠ¥</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_DEBUG</td>
<td>y</td>
<td>y</td>
<td>ä½¿èƒ½è°ƒè¯•è·Ÿè¸ª</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_DONTROUTE</td>
<td>y</td>
<td>y</td>
<td>æ—è·¯è·¯ç”±è¡¨æŸ¥è¯¢</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_ERROR</td>
<td>y</td>
<td></td>
<td>è·å–å¾…å¤„ç†é”™è¯¯å¹¶æ¶ˆé™¤</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_KEEPALIVE</td>
<td>y</td>
<td>y</td>
<td>å‘¨æœŸæ€§æµ‹è¯•è¿æ¥æ˜¯å¦å­˜æ´»</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_LINGER</td>
<td>y</td>
<td>y</td>
<td>è‹¥æœ‰æ•°æ®å¾…å‘é€åˆ™å»¶è¿Ÿå…³é—­</td>
<td></td>
<td>linger{}</td>
</tr>
<tr>
<td></td>
<td>SO_OOBINLINE</td>
<td>y</td>
<td>y</td>
<td>è®©æ¥æ”¶åˆ°çš„å¸¦å¤–æ•°æ®ç»§ç»­åœ¨çº¿å­˜æ”¾</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_RCVBUF</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶ç¼“å†²åŒºå¤§å°</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_SNDBUF</td>
<td>y</td>
<td>y</td>
<td>å‘é€ç¼“å†²åŒºå¤§å°</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_RCVLOWAT</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶ç¼“å†²åŒºä½æ½®é™åº¦</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_SNDLOWAT</td>
<td>y</td>
<td>y</td>
<td>å‘é€ç¼“å†²åŒºä½æ½®é™åº¦</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_RCVTIMEO</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶è¶…æ—¶</td>
<td></td>
<td>timeval{}</td>
</tr>
<tr>
<td></td>
<td>SO_SNDTIMEO</td>
<td>y</td>
<td>y</td>
<td>å‘é€è¶…æ—¶</td>
<td></td>
<td>timeval{}</td>
</tr>
<tr>
<td></td>
<td>SO_REUSEADDR</td>
<td>y</td>
<td>y</td>
<td>å…è®¸é‡ç”¨æœ¬åœ°åœ°å€</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_REUSEPORT</td>
<td>y</td>
<td>y</td>
<td>å…è®¸é‡ç”¨æœ¬åœ°åœ°å€</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_TYPE</td>
<td>y</td>
<td></td>
<td>å–å¾—å¥—æ¥å£ç±»å‹</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SO_USELOOPBACK</td>
<td>y</td>
<td>y</td>
<td>è·¯ç”±å¥—æ¥å£å–å¾—æ‰€å‘é€æ•°æ®çš„æ‹·è´</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>IPPROTO_IP</td>
<td>IP_HDRINCL</td>
<td>y</td>
<td>y</td>
<td>IPå¤´éƒ¨åŒ…æ‹¬æ•°æ®</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IP_OPTIONS</td>
<td>y</td>
<td>y</td>
<td>IPå¤´éƒ¨é€‰é¡¹</td>
<td></td>
<td>è§åé¢è¯´æ˜</td>
</tr>
<tr>
<td></td>
<td>IP_RECVDSTADDR</td>
<td>y</td>
<td>y</td>
<td>è¿”å›ç›®çš„IPåœ°å€</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IP_RECVIF</td>
<td>y</td>
<td>y</td>
<td>è¿”å›æ¥æ”¶åˆ°çš„æ¥å£ç´¢å¼•</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IP_TOS</td>
<td>y</td>
<td>y</td>
<td>æœåŠ¡ç±»å‹å’Œä¼˜å…ˆæƒ</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IP_TTL</td>
<td>y</td>
<td>y</td>
<td>å­˜æ´»æ—¶é—´</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IP_MULTICAST_IF</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šå¤–å‡ºæ¥å£</td>
<td></td>
<td>in_addr{}</td>
</tr>
<tr>
<td></td>
<td>IP_MULTICAST_TTL</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šå¤–å‡ºTTL</td>
<td></td>
<td>u_char</td>
</tr>
<tr>
<td></td>
<td>IP_MULTICAST_LOOP</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šæ˜¯å¦å›é¦ˆ</td>
<td></td>
<td>u_char</td>
</tr>
<tr>
<td></td>
<td>IP_ADD_MEMBERSHIP</td>
<td></td>
<td>y</td>
<td>åŠ å…¥å¤šæ’­ç»„</td>
<td></td>
<td>ip_mreq{}</td>
</tr>
<tr>
<td></td>
<td>IP_DROP_MEMBERSHIP</td>
<td></td>
<td>y</td>
<td>ç¦»å¼€å¤šæ’­ç»„</td>
<td></td>
<td>ip_mreq{}</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>IPPROTO_ICMPV6</td>
<td>ICMP6_FILTER</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šä¼ é€’çš„ICMPv6æ¶ˆæ¯ç±»å‹</td>
<td></td>
<td>icmp6_filter{}</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>IPPROTO_IPV6</td>
<td>IPV6_ADDRFORM</td>
<td>y</td>
<td>y</td>
<td>æ”¹å˜å¥—æ¥å£çš„åœ°å€ç»“æ„</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_CHECKSUM</td>
<td>y</td>
<td>y</td>
<td>åŸå§‹å¥—æ¥å£çš„æ ¡éªŒå’Œå­—æ®µåç§»</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_DSTOPTS</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶ç›®æ ‡é€‰é¡¹</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_HOPLIMIT</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶å•æ’­è·³é™</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_HOPOPTS</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶æ­¥è·³é€‰é¡¹</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_NEXTHOP</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šä¸‹ä¸€è·³åœ°å€</td>
<td>y</td>
<td>sockaddr{}</td>
</tr>
<tr>
<td></td>
<td>IPV6_PKTINFO</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶åˆ†ç»„ä¿¡æ¯</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_PKTOPTIONS</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šåˆ†ç»„é€‰é¡¹</td>
<td></td>
<td>è§åé¢è¯´æ˜</td>
</tr>
<tr>
<td></td>
<td>IPV6_RTHDR</td>
<td>y</td>
<td>y</td>
<td>æ¥æ”¶åŸè·¯å¾„</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_UNICAST_HOPS</td>
<td>y</td>
<td>y</td>
<td>ç¼ºçœå•æ’­è·³é™</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>IPV6_MULTICAST_IF</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šå¤–å‡ºæ¥å£</td>
<td></td>
<td>in6_addr{}</td>
</tr>
<tr>
<td></td>
<td>IPV6_MULTICAST_HOPS</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šå¤–å‡ºè·³é™</td>
<td></td>
<td>u_int</td>
</tr>
<tr>
<td></td>
<td>IPV6_MULTICAST_LOOP</td>
<td>y</td>
<td>y</td>
<td>æŒ‡å®šæ˜¯å¦å›é¦ˆ</td>
<td>y</td>
<td>u_int</td>
</tr>
<tr>
<td></td>
<td>IPV6_ADD_MEMBERSHIP</td>
<td></td>
<td>y</td>
<td>åŠ å…¥å¤šæ’­ç»„</td>
<td></td>
<td>ipv6_mreq{}</td>
</tr>
<tr>
<td></td>
<td>IPV6_DROP_MEMBERSHIP</td>
<td></td>
<td>y</td>
<td>ç¦»å¼€å¤šæ’­ç»„</td>
<td></td>
<td>ipv6_mreq{}</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>IPPROTO_TCP</td>
<td>TCP_KEEPALIVE</td>
<td>y</td>
<td>y</td>
<td>æ§æµ‹å¯¹æ–¹æ˜¯å¦å­˜æ´»å‰è¿æ¥é—²ç½®ç§’æ•°</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>TCP_MAXRT</td>
<td>y</td>
<td>y</td>
<td>TCPæœ€å¤§é‡ä¼ æ—¶é—´</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>TCP_MAXSEG</td>
<td>y</td>
<td>y</td>
<td>TCPæœ€å¤§åˆ†èŠ‚å¤§å°</td>
<td></td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>TCP_NODELAY</td>
<td>y</td>
<td>y</td>
<td>ç¦æ­¢Nagleç®—æ³•</td>
<td>y</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>TCP_STDURG</td>
<td>y</td>
<td>y</td>
<td>ç´§æ€¥æŒ‡é’ˆçš„è§£é‡Š</td>
<td>y</td>
<td>int</td>
</tr>
</tbody>
</table>
<p><strong>è¯¦ç»†è¯´æ˜ï¼š</strong></p>
<h3 id="so_broadcast">SO_BROADCAST<a hidden class="anchor" aria-hidden="true" href="#so_broadcast">#</a></h3>
<p>ä½¿èƒ½æˆ–ç¦æ­¢è¿›ç¨‹å‘é€å¹¿æ’­æ¶ˆæ¯çš„èƒ½åŠ›ã€‚åªæœ‰æ•°æ®æŠ¥å¥—æ¥å£æ”¯æŒå¹¿æ’­ï¼Œå¹¶ä¸”è¿˜å¿…é¡»åœ¨æ”¯æŒå¹¿æ’­æ¶ˆæ¯çš„ç½‘ç»œä¸Šï¼ˆå¦‚ä»¥å¤ªç½‘ã€ä»¤ç‰Œç¯ç½‘ç­‰ï¼‰ã€‚</p>
<p>å¦‚æœç›®çš„åœ°å€æ˜¯å¹¿æ’­åœ°å€ä½†æ­¤é€‰é¡¹æœªè®¾ï¼Œåˆ™è¿”å›EACCESé”™è¯¯ã€‚</p>
<h3 id="so_debug">SO_DEBUG<a hidden class="anchor" aria-hidden="true" href="#so_debug">#</a></h3>
<p>ä»…ä»…TCPæ”¯æŒã€‚å½“æ‰“å¼€æ­¤é€‰é¡¹æ—¶ï¼Œå†…æ ¸å¯¹TCPåœ¨æ­¤å¥—æ¥å£æ‰€å‘é€å’Œæ¥æ”¶çš„æ‰€æœ‰åˆ†ç»„è·Ÿè¸ªè¯¦ç»†ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨å†…æ ¸çš„ç¯å½¢ç¼“å†²åŒºå†…ï¼Œå¯ç”±ç¨‹åºtrptè¿›è¡Œæ£€æŸ¥ã€‚</p>
<h3 id="so_dontroute">SO_DONTROUTE<a hidden class="anchor" aria-hidden="true" href="#so_dontroute">#</a></h3>
<p>æ­¤é€‰é¡¹è§„å®šå‘å‡ºçš„åˆ†ç»„å°†æ—è·¯åº•å±‚åè®®çš„æ­£å¸¸è·¯ç”±æœºåˆ¶ã€‚</p>
<p>è¯¥é€‰é¡¹ç»å¸¸ç”±è·¯ç”±å®ˆæŠ¤è¿›ç¨‹ï¼ˆroutedå’Œgatedï¼‰ç”¨æ¥æ—è·¯è·¯ç”±è¡¨ï¼ˆè·¯ç”±è¡¨ä¸æ­£ç¡®çš„æƒ…å†µä¸‹ï¼‰ï¼Œå¼ºåˆ¶ä¸€ä¸ªåˆ†ç»„ä»æŸä¸ªç‰¹å®šæ¥å£å‘å‡ºã€‚</p>
<h3 id="so_error">SO_ERROR<a hidden class="anchor" aria-hidden="true" href="#so_error">#</a></h3>
<p>å½“å¥—æ¥å£ä¸Šå‘ç”Ÿé”™è¯¯æ—¶ï¼Œæºè‡ªBerkeleyçš„å†…æ ¸ä¸­çš„åè®®æ¨¡å—å°†æ­¤å¥—æ¥å£çš„åä¸ºso_errorçš„å˜é‡è®¾ä¸ºæ ‡å‡†çš„UNIX Exxxå€¼ä¸­çš„ä¸€ä¸ªï¼Œå®ƒç§°ä¸ºæ­¤å¥—æ¥å£çš„å¾…å¤„ç†é”™è¯¯ï¼ˆpending errorï¼‰ã€‚å†…æ ¸å¯ç«‹å³ä»¥ä»¥ä¸‹ä¸¤ç§æ–¹å¼é€šçŸ¥è¿›ç¨‹ï¼š</p>
<ol>
<li>å¦‚æœè¿›ç¨‹é˜»å¡äºæ¬¡å¥—æ¥å£çš„selectè°ƒç”¨ï¼Œåˆ™æ— è®ºæ˜¯æ£€æŸ¥å¯è¯»æ¡ä»¶è¿˜æ˜¯å¯å†™æ¡ä»¶ï¼Œselectéƒ½è¿”å›å¹¶è®¾ç½®å…¶ä¸­ä¸€ä¸ªæˆ–æ‰€æœ‰ä¸¤ä¸ªæ¡ä»¶ã€‚</li>
<li>å¦‚æœè¿›ç¨‹ä½¿ç”¨ä¿¡å·é©±åŠ¨I/Oæ¨¡å‹ï¼Œåˆ™ç»™è¿›ç¨‹æˆ–è¿›ç¨‹ç»„ç”Ÿæˆä¿¡å·SIGIOã€‚</li>
</ol>
<p>è¿›ç¨‹ç„¶åå¯ä»¥é€šè¿‡è·å–SO_ERRORå¥—æ¥å£é€‰é¡¹æ¥å¾—åˆ°so_errorçš„å€¼ã€‚ç”±getsockoptè¿”å›çš„æ•´æ•°å€¼å°±æ˜¯æ­¤å¥—æ¥å£çš„å¾…å¤„ç†é”™è¯¯ã€‚so_erroréšåç”±å†…æ ¸å¤ä½ä¸º0ã€‚</p>
<p>å½“è¿›ç¨‹è°ƒç”¨readä¸”æ²¡æœ‰æ•°æ®è¿”å›æ—¶ï¼Œå¦‚æœso_errorä¸ºé0å€¼ï¼Œåˆ™readè¿”å›-1ä¸”errnoè®¾ä¸ºso_errorçš„å€¼ï¼Œæ¥ç€so_errorçš„å€¼è¢«å¤ä½ä¸º0ã€‚å¦‚æœæ­¤å¥—æ¥å£ä¸Šæœ‰æ•°æ®åœ¨æ’é˜Ÿï¼Œåˆ™readè¿”å›é‚£äº›æ•°æ®è€Œä¸æ˜¯è¿”å›é”™è¯¯æ¡ä»¶ã€‚</p>
<p>å¦‚æœè¿›ç¨‹è°ƒç”¨writeæ—¶so_errorä¸ºé0å€¼ï¼Œåˆ™writeè¿”å›-1ä¸”errnoè®¾ä¸ºso_errorçš„å€¼ï¼Œéšåso_errorä¹Ÿè¢«å¤ä½ã€‚</p>
<h3 id="so_keepalive">SO_KEEPALIVE<a hidden class="anchor" aria-hidden="true" href="#so_keepalive">#</a></h3>
<p>æ‰“å¼€æ­¤é€‰é¡¹åï¼Œå¦‚æœ2å°æ—¶å†…åœ¨æ­¤å¥—æ¥å£ä¸Šæ²¡æœ‰ä»»ä½•æ•°æ®äº¤æ¢ï¼ŒTCPå°±ä¼šè‡ªåŠ¨ç»™å¯¹æ–¹å‘ä¸€ä¸ªä¿æŒå­˜æ´»æ¢æµ‹åˆ†èŠ‚ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¹æ–¹ä»¥æœŸæœ›çš„ACKå“åº”ï¼Œåˆ™ä¸€åˆ‡æ­£å¸¸ï¼Œåº”ç”¨ç¨‹åºå¾—ä¸åˆ°é€šçŸ¥ï¼›</li>
<li>å¯¹æ–¹ä»¥RSTå“åº”ï¼Œå¥—æ¥å£çš„å¾…å¤„ç†é”™è¯¯è¢«ç½®ä¸ºECONNRESETï¼Œå¥—æ¥å£æœ¬èº«åˆ™è¢«å…³é—­ï¼›</li>
<li>å¯¹æ–¹å¯¹æ¢æµ‹åˆ†èŠ‚æ— ä»»ä½•å“åº”ï¼Œç»è¿‡é‡è¯•éƒ½æ²¡æœ‰ä»»ä½•å“åº”ï¼Œå¥—æ¥å£çš„å¾…å¤„ç†é”™è¯¯è¢«ç½®ä¸ºETIMEOUTï¼Œå¥—æ¥å£æœ¬èº«è¢«å…³é—­ï¼›è‹¥æ¥æ”¶åˆ°ä¸€ä¸ªICMPé”™è¯¯ä½œä¸ºæŸä¸ªæ¢æµ‹åˆ†èŠ‚çš„å“åº”ï¼Œåˆ™è¿”å›ç›¸åº”é”™è¯¯ã€‚</li>
</ol>
<p>æ­¤é€‰é¡¹ä¸€èˆ¬ç”±æœåŠ¡å™¨ä½¿ç”¨ã€‚æœåŠ¡å™¨ä½¿ç”¨å®ƒæ˜¯ä¸ºäº†æ£€æµ‹å‡ºåŠå¼€è¿æ¥å¹¶ç»ˆæ­¢ä»–ä»¬ã€‚</p>
<h3 id="so_linger">SO_LINGER<a hidden class="anchor" aria-hidden="true" href="#so_linger">#</a></h3>
<p>æ­¤é€‰é¡¹æŒ‡å®šå‡½æ•°closeå¯¹é¢å‘è¿æ¥çš„åè®®å¦‚ä½•æ“ä½œï¼ˆå¦‚TCPï¼‰ã€‚ç¼ºçœcloseæ“ä½œæ˜¯ç«‹å³è¿”å›ï¼Œå¦‚æœæœ‰æ•°æ®æ®‹ç•™åœ¨å¥—æ¥å£ç¼“å†²åŒºä¸­åˆ™ç³»ç»Ÿå°†è¯•ç€å°†è¿™äº›æ•°æ®å‘é€ç»™å¯¹æ–¹ã€‚</p>
<p>SO_LINGERé€‰é¡¹ç”¨æ¥æ”¹å˜æ­¤ç¼ºçœè®¾ç½®ã€‚ä½¿ç”¨å¦‚ä¸‹ç»“æ„ï¼š
struct linger {
int l_onoff; /* 0 = off, nozero = on <em>/
int l_linger; /</em> linger time */
};</p>
<p>æœ‰ä¸‹åˆ—ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>l_onoffä¸º0ï¼Œåˆ™è¯¥é€‰é¡¹å…³é—­ï¼Œl_lingerçš„å€¼è¢«å¿½ç•¥ï¼Œç­‰äºç¼ºçœæƒ…å†µï¼Œcloseç«‹å³è¿”å›ï¼›</li>
<li>l_onoffä¸ºé0ï¼Œl_lingerä¸º0ï¼Œåˆ™å¥—æ¥å£å…³é—­æ—¶TCPå¤­æŠ˜è¿æ¥ï¼ŒTCPå°†ä¸¢å¼ƒä¿ç•™åœ¨å¥—æ¥å£å‘é€ç¼“å†²åŒºä¸­çš„ä»»ä½•æ•°æ®å¹¶å‘é€ä¸€ä¸ªRSTç»™å¯¹æ–¹ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„å››åˆ†ç»„ç»ˆæ­¢åºåˆ—ï¼Œè¿™é¿å…äº†TIME_WAITçŠ¶æ€ï¼›</li>
<li>l_onoff ä¸ºé0ï¼Œl_lingerä¸ºé0ï¼Œå½“å¥—æ¥å£å…³é—­æ—¶å†…æ ¸å°†æ‹–å»¶ä¸€æ®µæ—¶é—´ï¼ˆç”±l_lingerå†³å®šï¼‰ã€‚å¦‚æœå¥—æ¥å£ç¼“å†²åŒºä¸­ä»æ®‹ç•™æ•°æ®ï¼Œè¿›ç¨‹å°†å¤„äºç¡çœ çŠ¶æ€ï¼Œç›´åˆ°ï¼ˆaï¼‰æ‰€æœ‰æ•°æ®å‘é€å®Œä¸”è¢«å¯¹æ–¹ç¡®è®¤ï¼Œä¹‹åè¿›è¡Œæ­£å¸¸çš„ç»ˆæ­¢åºåˆ—ï¼ˆæè¿°å­—è®¿é—®è®¡æ•°ä¸º0ï¼‰æˆ–ï¼ˆbï¼‰å»¶è¿Ÿæ—¶é—´åˆ°ã€‚æ­¤ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºæ£€æŸ¥closeçš„è¿”å›å€¼æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦‚æœåœ¨æ•°æ®å‘é€å®Œå¹¶è¢«ç¡®è®¤å‰æ—¶é—´åˆ°ï¼Œcloseå°†è¿”å›EWOULDBLOCKé”™è¯¯ä¸”å¥—æ¥å£å‘é€ç¼“å†²åŒºä¸­çš„ä»»ä½•æ•°æ®éƒ½ä¸¢å¤±ã€‚closeçš„æˆåŠŸè¿”å›ä»…å‘Šè¯‰æˆ‘ä»¬å‘é€çš„æ•°æ®ï¼ˆå’ŒFINï¼‰å·²ç”±å¯¹æ–¹TCPç¡®è®¤ï¼Œå®ƒå¹¶ä¸èƒ½å‘Šè¯‰æˆ‘ä»¬å¯¹æ–¹åº”ç”¨è¿›ç¨‹æ˜¯å¦å·²è¯»äº†æ•°æ®ã€‚å¦‚æœå¥—æ¥å£è®¾ä¸ºéé˜»å¡çš„ï¼Œå®ƒå°†ä¸ç­‰å¾…closeå®Œæˆã€‚</li>
</ol>
<p>l_lingerçš„å•ä½ä¾èµ–äºå®ç°ï¼Œ4.4BSDå‡è®¾å…¶å•ä½æ˜¯æ—¶é’Ÿæ»´ç­”ï¼ˆç™¾åˆ†ä¹‹ä¸€ç§’ï¼‰ï¼Œä½†Posix.1gè§„å®šå•ä½ä¸ºç§’ã€‚</p>
<p>è®©å®¢æˆ·çŸ¥é“æœåŠ¡å™¨å·²ç»è¯»å…¶æ•°æ®çš„ä¸€ä¸ªæ–¹æ³•æ—¶ï¼šè°ƒç”¨shutdownï¼ˆSHUT_WRï¼‰è€Œä¸æ˜¯è°ƒç”¨closeï¼Œå¹¶ç­‰å¾…å¯¹æ–¹closeè¿æ¥çš„æœ¬åœ°ï¼ˆæœåŠ¡å™¨ï¼‰ç«¯ã€‚</p>
<h3 id="so_oobinline">SO_OOBINLINE<a hidden class="anchor" aria-hidden="true" href="#so_oobinline">#</a></h3>
<p>æ­¤é€‰é¡¹æ‰“å¼€æ—¶ï¼Œå¸¦å¤–æ•°æ®å°†è¢«ä¿ç•™åœ¨æ­£å¸¸çš„è¾“å…¥é˜Ÿåˆ—ä¸­ï¼ˆå³åœ¨çº¿å­˜æ”¾ï¼‰ã€‚å½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œæ¥æ”¶å‡½æ•°çš„MSG_OOBæ ‡å¿—ä¸èƒ½ç”¨æ¥è¯»å¸¦å¤–æ•°æ®ã€‚</p>
<h3 id="so_rcvbufå’Œso_sndbuf">SO_RCVBUFå’ŒSO_SNDBUF<a hidden class="anchor" aria-hidden="true" href="#so_rcvbufå’Œso_sndbuf">#</a></h3>
<p>æ¯ä¸ªå¥—æ¥å£éƒ½æœ‰ä¸€ä¸ªå‘é€ç¼“å†²åŒºå’Œä¸€ä¸ªæ¥æ”¶ç¼“å†²åŒºï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªå¥—æ¥å£é€‰é¡¹å¯ä»¥æ”¹å˜ç¼ºçœç¼“å†²åŒºå¤§å°ã€‚</p>
<p>å½“è®¾ç½®TCPå¥—æ¥å£æ¥æ”¶ç¼“å†²åŒºçš„å¤§å°æ—¶ï¼Œå‡½æ•°è°ƒç”¨é¡ºåºæ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºTCPçš„çª—å£è§„æ¨¡é€‰é¡¹æ˜¯åœ¨å»ºç«‹è¿æ¥æ—¶ç”¨SYNä¸å¯¹æ–¹äº’æ¢å¾—åˆ°çš„ã€‚å¯¹äºå®¢æˆ·ï¼ŒSO_RCVBUFé€‰é¡¹å¿…é¡»åœ¨connectä¹‹å‰è®¾ç½®ï¼›å¯¹äºæœåŠ¡å™¨ï¼ŒSO_RCVBUFé€‰é¡¹å¿…é¡»åœ¨listenå‰è®¾ç½®ã€‚</p>
<p>TCPå¥—æ¥å£ç¼“å†²åŒºçš„å¤§å°è‡³å°‘æ˜¯è¿æ¥çš„MSSçš„ä¸‰å€ï¼Œè€Œå¿…é¡»æ˜¯è¿æ¥çš„MSSçš„å¶æ•°å€ã€‚</p>
<h3 id="so_rcvlowatå’Œso_sndlowat">SO_RCVLOWATå’ŒSO_SNDLOWAT<a hidden class="anchor" aria-hidden="true" href="#so_rcvlowatå’Œso_sndlowat">#</a></h3>
<p>æ¯ä¸ªå¥—æ¥å£æœ‰ä¸€ä¸ªæ¥æ”¶ä½æ½®é™åº¦å’Œä¸€ä¸ªå‘é€ä½æ½®é™åº¦ï¼Œä»–ä»¬ç”±å‡½æ•°selectä½¿ç”¨ã€‚è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥ä¿®æ”¹ä»–ä»¬ã€‚</p>
<p>æ¥æ”¶ä½æ½®é™åº¦æ˜¯è®©selectè¿”å›â€œå¯è¯»â€è€Œåœ¨å¥—æ¥å£æ¥æ”¶ç¼“å†²åŒºä¸­å¿…é¡»æœ‰çš„æ•°æ®é‡ï¼Œå¯¹äºä¸€ä¸ªTCPæˆ–UDPå¥—æ¥å£ï¼Œæ­¤å€¼ç¼ºçœä¸º1ã€‚å‘é€ä½æ½®é™åº¦æ˜¯è®©selectè¿”å›â€œå¯å†™â€è€Œåœ¨å¥—æ¥å£å‘é€ç¼“å†²åŒºä¸­å¿…é¡»æœ‰çš„å¯ç”¨ç©ºé—´ï¼Œå¯¹äºTCPå¥—æ¥å£ï¼Œæ­¤å€¼å¸¸ä¸º2048ã€‚</p>
<h3 id="so_rcvtimeoå’Œso_sndtimeo">SO_RCVTIMEOå’ŒSO_SNDTIMEO<a hidden class="anchor" aria-hidden="true" href="#so_rcvtimeoå’Œso_sndtimeo">#</a></h3>
<p>ä½¿ç”¨è¿™ä¸¤ä¸ªé€‰é¡¹å¯ä»¥ç»™å¥—æ¥å£è®¾ç½®ä¸€ä¸ªæ¥æ”¶å’Œå‘é€è¶…æ—¶ã€‚é€šè¿‡è®¾ç½®å‚æ•°çš„å€¼ä¸º0ç§’å’Œ0å¾®ç§’æ¥ç¦æ­¢è¶…æ—¶ã€‚ç¼ºçœæ—¶ä¸¤ä¸ªè¶…æ—¶éƒ½æ˜¯ç¦æ­¢çš„ã€‚</p>
<p>æ¥æ”¶è¶…æ—¶å½±å“5ä¸ªè¾“å…¥å‡½æ•°ï¼šreadã€readvã€recvã€recvfromå’Œrecvmsgï¼›å‘é€è¶…æ—¶å½±å“5ä¸ªè¾“å‡ºå‡½æ•°ï¼šwriteã€writevã€sendã€sendtoå’Œsendmsgã€‚</p>
<h3 id="so_reuseaddrå’Œso_reuseport">SO_REUSEADDRå’ŒSO_REUSEPORT<a hidden class="anchor" aria-hidden="true" href="#so_reuseaddrå’Œso_reuseport">#</a></h3>
<p>SO_REUSEADDRæä¾›å¦‚ä¸‹å››ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>SO_REUSEADDRå…è®¸å¯åŠ¨ä¸€ä¸ªç›‘å¬æœåŠ¡å™¨å¹¶æ†ç»‘å…¶ä¼—æ‰€å‘¨çŸ¥ç«¯å£ï¼Œå³ä½¿ä»¥å‰å»ºç«‹çš„å°†æ­¤ç«¯å£ç”¨åšä»–ä»¬çš„æœ¬åœ°ç«¯å£çš„è¿æ¥ä»å­˜åœ¨ã€‚è¿™é€šå¸¸æ˜¯é‡å¯ç›‘å¬æœåŠ¡å™¨æ—¶å‡ºç°ï¼Œè‹¥ä¸è®¾ç½®æ­¤é€‰é¡¹ï¼Œåˆ™bindæ—¶å°†å‡ºé”™ã€‚</li>
<li>SO_REUSEADDRå…è®¸åœ¨åŒä¸€ç«¯å£ä¸Šå¯åŠ¨åŒä¸€æœåŠ¡å™¨çš„å¤šä¸ªå®ä¾‹ï¼Œåªè¦æ¯ä¸ªå®ä¾‹æ†ç»‘ä¸€ä¸ªä¸åŒçš„æœ¬åœ°IPåœ°å€å³å¯ã€‚å¯¹äºTCPï¼Œæˆ‘ä»¬æ ¹æœ¬ä¸å¯èƒ½å¯åŠ¨æ†ç»‘ç›¸åŒIPåœ°å€å’Œç›¸åŒç«¯å£å·çš„å¤šä¸ªæœåŠ¡å™¨ã€‚</li>
<li>SO_REUSEADDRå…è®¸å•ä¸ªè¿›ç¨‹æ†ç»‘åŒä¸€ç«¯å£åˆ°å¤šä¸ªå¥—æ¥å£ä¸Šï¼Œåªè¦æ¯ä¸ªæ†ç»‘æŒ‡å®šä¸åŒçš„æœ¬åœ°IPåœ°å€å³å¯ã€‚è¿™ä¸€èˆ¬ä¸ç”¨äºTCPæœåŠ¡å™¨ã€‚</li>
<li>SO_REUSEADDRå…è®¸å®Œå…¨é‡å¤çš„æ†ç»‘ï¼šå½“ä¸€ä¸ªIPåœ°å€å’Œç«¯å£ç»‘å®šåˆ°æŸä¸ªå¥—æ¥å£ä¸Šæ—¶ï¼Œè¿˜å…è®¸æ­¤IPåœ°å€å’Œç«¯å£æ†ç»‘åˆ°å¦ä¸€ä¸ªå¥—æ¥å£ä¸Šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªç‰¹æ€§ä»…åœ¨æ”¯æŒå¤šæ’­çš„ç³»ç»Ÿä¸Šæ‰æœ‰ï¼Œè€Œä¸”åªå¯¹UDPå¥—æ¥å£è€Œè¨€ï¼ˆTCPä¸æ”¯æŒå¤šæ’­ï¼‰ã€‚</li>
</ol>
<p>SO_REUSEPORTé€‰é¡¹æœ‰å¦‚ä¸‹è¯­ä¹‰ï¼š</p>
<ol>
<li>æ­¤é€‰é¡¹å…è®¸å®Œå…¨é‡å¤æ†ç»‘ï¼Œä½†ä»…åœ¨æƒ³æ†ç»‘ç›¸åŒIPåœ°å€å’Œç«¯å£çš„å¥—æ¥å£éƒ½æŒ‡å®šäº†æ­¤å¥—æ¥å£é€‰é¡¹æ‰æ€§ã€‚</li>
<li>å¦‚æœè¢«æ†ç»‘çš„IPåœ°å€æ˜¯ä¸€ä¸ªå¤šæ’­åœ°å€ï¼Œåˆ™SO_REUSEADDRå’ŒSO_REUSEPORTç­‰æ•ˆã€‚</li>
</ol>
<p>ä½¿ç”¨è¿™ä¸¤ä¸ªå¥—æ¥å£é€‰é¡¹çš„å»ºè®®ï¼š</p>
<ol>
<li>åœ¨æ‰€æœ‰TCPæœåŠ¡å™¨ä¸­ï¼Œåœ¨è°ƒç”¨bindä¹‹å‰è®¾ç½®SO_REUSEADDRå¥—æ¥å£é€‰é¡¹ï¼›</li>
<li>å½“ç¼–å†™ä¸€ä¸ªåŒä¸€æ—¶åˆ»åœ¨åŒä¸€ä¸»æœºä¸Šå¯è¿è¡Œå¤šæ¬¡çš„å¤šæ’­åº”ç”¨ç¨‹åºæ—¶ï¼Œè®¾ç½®SO_REUSEADDRé€‰é¡¹ï¼Œå¹¶å°†æœ¬ç»„çš„å¤šæ’­åœ°å€ä½œä¸ºæœ¬åœ°IPåœ°å€æ†ç»‘ã€‚</li>
</ol>
<h3 id="so_type">SO_TYPE<a hidden class="anchor" aria-hidden="true" href="#so_type">#</a></h3>
<p>è¯¥é€‰é¡¹è¿”å›å¥—æ¥å£çš„ç±»å‹ï¼Œè¿”å›çš„æ•´æ•°å€¼æ˜¯ä¸€ä¸ªè¯¸å¦‚SOCK_STREAMæˆ–SOCK_DGRAMè¿™æ ·çš„å€¼ã€‚</p>
<h3 id="so_useloopback">SO_USELOOPBACK<a hidden class="anchor" aria-hidden="true" href="#so_useloopback">#</a></h3>
<p>è¯¥é€‰é¡¹ä»…ç”¨äºè·¯ç”±åŸŸï¼ˆAF_ROUTEï¼‰çš„å¥—æ¥å£ï¼Œå®ƒå¯¹è¿™äº›å¥—æ¥å£çš„ç¼ºçœè®¾ç½®ä¸ºæ‰“å¼€ï¼ˆè¿™æ˜¯å”¯ä¸€ä¸€ä¸ªç¼ºçœä¸ºæ‰“å¼€è€Œä¸æ˜¯å…³é—­çš„SO_xxxå¥—æ¥å£é€‰é¡¹ï¼‰ã€‚å½“æ­¤å¥—æ¥å£æ‰“å¼€æ—¶ï¼Œå¥—æ¥å£æ¥æ”¶åœ¨å…¶ä¸Šå‘é€çš„ä»»ä½•æ•°æ®çš„ä¸€ä¸ªæ‹·è´ã€‚</p>
<p>ç¦æ­¢è¿™äº›å›é¦ˆæ‹·è´çš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯shutdownï¼Œç¬¬äºŒä¸ªå‚æ•°åº”è®¾ä¸ºSHUT_RDã€‚</p>
<h3 id="ip_hdrincl">IP_HDRINCL<a hidden class="anchor" aria-hidden="true" href="#ip_hdrincl">#</a></h3>
<p>å¦‚æœä¸€ä¸ªåŸå§‹å¥—æ¥å£è®¾ç½®è¯¥é€‰é¡¹ï¼Œåˆ™æˆ‘ä»¬å¿…é¡»ä¸ºæ‰€æœ‰å‘é€åˆ°æ­¤åŸå§‹å¥—æ¥å£ä¸Šçš„æ•°æ®æŠ¥æ„é€ è‡ªå·±çš„IPå¤´éƒ¨ã€‚</p>
<h3 id="ip_options">IP_OPTIONS<a hidden class="anchor" aria-hidden="true" href="#ip_options">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹å…è®¸æˆ‘ä»¬åœ¨IPv4å¤´éƒ¨ä¸­è®¾ç½®IPé€‰é¡¹ã€‚è¿™è¦æ±‚æŒæ¡IPå¤´éƒ¨ä¸­IPé€‰é¡¹çš„æ ¼å¼ä¿¡æ¯ã€‚</p>
<h3 id="ip_recvdstaddr">IP_RECVDSTADDR<a hidden class="anchor" aria-hidden="true" href="#ip_recvdstaddr">#</a></h3>
<p>è¯¥é€‰é¡¹å¯¼è‡´æ‰€æ¥æ”¶åˆ°çš„UDPæ•°æ®æŠ¥çš„ç›®çš„IPåœ°å€ç”±å‡½æ•°recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚</p>
<h3 id="ip_recvif">IP_RECVIF<a hidden class="anchor" aria-hidden="true" href="#ip_recvif">#</a></h3>
<p>è¯¥é€‰é¡¹å¯¼è‡´æ‰€æ¥æ”¶åˆ°çš„UDPæ•°æ®æŠ¥çš„æ¥å£ç´¢å¼•ç”±å‡½æ•°recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚</p>
<h3 id="ip_tos">IP_TOS<a hidden class="anchor" aria-hidden="true" href="#ip_tos">#</a></h3>
<p>è¯¥é€‰é¡¹ä½¿æˆ‘ä»¬å¯ä»¥ç»™TCPæˆ–UDPå¥—æ¥å£åœ¨IPå¤´éƒ¨ä¸­è®¾ç½®æœåŠ¡ç±»å‹å­—æ®µã€‚å¦‚æœæˆ‘ä»¬ç»™æ­¤é€‰é¡¹è°ƒç”¨getsockoptï¼Œåˆ™æ”¾åˆ°å¤–å‡ºIPæ•°æ®æŠ¥å¤´éƒ¨çš„TOSå­—æ®µä¸­çš„å½“å‰å€¼å°†è¿”å›ï¼ˆç¼ºçœä¸º0ï¼‰ã€‚è¿˜æ²¡æœ‰åŠæ³•ä»æ¥æ”¶åˆ°çš„IPæ•°æ®æŠ¥ä¸­å–æ­¤å€¼ã€‚</p>
<p>å¯ä»¥å°†TOSè®¾ç½®ä¸ºå¦‚ä¸‹çš„å€¼ï¼š</p>
<ul>
<li>IPTOS_LOWDELAYï¼šæœ€å°åŒ–å»¶è¿Ÿ</li>
<li>IPTOS_THROUGHPUTï¼šæœ€å¤§åŒ–ååé‡</li>
<li>IPTOS_RELIABILITYï¼šæœ€å¤§åŒ–å¯é æ€§</li>
<li>IPTOS_LOWCOSTï¼šæœ€å°åŒ–æˆæœ¬</li>
</ul>
<h3 id="ip_ttl">IP_TTL<a hidden class="anchor" aria-hidden="true" href="#ip_ttl">#</a></h3>
<p>ç”¨æ¬¡é€‰é¡¹ï¼Œå¯ä»¥è®¾ç½®å’Œè·å–ç³»ç»Ÿç”¨äºæŸä¸ªç»™å®šå¥—æ¥å£çš„ç¼ºçœTTLå€¼ï¼ˆå­˜æ´»æ—¶é—´å­—æ®µï¼‰ã€‚ä¸TOSä¸€æ ·ï¼Œæ²¡æœ‰åŠæ³•ä»æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥ä¸­å¾—åˆ°æ­¤å€¼ã€‚</p>
<h3 id="icmp6_filter">ICMP6_FILTER<a hidden class="anchor" aria-hidden="true" href="#icmp6_filter">#</a></h3>
<p>å¯è·å–å’Œè®¾ç½®ä¸€ä¸ªicmp6_filterç»“æ„ï¼Œä»–æŒ‡æ˜256ä¸ªå¯èƒ½çš„ICMPv6æ¶ˆæ¯ç±»å‹ä¸­å“ªä¸€ä¸ªä¼ é€’ç»™åœ¨åŸå§‹å¥—æ¥å£ä¸Šçš„è¿›ç¨‹ã€‚</p>
<h3 id="ipv6_addrform">IPV6_ADDRFORM<a hidden class="anchor" aria-hidden="true" href="#ipv6_addrform">#</a></h3>
<p>å…è®¸å¥—æ¥å£ä»IPv4è½¬æ¢åˆ°IPv6ï¼Œåä¹‹äº¦å¯ã€‚</p>
<h3 id="ipv6_checksum">IPV6_CHECKSUM<a hidden class="anchor" aria-hidden="true" href="#ipv6_checksum">#</a></h3>
<p>æŒ‡å®šç”¨æˆ·æ•°æ®ä¸­æ ¡éªŒå’Œæ‰€å¤„ä½ç½®çš„å­—èŠ‚åç§»ã€‚å¦‚æœæ­¤å€¼ä¸ºéè´Ÿï¼Œåˆ™å†…æ ¸å°†ï¼ˆ1ï¼‰ç»™æ‰€æœ‰å¤–å‡ºåˆ†ç»„è®¡ç®—å¹¶å­˜å‚¨æ ¡éªŒå’Œï¼›ï¼ˆ2ï¼‰è¾“å…¥æ—¶æ£€æŸ¥æ‰€æ”¶åˆ°çš„åˆ†ç»„çš„æ ¡éªŒå’Œï¼Œä¸¢å¼ƒå¸¦æœ‰æ— æ•ˆæ ¡éªŒå’Œçš„åˆ†ç»„ã€‚æ­¤é€‰é¡¹å½±å“å‡ºICMPv6åŸå§‹å¥—æ¥å£å¤–çš„æ‰€æœ‰IPv6å¥—æ¥å£ã€‚å¦‚æœæŒ‡å®šçš„å€¼ä¸º-1ï¼ˆç¼ºçœå€¼ï¼‰ï¼Œå†…æ ¸åœ¨æ­¤åŸå§‹å¥—æ¥å£ä¸Šå°†ä¸ç»™å¤–å‡ºçš„åˆ†ç»„è®¡ç®—å¹¶å­˜å‚¨æ ¡éªŒå’Œï¼Œä¹Ÿä¸æ£€æŸ¥æ‰€æ”¶åˆ°çš„åˆ†ç»„çš„æ ¡éªŒå’Œã€‚</p>
<h3 id="ipv6_dstopts">IPV6_DSTOPTS<a hidden class="anchor" aria-hidden="true" href="#ipv6_dstopts">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹æŒ‡æ˜ï¼šä»»ä½•æ¥æ”¶åˆ°çš„IPv6ç›®æ ‡é€‰é¡¹éƒ½å°†ç”±recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚æ­¤é€‰é¡¹ç¼ºçœä¸ºå…³é—­ã€‚</p>
<h3 id="ipv6_hoplimit">IPV6_HOPLIMIT<a hidden class="anchor" aria-hidden="true" href="#ipv6_hoplimit">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹æŒ‡æ˜ï¼šæ¥æ”¶åˆ°çš„è·³é™å­—æ®µå°†ç”±recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚</p>
<h3 id="ipv6_hopopts">IPV6_HOPOPTS<a hidden class="anchor" aria-hidden="true" href="#ipv6_hopopts">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹æŒ‡æ˜ï¼šä»»ä½•æ¥æ”¶åˆ°çš„æ­¥è·³é€‰é¡¹éƒ½å°†ç”±recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚</p>
<h3 id="ipv6_nexthop">IPV6_NEXTHOP<a hidden class="anchor" aria-hidden="true" href="#ipv6_nexthop">#</a></h3>
<p>è¿™ä¸æ˜¯ä¸€ä¸ªå¥—æ¥å£é€‰é¡¹ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯æŒ‡å®šä¸ªsendmsgçš„è¾…åŠ©æ•°æ®å¯¹è±¡çš„ç±»å‹ã€‚æ­¤å¯¹è±¡ä»¥ä¸€ä¸ªå¥—æ¥å£åœ°å€ç»“æ„æŒ‡å®šæŸä¸ªæ•°æ®æŠ¥çš„ä¸‹ä¸€è·³åœ°å€ã€‚</p>
<h3 id="ipv6_pktinfo">IPV6_PKTINFO<a hidden class="anchor" aria-hidden="true" href="#ipv6_pktinfo">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹æŒ‡æ˜ï¼šä¸‹é¢å…³äºæ¥æ”¶åˆ°çš„IPv6æ•°æ®æŠ¥çš„ä¸¤æ¡ä¿¡æ¯å°†ç”±recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ï¼šç›®çš„IPv6åœ°å€å’Œåˆ°è¾¾æ¥å£ç´¢å¼•ã€‚</p>
<h3 id="ipv6_pktoptions">IPV6_PKTOPTIONS<a hidden class="anchor" aria-hidden="true" href="#ipv6_pktoptions">#</a></h3>
<p>å¤§å¤šæ•°IPv6å¥—æ¥å£é€‰é¡¹å‡è®¾UDPå¥—æ¥å£ä½¿ç”¨recvmsgå’Œsendmsgæ‰€ç”¨çš„è¾…åŠ©æ•°æ®åœ¨å†…æ ¸ä¸åº”ç”¨è¿›ç¨‹é—´ä¼ é€’ä¿¡æ¯ã€‚TCPå¥—æ¥å£ä½¿ç”¨IPV6_PKTOPTIONSæ¥è·å–å’Œå­˜å‚¨è¿™äº›å€¼ã€‚</p>
<h3 id="ipv6_rthdr">IPV6_RTHDR<a hidden class="anchor" aria-hidden="true" href="#ipv6_rthdr">#</a></h3>
<p>è®¾ç½®æ­¤é€‰é¡¹æŒ‡æ˜ï¼šæ¥æ”¶åˆ°çš„IPv6è·¯ç”±å¤´éƒ¨å°†ç”±recvmsgä½œä¸ºè¾…åŠ©æ•°æ®è¿”å›ã€‚</p>
<h3 id="ipv6_unicast_hops">IPV6_UNICAST_HOPS<a hidden class="anchor" aria-hidden="true" href="#ipv6_unicast_hops">#</a></h3>
<p>ç±»ä¼¼äºIPv4çš„IP_TTLï¼Œå®ƒçš„è®¾ç½®æŒ‡å®šå‘é€åˆ°å¥—æ¥å£ä¸Šçš„å¤–å‡ºæ•°æ®æŠ¥çš„ç¼ºçœè·³é™ï¼Œè€Œå®ƒçš„è·å–åˆ™è¿”å›å†…æ ¸å°†ç”¨äºå¥—æ¥å£çš„è·³é™å€¼ã€‚ä¸ºäº†ä»æ¥æ”¶åˆ°çš„IPv6æ•°æ®æŠ¥ä¸­å¾—åˆ°çœŸå®çš„è·³é™å­—æ®µï¼Œè¦æ±‚ä½¿ç”¨IPV6_HOPLIMITå¥—æ¥å£é€‰é¡¹ã€‚</p>
<h3 id="tcp_keepalive">TCP_KEEPALIVE<a hidden class="anchor" aria-hidden="true" href="#tcp_keepalive">#</a></h3>
<p>å®ƒæŒ‡å®šTCPå¼€å§‹å‘é€ä¿æŒå­˜æ´»æ¢æµ‹åˆ†èŠ‚å‰ä»¥ç§’ä¸ºå•ä½çš„è¿æ¥ç©ºé—²æ—¶é—´ã€‚ç¼ºçœå€¼è‡³å°‘ä¸º7200ç§’ï¼Œå³2å°æ—¶ã€‚è¯¥é€‰é¡¹ä»…åœ¨SO_KEEPALIVEå¥—æ¥å£é€‰é¡¹æ‰“å¼€æ—¶æ‰æœ‰æ•ˆã€‚</p>
<h3 id="tcp_maxrt">TCP_MAXRT<a hidden class="anchor" aria-hidden="true" href="#tcp_maxrt">#</a></h3>
<p>å®ƒæŒ‡å®šä¸€æ—¦TCPå¼€å§‹é‡ä¼ æ•°æ®ï¼Œåœ¨è¿æ¥æ–­å¼€ä¹‹å‰éœ€ç»å†çš„ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æ€»é‡ã€‚å€¼0æ„å‘³ç€ä½¿ç”¨ç³»ç»Ÿç¼ºçœå€¼ï¼Œå€¼-1æ„å‘³ç€æ°¸è¿œé‡ä¼ æ•°æ®ã€‚</p>
<h3 id="tcp_maxseg">TCP_MAXSEG<a hidden class="anchor" aria-hidden="true" href="#tcp_maxseg">#</a></h3>
<p>å…è®¸è·å–æˆ–è®¾ç½®TCPè¿æ¥çš„æœ€å¤§åˆ†èŠ‚å¤§å°ï¼ˆMSSï¼‰ã€‚è¿”å›å€¼æ˜¯æˆ‘ä»¬çš„TCPå‘é€ç»™å¦ä¸€ç«¯çš„æœ€å¤§æ•°æ®é‡ï¼Œä»–å¸¸å¸¸å°±æ˜¯ç”±å¦ä¸€ç«¯ç”¨SYNåˆ†èŠ‚é€šå‘Šçš„MSSï¼Œé™¤éæˆ‘ä»¬çš„TCPé€‰æ‹©ä½¿ç”¨ä¸€ä¸ªæ¯”å¯¹æ–¹é€šå‘Šçš„MSSå°çš„å€¼ã€‚å¦‚æœæ­¤é€‰é¡¹åœ¨å¥—æ¥å£è¿æ¥ä¹‹å‰å–å¾—ï¼Œåˆ™è¿”å›å€¼ä¸ºæœªä»å¦ä¸€ç«¯æ”¶åˆ°çš„MSSé€‰é¡¹çš„æƒ…å†µä¸‹æ‰€ç”¨çš„ç¼ºçœå€¼ã€‚</p>
<h3 id="tcp_nodelay">TCP_NODELAY<a hidden class="anchor" aria-hidden="true" href="#tcp_nodelay">#</a></h3>
<p>å¦‚æœè®¾ç½®ï¼Œæ­¤é€‰é¡¹ç¦æ­¢TCPçš„Nagleç®—æ³•ã€‚ç¼ºçœæ—¶ï¼Œè¯¥ç®—æ³•æ˜¯ä½¿èƒ½çš„ã€‚</p>
<p>Nagleç®—æ³•çš„ç›®çš„æ˜¯å‡å°‘WANä¸Šå°åˆ†ç»„çš„æ•°ç›®ã€‚</p>
<p>Nagleç®—æ³•å¸¸å¸¸ä¸å¦ä¸€ä¸ªTCPç®—æ³•è”åˆä½¿ç”¨ï¼šå»¶è¿ŸACKï¼ˆdelayed ACKï¼‰ç®—æ³•ã€‚</p>
<p>è§£å†³å¤šæ¬¡å†™å¯¼è‡´Nagleç®—æ³•å’Œå»¶è¿ŸACKç®—æ³•è´Ÿé¢å½±å“çš„æ–¹æ³•ï¼š</p>
<ol>
<li>ä½¿ç”¨writevè€Œä¸æ˜¯å¤šæ¬¡writeï¼›</li>
<li>åˆå¹¶ç¼“å†²åŒºï¼Œå¯¹æ­¤ç¼“å†²åŒºä½¿ç”¨ä¸€æ¬¡writeï¼›</li>
<li>è®¾ç½®TCP_NODELAYé€‰é¡¹ï¼Œç»§ç»­è°ƒç”¨writeå¤šæ¬¡ï¼Œè¿™æ˜¯æœ€ä¸å¯å–çš„è§£å†³æ–¹æ³•ã€‚</li>
</ol>
<h3 id="tcp_stdurg">TCP_STDURG<a hidden class="anchor" aria-hidden="true" href="#tcp_stdurg">#</a></h3>
<p>å®ƒå½±å“å¯¹TCPç´§æ€¥æŒ‡é’ˆçš„è§£é‡Šã€‚</p>
<hr>
<h2 id="19å¤„ç†å¥—æ¥å£çš„fcntlå‡½æ•°">19.å¤„ç†å¥—æ¥å£çš„fcntlå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#19å¤„ç†å¥—æ¥å£çš„fcntlå‡½æ•°">#</a></h2>
<p>#include &lt;fcntl.h&gt;
int fcntl(int fd, int cmd, â€¦ /* arg */);
è¿”å›ï¼šä¾èµ–äºå‚æ•°cmdâ€”æˆåŠŸï¼Œ-1â€”å¤±è´¥ã€‚</p>
<p>å‡½æ•°fcntlæä¾›äº†å¦‚ä¸‹å…³äºç½‘ç»œç¼–ç¨‹çš„ç‰¹æ€§ï¼š</p>
<ol>
<li>éé˜»å¡I/Oï¼šé€šè¿‡ç”¨F_SETFLå‘½ä»¤è®¾ç½®O_NONBLOCKæ–‡ä»¶çŠ¶æ€æ ‡å¿—æ¥è®¾ç½®å¥—æ¥å£ä¸ºéé˜»å¡å‹ã€‚</li>
<li>ä¿¡å·é©±åŠ¨I/Oï¼šç”¨F_SETFLå‘½ä»¤æ¥è®¾ç½®O_ASYNCæ–‡ä»¶çŠ¶æ€æ ‡å¿—ï¼Œè¿™å¯¼è‡´åœ¨å¥—æ¥å£çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å†…æ ¸ç”Ÿæˆä¿¡å·SIGIOã€‚</li>
<li>F_SETOWNå‘½ä»¤è®¾ç½®å¥—æ¥å£å±ä¸»ï¼ˆè¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„IDï¼‰ï¼Œç”±å®ƒæ¥æ¥æ”¶ä¿¡å·SIGIOå’ŒSIGURGã€‚SIGIOåœ¨è®¾ç½®å¥—æ¥å£ä¸ºä¿¡å·é©±åŠ¨I/Oå‹æ—¶ç”Ÿæˆï¼ŒSIGURGåœ¨æ–°çš„å¸¦å¤–æ•°æ®åˆ°è¾¾å¥—æ¥å£æ—¶ç”Ÿæˆã€‚</li>
<li>F_GETOWNå‘½ä»¤è¿”å›å¥—æ¥å£çš„å½“å‰å±ä¸»ã€‚</li>
</ol>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>è®¾ç½®æŸä¸ªæ–‡ä»¶çŠ¶æ€æ ‡å¿—æ—¶ï¼Œå…ˆå–å¾—å½“å‰æ ‡å¿—ï¼Œä¸æ–°æ ‡å¿—è·¯é€»è¾‘æˆ–åå†è®¾ç½®æ ‡å¿—ã€‚</li>
<li>ä¿¡å·SIGIOå’ŒSIGURGä¸å…¶ä»–ä¿¡å·ä¸åŒä¹‹å¤„åœ¨äºï¼Œè¿™ä¸¤ä¸ªä¿¡å·åªæœ‰åœ¨å·²ä½¿ç”¨å‘½ä»¤F_SETOWNç»™å¥—æ¥å£æŒ‡æ´¾äº†å±ä¸»åæ‰ä¼šç”Ÿæˆã€‚F_SETOWNå‘½ä»¤çš„æ•´å‚æ•°argæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼ŒæŒ‡æ˜æ¥æ”¶ä¿¡å·çš„è¿›ç¨‹IDï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè´Ÿæ•´æ•°ï¼Œå®ƒçš„ç»å¯¹å€¼æ˜¯æ¥æ”¶ä¿¡å·çš„è¿›ç¨‹ç»„IDã€‚</li>
<li>å½“ä¸€ä¸ªæ–°çš„å¥—æ¥å£ç”±å‡½æ•°socketåˆ›å»ºæ—¶ï¼Œä»–æ²¡æœ‰å±ä¸»ï¼Œä½†æ˜¯å½“ä¸€ä¸ªæ–°çš„å¥—æ¥å£ä»ä¸€ä¸ªç›‘å¬å¥—æ¥å£åˆ›å»ºæ—¶ï¼Œå¥—æ¥å£å±ä¸»ä¾¿ç”±å·²è¿æ¥å¥—æ¥å£ä»ç›‘å¬å¥—æ¥å£ç»§æ‰¿è€Œæ¥ã€‚</li>
</ul>
<hr>
<h2 id="20gethostbynameå‡½æ•°">20.gethostbynameå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#20gethostbynameå‡½æ•°">#</a></h2>
<p>#include &lt;netdb.h&gt;
struct hostent *gethostbyname(const char *hostname);
è¿”å›ï¼šéç©ºæŒ‡é’ˆâ€”æˆåŠŸï¼Œç©ºæŒ‡é’ˆâ€”å‡ºé”™ï¼ŒåŒæ—¶è®¾ç½®h_errnoã€‚</p>
<p>å‡½æ•°è¿”å›çš„éç©ºæŒ‡é’ˆæŒ‡å‘çš„ç»“æ„å¦‚ä¸‹ï¼š
struct hostent {
char *h_name; /*è§„èŒƒä¸»æœºå */
char *<em>h_aliases; /</em> åˆ«ååˆ—è¡¨ <em>/
int h_addrtype; /</em> AF_INET or AF_INET6 <em>/
int h_length; /</em> åœ°å€é•¿åº¦ */
char *<em>h_addr_list; /</em> IPv4æˆ–IPv6åœ°å€ç»“æ„åˆ—è¡¨ */
};
#define h_addr h_addr_list[0];</p>
<p>æŒ‰ç…§DNSçš„è¯´æ³•ï¼Œgethostbynameæ‰§è¡Œä¸€ä¸ªå¯¹Aè®°å½•çš„æŸ¥è¯¢æˆ–å¯¹AAAAè®°å½•çš„æŸ¥è¯¢ï¼Œè¿”å›IPv4æˆ–IPv6åœ°å€ã€‚</p>
<p>h_addrçš„å®šä¹‰æ˜¯ä¸ºäº†å…¼å®¹ï¼Œåœ¨æ–°ä»£ç ä¸­ä¸åº”ä½¿ç”¨ã€‚</p>
<p>è¿”å›çš„h_nameç§°ä¸ºä¸»æœºçš„è§„èŒƒï¼ˆcanonicalï¼‰åå­—ã€‚å½“è¿”å›IPv6åœ°å€æ—¶ï¼Œh_addrtypeè¢«è®¾ç½®ä¸ºAF_INET6ï¼Œæˆå‘˜h_lengthè¢«è®¾ç½®ä¸º16ã€‚</p>
<p>gethostbynameçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼šå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä»–ä¸è®¾ç½®errnoï¼Œè€Œæ˜¯å°†å…¨å±€æ•´æ•°h_errnoè®¾ç½®ä¸ºå®šä¹‰åœ¨å¤´æ–‡ä»¶&lt;netdb.h&gt;ä¸­çš„ä¸‹åˆ—å¸¸å€¼ä¸­çš„ä¸€ä¸ªï¼š</p>
<ul>
<li>HOST_NOT_FOUNDï¼›</li>
<li>TRY_AGAINï¼›</li>
<li>NO_RECOVERYï¼›</li>
<li>NO_DATAï¼ˆç­‰åŒäºNO_ADDRESSï¼‰ã€‚</li>
</ul>
<p>æœ‰å‡½æ•°hstrerrorï¼ˆï¼‰ï¼Œå®ƒå°†h_errnoçš„å€¼ä½œä¸ºå”¯ä¸€çš„å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ç›¸åº”é”™è¯¯è¯´æ˜çš„const char *å‹æŒ‡é’ˆã€‚</p>
<h3 id="dnså°å¸¸è¯†">DNSå°å¸¸è¯†ï¼š<a hidden class="anchor" aria-hidden="true" href="#dnså°å¸¸è¯†">#</a></h3>
<p>DNSä¸­çš„æ¡ç›®ç§°ä¸ºèµ„æºè®°å½•RRï¼ˆresource recordï¼‰ï¼Œä»…æœ‰å°‘æ•°å‡ ç±»RRä¼šå½±å“æˆ‘ä»¬çš„åå­—ä¸åœ°å€è½¬æ¢ï¼š</p>
<ul>
<li>Aï¼šAè®°å½•å°†ä¸»æœºåæ˜ å°„ä¸º32ä½çš„IPv4åœ°å€ï¼›</li>
<li>AAAAï¼šâ€œå››Aâ€è®°å½•å°†ä¸»æœºåæ˜ å°„ä¸º128ä½çš„IPv6åœ°å€ï¼›</li>
<li>PTRï¼šPTRè®°å½•ï¼ˆç§°ä¸ºâ€œæŒ‡é’ˆè®°å½•â€ï¼‰å°†IPåœ°å€æ˜ å°„ä¸ºä¸»æœºåï¼›</li>
<li>MXï¼šMXè®°å½•æŒ‡å®šä¸€ä¸»æœºä½œä¸ºæŸä¸»æœºçš„â€œé‚®ä»¶äº¤æ¢å™¨â€ã€‚</li>
<li>CNAMEï¼šCNAMEä»£è¡¨â€œcanonical nameï¼ˆè§„èŒƒåå­—ï¼‰â€ï¼Œå…¶å¸¸è§çš„ç”¨æ³•æ˜¯ä¸ºå¸¸ç”¨æœåŠ¡å¦‚ftpå’ŒwwwæŒ‡æ´¾ä¸€ä¸ªCNAMEè®°å½•ã€‚</li>
</ul>
<hr>
<h2 id="21gethostbyname2å‡½æ•°">21.gethostbyname2å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#21gethostbyname2å‡½æ•°">#</a></h2>
<p>#include &lt;netdb.h&gt;
struct hostent *gethostbyname2(const char *hostname, int family);
è¿”å›ï¼šéç©ºæŒ‡é’ˆâ€”æˆåŠŸï¼Œç©ºæŒ‡é’ˆâ€”å‡ºé”™ï¼ŒåŒæ—¶è®¾ç½®h_errnoã€‚</p>
<p>è¯¥å‡½æ•°å…è®¸æŒ‡å®šåœ°å€æ—ï¼Œå…¶ä»–ä¸gethostbynameç›¸ä¼¼ã€‚</p>
<hr>
<h2 id="22gethostbyaddrå‡½æ•°">22.gethostbyaddrå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#22gethostbyaddrå‡½æ•°">#</a></h2>
<p>#include &lt;netdb.h&gt;
struct hostent *gethostbyaddr(const char *addr, size_t len, int family);
è¿”å›ï¼šéç©ºæŒ‡é’ˆâ€”æˆåŠŸï¼Œç©ºæŒ‡é’ˆâ€”å‡ºé”™ï¼ŒåŒæ—¶è®¾ç½®h_errorã€‚</p>
<p>å‡½æ•°æ ¹æ®ä¸€ä¸ªäºŒè¿›åˆ¶çš„IPåœ°å€å¹¶è¯•å›¾æ‰¾å‡ºç›¸åº”äºæ­¤åœ°å€çš„ä¸»æœºåï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯è§„èŒƒä¸»æœºåh_nameã€‚</p>
<p>å‚æ•°addrä¸æ˜¯char *ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ªçœŸæ­£æŒ‡å‘å«æœ‰IPv4æˆ–IPv6åœ°å€çš„ç»“æ„in_addræˆ–in6_addrçš„æŒ‡é’ˆï¼›lenæ˜¯è¯¥ç»“æ„çš„å¤§å°ï¼Œå¯¹äºIPv4æ˜¯4ï¼Œå¯¹äºIPv6æ˜¯16ï¼›familyæˆ–ä¸ºAF_INETæˆ–ä¸ºAF_INET6ã€‚</p>
<p>æŒ‰ç…§DNSçš„è¯´æ³•ï¼Œè¯¥å‡½æ•°æŸ¥è¯¢PTRè®°å½•ã€‚</p>
<hr>
<h2 id="23unameå‡½æ•°">23.unameå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#23unameå‡½æ•°">#</a></h2>
<p>#include &lt;sys/utsname.h&gt;
int uname(struct utsname *name);
è¿”å›ï¼šéè´Ÿå€¼â€”æˆåŠŸï¼Œ-1â€”å¤±è´¥ã€‚</p>
<p>è¿”å›å½“å‰ä¸»æœºçš„åå­—ï¼Œå­˜æ”¾åœ¨å¦‚ä¸‹çš„ç»“æ„é‡Œï¼š
#define UTS_NAMESIZE 16
#define UTS_NODESIZE 256
struct utsname {
char sysname[UTS_NAMESIZE];
char nodename[UTS_NODESIZE];
char release[UTS_NAMESIZE];
char version[UTS_NAMESIZE];
char machine[UTS_NAMESIZE];
};</p>
<p>è¯¥å‡½æ•°ç»å¸¸ä¸gethostbynameä¸€èµ·ç”¨æ¥ç¡®å®šæœ¬æœºçš„IPåœ°å€ï¼šå…ˆè°ƒç”¨unameè·å¾—ä¸»æœºåå­—ï¼Œç„¶åè°ƒç”¨gethostbynameå¾—åˆ°æ‰€æœ‰çš„IPåœ°å€ã€‚</p>
<p>è·å¾—æœ¬æœºIPåœ°å€çš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯ioctlçš„å‘½ä»¤SIOCGIFCONFã€‚</p>
<hr>
<h2 id="24gethostnameå‡½æ•°">24.gethostnameå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#24gethostnameå‡½æ•°">#</a></h2>
<p>#include &lt;unistd.h&gt;
int gethostname(char *name, size_t namelen);
è¿”å›ï¼š0â€”æˆåŠŸï¼Œ-1â€”å¤±è´¥ã€‚</p>
<p>è¿”å›å½“å‰ä¸»æœºçš„åå­—ã€‚nameæ˜¯æŒ‡å‘ä¸»æœºåå­˜å‚¨ä½ç½®çš„æŒ‡é’ˆï¼Œnamelenæ˜¯æ­¤æ•°ç»„çš„å¤§å°ï¼Œå¦‚æœæœ‰ç©ºé—´ï¼Œä¸»æœºåä»¥ç©ºå­—ç¬¦ç»“æŸã€‚</p>
<p>ä¸»æœºåçš„æœ€å¤§å¤§å°é€šå¸¸æ˜¯å¤´æ–‡ä»¶&lt;sys/param.h&gt;å®šä¹‰çš„å¸¸å€¼MAXHOSTNAMELENã€‚</p>
<hr>
<h2 id="25getservbynameå‡½æ•°">25.getservbynameå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#25getservbynameå‡½æ•°">#</a></h2>
<p>#include &lt;netdb.h&gt;
struct servent *getservbyname(const char *servname, const char *protoname);
è¿”å›ï¼šéç©ºæŒ‡é’ˆâ€”æˆåŠŸï¼Œç©ºæŒ‡é’ˆâ€”å¤±è´¥ã€‚</p>
<p>å‡½æ•°è¿”å›å¦‚ä¸‹ç»“æ„çš„æŒ‡é’ˆï¼š
struct servent {
char *s_name;
char **s_aliases;
int s_port;
char *s_proto;
};</p>
<p>æœåŠ¡åservnameå¿…é¡»æŒ‡å®šï¼Œå¦‚æœè¿˜æŒ‡å®šäº†åè®®ï¼ˆprotonameä¸ºéç©ºæŒ‡é’ˆï¼‰ï¼Œåˆ™ç»“æœè¡¨é¡¹å¿…é¡»æœ‰åŒ¹é…çš„è®°å½•ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šåè®®åè€ŒæœåŠ¡æ”¯æŒå¤šä¸ªåè®®ï¼Œåˆ™è¿”å›å“ªä¸ªç«¯å£æ˜¯ä¾èµ–äºå®ç°çš„ã€‚</p>
<p>ç»“æ„ä¸­çš„ç«¯å£å·æ˜¯ä»¥ç½‘ç»œå­—èŠ‚åºè¿”å›çš„ï¼Œæ‰€ä»¥åœ¨å°†å®ƒå­˜å‚¨åœ¨å¥—æ¥å£åœ°å€ç»“æ„æ—¶ï¼Œç»å¯¹ä¸èƒ½è°ƒç”¨htonsã€‚</p>
<hr>
<h2 id="26getservbyportå‡½æ•°">26.getservbyportå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#26getservbyportå‡½æ•°">#</a></h2>
<p>#include &lt;netdb.h&gt;
struct servent *getservbyport(int port, const char *protname);
è¿”å›ï¼šéç©ºæŒ‡é’ˆâ€”æˆåŠŸï¼Œç©ºæŒ‡é’ˆâ€”å‡ºé”™ã€‚</p>
<p>portå¿…é¡»ä¸ºç½‘ç»œå­—èŠ‚åºã€‚ä¾‹å¦‚ï¼š
sptr = getservbyport(htons(53), â€œudpâ€);</p>
<hr>
<h2 id="27recvå’Œsend">27.recvå’Œsend<a hidden class="anchor" aria-hidden="true" href="#27recvå’Œsend">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
ssize_t recv(int sockfd, void *buf, size_t nbytes, int flags);
ssize_t send(int sockfd, void *buf, size_t nbytes, int flags);
è¿”å›ï¼šæˆåŠŸè¿”å›è¯»å…¥æˆ–å†™å‡ºçš„å­—èŠ‚æ•°ï¼Œå‡ºé”™è¿”å›-1ã€‚</p>
<p>å‰ä¸‰ä¸ªå‚æ•°ä¸readå’Œwriteç›¸åŒï¼Œå‚æ•°flagsçš„å€¼æˆ–ä¸º0ï¼Œæˆ–ç”±ä»¥ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªå¸¸å€¼é€»è¾‘æˆ–æ„æˆï¼š</p>
<table>
<thead>
<tr>
<th>flags</th>
<th>æè¿°</th>
<th>recv</th>
<th>send</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MSG_DONTROUTE</td>
<td>ä¸æŸ¥è·¯ç”±è¡¨</td>
<td></td>
<td>y</td>
</tr>
<tr>
<td>MSG_DONTWAIT</td>
<td>æœ¬æ“ä½œä¸é˜»å¡</td>
<td>y</td>
<td>y</td>
</tr>
<tr>
<td>MSG_OOB</td>
<td>å‘é€æˆ–æ¥æ”¶å¸¦å¤–æ•°æ®</td>
<td>y</td>
<td>y</td>
</tr>
<tr>
<td>MSG_PEEK</td>
<td>æŸ¥çœ‹å¤–æ¥çš„æ¶ˆæ¯</td>
<td>y</td>
<td></td>
</tr>
<tr>
<td>MSG_WAITALL</td>
<td>ç­‰å¾…æ‰€æœ‰æ•°æ®</td>
<td>y</td>
<td></td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢è¯´æ˜æ¯ä¸ªæ ‡å¿—çš„ä½œç”¨ï¼š</p>
<ul>
<li>MSG_DONTROUTEï¼šè¿™ä¸ªæ ‡å¿—å‘Šè¯‰å†…æ ¸ç›®çš„ä¸»æœºåœ¨ç›´æ¥è¿æ¥çš„æœ¬åœ°ç½‘ç»œä¸Šï¼Œä¸è¦æŸ¥è·¯ç”±è¡¨ã€‚è¿™æ˜¯å¯¹æä¾›è¿™ç§ç‰¹æ€§çš„SO_DONTROUTEå¥—æ¥å£é€‰é¡¹çš„è¡¥å……ã€‚è¯¥æ ‡å¿—å¯ä»¥å¯¹å•ä¸ªè¾“å‡ºæ“ä½œæä¾›è¿™ç§ç‰¹æ€§ï¼Œè€Œå¥—æ¥å£é€‰é¡¹åˆ™é’ˆå¯¹æŸä¸ªå¥—æ¥å£ä¸Šçš„æ‰€æœ‰è¾“å‡ºæ“ä½œã€‚</li>
<li>MSG_DONTWAITï¼šè¿™ä¸ªæ ‡å¿—å°†å•ä¸ªI/Oæ“ä½œè®¾ä¸ºéé˜»å¡æ–¹å¼ï¼Œè€Œä¸éœ€è¦åœ¨å¥—æ¥å£ä¸Šæ‰“å¼€éé˜»å¡æ ‡å¿—ï¼Œæ‰§è¡ŒI/Oæ“ä½œï¼Œç„¶åå…³é—­é˜»å¡æ ‡å¿—ã€‚</li>
<li>MSG_OOBï¼šç”¨sendæ—¶ï¼Œè¿™ä¸ªæ ‡å¿—æŒ‡æ˜å‘é€çš„æ˜¯å¸¦å¤–æ•°æ®ï¼Œç”¨recvæ—¶ï¼Œè¯¥æ ‡å¿—æŒ‡æ˜è¦è¯»çš„æ˜¯å¸¦å¤–æ•°æ®è€Œä¸æ˜¯ä¸€èˆ¬æ•°æ®ã€‚</li>
<li>MSG_PEEKï¼šè¿™ä¸ªæ ‡å¿—å¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹å¯è¯»çš„æ•°æ®ï¼Œåœ¨recvæˆ–recvfromåç³»ç»Ÿä¸ä¼šå°†è¿™äº›æ•°æ®ä¸¢å¼ƒã€‚</li>
<li>MSG_WAITALLï¼šç”±4.3BSD Renoå¼•å…¥ï¼Œä»–å‘Šè¯‰å†…æ ¸åœ¨æ²¡æœ‰è¯»åˆ°è¯·æ±‚çš„å­—èŠ‚æ•°ä¹‹å‰ä¸ä½¿è¯»æ“ä½œè¿”å›ã€‚å¦‚æœç³»ç»Ÿæ”¯æŒè¿™ä¸ªæ ‡å¿—ï¼Œåˆ™å¯ä»¥å»æ‰readnå‡½æ•°ã€‚å³ä½¿è®¾å®šäº†è¯¥æ ‡å¿—ï¼Œå¦‚æœå‘ç”Ÿå¦‚ä¸‹æƒ…å†µï¼šï¼ˆ1ï¼‰æ•è·äº†ä¸€ä¸ªä¿¡å·ï¼›ï¼ˆ2ï¼‰è¿æ¥è¢«ç»ˆæ­¢ï¼›ï¼ˆ3ï¼‰åœ¨å¥—æ¥å£ä¸Šå‘ç”Ÿé”™è¯¯ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å­—èŠ‚æ•°ä»ä¼šæ¯”è¯·æ±‚çš„å°‘ã€‚</li>
</ul>
<hr>
<h2 id="28readvå’Œwritev">28.readvå’Œwritev<a hidden class="anchor" aria-hidden="true" href="#28readvå’Œwritev">#</a></h2>
<p>#include &lt;sys/uio.h&gt;
ssize_t readv(int filedes, const struct iovec *iov, int iovcnt);
ssize_t writev(int filedes, const struct iovec *iov, int iovcnt);
è¿”å›ï¼šè¯»åˆ°æˆ–å†™å‡ºçš„å­—èŠ‚æ•°ï¼Œå‡ºé”™è¿”å›-1ã€‚</p>
<p>readvå’Œwritevå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸­è¯»æˆ–å†™å¤šä¸ªç¼“å†²åŒºï¼Œè¿™äº›æ“ä½œè¢«ç§°ä¸ºåˆ†æ•£è¯»å’Œé›†ä¸­å†™ã€‚</p>
<p>iovecç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š
struct iovec {
void <em>iov_base; /</em> starting address of buffer <em>/
size_t iov_len; /</em> size of buffer */
};</p>
<p>åœ¨å…·ä½“çš„å®ç°ä¸­å¯¹iovecç»“æ„æ•°ç»„çš„å…ƒç´ ä¸ªæ•°æœ‰é™åˆ¶ï¼Œ4.3BSDæœ€å¤šå…è®¸1024ä¸ªï¼Œè€ŒSolaris2.5ä¸Šé™æ˜¯16ã€‚Posix.1gè¦æ±‚å®šä¹‰ä¸€ä¸ªå¸¸å€¼IOV_MAXï¼Œè€Œä¸”å®ƒçš„å€¼ä¸å°äº16ã€‚</p>
<p>readvå’Œwritevå¯ç”¨äºä»»ä½•æè¿°å­—ã€‚writevæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå¯ä»¥é¿å…å¤šæ¬¡å†™å¼•å‘çš„Nagleç®—æ³•ã€‚</p>
<hr>
<h2 id="29readmsgå’Œwritemsg">29.readmsgå’Œwritemsg<a hidden class="anchor" aria-hidden="true" href="#29readmsgå’Œwritemsg">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
ssize_t recvmsg(int sockfd, struct msghdr *msg, int flags);
ssize_t sendmsg(int sockfd, struct msghdr *msg, int flags);
è¿”å›ï¼šæˆåŠŸæ—¶ä¸ºè¯»å…¥æˆ–å†™å‡ºçš„å­—èŠ‚æ•°ï¼Œå‡ºé”™æ—¶ä¸º-1ã€‚</p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯æœ€é€šç”¨çš„å¥—æ¥å£I/Oå‡½æ•°ï¼Œå¯ä»¥ç”¨recvmsgä»£æ›¿readã€readvã€recvå’Œrecvfromï¼ŒåŒæ ·ï¼Œå„ç§è¾“å‡ºå‡½æ•°éƒ½å¯ä»¥ç”¨sendmsgä»£æ›¿ã€‚</p>
<p>å‚æ•°msghdrç»“æ„çš„å®šä¹‰å¦‚ä¸‹ï¼š
struct msghdr {
void <em>msg_name; /</em> protocol address <em>/
socklen_t msg_namelen; /</em> size of protocol address */
struct iovec <em>msg_iov; /</em> scatter/gather array <em>/
size_t msg_iovlen; /</em> elements in msg_iov */
void <em>msg_control; /</em> ancillary data; must be aligned for a cmsghdr structure <em>/
socklen_t msg_controllen; /</em> length of ancillary data <em>/
int msg_flags; /</em> flags returned by recvmsg() */
};</p>
<p>è¯¥ç»“æ„æºè‡ª4.3BSD Renoï¼Œä¹Ÿæ˜¯Posix.1gä¸­æ‰€è¯´æ˜çš„ï¼Œæœ‰äº›ç³»ç»Ÿä»ä½¿ç”¨ä¸€ç§è€çš„msghdrç»“æ„ï¼Œæ­¤ç§ç»“æ„ä¸­æ²¡æœ‰msg_flagsæˆå‘˜ï¼Œè€Œä¸” msg_controlå’Œmsg_controllenæˆå‘˜åˆ†åˆ«è¢«å«åšmsg_accrightså’Œmsg_accrightslenã€‚è€ç³»ç»Ÿä¸­æ”¯æŒçš„å”¯ä¸€ä¸€ç§è¾…åŠ©æ•°æ®å½¢å¼æ˜¯æ–‡ä»¶æè¿°å­—ï¼ˆç§°ä¸ºè®¿é—®æƒé™ï¼‰çš„ä¼ é€’ã€‚</p>
<p>msg_nameå’Œmsg_namelenæˆå‘˜ç”¨äºæœªç»è¿æ¥çš„å¥—æ¥å£ï¼Œä»–ä»¬ä¸ recvfromå’Œsendtoçš„ç¬¬äº”å’Œç¬¬å…­ä¸ªå‚æ•°ç±»ä¼¼ï¼šmsg_nameæŒ‡å‘ä¸€ä¸ªå¥—æ¥å£åœ°å€ç»“æ„ï¼Œå¦‚æœä¸éœ€è¦æŒ‡æ˜åè®®åœ°å€ï¼Œmsg_nameåº”è¢«è®¾ç½®ä¸ºç©ºæŒ‡é’ˆï¼Œmsg_namelenå¯¹sendmsgæ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œå¯¹recvmsgæ˜¯ä¸€ä¸ªå€¼-ç»“æœå‚æ•°ã€‚</p>
<p>msg_iovå’Œmsg_iovlenæˆå‘˜æŒ‡æ˜è¾“å…¥æˆ–è¾“å‡ºçš„ç¼“å†²åŒºæ•°ç»„ã€‚</p>
<p>msg_controlå’Œmsg_controllenæŒ‡æ˜å¯é€‰çš„è¾…åŠ©æ•°æ®çš„ä½ç½®å’Œå¤§å°ï¼Œmsg_controllenå¯¹recvmsgæ˜¯ä¸€ä¸ªå€¼-ç»“æœå‚æ•°ã€‚</p>
<p>msg_flagsåªç”¨äºrevmsgï¼Œè°ƒç”¨recvmsgæ—¶ï¼Œflagså‚æ•°è¢«æ‹·è´åˆ°msg_flagsæˆå‘˜ï¼Œè€Œä¸”å†…æ ¸ç”¨è¿™ä¸ªå€¼è¿›è¡Œæ¥æ”¶å¤„ç†ï¼Œæ¥ç€å®ƒçš„å€¼ä¼šæ ¹æ®recvmsgçš„ç»“æœè€Œæ›´æ–°ï¼Œsendmsgä¼šå¿½ç•¥msg_flagsæˆå‘˜ï¼Œå› ä¸ºå®ƒåœ¨è¿›è¡Œè¾“å‡ºå¤„ç†æ—¶ä½¿ç”¨flagså‚æ•°ã€‚</p>
<p>å†…æ ¸æ£€æŸ¥çš„flagså’Œè¿”å›çš„msg_flagså¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>æ ‡å¿—</th>
<th>åœ¨send flagsã€ sendto flagsã€ sendmsg flagsä¸­æ£€æŸ¥</th>
<th>åœ¨recv flagsã€ recvfrom flagsã€ recvmsg flagsä¸­æ£€æŸ¥</th>
<th>åœ¨recvmsg msg_flags ä¸­è¿”å›</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MSG_DONTROUTE</td>
<td>y</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MSG_DONTWAIT</td>
<td>y</td>
<td>y</td>
<td></td>
</tr>
<tr>
<td>MSG_PEEK</td>
<td></td>
<td>y</td>
<td></td>
</tr>
<tr>
<td>MSG_WAITALL</td>
<td></td>
<td>y</td>
<td></td>
</tr>
<tr>
<td>MSG_EOR</td>
<td>y</td>
<td></td>
<td>y</td>
</tr>
<tr>
<td>MSG_OOB</td>
<td>y</td>
<td>y</td>
<td>y</td>
</tr>
<tr>
<td>MSG_BCAST</td>
<td></td>
<td></td>
<td>y</td>
</tr>
<tr>
<td>MSG_MCAST</td>
<td></td>
<td></td>
<td>y</td>
</tr>
<tr>
<td>MSG_TRUNC</td>
<td></td>
<td></td>
<td>y</td>
</tr>
<tr>
<td>MSG_CTRUNC</td>
<td></td>
<td></td>
<td>y</td>
</tr>
</tbody>
</table>
<p>å‰å››ä¸ªæ ‡å¿—åªæ£€æŸ¥ä¸è¿”å›ï¼Œä¸‹ä¸¤ä¸ªæ ‡å¿—æ—¢æ£€æŸ¥åˆè¿”å›ï¼Œæœ€åå››ä¸ªåªè¿”å›ã€‚è¿”å›çš„å…­ä¸ªæ ‡å¿—å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>MSG_BCASTï¼šå½“æ”¶åˆ°çš„æ•°æ®æŠ¥æ˜¯ä¸€ä¸ªé“¾è·¯å±‚çš„å¹¿æ’­æˆ–å…¶ç›®çš„IPåœ°å€ä¸ºå¹¿æ’­åœ°å€æ—¶ï¼Œå°†è¿”å›æ­¤æ ‡å¿—ã€‚</li>
<li>MSG_MCASTï¼šå½“æ”¶åˆ°çš„æ•°æ®æŠ¥æ˜¯é“¾è·¯å±‚çš„å¤šæ’­æ—¶ï¼Œå°†è¿”å›è¯¥æ ‡å¿—ã€‚</li>
<li>MSG_TRUNCï¼šè¿™ä¸ªæ ‡å¿—åœ¨æ•°æ®æŠ¥è¢«æˆªæ–­æ—¶è¿”å›ã€‚</li>
<li>MSG_CTRUNCï¼šè¿™ä¸ªæ ‡å¿—åœ¨è¾…åŠ©æ•°æ®è¢«æˆªæ–­æ—¶è¿”å›ã€‚</li>
<li>MSG_EORï¼šå¦‚æœè¿”å›çš„æ•°æ®ä¸æ˜¯ä¸€ä¸ªé€»è¾‘è®°å½•çš„ç»“å°¾ï¼Œè¯¥æ ‡å¿—è¢«æ¸…ä½ï¼Œåä¹‹åˆ™ç½®ä½ã€‚TCPä¸ä½¿ç”¨è¿™ä¸ªæ ‡å¿—ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§å­—èŠ‚æµåè®®ã€‚</li>
<li>MSG_OOBï¼šè¿™ä¸ªæ ‡å¿—ä¸æ˜¯ä¸ºTCPçš„å¸¦å¤–æ•°æ®è¿”å›çš„ï¼Œå®ƒç”¨äºå…¶ä»–åè®®æ—ï¼ˆè­¬å¦‚OSIåè®®ç­‰ï¼‰ã€‚</li>
</ul>
<p>å…·ä½“çš„å®ç°å¯èƒ½ä¼šåœ¨msg_flagsä¸­è¿”å›ä¸€äº›è¾“å…¥çš„flagsçš„æ ‡å¿—ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åªæ£€æŸ¥é‚£äº›æ„Ÿå…´è¶£çš„æ ‡å¿—çš„å€¼ã€‚</p>
<hr>
<h2 id="30socketpairå‡½æ•°">30.socketpairå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#30socketpairå‡½æ•°">#</a></h2>
<p>#include &lt;sys/socket.h&gt;
int socketpair(int family, int type, int protocol, int sockfd[2]);
è¿”å›ï¼šæˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1ã€‚</p>
<p>familyå¿…é¡»ä¸ºAF_LOCALï¼Œprotocolå¿…é¡»ä¸º0ï¼Œtypeå¯ä»¥æ˜¯SOCK_STREAMæˆ–SOCK_DGRAMã€‚æ–°åˆ›å»ºçš„ä¸¤ä¸ªå¥—æ¥å£æè¿°å­—ä½œä¸ºsockfd[0]å’Œsockfd[1]è¿”å›ã€‚</p>
<p>è¿™ä¸¤ä¸ªæè¿°å­—ç›¸äº’è¿æ¥ï¼Œæ²¡æœ‰åå­—ï¼Œå³æ²¡æœ‰æ¶‰åŠéšå¼bindã€‚</p>
<p>ä»¥SOCK_STREAMä½œä¸ºtypeè°ƒç”¨æ‰€å¾—åˆ°çš„ç»“æœç§°ä¸ºæµç®¡é“ï¼ˆstream pipeï¼‰ã€‚è¿™ä¸ä¸€èˆ¬çš„UNIXç®¡é“ç±»ä¼¼ï¼Œä½†æµç®¡é“æ˜¯å…¨åŒå·¥çš„ï¼Œä¸¤ä¸ªæè¿°å­—éƒ½æ˜¯å¯è¯»å†™çš„ã€‚</p>
<hr>
<h2 id="31å¥—æ¥å£ioctlå‡½æ•°">31.å¥—æ¥å£ioctlå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#31å¥—æ¥å£ioctlå‡½æ•°">#</a></h2>
<p>#include &lt;unistd.h&gt;
int ioctl(int fd, int request, â€¦ /* void *arg */ );
è¿”å›ï¼šæˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°æ€»æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†æŒ‡é’ˆçš„ç±»å‹ä¾èµ–äºrequestã€‚</p>
<p>ioctlå’Œç½‘ç»œæœ‰å…³çš„è¯·æ±‚å¯åˆ†ä¸ºå¦‚ä¸‹6ç±»ï¼š</p>
<table>
<thead>
<tr>
<th>ç±»åˆ«</th>
<th>request</th>
<th>æè¿°</th>
<th>æ•°æ®ç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>å¥—æ¥å£</td>
<td>SIOCATMARK</td>
<td>åœ¨å¸¦å¤–æ ‡å¿—ä¸Šå—</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SIOCSPGRP</td>
<td>è®¾ç½®å¥—æ¥å£çš„è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„ID</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>SIOCGPGRP</td>
<td>è·å–å¥—æ¥å£çš„è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„ID</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>æ–‡ä»¶</td>
<td>FIONBIO</td>
<td>è®¾ç½®/æ¸…é™¤éé˜»å¡æ ‡å¿—</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>FIOASYNC</td>
<td>è®¾ç½®/æ¸…é™¤å¼‚æ­¥I/Oæ ‡å¿—</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>FIONREAD</td>
<td>è·å–æ¥æ”¶ç¼“å†²åŒºä¸­çš„å­—èŠ‚æ•°</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>FIOSETOWN</td>
<td>è®¾ç½®æ–‡ä»¶çš„è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„ID</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td>FIOGETOWN</td>
<td>è·å–æ–‡ä»¶çš„è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„ID</td>
<td>int</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>æ¥å£</td>
<td>SIOCGIFCONF</td>
<td>è·å–æ‰€æœ‰æ¥å£çš„åˆ—è¡¨</td>
<td>struct ifconf</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFADDR</td>
<td>è®¾ç½®æ¥å£åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFADDR</td>
<td>è·å–æ¥å£åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFFLAGS</td>
<td>è®¾ç½®æ¥å£æ ‡å¿—</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFFLAGS</td>
<td>è·å–æ¥å£æ ‡å¿—</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFDSTADDR</td>
<td>è®¾ç½®ç‚¹åˆ°ç‚¹åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFDSTADDR</td>
<td>è·å–ç‚¹åˆ°ç‚¹åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFBRDADDR</td>
<td>è·å–å¹¿æ’­åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFBRDADDR</td>
<td>è®¾ç½®å¹¿æ’­åœ°å€</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFNETMASK</td>
<td>è·å–å­ç½‘æ©ç </td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFNETMASK</td>
<td>è®¾ç½®å­ç½‘æ©ç </td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGIFMETRIC</td>
<td>è·å–æ¥å£çš„æµ‹åº¦ï¼ˆmetricï¼‰</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCSIFMETRIC</td>
<td>è®¾ç½®æ¥å£çš„æµ‹åº¦ï¼ˆmetricï¼‰</td>
<td>struct ifreq</td>
</tr>
<tr>
<td></td>
<td>SIOCxxx</td>
<td>ï¼ˆæœ‰å¾ˆå¤šï¼Œä¾èµ–äºå®ç°ï¼‰</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ARP</td>
<td>SIOCSARP</td>
<td>åˆ›å»º/ä¿®æ”¹ARPé¡¹</td>
<td>struct arpreq</td>
</tr>
<tr>
<td></td>
<td>SIOCGARP</td>
<td>è·å–ARPé¡¹</td>
<td>struct arpreq</td>
</tr>
<tr>
<td></td>
<td>SIOCDARP</td>
<td>åˆ é™¤ARPé¡¹</td>
<td>struct arpreq</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>è·¯ç”±</td>
<td>SIOCADDRT</td>
<td>å¢åŠ è·¯å¾„</td>
<td>struct rtentry</td>
</tr>
<tr>
<td></td>
<td>SIOCDELRT</td>
<td>åˆ é™¤è·¯å¾„</td>
<td>struct rtentry</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>æµ</td>
<td>I_xxx</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="1å¥—æ¥å£æ“ä½œ">(1)å¥—æ¥å£æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#1å¥—æ¥å£æ“ä½œ">#</a></h3>
<ul>
<li>SIOCATMARKï¼šå¦‚æœå¥—æ¥å£çš„è¯»æŒ‡é’ˆå½“å‰åœ¨å¸¦å¤–æ ‡å¿—ä¸Šï¼Œåˆ™é€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„æ•´æ•°è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼Œå¦åˆ™è¿”å›é›¶ã€‚Posix.1gç”¨sockatmarkä»£æ›¿äº†è¿™ç§è¯·æ±‚ã€‚</li>
<li>SIOCGPGRPï¼šé€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„æ•´æ•°è¿”å›ä¸ºæ¥æ”¶æ¥è‡ªè¿™ä¸ªå¥—æ¥å£çš„SIGIOæˆ–SIGURGä¿¡å·è€Œè®¾ç½®çš„è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„IDã€‚è¿™å’Œfcntlçš„F_GETOWNç›¸åŒã€‚</li>
<li>SIOCSPGRPï¼šç”¨ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„æ•´æ•°è®¾ç½®è¿›ç¨‹IDæˆ–è¿›ç¨‹ç»„IDä»¥æ¥æ”¶è¿™ä¸ªå¥—æ¥å£çš„SIGIOæˆ–SIGURGä¿¡å·ã€‚è¿™å’Œfcntlçš„F_SETOWNç›¸åŒã€‚</li>
</ul>
<h3 id="2æ–‡ä»¶æ“ä½œ">(2)æ–‡ä»¶æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#2æ–‡ä»¶æ“ä½œ">#</a></h3>
<ul>
<li>FIONBIOï¼šå¥—æ¥å£çš„éé˜»å¡æ ‡å¿—ä¼šæ ¹æ®ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„å€¼æ˜¯å¦ä¸ºé›¶è€Œæ¸…é™¤æˆ–è®¾ç½®ã€‚ç­‰ä»·äºfcntlçš„F_SETFLè®¾ç½®/æ¸…é™¤O_NONBLOCKæ ‡å¿—ã€‚</li>
<li>FIOASYNCï¼šæ ¹æ®ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„å€¼æ˜¯å¦ä¸ºé›¶å†³å®šæ¸…é™¤æˆ–æ¥æ”¶å¥—æ¥å£ä¸Šçš„å¼‚æ­¥I/Oä¿¡å·ã€‚ç­‰ä»·äºfcntlçš„F_SETFLè®¾ç½®å’Œæ¸…é™¤O_AYNCæ ‡å¿—ã€‚</li>
<li>FIONREADï¼šåœ¨ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘çš„æ•´æ•°ä¸­è¿”å›å¥—æ¥å£æ¥æ”¶ç¼“å†²åŒºä¸­å½“å‰çš„å­—èŠ‚æ•°ã€‚</li>
<li>FIOSETOWNï¼šåœ¨å¥—æ¥å£ä¸Šç­‰ä»·äºSIOCSPGRPã€‚</li>
<li>FIOGETOWNï¼šåœ¨å¥—æ¥å£ä¸Šç­‰ä»·äºSIOCGPGRPã€‚</li>
</ul>
<h3 id="3æ¥å£é…ç½®">(3)æ¥å£é…ç½®<a hidden class="anchor" aria-hidden="true" href="#3æ¥å£é…ç½®">#</a></h3>
<p>SIOCGIFCONFï¼šä»å†…æ ¸ä¸­è·å–ç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰æ¥å£ã€‚å®ƒä½¿ç”¨äº†ç»“æ„ifconfï¼Œifconfåˆä½¿ç”¨äº†ifreqç»“æ„ã€‚</p>
<p>ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š
struct ifconf {
int ifc_len; /* size of buffer, value-result <em>/
union {
caddr_t ifcu_buf; /</em> input from user-&gt;kernel */
struct ifreq <em>ifcu_req; /</em> return from kernel-&gt;user */
}ifc_ifcu;
};
#define ifc_buf ifc_ifcu.ifcu_buf
#define ifc_req ifc_ifcu.ifcu_req
#define IFNAMSIZ 16</p>
<p>struct ifreq {
char ifr_name[IFNAMSIZ];
union {
struct sockaddr ifru_addr;
struct sockaddr ifru_dstaddr;
struct sockaddr ifru_broadaddr;
short ifru_flags;
int ifru_metric;
caddr_t ifru_data;
}ifr_ifru;
};
#define ifr_addr ifr_ifru.ifru_addr
#define ifr_dstaddr ifr_ifru.ifru_dstaddr
#define ifr_broadaddr ifr_ifru.broadaddr
#define ifr_flags ifr_ifru.ifru_flags
#define ifr_metric ifr_ifru.ifru_metric
#define ifr_data ifr_ifru.ifru_data</p>
<p>åœ¨è°ƒç”¨ioctlä¹‹å‰åˆ†é…ä¸€ä¸ªç¼“å†²åŒºå’Œä¸€ä¸ªifconfç»“æ„ï¼Œç„¶ååˆå§‹åŒ–åè€…ï¼Œiotctlçš„ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å‘ifconfç»“æ„ã€‚</p>
<p>ä¸€ä¸ªå®ç°è·å–æ‰€æœ‰æ¥å£çš„ç¨‹åºï¼Œå¯å‚è§unpv12eï¼šlib/get_ifi_info.c</p>
<h3 id="4æ¥å£æ“ä½œ">(4)æ¥å£æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#4æ¥å£æ“ä½œ">#</a></h3>
<ul>
<li>SIOCGIFCONFï¼šä»å†…æ ¸ä¸­è·å–ç³»ç»Ÿä¸­é…ç½®çš„æ‰€æœ‰æ¥å£ã€‚</li>
</ul>
<h3 id="5arpé«˜é€Ÿç¼“å­˜æ“ä½œ">(5)ARPé«˜é€Ÿç¼“å­˜æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#5arpé«˜é€Ÿç¼“å­˜æ“ä½œ">#</a></h3>
<h3 id="6è·¯ç”±è¡¨æ“ä½œ">(6)è·¯ç”±è¡¨æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#6è·¯ç”±è¡¨æ“ä½œ">#</a></h3>
<p><a href="http://www.cnblogs.com/riky/archive/2006/11/24/570713.aspx">http://www.cnblogs.com/riky/archive/2006/11/24/570713.aspx</a></p>
<p>è½¬è‡ªï¼šhttp://blog.chinaunix.net/space.php?uid=20564848&amp;do=blog&amp;id=73226</p>
<h1 id="è¿›ç¨‹é—´é€šä¿¡ipc-inter-process-communication">è¿›ç¨‹é—´é€šä¿¡IPC Inter-Process Communication<a hidden class="anchor" aria-hidden="true" href="#è¿›ç¨‹é—´é€šä¿¡ipc-inter-process-communication">#</a></h1>
<h2 id="ä¿¡å·signal">ä¿¡å·Signal<a hidden class="anchor" aria-hidden="true" href="#ä¿¡å·signal">#</a></h2>
<h3 id="ä»€ä¹ˆæ˜¯ä¿¡å·">ä»€ä¹ˆæ˜¯ä¿¡å·<a hidden class="anchor" aria-hidden="true" href="#ä»€ä¹ˆæ˜¯ä¿¡å·">#</a></h3>
<ul>
<li>ä¿¡å·åœ¨ç°å®ä¸–ç•Œå°±æ˜¯ç”¨æ¥ä¼ é€’çš„æŸç§ä¿¡æ¯çš„ä¸€ç§æ‰‹æ®µï¼Œæ¯”å¦‚ä¸€ä¸ªçœ¼ç¥ï¼Œä¸€ä¸ªå£°éŸ³ã€ä¸€ä¸ªçº¦å®šçš„æ‰‹åŠ¿ç­‰ç­‰</li>
<li>è®¡ç®—æœºä¸–ç•Œä¿¡å·æ˜¯è½¯ä»¶å±‚æ¬¡ä¸Šå¯¹ä¸­æ–­æœºåˆ¶çš„ä¸€ç§æ¨¡æ‹Ÿã€‚</li>
<li>ä¿¡å·æ˜¯å¼‚æ­¥çš„ï¼Œè¿›ç¨‹ä¸ç”¨åšä»€ä¹ˆæ“ä½œæ¥ç­‰å¾…ä¿¡å·åˆ°è¾¾ï¼Œä¹Ÿä¸æ¸…æ¥šä¿¡å·ä»€ä¹ˆæ—¶å€™èƒ½å¤Ÿåˆ°è¾¾ï¼Œç”¨æ¥å¼‚æ­¥é€šçŸ¥ä¸€ä¸ªè¿›ç¨‹æŸç§äº‹æƒ…å‘ç”Ÿäº†ï¼Œè¿›ç¨‹é€šè¿‡å®ç°æ³¨å†ŒæŸäº›å‡½æ•°ï¼Œæ¥å¼‚æ­¥ç­‰å¾…ç›¸åº”ä¿¡å·å‘ç”Ÿçš„æ—¶å€™åšç›¸åº”çš„å¤„ç†ã€‚</li>
</ul>
<h3 id="ä¿¡å·çš„æ¥æº">ä¿¡å·çš„æ¥æº<a hidden class="anchor" aria-hidden="true" href="#ä¿¡å·çš„æ¥æº">#</a></h3>
<ul>
<li>ç¡¬ä»¶æ¥æº
<ul>
<li>(æ¯”å¦‚æˆ‘ä»¬æŒ‰ä¸‹äº†é”®ç›˜ä¸Šçš„æŸäº›é”®ã€Control+Cä¹‹ç±»çš„ã€‘ æˆ–è€…æŸäº›ç¡¬ä»¶å‡ºç°äº†æ•…éšœç­‰ç­‰)</li>
</ul>
</li>
<li>è½¯ä»¶æ¥æº
<ul>
<li>é€šè¿‡kill, raise,alarm,setitimer,sigqueue,abortç³»ç»Ÿå‡½æ•° å‘ç‰¹å®šè¿›ç¨‹å‘é€ä¿¡å·</li>
<li>ä¸€äº›éå¸¸è¿ç®—æ“ä½œ æ¯”å¦‚é™¤ä»¥0ç­‰ç­‰</li>
</ul>
</li>
</ul>
<h3 id="æ”¶åˆ°ä¿¡å·å¦‚ä½•å¤„ç†">æ”¶åˆ°ä¿¡å·å¦‚ä½•å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#æ”¶åˆ°ä¿¡å·å¦‚ä½•å¤„ç†">#</a></h3>
<ul>
<li>å¿½ç•¥ä¿¡å·
<ul>
<li>ä¹Ÿå°±æ˜¯ä¸åšä»»ä½•å¤„ç† SIGKILLã€SIGSTOPä¸èƒ½å¿½ç•¥</li>
<li>æ•æ‰ä¿¡å·ï¼Œå®šä¹‰è‡ªå·±çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“ä¿¡å·æ¥äº†ï¼Œæ‰§è¡Œç›¸åº”å¤„ç†</li>
<li>æ‰§è¡Œç¼ºçœæ“ä½œï¼Œä¸èµ°ä¸Šé¢2ä¸ªæ­¥éª¤ï¼Œé»˜è®¤å°±æ˜¯è¿™ä¸ªï¼Œlinuxå¯¹æ¯ä¸ªä¿¡å·éƒ½æœ‰é»˜è®¤æ“ä½œ</li>
</ul>
</li>
</ul>
<h3 id="ç›¸å…³ç³»ç»Ÿå‡½æ•°è¯´æ˜">ç›¸å…³ç³»ç»Ÿå‡½æ•°è¯´æ˜<a hidden class="anchor" aria-hidden="true" href="#ç›¸å…³ç³»ç»Ÿå‡½æ•°è¯´æ˜">#</a></h3>
<ul>
<li>
<p>killå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/types.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> kill(pid_t pid,<span style="color:#a6e22e">int</span> signo) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¯¹æŒ‡å®šçš„è¿›ç¨‹å‘é€ä»€ä¹ˆä¿¡æ¯ã€‚</span>
</span></span><span style="display:flex;"><span>pid<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">è¿›ç¨‹</span> ID <span style="color:#960050;background-color:#1e0010">ä¸º</span> pid <span style="color:#960050;background-color:#1e0010">çš„è¿›ç¨‹ï¼›</span>
</span></span><span style="display:flex;"><span>pid<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„è¿›ç¨‹ï¼›</span>
</span></span><span style="display:flex;"><span>pid<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> pid<span style="color:#f92672">!=-</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">è¿›ç¨‹ç»„</span> ID <span style="color:#960050;background-color:#1e0010">ä¸º</span> <span style="color:#f92672">-</span>pid <span style="color:#960050;background-color:#1e0010">çš„æ‰€æœ‰è¿›ç¨‹ï¼›</span>
</span></span><span style="display:flex;"><span>pid<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">é™¤å‘é€è¿›ç¨‹è‡ªèº«å¤–ï¼Œæ‰€æœ‰è¿›ç¨‹</span> ID <span style="color:#960050;background-color:#1e0010">å¤§äº</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">çš„è¿›ç¨‹ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>raiseå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> raise(<span style="color:#a6e22e">int</span> signo) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å‘è¿›ç¨‹æœ¬èº«å‘é€ä¿¡å·ï¼Œå‚æ•°ä¸ºå³å°†å‘é€çš„ä¿¡å·å€¼ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è°ƒç”¨æˆåŠŸè¿”å›</span> <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">ï¼›å¦åˆ™ï¼Œè¿”å›</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div></li>
<li>
<p>sigqueueå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/types.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> sigqueue(pid_t pid, <span style="color:#a6e22e">int</span> sig, <span style="color:#66d9ef">const</span> union sigval val) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è°ƒç”¨æˆåŠŸè¿”å›</span> <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">ï¼›å¦åˆ™ï¼Œè¿”å›</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å®šæ¥æ”¶ä¿¡å·çš„è¿›ç¨‹</span> ID<span style="color:#960050;background-color:#1e0010">ï¼Œç¬¬äºŒä¸ªå‚æ•°ç¡®å®šå³å°†å‘é€çš„ä¿¡å·ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè”åˆæ•°æ®ç»“æ„</span> union sigval<span style="color:#960050;background-color:#1e0010">ï¼ŒæŒ‡å®šäº†ä¿¡å·ä¼ é€’çš„å‚æ•°ï¼Œ</span>sigqueue() <span style="color:#960050;background-color:#1e0010">æ¯”</span> kill() <span style="color:#960050;background-color:#1e0010">ä¼ é€’äº†æ›´å¤šçš„é™„åŠ ä¿¡æ¯ï¼Œä½†</span> sigqueue() <span style="color:#960050;background-color:#1e0010">åªèƒ½å‘ä¸€ä¸ªè¿›ç¨‹å‘é€ä¿¡å·ï¼Œè€Œä¸èƒ½å‘é€ä¿¡å·ç»™ä¸€ä¸ªè¿›ç¨‹ç»„</span>
</span></span></code></pre></div></li>
<li>
<p>alarmå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">alarm</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> seconds) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ä¸º</span> SIGALRM <span style="color:#960050;background-color:#1e0010">ä¿¡å·è€Œè®¾ï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´</span> seconds <span style="color:#960050;background-color:#1e0010">ç§’åï¼Œå°†å‘è¿›ç¨‹æœ¬èº«å‘é€</span> SIGALRM <span style="color:#960050;background-color:#1e0010">ä¿¡å·ï¼Œåˆç§°ä¸ºé—¹é’Ÿæ—¶é—´ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è¿›ç¨‹è°ƒç”¨</span> alarm <span style="color:#960050;background-color:#1e0010">åï¼Œä»»ä½•ä»¥å‰çš„</span> <span style="color:#a6e22e">alarm</span>() <span style="color:#960050;background-color:#1e0010">è°ƒç”¨éƒ½å°†æ— æ•ˆã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¦‚æœå‚æ•°</span> seconds <span style="color:#960050;background-color:#1e0010">ä¸ºé›¶ï¼Œé‚£ä¹ˆè¿›ç¨‹å†…å°†ä¸å†åŒ…å«ä»»ä½•é—¹é’Ÿæ—¶é—´ã€‚</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è¿”å›å€¼ï¼Œå¦‚æœè°ƒç”¨</span> alarm <span style="color:#960050;background-color:#1e0010">å‰ï¼Œè¿›ç¨‹ä¸­å·²ç»è®¾ç½®äº†é—¹é’Ÿæ—¶é—´ï¼Œåˆ™è¿”å›ä¸Šä¸€ä¸ªé—¹é’Ÿæ—¶é—´çš„å‰©ä½™æ—¶é—´ï¼Œå¦åˆ™è¿”å›</span> <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>setitimerå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/time.h&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> setitimer(<span style="color:#a6e22e">int</span> which, <span style="color:#66d9ef">const</span> struct itimerval <span style="color:#f92672">*</span>value, struct itimerval <span style="color:#f92672">*</span>ovalue));
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">æ¯”</span> alarmåŠŸèƒ½å¼ºå¤§<span style="color:#960050;background-color:#1e0010">ï¼Œæ”¯æŒ</span><span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">ç§ç±»å‹çš„å®šæ—¶å™¨ï¼š</span>
</span></span><span style="display:flex;"><span>ITIMER_REAL<span style="color:#960050;background-color:#1e0010">ï¼š</span>  <span style="color:#960050;background-color:#1e0010">è®¾å®šç»å¯¹æ—¶é—´ï¼›ç»è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œå†…æ ¸å°†å‘é€</span>SIGALRMä¿¡å·ç»™æœ¬è¿›ç¨‹<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span>ITIMER_VIRTUAL <span style="color:#960050;background-color:#1e0010">è®¾å®šç¨‹åºæ‰§è¡Œæ—¶é—´ï¼›ç»è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œå†…æ ¸å°†å‘é€</span>SIGVTALRMä¿¡å·ç»™æœ¬è¿›ç¨‹<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span>ITIMER_PROF    <span style="color:#960050;background-color:#1e0010">è®¾å®šè¿›ç¨‹æ‰§è¡Œä»¥åŠå†…æ ¸å› æœ¬è¿›ç¨‹è€Œæ¶ˆè€—çš„æ—¶é—´å’Œï¼Œç»è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œå†…æ ¸å°†å‘é€</span>ITIMER_VIRTUALä¿¡å·ç»™æœ¬è¿›ç¨‹<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span></code></pre></div></li>
<li>
<p>abortå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">abort</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å‘è¿›ç¨‹å‘é€</span> SIGABORT <span style="color:#960050;background-color:#1e0010">ä¿¡å·ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿›ç¨‹ä¼šå¼‚å¸¸é€€å‡ºï¼Œå½“ç„¶å¯å®šä¹‰è‡ªå·±çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å³ä½¿</span> SIGABORT <span style="color:#960050;background-color:#1e0010">è¢«è¿›ç¨‹è®¾ç½®ä¸ºé˜»å¡ä¿¡å·ï¼Œè°ƒç”¨</span> <span style="color:#a6e22e">abort</span>() <span style="color:#960050;background-color:#1e0010">åï¼Œ</span>SIGABORT <span style="color:#960050;background-color:#1e0010">ä»ç„¶èƒ½è¢«è¿›ç¨‹æ¥æ”¶ã€‚è¯¥å‡½æ•°æ— è¿”å›å€¼ã€‚</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="å¦‚ä½•æ³¨å†Œä¿¡å·å¤„ç†">å¦‚ä½•æ³¨å†Œä¿¡å·å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#å¦‚ä½•æ³¨å†Œä¿¡å·å¤„ç†">#</a></h3>
<ul>
<li>
<p><strong>ç¡®å®šä¿¡å·å€¼åŠè¿›ç¨‹é’ˆå¯¹è¯¥ä¿¡å·å€¼çš„åŠ¨ä½œä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå³è¿›ç¨‹å°†è¦å¤„ç†å“ªä¸ªä¿¡å·ï¼›è¯¥ä¿¡å·è¢«ä¼ é€’ç»™è¿›ç¨‹æ—¶ï¼Œå°†æ‰§è¡Œä½•ç§æ“ä½œ</strong></p>
</li>
<li>
<p>signalå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt; </span>
</span></span><span style="display:flex;"><span>void (<span style="color:#66d9ef">signal</span>(<span style="color:#a6e22e">int</span> signum, void (handler))(<span style="color:#a6e22e">int</span>)))(<span style="color:#a6e22e">int</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">-------</span><span style="color:#960050;background-color:#1e0010">æˆ–è€…</span><span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt; </span>
</span></span><span style="display:flex;"><span>typedef void (<span style="color:#f92672">*</span>sighandler_t)(<span style="color:#a6e22e">int</span>);
</span></span><span style="display:flex;"><span>sighandler_t <span style="color:#66d9ef">signal</span>(<span style="color:#a6e22e">int</span> signum, sighandler_t handler));
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šä¿¡å·çš„å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šé’ˆå¯¹å‰é¢ä¿¡å·å€¼çš„å¤„ç†ï¼Œå¯ä»¥å¿½ç•¥è¯¥ä¿¡å·ï¼ˆå‚æ•°è®¾ä¸º</span> SIG_IGN<span style="color:#960050;background-color:#1e0010">ï¼‰ï¼›</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¯ä»¥é‡‡ç”¨ç³»ç»Ÿé»˜è®¤æ–¹å¼å¤„ç†ä¿¡å·</span>(<span style="color:#960050;background-color:#1e0010">å‚æ•°è®¾ä¸º</span> SIG_DFL)<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ä¹Ÿå¯ä»¥è‡ªå·±å®ç°å¤„ç†æ–¹å¼</span>(<span style="color:#960050;background-color:#1e0010">å‚æ•°æŒ‡å®šä¸€ä¸ªå‡½æ•°åœ°å€</span>)<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¦‚æœ</span> <span style="color:#66d9ef">signal</span>() <span style="color:#960050;background-color:#1e0010">è°ƒç”¨æˆåŠŸï¼Œè¿”å›æœ€åä¸€æ¬¡ä¸ºå®‰è£…ä¿¡å·</span> signum <span style="color:#960050;background-color:#1e0010">è€Œè°ƒç”¨</span><span style="color:#66d9ef">signal</span>() <span style="color:#960050;background-color:#1e0010">æ—¶çš„</span> handlerå€¼<span style="color:#960050;background-color:#1e0010">ï¼›å¤±è´¥åˆ™è¿”å›</span> SIG_ERR<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>sigactionå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;signal.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> sigaction(<span style="color:#a6e22e">int</span> signum,<span style="color:#66d9ef">const</span> struct sigaction <span style="color:#f92672">*</span>act,struct sigaction <span style="color:#f92672">*</span>oldact));
</span></span><span style="display:flex;"><span>sigactionå‡½æ•° <span style="color:#960050;background-color:#1e0010">ç”¨äºæ”¹å˜è¿›ç¨‹æ¥æ”¶åˆ°ç‰¹å®šä¿¡å·åçš„è¡Œä¸ºã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¿¡å·çš„å€¼ï¼Œå¯ä»¥ä¸ºé™¤</span>SIGKILLåŠSIGSTOPå¤–çš„ä»»ä½•ä¸€ä¸ªç‰¹å®šæœ‰æ•ˆçš„ä¿¡å·<span style="color:#960050;background-color:#1e0010">ï¼ˆä¸ºè¿™ä¸¤ä¸ªä¿¡å·å®šä¹‰è‡ªå·±çš„å¤„ç†å‡½æ•°ï¼Œå°†å¯¼è‡´ä¿¡å·å®‰è£…é”™è¯¯ï¼‰ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡å‘ç»“æ„</span> sigaction <span style="color:#960050;background-color:#1e0010">çš„ä¸€ä¸ªå®ä¾‹çš„æŒ‡é’ˆï¼Œåœ¨ç»“æ„</span>sigaction <span style="color:#960050;background-color:#1e0010">çš„å®ä¾‹ä¸­ï¼ŒæŒ‡å®šäº†å¯¹ç‰¹å®šä¿¡å·çš„å¤„ç†ï¼Œå¯ä»¥ä¸ºç©ºï¼Œè¿›ç¨‹ä¼šä»¥ç¼ºçœæ–¹å¼å¯¹ä¿¡å·å¤„ç†ï¼›</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬ä¸‰ä¸ªå‚æ•°</span> oldact <span style="color:#960050;background-color:#1e0010">æŒ‡å‘çš„å¯¹è±¡ç”¨æ¥ä¿å­˜åŸæ¥å¯¹ç›¸åº”ä¿¡å·çš„å¤„ç†ï¼Œå¯æŒ‡å®š</span> oldact <span style="color:#960050;background-color:#1e0010">ä¸º</span> NULL<span style="color:#960050;background-color:#1e0010">ã€‚å¦‚æœæŠŠç¬¬äºŒã€ç¬¬ä¸‰ä¸ªå‚æ•°éƒ½è®¾ä¸º</span>NULL<span style="color:#960050;background-color:#1e0010">ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°å¯ç”¨äºæ£€æŸ¥ä¿¡å·çš„æœ‰æ•ˆæ€§ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬äºŒä¸ªå‚æ•°æœ€ä¸ºé‡è¦ï¼Œå…¶ä¸­åŒ…å«äº†å¯¹æŒ‡å®šä¿¡å·çš„å¤„ç†ã€ä¿¡å·æ‰€ä¼ é€’çš„ä¿¡æ¯ã€ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­åº”å±è”½æ‰å“ªäº›å‡½æ•°ç­‰ç­‰ã€‚</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="ç¼ºç‚¹">ç¼ºç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç¼ºç‚¹">#</a></h3>
<ul>
<li>èƒ½å¤Ÿä¼ é€’çš„ä¿¡æ¯æ˜¯æœ‰é™çš„ï¼Œä¸èƒ½ä¼ é€’æ›´ä¸ºå¤æ‚çš„ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="æ–‡ä»¶-file">æ–‡ä»¶ file<a hidden class="anchor" aria-hidden="true" href="#æ–‡ä»¶-file">#</a></h2>
<ul>
<li>è¿™ç§åº”è¯¥æ˜¯æœ€ç®€å• æœ€å®¹æ˜“ç†è§£çš„ä¸€ç§é€šä¿¡æ–¹å¼ ä¸€ä¸ªè¿›ç¨‹å¾€æ–‡ä»¶å†™ä¿¡æ¯ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹è¯»ä¿¡æ¯ï¼Œä¹Ÿå°±å®Œæˆäº†é€šä¿¡è¿‡ç¨‹ã€‚</li>
<li>é€šä¿¡æœ¬èº«æ²¡æœ‰ä»»ä½•é¡ºåºæ§åˆ¶ï¼Œå¯èƒ½æ²¡æœ‰å†™å®Œï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹å°±è¯»åˆ°äº†ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹æœ¬èº«å¯èƒ½ä¹Ÿèƒ½å¤Ÿå†™
<ul>
<li>å¯ä»¥é€šè¿‡ä¿¡å·æ¥æ§åˆ¶æœ‰åº</li>
</ul>
</li>
<li>æ–‡ä»¶é€šä¿¡æ²¡æœ‰è®¿é—®è§„åˆ™</li>
<li>æ–‡ä»¶è®¿é—®çš„é€Ÿåº¦æ˜¯å¾ˆæ…¢çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å¸¸ç”¨</li>
</ul>
<h2 id="ç®¡é“-pipenamed-pipe">ç®¡é“ pipe/named pipe<a hidden class="anchor" aria-hidden="true" href="#ç®¡é“-pipenamed-pipe">#</a></h2>
<ul>
<li>
<p>pipe</p>
<ul>
<li>åŠåŒå·¥ æ•°æ®æµå‘æ˜¯å•ä¸€çš„ï¼Œå¦‚æœåŒæ–¹é€šä¿¡æ—¶ éœ€è¦å»ºç«‹2ä¸ªpipe</li>
<li>ä½¿ç”¨èŒƒå›´åªèƒ½æ˜¯çˆ¶å­è¿›ç¨‹/å…„å¼Ÿè¿›ç¨‹</li>
<li>åœ¨å†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ</li>
<li>ä¸€ä¸ªè¿›ç¨‹å†™å…¥è¾“å…¥åˆ°ç®¡é“ å¯ä»¥è¢«å¦å¤–ä¸€ç«¯çš„è¿›ç¨‹è¯»å‡ºï¼Œå†™å…¥çš„å†…å®¹æ¯æ¬¡éƒ½æ·»åŠ åˆ°ç®¡é“ç¼“å†²åŒºçš„å°¾éƒ¨ï¼Œç›¸åº”çš„å¦å¤–ä¸€ç«¯è¿›ç¨‹æ¯æ¬¡éƒ½ä»ç¼“å†²åŒºçš„å¤´éƒ¨è¯»å–ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pipe</span>(<span style="color:#66d9ef">int</span> fd[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ä¸€ç«¯åªèƒ½ç”¨äºè¯»ï¼Œç”±æè¿°å­—</span> fd[<span style="color:#ae81ff">0</span>] <span style="color:#960050;background-color:#1e0010">è¡¨ç¤ºï¼Œç§°å…¶ä¸ºç®¡é“è¯»ç«¯</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ä¸€ç«¯åˆ™åªèƒ½ç”¨äºå†™ï¼Œç”±æè¿°å­—</span> fd[<span style="color:#ae81ff">1</span>] <span style="color:#960050;background-color:#1e0010">æ¥è¡¨ç¤ºï¼Œç§°å…¶ä¸ºç®¡é“å†™ç«¯</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è¯•å›¾ä»ç®¡é“å†™ç«¯è¯»å–æ•°æ®ï¼Œæˆ–è€…å‘ç®¡é“è¯»ç«¯å†™å…¥æ•°æ®éƒ½å°†å¯¼è‡´é”™è¯¯å‘ç”Ÿ</span>
</span></span><span style="display:flex;"><span>fdåˆ›å»ºå fd[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">/</span>fd[<span style="color:#ae81ff">1</span>]<span style="color:#960050;background-color:#1e0010">å°±å¯ä»¥å½“ä½œæ™®é€šçš„æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨äº†</span> <span style="color:#960050;background-color:#1e0010">æ¯”å¦‚</span>close read writeç­‰
</span></span></code></pre></div></li>
<li>
<p>Named pipe</p>
<ul>
<li>å¯ä»¥åœ¨ä»»æ„è¿›ç¨‹é—´ä½¿ç”¨æ¥å®Œæˆé€šä¿¡å·¥ä½œ</li>
<li>ä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºä¸€ä¸ªçœŸå®å­˜åœ¨çš„æ–‡ä»¶ï¼Œä½†å®é™…æ˜¯å°†å…¶æ˜ å°„åˆ°å†…å­˜ä¸­çš„ä¸€ä¸ªç‰¹æ®ŠåŒºåŸŸ æ–‡ä»¶æœ¬èº«å¯ä»¥è®¾ç½®ç›¸åº”çš„æƒé™æ§åˆ¶</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/types.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;sys/stat.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> mkfifo(<span style="color:#66d9ef">const</span> char <span style="color:#f92672">*</span> pathname, mode_t mode)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ™®é€šçš„è·¯å¾„åï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå</span> FIFO <span style="color:#960050;background-color:#1e0010">çš„åå­—ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ç¬¬äºŒä¸ªå‚æ•°ä¸æ‰“å¼€æ™®é€šæ–‡ä»¶çš„</span> open() <span style="color:#960050;background-color:#1e0010">å‡½æ•°ä¸­çš„</span>mode <span style="color:#960050;background-color:#1e0010">å‚æ•°ç›¸åŒã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å¦‚æœ</span> mkfifo <span style="color:#960050;background-color:#1e0010">çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„è·¯å¾„åæ—¶ï¼Œä¼šè¿”å›</span>EEXIST <span style="color:#960050;background-color:#1e0010">é”™è¯¯ï¼Œæ‰€ä»¥ä¸€èˆ¬å…¸å‹çš„è°ƒç”¨ä»£ç é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦è¿”å›è¯¥é”™è¯¯ï¼Œå¦‚æœç¡®å®è¿”å›è¯¥é”™è¯¯ï¼Œé‚£ä¹ˆåªè¦è°ƒç”¨æ‰“å¼€</span> FIFO <span style="color:#960050;background-color:#1e0010">çš„å‡½æ•°å°±å¯ä»¥äº†ã€‚ä¸€èˆ¬æ–‡ä»¶çš„</span> I<span style="color:#f92672">/</span>O <span style="color:#960050;background-color:#1e0010">å‡½æ•°éƒ½å¯ä»¥ç”¨äº</span> FIFO<span style="color:#960050;background-color:#1e0010">ï¼Œå¦‚</span> close<span style="color:#960050;background-color:#1e0010">ã€</span>read<span style="color:#960050;background-color:#1e0010">ã€</span>write <span style="color:#960050;background-color:#1e0010">ç­‰ç­‰ã€‚</span>
</span></span></code></pre></div></li>
<li>
<p>ç®¡é“åœ¨è¿›ç¨‹é—´é€šä¿¡ä¸­ä½¿ç”¨çš„æ¯”è¾ƒé¢‘ç¹ï¼Œå°¤å…¶æ˜¯çˆ¶å­å¤šè¿›ç¨‹é—´é€šä¿¡ ç”¨çš„éå¸¸å¤š</p>
</li>
</ul>
<h2 id="å…±äº«å†…å­˜-shm">å…±äº«å†…å­˜ shm<a hidden class="anchor" aria-hidden="true" href="#å…±äº«å†…å­˜-shm">#</a></h2>
<h3 id="ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜">ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#ä»€ä¹ˆæ˜¯å…±äº«å†…å­˜">#</a></h3>
<ul>
<li>
<p>é¡¾åæ€ä¹‰å°±æ˜¯å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œå…±äº«å†…å­˜å…è®¸å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ªå­˜å‚¨åŒºï¼Œå› ä¸ºæ•°æ®ä¸ç”¨æ¥å›çš„å¤åˆ¶ï¼Œæ‰€ä»¥æ˜¯æ˜¯æœ€å¿«çš„IPCå½¢å¼ï¼Œè¿™ä¸ªå…±äº«å†…å­˜æ˜¯ç‹¬ç«‹ä¸ æ‰€æœ‰è¿›ç¨‹ç©ºé—´ä¹‹å¤–çš„ã€‚</p>
</li>
<li>
<p>è¿›ç¨‹å¯¹äºå…±äº«å†…å­˜çš„ä¸»è¦ä½¿ç”¨å¯èƒ½æœ‰ä»¥ä¸‹å‡ ç‚¹</p>
<ul>
<li>å‘å†…æ ¸æäº¤ç”³è¯· åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸ</li>
<li>ç”³è¯·ä½¿ç”¨ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å…±äº«å†…å­˜åŒºåŸŸ</li>
<li>ç”³è¯·é‡Šæ”¾æŸä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸ</li>
</ul>
</li>
<li>
<p>å¯ä»¥é€šè¿‡mmap()æ˜ å°„æ™®é€šæ–‡ä»¶(<strong>ç‰¹æ®Šæƒ…å†µä¸‹è¿˜å¯ä»¥é‡‡ç”¨åŒ¿åæ˜ å°„</strong>ï¼‰æœºåˆ¶å®ç°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»ŸVå…±äº«å†…å­˜æœºåˆ¶å®ç°</p>
</li>
<li>
<p>åº”ç”¨æ¥å£å’ŒåŸç†å¾ˆå¥½ç†è§£ï¼Œä½†å†…éƒ¨å®ç°æœºåˆ¶å¤æ‚ï¼Œå¾€å¾€ä¸ºäº†å®‰å…¨é€šä¿¡ï¼Œè¦å¼•å…¥ä¿¡å·ç¯ï¼Œé”ç­‰åŒæ­¥æœºåˆ¶å…±åŒä½¿ç”¨</p>
</li>
</ul>
<h3 id="åˆ›å»ºåŠä½¿ç”¨">åˆ›å»ºåŠä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºåŠä½¿ç”¨">#</a></h3>
<ul>
<li>
<p>mmap()æ˜ å°„ä¸€ä¸ªæ™®é€šæ–‡ä»¶å®ç°å…±äº«å†…å­˜</p>
</li>
<li>
<p>é€šè¿‡shmå…±äº«å†…å­˜æœºåˆ¶åˆ›å»º(æ¯ä¸ªå…±äº«å†…å­˜åŒºåŸŸå¯¹åº”ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿshmä¸­çš„ä¸€ä¸ªæ–‡ä»¶)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#a6e22e">int</span> shmget(key_t key, size_t size, <span style="color:#a6e22e">int</span> shmflg); <span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">è¿”å›å€¼æ˜¯å…±äº«å†…å­˜çš„æ ‡å·</span>shmid
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> shmid <span style="color:#f92672">=</span> shmget(key, <span style="color:#ae81ff">256</span>, IPC_CREAT <span style="color:#f92672">|</span> IPC_EXCL <span style="color:#f92672">|</span> <span style="color:#ae81ff">0755</span>)<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span>key_t <span style="color:#960050;background-color:#1e0010">æ˜¯ä¸€ä¸ª</span> long <span style="color:#960050;background-color:#1e0010">ç±»å‹ï¼Œæ˜¯</span> IPC <span style="color:#960050;background-color:#1e0010">èµ„æºå¤–éƒ¨çº¦å®šçš„</span> key (<span style="color:#960050;background-color:#1e0010">å…³é”®</span>)<span style="color:#960050;background-color:#1e0010">å€¼ï¼Œé€šè¿‡</span> key <span style="color:#960050;background-color:#1e0010">å€¼æ˜ å°„å¯¹åº”çš„å”¯ä¸€å­˜åœ¨çš„æŸä¸€ä¸ª</span> IPC <span style="color:#960050;background-color:#1e0010">èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">é€šè¿‡</span> key_t <span style="color:#960050;background-color:#1e0010">çš„å€¼å°±èƒ½å¤Ÿåˆ¤æ–­æŸä¸€ä¸ªå¯¹åº”çš„å…±äº«å†…å­˜åŒºåŸŸåœ¨å“ªï¼Œæ˜¯å¦å·²ç»åˆ›å»ºç­‰ç­‰</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">ä¸€ä¸ª</span> key <span style="color:#960050;background-color:#1e0010">å€¼åªèƒ½æ˜ å°„ä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸï¼Œä½†åŒæ—¶è¿˜å¯ä»¥æ˜ å°„ä¸€ä¸ªä¿¡å·é‡ï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—èµ„æºï¼Œäºæ˜¯å°±å¯ä»¥ä½¿ç”¨ä¸€ä¸ª</span> key <span style="color:#960050;background-color:#1e0010">å€¼ç®¡ç†ä¸‰ç§ä¸åŒçš„èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å…±äº«å†…å­˜çš„æ§åˆ¶ä¿¡æ¯å¯ä»¥é€šè¿‡</span> shmctl() <span style="color:#960050;background-color:#1e0010">æ–¹æ³•è·å–ï¼Œä¼šä¿å­˜åœ¨</span>struct_shmid_ds <span style="color:#960050;background-color:#1e0010">ç»“æ„ä½“ä¸­</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> shmctl(<span style="color:#a6e22e">int</span> shmid, <span style="color:#a6e22e">int</span> cmd, struct shmid_ds <span style="color:#f92672">*</span>buf)
</span></span><span style="display:flex;"><span>cmd<span style="color:#960050;background-color:#1e0010">ï¼šçœ‹æ‰§è¡Œä»€ä¹ˆæ“ä½œ</span>(<span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">ã€è·å–å…±äº«å†…å­˜ä¿¡æ¯ï¼›</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ã€è®¾ç½®å…±äº«å†…å­˜ä¿¡æ¯ï¼›</span><span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">ã€åˆ é™¤å…±äº«å†…å­˜</span>)<span style="color:#960050;background-color:#1e0010">ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-----------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>void <span style="color:#f92672">*</span> shmat(<span style="color:#a6e22e">int</span> shmid, <span style="color:#66d9ef">const</span> void <span style="color:#f92672">*</span>shmaddr, <span style="color:#a6e22e">int</span> shmflg);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å°†è¿™ä¸ªå†…å­˜åŒºåŸŸæ˜ å°„åˆ°æœ¬è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> shmdt(<span style="color:#66d9ef">const</span> void <span style="color:#f92672">*</span>shmaddr);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">å–æ¶ˆå…±äº«å†…å­˜æ˜ å°„</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="ä¿¡å·é‡semaphore">ä¿¡å·é‡semaphore<a hidden class="anchor" aria-hidden="true" href="#ä¿¡å·é‡semaphore">#</a></h2>
<h3 id="æ¦‚å¿µ">æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#æ¦‚å¿µ">#</a></h3>
<ul>
<li>ä¸åŒè¿›ç¨‹é—´/åŒä¸€è¿›ç¨‹çš„ä¸åŒçº¿ç¨‹é—´çš„ä¸€ç§åŒæ­¥æ‰‹æ®µ</li>
<li>ä¸ºäº†è§£å†³è®¿é—®å…±äº«èµ„æºæ—¶å€™çš„å†²çªé—®é¢˜</li>
</ul>
<h3 id="è®¿é—®è§„åˆ™">è®¿é—®è§„åˆ™<a hidden class="anchor" aria-hidden="true" href="#è®¿é—®è§„åˆ™">#</a></h3>
<p>â€‹	semï¼šè¡¨ç¤ºçš„æ˜¯ä¸€ç§å…±äº«èµ„æºçš„ä¸ªæ•°ï¼Œå¯¹å…±äº«èµ„æºçš„è®¿é—®è§„åˆ™</p>
<p>â€‹	1ï¼‰ç”¨ä¸€ç§æ•°é‡å•ä½å»æ ‡è¯†æŸä¸€ç§å…±äº«èµ„æºçš„ä¸ªæ•°ã€‚</p>
<p>â€‹	2ï¼‰å½“æœ‰è¿›ç¨‹éœ€è¦è®¿é—®å¯¹åº”çš„å…±äº«èµ„æºçš„æ—¶å€™ï¼Œåˆ™éœ€è¦å…ˆæŸ¥çœ‹ç”³è¯·ï¼Œæ ¹æ®å½“å‰èµ„æºå¯¹åº”çš„å¯ç”¨æ•°é‡è¿›è¡Œç”³è¯·ã€‚</p>
<p>â€‹	3ï¼‰èµ„æºçš„ç®¡ç†è€…ï¼ˆä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ï¼‰å°±ä½¿ç”¨å½“å‰çš„èµ„æºä¸ªæ•°å‡å»è¦ç”³è¯·çš„èµ„æºçš„ä¸ªæ•°ã€‚å¦‚æœç»“æœ &gt;=0 è¡¨ç¤ºæœ‰å¯ç”¨èµ„æºï¼Œå…è®¸è¯¥è¿›ç¨‹çš„ç»§ç»­è®¿é—®ï¼›å¦åˆ™è¡¨ç¤ºèµ„æºä¸å¯ç”¨ï¼Œé€šçŸ¥è¿›ç¨‹ï¼ˆæš‚åœæˆ–ç«‹å³è¿”å›ï¼‰ã€‚</p>
<p>â€‹	4ï¼‰èµ„æºæ•°é‡çš„å˜åŒ–å°±è¡¨ç¤ºèµ„æºçš„å ç”¨å’Œé‡Šæ”¾ã€‚å ç”¨ï¼šä½¿å¾—å¯ç”¨èµ„æºå‡å°‘ï¼›é‡Šæ”¾ï¼šä½¿å¾—å¯ç”¨èµ„æºå¢åŠ ã€‚</p>
<h3 id="ç›¸å…³api">ç›¸å…³API<a hidden class="anchor" aria-hidden="true" href="#ç›¸å…³api">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> //åˆ›å»ºä¿¡å·é‡é›†
</span></span><span style="display:flex;"><span> int semid = semget(key_t key, int nsems, int semflg)
</span></span><span style="display:flex;"><span> ä¿¡å·é‡ ID äº‹å®ä¸Šæ˜¯ä¿¡å·é‡é›†åˆçš„IDï¼Œä¸€ä¸ªID å¯¹åº”çš„æ˜¯ä¸€ç»„ä¿¡å·é‡ï¼Œæ­¤æ—¶å°±ä½¿ç”¨ä¿¡å·é‡ID è®¾ç½®æ•´ä¸ªä¿¡å·é‡é›†åˆ
</span></span><span style="display:flex;"><span> è¿™ä¸ªæ—¶å€™æ“ä½œåˆ†ä¸¤ç§ï¼š
</span></span><span style="display:flex;"><span>ï¼ˆ1ï¼‰é’ˆå¯¹ä¿¡å·é‡é›†åˆä¸­çš„ä¸€ä¸ªä¿¡å·é‡è¿›è¡Œè®¾ç½®ï¼›ä¿¡å·é‡é›†åˆä¸­çš„ä¿¡å·é‡æ˜¯æŒ‰ç…§æ•°ç»„çš„æ–¹å¼è¢«ç®¡ç†èµ·æ¥çš„ï¼Œä»è€Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¿¡å·çš„æ•°ç»„ä¸‹æ ‡æ¥è¿›è¡Œè®¿é—®ã€‚
</span></span><span style="display:flex;"><span>ï¼ˆ2ï¼‰é’ˆå¯¹æ•´ä¸ªä¿¡å·é‡é›†å’Œè¿›è¡Œç»Ÿä¸€çš„è®¾ç½®
</span></span><span style="display:flex;"><span>-----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>int semctl(int semid, int semnum, int cmd, ...)
</span></span><span style="display:flex;"><span>å¦‚æœ cmd æ˜¯ GETALLã€SETALLã€GETVALã€SETVAL...çš„è¯ï¼Œåˆ™éœ€è¦æä¾›ç¬¬å››ä¸ªå‚æ•°ã€‚ç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå…±ç”¨ä½“ï¼Œè¿™ä¸ªå…±ç”¨ä½“åœ¨ç¨‹åºä¸­å¿…é¡»çš„è‡ªå·±å®šä¹‰ï¼ˆä½œç”¨ï¼šåˆå§‹åŒ–èµ„æºä¸ªæ•°ï¼‰ï¼Œå®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š
</span></span><span style="display:flex;"><span>union semun{
</span></span><span style="display:flex;"><span>  int val;    /* Value for SETVAL */
</span></span><span style="display:flex;"><span>  struct semid_ds *buf;    /* Buffer for IPC_STAT, IPC_SET */
</span></span><span style="display:flex;"><span>  unsigned short  *array;  /* Array for GETALL, SETALL */
</span></span><span style="display:flex;"><span>  struct seminfo  *__buf;  /* Buffer for IPC_INFO
</span></span><span style="display:flex;"><span>  (Linux-specific) */
</span></span><span style="display:flex;"><span> };
</span></span><span style="display:flex;"><span> -----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  //semop()æ–¹æ³•ã€‚(opï¼šoperatoræ“ä½œ)
</span></span><span style="display:flex;"><span> int semop(int semid, struct sembuf *sops, unsigned nsops);
</span></span><span style="display:flex;"><span> ç¬¬äºŒä¸ªå‚æ•°éœ€è¦å€ŸåŠ©ç»“æ„ä½“ struct sembufï¼š
</span></span><span style="display:flex;"><span> struct sembuf{
</span></span><span style="display:flex;"><span> unsigned short sem_num;  /* semaphore number æ•°ç»„ä¸‹æ ‡ */
</span></span><span style="display:flex;"><span> short sem_op;   /* semaphore operation */
</span></span><span style="display:flex;"><span> short sem_flg;  /* operation flags é»˜è®¤0*/
</span></span><span style="display:flex;"><span> }ï¼›
</span></span><span style="display:flex;"><span> é€šè¿‡ä¸‹æ ‡ç›´æ¥å¯¹å…¶ä¿¡å·é‡ sem_op è¿›è¡ŒåŠ å‡å³å¯ã€‚
</span></span></code></pre></div><h3 id="ç‰¹ç‚¹">ç‰¹ç‚¹<a hidden class="anchor" aria-hidden="true" href="#ç‰¹ç‚¹">#</a></h3>
<ul>
<li>
<p>å¦‚æœæœ‰è¿›ç¨‹é€šè¿‡ä¿¡å·é‡ç”³è¯·å…±äº«èµ„æºï¼Œè€Œä¸”æ­¤æ—¶èµ„æºä¸ªæ•°å·²ç»å°äº0ï¼Œåˆ™æ­¤æ—¶å¯¹äºè¯¥è¿›ç¨‹æœ‰ä¸¤ç§å¯èƒ½æ€§ï¼šç­‰å¾…èµ„æºï¼Œä¸ç­‰å¾…ã€‚</p>
</li>
<li>
<p>å¦‚æœæ­¤æ—¶è¿›ç¨‹é€‰æ‹©ç­‰å¾…èµ„æºï¼Œåˆ™æ“ä½œç³»ç»Ÿå†…æ ¸ä¼šé’ˆå¯¹è¯¥ä¿¡å·é‡æ„å»ºè¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œå°†ç­‰å¾…çš„è¿›ç¨‹åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¹‹ä¸­ã€‚</p>
</li>
<li>
<p>å¦‚æœæ­¤æ—¶æœ‰è¿›ç¨‹é‡Šæ”¾èµ„æºåˆ™ä¼šï¼š</p>
<p>(1)ã€å…ˆå°†èµ„æºä¸ªæ•°å¢åŠ ï¼›</p>
<p>(2)ã€ä»ç­‰å¾…é˜Ÿåˆ—ä¸­æŠ½å–ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼›</p>
<p>(3)ã€æ ¹æ®æ­¤æ—¶èµ„æºä¸ªæ•°å’Œç¬¬ä¸€ä¸ªè¿›ç¨‹éœ€è¦ç”³è¯·çš„èµ„æºä¸ªæ•°è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœå¤§äº 0ï¼Œåˆ™å”¤é†’è¯¥è¿›ç¨‹ï¼›ç»“æœå°äº 0ï¼Œåˆ™è®©è¯¥è¿›ç¨‹ç»§ç»­ç­‰å¾…ã€‚</p>
<p>æ‰€ä»¥ä¸€èˆ¬ç»“åˆä¿¡å·é‡çš„æ“ä½œå’Œå…±äº«å†…å­˜ä½¿ç”¨æ¥è¾¾åˆ°è¿›ç¨‹é—´çš„é€šä¿¡</p>
</li>
</ul>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—-message">æ¶ˆæ¯é˜Ÿåˆ— Message<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯é˜Ÿåˆ—-message">#</a></h2>
<h3 id="æ¦‚å¿µ-1">æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#æ¦‚å¿µ-1">#</a></h3>
<ul>
<li>
<p>æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯çš„é“¾è¡¨ã€‚å¯ä»¥æŠŠæ¶ˆæ¯çœ‹ä½œä¸€ä¸ªè®°å½•ï¼Œå…·æœ‰ç‰¹å®šçš„æ ¼å¼ä»¥åŠç‰¹å®šçš„ä¼˜å…ˆçº§</p>
</li>
<li>
<p>å¯¹æ¶ˆæ¯é˜Ÿåˆ—æœ‰å†™æƒé™çš„è¿›ç¨‹å¯ä»¥å‘ä¸­æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ·»åŠ æ–°æ¶ˆæ¯ï¼›å¯¹æ¶ˆæ¯é˜Ÿåˆ—æœ‰è¯»æƒé™çš„è¿›ç¨‹åˆ™å¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»èµ°æ¶ˆæ¯</p>
</li>
<li>
<p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯éšå†…æ ¸æŒç»­çš„ï¼›å…‹æœäº†ä¿¡å·æ‰¿è½½ä¿¡æ¯é‡å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹</p>
</li>
<li>
<p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯éšå†…æ ¸æŒç»­çš„ï¼Œåªæœ‰åœ¨å†…æ ¸é‡èµ·æˆ–è€…æ˜¾ç¤ºåˆ é™¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—æ‰ä¼šçœŸæ­£è¢«åˆ é™¤ã€‚å› æ­¤ç³»ç»Ÿä¸­è®°å½•æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼ˆstruct ipc_ids msg_idsï¼‰ä½äºå†…æ ¸ä¸­ï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—éƒ½å¯ä»¥åœ¨ç»“æ„msg_idsä¸­æ‰¾åˆ°è®¿é—®å…¥å£</p>
</li>
</ul>
<h3 id="ç»“æ„">ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#ç»“æ„">#</a></h3>
<p>â€‹	æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯çš„é“¾è¡¨ã€‚æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—éƒ½æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¤´ï¼Œç”¨ç»“æ„struct msg_queueæ¥æè¿°ã€‚é˜Ÿåˆ—å¤´ä¸­åŒ…å«äº†è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„å¤§é‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¶ˆæ¯é˜Ÿåˆ—é”®å€¼ã€ç”¨æˆ·IDã€ç»„IDã€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°ç›®ç­‰ç­‰ï¼Œç”šè‡³è®°å½•äº†æœ€è¿‘å¯¹æ¶ˆæ¯é˜Ÿåˆ—è¯»å†™è¿›ç¨‹çš„IDã€‚è¯»è€…å¯ä»¥è®¿é—®è¿™äº›ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥è®¾ç½®å…¶ä¸­çš„æŸäº›ä¿¡æ¯ã€‚</p>
<p>â€‹	<img loading="lazy" src="http://becool.vip:666/img/%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%bb%93%e6%9e%84%e5%9b%be.png" alt=""  />
</p>
<ul>
<li>
<p>struct ipc_ids msg_idsæ˜¯å†…æ ¸ä¸­è®°å½•æ¶ˆæ¯é˜Ÿåˆ—çš„å…¨å±€æ•°æ®ç»“æ„ï¼›struct msg_queueæ˜¯æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´</p>
</li>
<li>
<p>å…¨å±€æ•°æ®ç»“æ„ struct ipc_ids msg_ids å¯ä»¥è®¿é—®åˆ°æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¤´çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼šstruct kern_ipc_perm</p>
</li>
<li>
<p>struct kern_ipc_perm èƒ½å¤Ÿä¸å…·ä½“çš„æ¶ˆæ¯é˜Ÿåˆ—å¯¹åº”èµ·æ¥æ˜¯å› ä¸ºåœ¨è¯¥ç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ª key_t ç±»å‹æˆå‘˜ keyï¼Œè€Œ key åˆ™å”¯ä¸€ç¡®å®šä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>struct kern_ipc_perm{   //å†…æ ¸ä¸­è®°å½•æ¶ˆæ¯é˜Ÿåˆ—çš„å…¨å±€æ•°æ®ç»“æ„msg_idsèƒ½å¤Ÿè®¿é—®åˆ°è¯¥ç»“æ„ï¼›
</span></span><span style="display:flex;"><span>		key_t   key;    //è¯¥é”®å€¼åˆ™å”¯ä¸€å¯¹åº”ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—
</span></span><span style="display:flex;"><span>		uid_t   uid;
</span></span><span style="display:flex;"><span>		gid_t   gid;
</span></span><span style="display:flex;"><span>		uid_t   cuid;
</span></span><span style="display:flex;"><span>		gid_t   cgid;
</span></span><span style="display:flex;"><span>		mode_t  mode;
</span></span><span style="display:flex;"><span>		unsigned long seq;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>ç®¡é“ä¸­çš„æ•°æ®æ²¡æœ‰åˆ†å‰²ä¸ºä¸€ä¸ªä¸ªç‹¬ç«‹å•å…ƒ å­—èŠ‚æµä¸Šæ˜¯è¿ç»­çš„ï¼Œä½†æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ•°æ®åˆ†æˆäº†ä¸€ä¸ªä¸ªç‹¬ç«‹çš„å•å…ƒï¼Œæ¯ä¸ªç‹¬ç«‹å•å…ƒç§°è°“æ¶ˆæ¯ä½“ï¼Œæ¯ä¸€ä¸ªæ¶ˆæ¯ä½“éƒ½æ˜¯å›ºå®šå¤§å°çš„å­˜å‚¨åŒºåŸŸï¼Œå­—èŠ‚æµä¸Šæ˜¯ä¸è¿ç»­çš„</p>
</li>
</ul>
<h3 id="ç›¸å…³api-1">ç›¸å…³API<a hidden class="anchor" aria-hidden="true" href="#ç›¸å…³api-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#a6e22e">int</span> msgget(key_t key, <span style="color:#a6e22e">int</span> msgflg); <span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">int</span> msgsnd(<span style="color:#a6e22e">int</span> msqid, <span style="color:#66d9ef">const</span> void <span style="color:#f92672">*</span>msgp, size_t msgsz, <span style="color:#a6e22e">int</span> msgflg);<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">å‘é€</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ˜¯åœ¨æ¶ˆæ¯ä½“ç»“æ„ä½“ä¸­æŒ‡å®šï¼Œå½“å‰çš„æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—é›†åˆä¸­çš„å“ªä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Š</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">æ¶ˆæ¯ä½“ç»“æ„ä½“ä¸­å°±å¿…é¡»åŒ…å«ä¸€ä¸ª</span> type <span style="color:#960050;background-color:#1e0010">å€¼ï¼Œ</span>type <span style="color:#960050;background-color:#1e0010">å€¼æ˜¯</span>longç±»å‹<span style="color:#960050;background-color:#1e0010">ï¼Œè€Œä¸”è¿˜å¿…é¡»æ˜¯ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ã€‚è€Œç»“æ„ä½“ä¸­çš„å…¶ä»–æˆå‘˜éƒ½è¢«è®¤ä¸ºæ˜¯è¦å‘é€çš„æ¶ˆæ¯ä½“æ•°æ®</span>
</span></span><span style="display:flex;"><span>ssize_t msgrcv(<span style="color:#a6e22e">int</span> msqid, void <span style="color:#f92672">*</span>msgp, size_t msgsz, long msgtyp,<span style="color:#a6e22e">int</span> msgflg);<span style="color:#f92672">//</span><span style="color:#960050;background-color:#1e0010">æ¥æ”¶</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">æ— è®ºæ˜¯</span> msgsnd() <span style="color:#960050;background-color:#1e0010">å‘é€è¿˜æ˜¯</span> msgrcv()<span style="color:#960050;background-color:#1e0010">æ¥æ”¶æ—¶ï¼Œåªè¦æ“ä½œç³»ç»Ÿå†…æ ¸å‘ç°æ–°æä¾›çš„</span> type <span style="color:#960050;background-color:#1e0010">å€¼å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—é›†åˆä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ™ç«‹å³ä¸ºå…¶åˆ›å»ºè¯¥æ¶ˆæ¯é˜Ÿåˆ—</span>
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div><h3 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹<a hidden class="anchor" aria-hidden="true" href="#æ³¨æ„äº‹é¡¹">#</a></h3>
<ul>
<li>
<p>ä¸ºäº†èƒ½å¤Ÿé¡ºåˆ©çš„å‘é€ä¸æ¥æ”¶ï¼Œå‘é€æ–¹ä¸æ¥æ”¶æ–¹éœ€è¦çº¦å®šè§„åˆ™</p>
<ul>
<li>åŒæ ·çš„æ¶ˆæ¯ä½“ç»“æ„ä½“ï¼›</li>
<li>å‘é€æ–¹ä¸æ¥æ”¶æ–¹åœ¨å‘é€å’Œæ¥æ”¶çš„æ•°æ®å—å„¿å¤§å°ä¸Šè¦ä¸æ¶ˆæ¯ç»“æ„ä½“çš„å…·ä½“æ•°æ®éƒ¨åˆ†ä¿æŒä¸€è‡´ï¼Œ å¦åˆ™å°†ä¸ä¼šè¯»å‡ºæ­£ç¡®çš„æ•°æ®ã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœç»“æ„ä½“æˆå‘˜æœ‰æŒ‡é’ˆ ä¸ä¼šå°†æŒ‡é’ˆæŒ‡å‘ç©ºé—´ä¸­çš„æ•°æ®å‘é€ åªæ˜¯å‘é€æŒ‡é’ˆæœ¬èº«çš„å€¼ã€‚</p>
</li>
<li>
<p>æ•°ç»„ä½œä¸ºæ¶ˆæ¯ç»“æ„ä½“æˆå‘˜æ˜¯å¯ä»¥çš„ å› ä¸ºæ•´ä¸ªæ•°ç»„ç©ºé—´éƒ½åœ¨æ¶ˆæ¯ç»“æ„ä½“ä¸­</p>
</li>
</ul>
<h2 id="socketé€šä¿¡">Socketé€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#socketé€šä¿¡">#</a></h2>
<ul>
<li>unixåŸŸå¥—æ¥å­—</li>
<li>å…¶å®ƒç½‘ç»œå¥—æ¥å­—</li>
</ul>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="http://becool.vip:666/img/wechatpayimg.JPG" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="http://becool.vip:666/img/alipayimg.JPG" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="http://heketong.github.io/posts/tech/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>è®¾è®¡æ¨¡å¼</span>
  </a>
  <a class="next" href="http://heketong.github.io/posts/tech/%E5%88%86%E5%B8%83%E5%BC%8F/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>åˆ†å¸ƒå¼</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2024
        <a href="http://heketong.github.io/" style="color:#939393;">ç–¯å­çˆ±æ·¡å®š</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">ç²¤ICPå¤‡2022127626å·-1</a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"ç–¯å­çˆ±æ·¡å®š"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"ç–¯å­çˆ±æ·¡å®š"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"ç–¯å­çˆ±æ·¡å®š"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
